(function(){var t=quat4.create();vec3.create(),quat4.rotateByVector=function(e,i,o){return o||(o=e),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,quat4.multiply(t,e),o},quat4.addScaledVector=function(e,i,o,a){a||(a=e);var n=Math.cos(i[0]*o/2),s=Math.cos(i[1]*o/2),c=Math.cos(i[2]*o/2),r=Math.sin(i[0]*o/2),h=Math.sin(i[1]*o/2),p=Math.sin(i[2]*o/2);return t[0]=r*s*c+n*h*p,t[1]=n*h*c-r*s*p,t[2]=n*s*p+r*h*c,t[3]=n*s*c-r*h*p,quat4.multiply(e,t),a}})(),window.Goblin=function(){"use strict";var t={},e=vec3.create(),i=vec3.create(),o=vec3.create(),a=quat4.create(),n=(mat3.create(),mat3.create(),mat4.create());return t.EPSILON=1e-6,t.AABB=function(t,e){this.min=t||vec3.create(),this.max=e||vec3.create()},t.AABB.prototype.transform=function(){var t=vec3.create(),i=vec3.create(),o=vec3.create(),a=vec3.create(),n=mat3.create();return function(s,c){vec3.subtract(s.max,s.min,t),vec3.scale(t,.5),vec3.add(s.max,s.min,i),vec3.scale(i,.5),mat4.multiplyVec3(c,i,o),n[0]=Math.abs(c[0]),n[1]=Math.abs(c[1]),n[2]=Math.abs(c[2]),n[3]=Math.abs(c[4]),n[4]=Math.abs(c[5]),n[5]=Math.abs(c[6]),n[6]=Math.abs(c[8]),n[7]=Math.abs(c[9]),n[8]=Math.abs(c[10]),e[0]=n[0],e[1]=n[1],e[2]=n[2],a[0]=vec3.dot(t,e),e[0]=n[3],e[1]=n[4],e[2]=n[5],a[1]=vec3.dot(t,e),e[0]=n[6],e[1]=n[7],e[2]=n[8],a[2]=vec3.dot(t,e),vec3.subtract(o,a,this.min),vec3.add(o,a,this.max)}}(),t.AABB.prototype.intersects=function(t){return this.max[0]<t.min[0]||this.max[1]<t.min[1]||this.max[2]<t.min[2]||this.min[0]>t.max[0]||this.min[1]>t.max[1]||this.min[2]>t.max[2]?!1:!0},t.BasicBroadphase=function(){this.bodies=[],this.collision_pairs=[]},t.BasicBroadphase.prototype.addBody=function(t){this.bodies.push(t)},t.BasicBroadphase.prototype.removeBody=function(t){var e,i=this.bodies.length;for(e=0;i>e;e++)if(this.bodies[e]===t){this.bodies.splice(e,1);break}},t.BasicBroadphase.prototype.predictContactPairs=function(){var t,e,i,o,a=this.bodies.length;for(this.collision_pairs.length=0,t=0;a>t;t++)for(i=this.bodies[t],e=0;a>e;e++)e>=t||(o=this.bodies[e],(1/0!==i.mass||1/0!==o.mass)&&i.aabb.intersects(o.aabb)&&this.collision_pairs.push([i,o]))},t.BoxSphere=function(a,s){var c,r,h=a.shape instanceof t.SphereShape?a:s,p=a.shape instanceof t.SphereShape?s:a;return mat4.multiplyVec3(p.transform_inverse,h.position,e),Math.abs(e[0])-h.shape.radius>p.shape.half_width||Math.abs(e[1])-h.shape.radius>p.shape.half_height||Math.abs(e[2])-h.shape.radius>p.shape.half_depth||(i[0]=i[1]=i[2]=0,r=e[0],r>p.shape.half_width?r=p.shape.half_width:-p.shape.half_width>r&&(r=-p.shape.half_width),i[0]=r,r=e[1],r>p.shape.half_height?r=p.shape.half_height:-p.shape.half_height>r&&(r=-p.shape.half_height),i[1]=r,r=e[2],r>p.shape.half_depth?r=p.shape.half_depth:-p.shape.half_depth>r&&(r=-p.shape.half_depth),i[2]=r,vec3.subtract(i,e,o),r=vec3.squaredLength(o),r>h.shape.radius*h.shape.radius)?void 0:(c=t.ObjectPool.getObject("ContactDetails"),c.object_a=h,c.object_b=p,0===r?t.BoxSphere.spherePenetration(p.shape,e,i,c):(vec3.subtract(i,e,c.contact_normal),c.penetration_depth=-vec3.length(c.contact_normal),vec3.scale(c.contact_normal,-1/c.penetration_depth),vec3.set(i,c.contact_point_in_b)),c.penetration_depth+=h.shape.radius,mat4.toRotationMat(p.transform,n),mat4.multiplyVec3(n,c.contact_normal),mat4.toRotationMat(h.transform_inverse,n),mat4.multiplyVec3(n,c.contact_normal,c.contact_point_in_a),vec3.scale(c.contact_point_in_a,h.shape.radius),vec3.scale(c.contact_normal,h.shape.radius-c.penetration_depth/2,c.contact_point),vec3.add(c.contact_point,h.position),c.restitution=(h.restitution+p.restitution)/2,c.friction=(h.friction+p.friction)/2,c)},t.BoxSphere.spherePenetration=function(t,e,o,a){var n,s;0>e[0]?(n=t.half_width+e[0],o[0]=-t.half_width,o[1]=o[2]=0,a.penetration_depth=n):(n=t.half_width-e[0],o[0]=t.half_width,o[1]=o[2]=0,a.penetration_depth=n),0>e[1]?(s=t.half_height+e[1],n>s&&(n=s,o[1]=-t.half_height,o[0]=o[2]=0,a.penetration_depth=n)):(s=t.half_height-e[1],n>s&&(n=s,o[1]=t.half_height,o[0]=o[2]=0,a.penetration_depth=n)),0>e[2]?(s=t.half_depth+e[2],n>s&&(o[2]=-t.half_depth,o[0]=o[1]=0,a.penetration_depth=n)):(s=t.half_depth-e[2],n>s&&(o[2]=t.half_depth,o[0]=o[1]=0,a.penetration_depth=n)),vec3.set(i,a.contact_point_in_b),vec3.scale(a.contact_point_in_b,-1,a.contact_normal),vec3.normalize(a.contact_normal)},t.GjkEpa={SupportPoint:function(t,e,i,o){this.direction=t,this.witness_a=e,this.witness_b=i,this.point=o},findSupportPoint:function(t,i,o,a){vec3.set(o,a.direction),t.findSupportPoint(o,a.witness_a),vec3.negate(o,e),i.findSupportPoint(e,a.witness_b),vec3.subtract(a.witness_a,a.witness_b,a.point)},GJK:function(){var o,a=[],n=vec3.create(),s=0,c=20,r=vec3.create(),h=vec3.create(),p=vec3.create(),l=vec3.create(),_=vec3.create(),v=vec3.create(),u=vec3.create(),b=vec3.create(),f=!0,d=e,m=i,j=function(e,i){var o,a,n,s;if(2===e.length){if(o=e[1],a=e[0],vec3.negate(o.point,r),vec3.subtract(a.point,o.point,h),0===r[0]&&0===r[1]&&0===r[2])return!0;vec3.dot(h,r)>=0?(vec3.cross(h,r,i),vec3.cross(i,h),0===i[0]&&0===i[1]&&0===i[2]&&(vec3.normalize(h),i[0]=1-Math.abs(h[0]),i[1]=1-Math.abs(h[1]),i[2]=1-Math.abs(h[2]))):(vec3.set(r,i),e.length=1)}else if(3===e.length)o=e[2],a=e[1],n=e[0],vec3.negate(o.point,r),vec3.subtract(a.point,o.point,h),vec3.subtract(n.point,o.point,p),vec3.cross(h,p,_),vec3.cross(h,_,v),vec3.cross(_,p,u),vec3.dot(u,r)>=0?vec3.dot(p,r)>=0?(e.length=0,e.push(n,o),vec3.cross(p,r,i),vec3.cross(i,p)):vec3.dot(h,r)>=0?(e.length=0,e.push(a,o),vec3.cross(h,r,i),vec3.cross(i,h)):(e.length=0,e.push(o)):vec3.dot(v,r)>=0?vec3.dot(h,r)>=0?(e.length=0,e.push(a,o),vec3.cross(h,r,i),vec3.cross(i,h)):(e.length=0,e.push(o)):vec3.dot(_,r)>=0?vec3.set(_,i):(vec3.set(_,i),vec3.negate(i),e.length=0,e.push(o,a,n));else if(4===e.length){if(o=e[3],a=e[2],n=e[1],s=e[0],vec3.negate(o.point,r),f=!0,vec3.subtract(s.point,o.point,h),vec3.subtract(n.point,o.point,l),vec3.cross(h,l,u),vec3.dot(u,o.point)>0&&(f=!1),vec3.subtract(n.point,o.point,h),vec3.subtract(a.point,o.point,l),vec3.cross(h,l,u),vec3.dot(u,o.point)>0&&(f=!1),vec3.subtract(a.point,o.point,h),vec3.subtract(s.point,o.point,l),vec3.cross(h,l,u),vec3.dot(u,o.point)>0&&(f=!1),vec3.subtract(a.point,s.point,h),vec3.subtract(n.point,s.point,l),vec3.cross(h,l,u),vec3.dot(u,s.point)>0&&(f=!1),f)return f;var c=1/0,j=0;if(t.GeometryMethods.findClosestPointInTriangle(b,s.point,n.point,o.point,m),vec3.squaredLength(m)<t.EPSILON)return!0;if(vec3.subtract(s.point,o.point,h),vec3.subtract(n.point,o.point,l),vec3.cross(h,l,d),j=vec3.length(m),c>j&&(c=j,vec3.set(d,i),e.length=0,e.push(o,n,s)),t.GeometryMethods.findClosestPointInTriangle(b,n.point,a.point,o.point,m),vec3.squaredLength(m)<t.EPSILON)return!0;if(vec3.subtract(n.point,o.point,h),vec3.subtract(a.point,o.point,l),vec3.cross(h,l,d),j=vec3.length(m),c>j&&(c=j,vec3.set(d,i),e.length=0,e.push(o,a,n)),t.GeometryMethods.findClosestPointInTriangle(b,a.point,s.point,o.point,m),vec3.squaredLength(m)<t.EPSILON)return!0;if(vec3.subtract(a.point,o.point,h),vec3.subtract(s.point,o.point,l),vec3.cross(h,l,d),j=vec3.length(m),c>j&&(c=j,vec3.set(d,i),e.length=0,e.push(a,s,o)),t.GeometryMethods.findClosestPointInTriangle(b,s.point,a.point,n.point,m),vec3.squaredLength(m)<t.EPSILON)return!0;vec3.subtract(s.point,n.point,h),vec3.subtract(a.point,n.point,l),vec3.cross(h,l,d),j=vec3.length(m),c>j&&(c=j,vec3.set(d,i),e.length=0,e.push(n,a,s))}return!1};return function(e,i){if(a.length=0,s=0,vec3.subtract(i.position,e.position,n),vec3.normalize(n),o=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(e,i,n,o),a.push(o),0>vec3.dot(a[0].point,n))return!1;for(vec3.negate(n);;){if(s++,s===c)return!1;if(o=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(e,i,n,o),a.push(o),0>vec3.dot(a[a.length-1].point,n))return!1;if(j(a,n))return t.GjkEpa.EPA(e,i,a)}}}(),EPA:function(a,n,s){function c(t,e){var i=[];return(vec3.equal(t.a.point,e.a.point)||vec3.equal(t.a.point,e.b.point)||vec3.equal(t.a.point,e.c.point))&&i.push(t.a),(vec3.equal(t.b.point,e.a.point)||vec3.equal(t.b.point,e.b.point)||vec3.equal(t.b.point,e.c.point))&&i.push(t.b),(vec3.equal(t.c.point,e.a.point)||vec3.equal(t.c.point,e.b.point)||vec3.equal(t.c.point,e.c.point))&&i.push(t.c),i}var r,h=e,p=i,l=o,_=h;if(2===s.length&&(vec3.cross(s[0].point,s[1].point,_),r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(a,n,_,r),s.push(r)),3===s.length){var v=s[2],u=s[1],b=s[0],f=h,d=p,m=l;vec3.negate(v.point,f),vec3.subtract(u.point,v.point,d),vec3.subtract(b.point,v.point,m),vec3.cross(d,m,_),r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(a,n,_,r),s.push(r)}var j=[];j.push(new t.GjkEpa.GjkFace(s[0],s[2],s[3],vec3.create(),0),new t.GjkEpa.GjkFace(s[0],s[1],s[2],vec3.create(),1),new t.GjkEpa.GjkFace(s[0],s[3],s[1],vec3.create(),2),new t.GjkEpa.GjkFace(s[3],s[2],s[1],vec3.create(),3)),vec3.subtract(j[0].b.point,j[0].a.point,h),vec3.subtract(j[0].c.point,j[0].a.point,p),vec3.cross(h,p,j[0].normal),vec3.normalize(j[0].normal),vec3.subtract(j[1].b.point,j[1].a.point,h),vec3.subtract(j[1].c.point,j[1].a.point,p),vec3.cross(h,p,j[1].normal),vec3.normalize(j[1].normal),vec3.subtract(j[2].b.point,j[2].a.point,h),vec3.subtract(j[2].c.point,j[2].a.point,p),vec3.cross(h,p,j[2].normal),vec3.normalize(j[2].normal),vec3.subtract(j[3].b.point,j[3].a.point,h),vec3.subtract(j[3].c.point,j[3].a.point,p),vec3.cross(h,p,j[3].normal),vec3.normalize(j[3].normal);for(var g,y,w,B,x,P,S=1/0,C=null,F=vec3.create(),G=vec3.create(),O=vec3.create(),M=0;;){for(M++,P=1/0,g=j.length-1;g>=0;)w=j[g],null!==w?(t.GeometryMethods.findClosestPointInTriangle(F,w.a.point,w.b.point,w.c.point,G),B=vec3.squaredLength(G),P>B&&(vec3.set(G,O),P=B,x=g),g--):g--;if(1e-4>S-P&&C===j[x]||20===M){var q=t.ObjectPool.getObject("ContactDetails");q.object_a=a,q.object_b=n,vec3.set(j[x].normal,q.contact_normal);var E=vec3.create();if(t.GeometryMethods.findBarycentricCoordinates(O,j[x].a.point,j[x].b.point,j[x].c.point,E),isNaN(E[0]))return!1;var k={a:vec3.create(),b:vec3.create(),c:vec3.create()};return vec3.scale(j[x].a.witness_a,E[0],k.a),vec3.scale(j[x].b.witness_a,E[1],k.b),vec3.scale(j[x].c.witness_a,E[2],k.c),vec3.add(k.a,k.b,q.contact_point_in_a),vec3.add(q.contact_point_in_a,k.c),vec3.scale(j[x].a.witness_b,E[0],k.a),vec3.scale(j[x].b.witness_b,E[1],k.b),vec3.scale(j[x].c.witness_b,E[2],k.c),vec3.add(k.a,k.b,q.contact_point_in_b),vec3.add(q.contact_point_in_b,k.c),vec3.add(q.contact_point_in_a,q.contact_point_in_b,q.contact_point),vec3.scale(q.contact_point,.5),mat4.multiplyVec3(q.object_a.transform_inverse,q.contact_point_in_a),mat4.multiplyVec3(q.object_b.transform_inverse,q.contact_point_in_b),q.penetration_depth=Math.sqrt(P),q.restitution=(a.restitution+n.restitution)/2,q.friction=(q.object_a.friction+q.object_b.friction)/2,q}r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(a,n,j[x].normal,r);var A=r,I=[];for(g=0;j.length>g;g++)null!==j[g]&&j[g].classifyVertex(A.point)>=t.EPSILON&&I.push(j[g]);var T=[];for(g=0;I.length>g;g++)for(y=0;I.length>y;y++)y>=g||Array.prototype.push.apply(T,c(I[g],I[y]));for(g=0;I.length>g;g++){w=I[g];var L=[];if((-1===T.indexOf(w.a)||-1===T.indexOf(w.b))&&L.push(new t.GjkEpa.GjkFace(w.a,w.b,A,vec3.create(),-1)),(-1===T.indexOf(w.b)||-1===T.indexOf(w.c))&&L.push(new t.GjkEpa.GjkFace(w.c,A,w.b,vec3.create(),-1)),(-1===T.indexOf(w.a)||-1===T.indexOf(w.c))&&L.push(new t.GjkEpa.GjkFace(w.c,w.a,A,vec3.create(),-1)),0!==L.length)for(j[w.index]=null,Array.prototype.push.apply(j,L),y=j.length-L.length;j.length>y;y++)vec3.subtract(j[y].b.point,j[y].a.point,h),vec3.subtract(j[y].c.point,j[y].a.point,p),vec3.cross(h,p,j[y].normal),vec3.normalize(j[y].normal),j[y].index=y}S=P,C=j[x]}}},t.GjkEpa.GjkFace=function(t,e,i,o,a){this.a=t,this.b=e,this.c=i,this.normal=o,this.index=a},t.GjkEpa.GjkFace.prototype.classifyVertex=function(t){var e=vec3.dot(this.normal,this.a.point),i=vec3.dot(this.normal,t)-e;return i},t.GjkEpa2={max_iterations:20,epa_condition:.001,SupportPoint:function(t,e,i){this.witness_a=t,this.witness_b=e,this.point=i},findSupportPoint:function(){var t=vec3.create();return function(e,i,o,a){e.findSupportPoint(o,a.witness_a),vec3.negate(o,t),i.findSupportPoint(t,a.witness_b),vec3.subtract(a.witness_a,a.witness_b,a.point)}}(),GJK:function(){return function(e,i){for(var o,a=new t.GjkEpa2.Simplex(e,i);o=a.addPoint(););return o===!1?null:a}}(),EPA:function(){return function(i){for(var o,a=new t.GjkEpa2.Polyhedron(i),n=0;++n;){a.findFaceClosestToOrigin(),a.closest_face_distance<t.EPSILON?vec3.set(a.faces[a.closest_face].normal,e):vec3.set(a.closest_point,e);var s=t.ObjectPool.getObject("GJK2SupportPoint");t.GjkEpa2.findSupportPoint(i.object_a,i.object_b,e,s),vec3.subtract(s.point,a.closest_point,e);var c=vec3.squaredLength(e);if(n===t.GjkEpa2.max_iterations||t.GjkEpa2.epa_condition>c&&a.closest_face_distance>t.EPSILON){var r=t.ObjectPool.getObject("ContactDetails");r.object_a=i.object_a,r.object_b=i.object_b,vec3.normalize(a.closest_point,r.contact_normal),0===vec3.squaredLength(r.contact_normal)&&vec3.subtract(r.object_b.position,r.object_a.position,r.contact_normal),vec3.normalize(r.contact_normal);var h=vec3.create();if(t.GeometryMethods.findBarycentricCoordinates(a.closest_point,a.faces[a.closest_face].a.point,a.faces[a.closest_face].b.point,a.faces[a.closest_face].c.point,h),isNaN(h[0]))return null;var p={a:vec3.create(),b:vec3.create(),c:vec3.create()};return vec3.scale(a.faces[a.closest_face].a.witness_a,h[0],p.a),vec3.scale(a.faces[a.closest_face].b.witness_a,h[1],p.b),vec3.scale(a.faces[a.closest_face].c.witness_a,h[2],p.c),vec3.add(p.a,p.b,r.contact_point_in_a),vec3.add(r.contact_point_in_a,p.c),vec3.scale(a.faces[a.closest_face].a.witness_b,h[0],p.a),vec3.scale(a.faces[a.closest_face].b.witness_b,h[1],p.b),vec3.scale(a.faces[a.closest_face].c.witness_b,h[2],p.c),vec3.add(p.a,p.b,r.contact_point_in_b),vec3.add(r.contact_point_in_b,p.c),vec3.add(r.contact_point_in_a,r.contact_point_in_b,r.contact_point),vec3.scale(r.contact_point,.5),mat4.multiplyVec3(r.object_a.transform_inverse,r.contact_point_in_a),mat4.multiplyVec3(r.object_b.transform_inverse,r.contact_point_in_b),r.penetration_depth=vec3.length(a.closest_point),r.restitution=(i.object_a.restitution+i.object_b.restitution)/2,r.friction=(i.object_a.friction+i.object_b.friction)/2,r}o=a.addVertex(s)}return null}}(),Face:function(t,o,a,n){this.active=!0,this.polyhedron=t,this.a=o,this.b=a,this.c=n,this.normal=vec3.create(),this.neighbors=[],vec3.subtract(a.point,o.point,e),vec3.subtract(n.point,o.point,i),vec3.cross(e,i,this.normal),vec3.normalize(this.normal)}},t.GjkEpa2.Polyhedron=function(e){this.closest_face=null,this.closest_face_distance=null,this.closest_point=vec3.create(),this.faces=[new t.GjkEpa2.Face(this,e.points[0],e.points[2],e.points[3]),new t.GjkEpa2.Face(this,e.points[0],e.points[1],e.points[2]),new t.GjkEpa2.Face(this,e.points[0],e.points[3],e.points[1]),new t.GjkEpa2.Face(this,e.points[3],e.points[2],e.points[1])],this.faces[0].neighbors.push(this.faces[1],this.faces[3],this.faces[2]),this.faces[1].neighbors.push(this.faces[2],this.faces[3],this.faces[0]),this.faces[2].neighbors.push(this.faces[0],this.faces[3],this.faces[1]),this.faces[3].neighbors.push(this.faces[0],this.faces[1],this.faces[2])},t.GjkEpa2.Polyhedron.prototype={addVertex:function(e){var i,o,a,n,s,c=[],r=[];for(this.faces[this.closest_face].silhouette(e,c),i=0;c.length-5>i;i+=5){if(a=c[i+3],n=c[i+4],0!==i&&s!==a)for(o=i+5;c.length>o;o+=5)if(c[o+3]===s){var h=c.slice(i,i+5);c[i]=c[o],c[i+1]=c[o+1],c[i+2]=c[o+2],c[i+3]=c[o+3],c[i+4]=c[o+4],c[o]=h[0],c[o+1]=h[1],c[o+2]=h[2],c[o+3]=h[3],c[o+4]=h[4],a=c[i+3],n=c[i+4];break}s=n}for(i=0;c.length>i;i+=5){var p=c[i];a=c[i+3],n=c[i+4];var l=new t.GjkEpa2.Face(this,n,e,a);l.neighbors[2]=c[i],r.push(l),p.neighbors[p.neighbors.indexOf(c[i+2])]=l}for(i=0;r.length>i;i++)r[i].neighbors[0]=r[i+1===r.length?0:i+1],r[i].neighbors[1]=r[0>i-1?r.length-1:i-1];return Array.prototype.push.apply(this.faces,r),c},findFaceClosestToOrigin:function(){var e=vec3.create(),i=vec3.create();return function(){this.closest_face_distance=1/0;var o,a;for(a=0;this.faces.length>a;a++)this.faces[a].active!==!1&&(t.GeometryMethods.findClosestPointInTriangle(e,this.faces[a].a.point,this.faces[a].b.point,this.faces[a].c.point,i),o=vec3.squaredLength(i),this.closest_face_distance>o&&(this.closest_face_distance=o,this.closest_face=a,vec3.set(i,this.closest_point)))}}()},t.GjkEpa2.Face.prototype={classifyVertex:function(t){var e=vec3.dot(this.normal,this.a.point),i=vec3.dot(this.normal,t.point)-e;return i},silhouette:function(t,e,i){if(this.active!==!1)if(this.classifyVertex(t)>0)this.active=!1,this.neighbors[0].silhouette(t,e,this),this.neighbors[1].silhouette(t,e,this),this.neighbors[2].silhouette(t,e,this);else if(i){var o,a,n=this.neighbors.indexOf(i);0===n?(o=this.a,a=this.b):1===n?(o=this.b,a=this.c):(o=this.c,a=this.a),e.push(this,n,i,a,o)}}},function(){var a=vec3.create(),n=vec3.create(),s=vec3.create(),c=vec3.create();t.GjkEpa2.Simplex=function(t,e){this.object_a=t,this.object_b=e,this.points=[],this.iterations=0,this.next_direction=vec3.create(),this.updateDirection()},t.GjkEpa2.Simplex.prototype={addPoint:function(){if(++this.iterations===t.GjkEpa2.max_iterations)return!1;var e=t.ObjectPool.getObject("GJK2SupportPoint");return t.GjkEpa2.findSupportPoint(this.object_a,this.object_b,this.next_direction,e),this.points.push(e),0>vec3.dot(this.points[this.points.length-1].point,this.next_direction)?!1:this.updateDirection()===!0?null:e},findDirectionFromLine:function(){vec3.negate(this.points[1].point,a),vec3.subtract(this.points[0].point,this.points[1].point,n),0>vec3.dot(n,a)?(vec3.set(a,this.next_direction),this.points.length=1):(vec3.cross(n,a,this.next_direction),vec3.cross(this.next_direction,n),0===this.next_direction[0]&&0===this.next_direction[1]&&0===this.next_direction[2]&&(vec3.normalize(n),this.next_direction[0]=1-Math.abs(n[0]),this.next_direction[1]=1-Math.abs(n[1]),this.next_direction[2]=1-Math.abs(n[2])))},findDirectionFromTriangle:function(){var t=this.points[2],c=this.points[1],r=this.points[0];vec3.negate(t.point,a),vec3.subtract(c.point,t.point,n),vec3.subtract(r.point,t.point,s),vec3.cross(n,s,e),vec3.cross(n,e,i),vec3.cross(e,s,o),vec3.dot(o,a)>=0?vec3.dot(s,a)>=0?(this.points.length=0,this.points.push(r,t),vec3.cross(s,a,this.next_direction),vec3.cross(this.next_direction,s)):vec3.dot(n,a)>=0?(this.points.length=0,this.points.push(c,t),vec3.cross(n,a,this.next_direction),vec3.cross(this.next_direction,n)):(this.points.length=0,this.points.push(t)):vec3.dot(i,a)>=0?vec3.dot(n,a)>=0?(this.points.length=0,this.points.push(c,t),vec3.cross(n,a,this.next_direction),vec3.cross(this.next_direction,n)):(this.points.length=0,this.points.push(t)):vec3.dot(e,a)>=0?vec3.set(e,this.next_direction):(vec3.set(e,this.next_direction),vec3.negate(this.next_direction),this.points.length=0,this.points.push(t,c,r))},getFaceNormal:function(t,e,i,o){vec3.subtract(i.point,t.point,s),vec3.subtract(e.point,t.point,n),vec3.cross(s,n,o),vec3.normalize(o)},faceNormalDotOrigin:function(t,o,a){return this.getFaceNormal(t,o,a,e),vec3.add(t.point,o.point,i),vec3.add(i,a.point),vec3.negate(i),vec3.normalize(i),vec3.dot(e,i)},findDirectionFromTetrahedron:function(){var o=this.points[3],a=this.points[2],s=this.points[1],r=this.points[0];if(this.containsOrigin())return!0;var h=vec3.create(),p=1/0,l=0;t.GeometryMethods.findClosestPointInTriangle(h,r.point,s.point,o.point,i),vec3.subtract(r.point,o.point,n),vec3.subtract(s.point,o.point,c),vec3.cross(n,c,e),l=vec3.length(i),p>l&&(p=l,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(o,s,r)),t.GeometryMethods.findClosestPointInTriangle(h,s.point,a.point,o.point,i),vec3.subtract(s.point,o.point,n),vec3.subtract(a.point,o.point,c),vec3.cross(n,c,e),l=vec3.length(i),p>l&&(p=l,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(o,a,s)),t.GeometryMethods.findClosestPointInTriangle(h,a.point,r.point,o.point,i),vec3.subtract(a.point,o.point,n),vec3.subtract(r.point,o.point,c),vec3.cross(n,c,e),l=vec3.length(i),p>l&&(p=l,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(a,r,o)),t.GeometryMethods.findClosestPointInTriangle(h,r.point,a.point,s.point,i),vec3.subtract(r.point,s.point,n),vec3.subtract(a.point,s.point,c),vec3.cross(n,c,e),l=vec3.length(i),p>l&&(p=l,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(s,a,r))},containsOrigin:function(){var t=this.points[3],i=this.points[2],o=this.points[1],a=this.points[0];return vec3.subtract(a.point,t.point,n),vec3.subtract(o.point,t.point,c),vec3.cross(n,c,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(o.point,t.point,n),vec3.subtract(i.point,t.point,c),vec3.cross(n,c,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(i.point,t.point,n),vec3.subtract(a.point,t.point,c),vec3.cross(n,c,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(i.point,a.point,n),vec3.subtract(o.point,a.point,c),vec3.cross(n,c,e),vec3.dot(e,a.point)>0?!1:!0)))},updateDirection:function(){if(0===this.points.length)vec3.subtract(this.object_b.position,this.object_a.position,this.next_direction);else if(1===this.points.length)vec3.negate(this.next_direction);else if(2===this.points.length)this.findDirectionFromLine();else{if(3!==this.points.length)return this.findDirectionFromTetrahedron();this.findDirectionFromTriangle()}}}}(),t.SphereSphere=function(i,o){var a=i.position,n=o.position;vec3.subtract(n,a,e);var s=vec3.length(e);if(!(s>i.shape.radius+o.shape.radius)){var c=t.ObjectPool.getObject("ContactDetails");return c.object_a=i,c.object_b=o,vec3.scale(e,1/s,c.contact_normal),vec3.scale(e,-.5),vec3.add(e,a,c.contact_point),c.penetration_depth=i.shape.radius+o.shape.radius-s,vec3.scale(c.contact_normal,c.object_a.shape.radius,c.contact_point_in_a),vec3.add(c.contact_point_in_a,c.object_a.position),vec3.scale(c.contact_normal,-c.object_b.shape.radius,c.contact_point_in_b),vec3.add(c.contact_point_in_b,c.object_b.position),vec3.add(c.contact_point_in_a,c.contact_point_in_b,c.contact_point),vec3.scale(c.contact_point,.5),mat4.multiplyVec3(c.object_a.transform_inverse,c.contact_point_in_a),mat4.multiplyVec3(c.object_b.transform_inverse,c.contact_point_in_b),c.restitution=(i.restitution+o.restitution)/2,c.friction=(i.friction+o.friction)/2,c}},t.Constraint=function(){this.object_a=null,this.object_b=null,this.rows=[]},t.ConstraintRow=function(){this.jacobian=new Float64Array(12),this.B=new Float64Array(12),this.D=0,this.lower_limit=-1/0,this.upper_limit=1/0,this.bias=0,this.multiplier=0,this.multiplier_cache=0,this.eta=0,this.eta_row=new Float64Array(12),this.applied_push_impulse=0},t.ConstraintRow.prototype.computeB=function(t){var i=0;null!=t.object_a&&1/0!==t.object_a.mass?(i=1/t.object_a.mass,this.B[0]=i*this.jacobian[0],this.B[1]=i*this.jacobian[1],this.B[2]=i*this.jacobian[2],e[0]=this.jacobian[3],e[1]=this.jacobian[4],e[2]=this.jacobian[5],mat3.multiplyVec3(t.object_a.inverseInertiaTensorWorldFrame,e),this.B[3]=e[0],this.B[4]=e[1],this.B[5]=e[2]):(this.B[0]=this.B[1]=this.B[2]=0,this.B[3]=this.B[4]=this.B[5]=0),null!=t.object_b&&1/0!==t.object_b.mass?(i=1/t.object_b.mass,this.B[6]=i*this.jacobian[6],this.B[7]=i*this.jacobian[7],this.B[8]=i*this.jacobian[8],e[0]=this.jacobian[9],e[1]=this.jacobian[10],e[2]=this.jacobian[11],mat3.multiplyVec3(t.object_b.inverseInertiaTensorWorldFrame,e),this.B[9]=e[0],this.B[10]=e[1],this.B[11]=e[2]):(this.B[6]=this.B[7]=this.B[8]=0,this.B[9]=this.B[10]=this.B[11]=0)},t.ConstraintRow.prototype.computeD=function(t){this.D=0,null!=t.object_a&&(this.D+=this.jacobian[0]*this.jacobian[0]+this.jacobian[1]*this.B[1]+this.jacobian[2]*this.B[2]+this.jacobian[3]*this.B[3]+this.jacobian[4]*this.B[4]+this.jacobian[5]*this.B[5]),null!=t.object_b&&(this.D+=this.jacobian[6]*this.jacobian[6]+this.jacobian[7]*this.B[7]+this.jacobian[8]*this.B[8]+this.jacobian[9]*this.B[9]+this.jacobian[10]*this.B[10]+this.jacobian[11]*this.B[11])},t.ConstraintRow.prototype.computeEta=function(t){var i;null!=t.object_a?(i=1/t.object_a.mass,this.eta_row[0]=t.object_a.linear_velocity[0]+i*t.object_a.accumulated_force[0],this.eta_row[1]=t.object_a.linear_velocity[1]+i*t.object_a.accumulated_force[1],this.eta_row[2]=t.object_a.linear_velocity[2]+i*t.object_a.accumulated_force[2],vec3.set(t.object_a.accumulated_torque,e),mat3.multiplyVec3(t.object_a.inverseInertiaTensorWorldFrame,e),this.eta_row[3]=t.object_a.angular_velocity[0]+e[0],this.eta_row[4]=t.object_a.angular_velocity[1]+e[1],this.eta_row[5]=t.object_a.angular_velocity[2]+e[2]):this.eta_row[0]=this.eta_row[1]=this.eta_row[2]=this.eta_row[3]=this.eta_row[4]=this.eta_row[5]=0,null!=t.object_b?(i=1/t.object_b.mass,this.eta_row[6]=t.object_b.linear_velocity[0]+i*t.object_b.accumulated_force[0],this.eta_row[7]=t.object_b.linear_velocity[1]+i*t.object_b.accumulated_force[1],this.eta_row[8]=t.object_b.linear_velocity[2]+i*t.object_b.accumulated_force[2],vec3.set(t.object_b.accumulated_torque,e),mat3.multiplyVec3(t.object_b.inverseInertiaTensorWorldFrame,e),this.eta_row[9]=t.object_b.angular_velocity[0]+e[0],this.eta_row[10]=t.object_b.angular_velocity[1]+e[1],this.eta_row[11]=t.object_b.angular_velocity[2]+e[2]):this.eta_row[6]=this.eta_row[7]=this.eta_row[8]=this.eta_row[9]=this.eta_row[10]=this.eta_row[11]=0;var o=this.jacobian[0]*this.eta_row[0]+this.jacobian[1]*this.eta_row[1]+this.jacobian[2]*this.eta_row[2]+this.jacobian[3]*this.eta_row[3]+this.jacobian[4]*this.eta_row[4]+this.jacobian[5]*this.eta_row[5]+this.jacobian[6]*this.eta_row[6]+this.jacobian[7]*this.eta_row[7]+this.jacobian[8]*this.eta_row[8]+this.jacobian[9]*this.eta_row[9]+this.jacobian[10]*this.eta_row[10]+this.jacobian[11]*this.eta_row[11];this.eta=this.bias-o},t.ContactConstraint=function(){t.Constraint.call(this)},t.ContactConstraint.prototype.buildFromContact=function(i){var o=this.rows[0]||t.ObjectPool.getObject("ConstraintRow");this.object_a=i.object_a,this.object_b=i.object_b,this.contact=i,o.lower_limit=0,o.upper_limit=1/0,null==this.object_a||1/0===this.object_a.mass?(o.jacobian[0]=o.jacobian[1]=o.jacobian[2]=0,o.jacobian[3]=o.jacobian[4]=o.jacobian[5]=0):(o.jacobian[0]=-i.contact_normal[0],o.jacobian[1]=-i.contact_normal[1],o.jacobian[2]=-i.contact_normal[2],vec3.subtract(i.contact_point,i.object_a.position,e),vec3.cross(e,i.contact_normal,e),o.jacobian[3]=-e[0],o.jacobian[4]=-e[1],o.jacobian[5]=-e[2]),null==this.object_b||1/0===this.object_b.mass?(o.jacobian[6]=o.jacobian[7]=o.jacobian[8]=0,o.jacobian[9]=o.jacobian[10]=o.jacobian[11]=0):(o.jacobian[6]=i.contact_normal[0],o.jacobian[7]=i.contact_normal[1],o.jacobian[8]=i.contact_normal[2],vec3.subtract(i.contact_point,i.object_b.position,e),vec3.cross(e,i.contact_normal,e),o.jacobian[9]=e[0],o.jacobian[10]=e[1],o.jacobian[11]=e[2]),o.bias=i.penetration_depth;var a=vec3.dot(this.object_a.linear_velocity,i.contact_normal);a-=vec3.dot(this.object_b.linear_velocity,i.contact_normal),o.bias+=a*i.restitution,this.rows[0]=o},t.FrictionConstraint=function(){t.Constraint.call(this)},t.FrictionConstraint.prototype.buildFromContact=function(e){var i=this.rows[0]||t.ObjectPool.getObject("ConstraintRow");this.object_a=e.object_a,this.object_b=e.object_b;var o=vec3.create(),a=vec3.create();vec3.subtract(e.contact_point,e.object_a.position,o),vec3.subtract(e.contact_point,e.object_b.position,a);var n=vec3.create(),s=vec3.create();vec3.cross(e.object_a.angular_velocity,o,n),vec3.add(n,e.object_a.linear_velocity),vec3.cross(e.object_b.angular_velocity,a,s),vec3.add(s,e.object_b.linear_velocity);var c=vec3.create();vec3.subtract(n,s,c);var r=vec3.dot(e.contact_normal,c);c[0]-=r*e.contact_normal[0],c[1]-=r*e.contact_normal[1],c[2]-=r*e.contact_normal[2];var h=vec3.squaredLength(c);if(!(h>=t.EPSILON))return this.rows.length=0,void 0;h=Math.sqrt(h),i.jacobian[0]=c[0]/h,i.jacobian[1]=c[1]/h,i.jacobian[2]=c[2]/h,i.jacobian[6]=c[0]/-h,i.jacobian[7]=c[1]/-h,i.jacobian[8]=c[2]/-h,i.jacobian[3]=o[1]*i.jacobian[2]-o[2]*i.jacobian[1],i.jacobian[4]=o[2]*i.jacobian[0]-o[0]*i.jacobian[2],i.jacobian[5]=o[0]*i.jacobian[1]-o[1]*i.jacobian[0],i.jacobian[9]=i.jacobian[1]*a[2]-i.jacobian[2]*a[1],i.jacobian[10]=i.jacobian[2]*a[0]-i.jacobian[0]*a[2],i.jacobian[11]=i.jacobian[0]*a[1]-i.jacobian[1]*a[0];var p=.1*e.friction;i.lower_limit=-p,i.upper_limit=p,i.bias=0,this.rows.push(i)},t.ContactDetails=function(){this.object_a=null,this.object_b=null,this.contact_point=vec3.create(),this.contact_point_in_a=vec3.create(),this.contact_point_in_b=vec3.create(),this.contact_normal=vec3.create(),this.penetration_depth=0,this.restitution=0,this.friction=0},t.ContactManifold=function(){this.object_a=null,this.object_b=null,this.points=[],this.next_manifold=null},t.ContactManifold.prototype.findWeakestContact=function(t){var o,a,n=-1,s=t.penetration_depth;for(o=0;4>o;o++)a=this.points[o],a.penetration_depth>s&&(s=a.penetration_depth,n=o);var c=0,r=0,h=0,p=0;0!==n&&(vec3.subtract(t.contact_point_in_a,this.points[1].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a,i),vec3.cross(e,i),c=vec3.squaredLength(e)),1!==n&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a,i),vec3.cross(e,i),r=vec3.squaredLength(e)),2!==n&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[1].contact_point_in_a,i),vec3.cross(e,i),h=vec3.squaredLength(e)),3!==n&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[2].contact_point_in_a,this.points[1].contact_point_in_a,i),vec3.cross(e,i),p=vec3.squaredLength(e));var l=0,_=c;return r>_&&(l=1,_=r),h>_&&(l=2,_=h),p>_&&(l=3),l},t.ContactManifold.prototype.addContact=function(e){var i;for(i=0;this.points.length>i;i++)if(.02>=vec3.dist(this.points[i].contact_point,e.contact_point))return t.ObjectPool.freeObject("ContactDetails",e),void 0;this.points.push(e)},t.ContactManifold.prototype.update=function(){var i,o,a,n=vec3.create(),s=vec3.create(),c=vec3.create();for(i=0;this.points.length>i;i++)if(a=this.points[i],mat4.multiplyVec3(a.object_a.transform,a.contact_point_in_a,n),mat4.multiplyVec3(a.object_b.transform,a.contact_point_in_b,s),vec3.add(n,s,a.contact_point),vec3.scale(a.contact_point,.5),vec3.subtract(n,s,c),a.penetration_depth=vec3.dot(c,a.contact_normal),-.02>a.penetration_depth){for(t.ObjectPool.freeObject("ContactDetails",a),o=i;this.points.length>o;o++)this.points[o]=this.points[o+1];this.points.length=this.points.length-1}else{vec3.scale(a.contact_normal,a.penetration_depth,e),vec3.subtract(n,e,e),vec3.subtract(s,e,e);var r=vec3.squaredLength(e);if(r>.2*.2){for(t.ObjectPool.freeObject("ContactDetails",a),o=i;this.points.length>o;o++)this.points[o]=this.points[o+1];this.points.length=this.points.length-1}}},t.ContactManifoldList=function(){this.first=null},t.ContactManifoldList.prototype.insert=function(t){t.next_manifold=this.first,this.first=t},t.ContactManifoldList.prototype.getManifoldForObjects=function(e,i){var o=null;if(null!==this.first)for(var a=this.first;null!==a;){if(a.object_a===e&&a.object_b===i||a.object_a===i&&a.object_b===e){o=a;break}a=a.next_manifold}return null===o&&(o=t.ObjectPool.getObject("ContactManifold"),o.object_a=e,o.object_b=i,this.insert(o)),o},t.ForceGenerator=function(t){this.force=t||vec3.create(),this.enabled=!0,this.affected=[]},t.ForceGenerator.prototype.applyForce=function(){if(this.enabled){var t,e;for(t=0,e=this.affected.length;e>t;t++)this.affected[t].applyForce(this.force)}},t.ForceGenerator.prototype.enable=function(){this.enabled=!0},t.ForceGenerator.prototype.disable=function(){this.enabled=!1},t.ForceGenerator.prototype.affect=function(t){var e,i;for(e=0,i=this.affected.length;i>e;e++)if(this.affected[e]===t)return;this.affected.push(t)},t.ForceGenerator.prototype.unaffect=function(t){var e,i;for(e=0,i=this.affected.length;i>e;e++)if(this.affected[e]===t)return this.affected.splice(e,1),void 0},t.DragForce=function(t,e){this.drag_coefficient=t||0,this.squared_drag_coefficient=e||0,this.enabled=!0,this.affected=[]
},t.DragForce.prototype.enable=t.ForceGenerator.prototype.enable,t.DragForce.prototype.disable=t.ForceGenerator.prototype.disable,t.DragForce.prototype.affect=t.ForceGenerator.prototype.affect,t.DragForce.prototype.unaffect=t.ForceGenerator.prototype.unaffect,t.DragForce.prototype.applyForce=function(){if(this.enabled){var t,i,o,a,n=e;for(t=0,i=this.affected.length;i>t;t++)o=this.affected[t],vec3.set(o.linear_velocity,n),a=vec3.length(n),a=this.drag_coefficient*a+this.squared_drag_coefficient*a*a,vec3.normalize(n),vec3.scale(n,-a),o.applyForce(n)}},t.GeometryMethods={findClosestPointInTriangle:function(){var t=vec3.create(),e=vec3.create(),i=vec3.create();return function(o,a,n,s,c){var r;vec3.subtract(n,a,t),vec3.subtract(s,a,e),vec3.subtract(o,a,i);var h=vec3.dot(t,i),p=vec3.dot(e,i);if(0>=h&&0>=p)return vec3.set(a,c),void 0;vec3.subtract(o,n,i);var l=vec3.dot(t,i),_=vec3.dot(e,i);if(l>=0&&l>=_)return vec3.set(n,c),void 0;var v=h*_-l*p;if(0>=v&&h>=0&&0>=l)return r=h/(h-l),vec3.scale(t,r,c),vec3.add(c,a),void 0;vec3.subtract(o,s,i);var u=vec3.dot(t,i),b=vec3.dot(e,i);if(b>=0&&b>=u)return vec3.set(s,c),void 0;var f,d=u*p-h*b;if(0>=d&&p>=0&&0>=b)return f=p/(p-b),vec3.scale(e,f,c),vec3.add(c,a),void 0;var m=l*b-u*_;if(0>=m&&_-l>=0&&u-b>=0)return f=(_-l)/(_-l+(u-b)),vec3.subtract(s,n,c),vec3.scale(c,f),vec3.add(c,n),void 0;var j=1/(m+d+v);r=d*j,f=v*j,vec3.scale(t,r),vec3.add(t,a),vec3.scale(e,f),vec3.add(t,e,c)}}(),findBarycentricCoordinates:function(t,e,i,o,a){var n=vec3.create(),s=vec3.create(),c=vec3.create();vec3.subtract(i,e,n),vec3.subtract(o,e,s),vec3.subtract(t,e,c);var r=vec3.dot(n,n),h=vec3.dot(n,s),p=vec3.dot(s,s),l=vec3.dot(c,n),_=vec3.dot(c,s),v=r*p-h*h;a[1]=(p*l-h*_)/v,a[2]=(r*_-h*l)/v,a[0]=1-a[1]-a[2]}},t.NearPhase=function(){this.contact_manifolds=new t.ContactManifoldList},t.NearPhase.prototype.updateContactManifolds=function(){for(var e=this.contact_manifolds.first,i=null;null!==e;)e.update(),0===e.points.length?(t.ObjectPool.freeObject("ContactManifold",e),null==i?this.contact_manifolds.first=e.next_manifold:i.next_manifold=e.next_manifold,e=e.next_manifold):(i=e,e=e.next_manifold)},t.NearPhase.prototype.generateContacts=function(e){var i,o,a,n,s=e.length;for(this.updateContactManifolds(),i=0;s>i;i++)o=e[i][0],a=e[i][1],o.shape instanceof t.SphereShape&&a.shape instanceof t.SphereShape?(n=t.SphereSphere(o,a),null!=n&&this.contact_manifolds.getManifoldForObjects(o,a).addContact(n)):o.shape instanceof t.SphereShape&&a.shape instanceof t.BoxShape||o.shape instanceof t.BoxShape&&a.shape instanceof t.SphereShape?(n=t.BoxSphere(o,a),null!=n&&this.contact_manifolds.getManifoldForObjects(o,a).addContact(n)):null!=(n=t.GjkEpa2.GJK(o,a))&&(n=t.GjkEpa2.EPA(n),null!=n&&this.contact_manifolds.getManifoldForObjects(o,a).addContact(n))},t.ObjectPool={types:{},pools:{},registerType:function(t,e){this.types[t]=e,this.pools[t]=[]},getObject:function(t){var e=this.pools[t];return 0!==e.length?e.pop():this.types[t]()},freeObject:function(t,e){this.pools[t].push(e)}},t.ObjectPool.registerType("ContactDetails",function(){return new t.ContactDetails}),t.ObjectPool.registerType("ContactManifold",function(){return new t.ContactManifold}),t.ObjectPool.registerType("GJKSupportPoint",function(){return new t.GjkEpa.SupportPoint(vec3.create(),vec3.create(),vec3.create(),vec3.create())}),t.ObjectPool.registerType("GJK2SupportPoint",function(){return new t.GjkEpa2.SupportPoint(vec3.create(),vec3.create(),vec3.create(),vec3.create())}),t.ObjectPool.registerType("ConstraintRow",function(){return new t.ConstraintRow}),t.ObjectPool.registerType("ContactConstraint",function(){return new t.ContactConstraint}),t.ObjectPool.registerType("FrictionConstraint",function(){return new t.FrictionConstraint}),t.RigidBody=function(){var e=0;return function(i,o){this.id=e++,this.shape=i,this.aabb=new t.AABB,this.mass=o||1/0,this.position=vec3.create(),this.rotation=quat4.createFrom(0,0,0,1),this.linear_velocity=vec3.create(),this.angular_velocity=vec3.create(),this.transform=mat4.identity(),this.transform_inverse=mat4.identity(),this.inertiaTensor=i.getInertiaTensor(o),this.inverseInertiaTensor=mat3.inverse(this.inertiaTensor),this.inertiaTensorWorldFrame=mat3.create(),this.inverseInertiaTensorWorldFrame=mat3.create(),this.acceleration=vec3.create(),this.linear_damping=vec3.createFrom(0,0,0),this.angular_damping=vec3.createFrom(0,0,0),this.restitution=.05,this.friction=.5,this.gravity=null,this.world=null,this.accumulated_force=vec3.create(),this.accumulated_torque=vec3.create(),this.push_velocity=vec3.create(),this.turn_velocity=vec3.create(),this.solver_impulse=new Float64Array(6),this.updateDerived()}}(),t.RigidBody.prototype.findSupportPoint=function(){var t=vec3.create();return function(e,i){var o=this.transform_inverse[12],a=this.transform_inverse[13],n=this.transform_inverse[14];this.transform_inverse[12]=this.transform_inverse[13]=this.transform_inverse[14]=0,mat4.multiplyVec3(this.transform_inverse,e,t),this.transform_inverse[12]=o,this.transform_inverse[13]=a,this.transform_inverse[14]=n,this.shape.findSupportPoint(t,i),mat4.multiplyVec3(this.transform,i)}}(),t.RigidBody.prototype.integrate=function(t){if(1/0!==this.mass){var i=1/this.mass;vec3.scale(this.accumulated_force,i,e),vec3.add(this.linear_velocity,e),mat3.multiplyVec3(this.inverseInertiaTensorWorldFrame,this.accumulated_torque,e),vec3.scale(e,t),vec3.add(this.angular_velocity,e),this.linear_velocity[0]*=1/(1+t*this.linear_damping[0]),this.linear_velocity[1]*=1/(1+t*this.linear_damping[1]),this.linear_velocity[2]*=1/(1+t*this.linear_damping[2]),this.angular_velocity[0]*=1/(1+t*this.angular_damping[0]),this.angular_velocity[1]*=1/(1+t*this.angular_damping[1]),this.angular_velocity[2]*=1/(1+t*this.angular_damping[2]),vec3.scale(this.linear_velocity,t,e),vec3.add(this.position,e),a[0]=this.angular_velocity[0],a[1]=this.angular_velocity[1],a[2]=this.angular_velocity[2],a[3]=0,quat4.multiply(a,this.rotation);var o=.5*t;this.rotation[0]+=o*a[0],this.rotation[1]+=o*a[1],this.rotation[2]+=o*a[2],this.rotation[3]+=o*a[3],quat4.normalize(this.rotation),this.accumulated_force[0]=this.accumulated_force[1]=this.accumulated_force[2]=0,this.accumulated_torque[0]=this.accumulated_torque[1]=this.accumulated_torque[2]=0,this.solver_impulse[0]=this.solver_impulse[1]=this.solver_impulse[2]=this.solver_impulse[3]=this.solver_impulse[4]=this.solver_impulse[5]=0,this.push_velocity[0]=this.push_velocity[1]=this.push_velocity[2]=0,this.turn_velocity[0]=this.turn_velocity[1]=this.turn_velocity[2]=0}},t.RigidBody.prototype.setGravity=function(t,e,i){this.gravity?(this.gravity[0]=t,this.gravity[1]=e,this.gravity[2]=i):this.gravity=vec3.createFrom(t,e,i)},t.RigidBody.prototype.applyForce=function(t){vec3.add(this.accumulated_force,t)},t.RigidBody.prototype.applyForceAtWorldPoint=function(t,i){var o=e;vec3.set(i,o),vec3.subtract(o,this.position),vec3.cross(o,t),vec3.add(this.accumulated_force,t),vec3.add(this.accumulated_torque,o)},t.RigidBody.prototype.applyForceAtLocalPoint=function(t,i){var o=e;mat4.multiplyVec3(this.transform,i,o),this.applyForceAtWorldPoint(t,o)},t.RigidBody.prototype.updateDerived=function(){quat4.normalize(this.rotation),mat4.fromRotationTranslation(this.rotation,this.position,this.transform),mat4.inverse(this.transform,this.transform_inverse),1/0!==this.mass&&this.updateInverseInertiaTensorWorldFrame(),this.aabb.transform(this.shape.aabb,this.transform)},t.RigidBody.prototype.updateInverseInertiaTensorWorldFrame=function(){var t=this.transform,e=this.inverseInertiaTensorWorldFrame,i=this.inverseInertiaTensor;this.rotation;var o=t[0]*i[0]+t[1]*i[3]+t[2]*i[6],a=t[0]*i[1]+t[1]*i[4]+t[2]*i[7],n=t[0]*i[2]+t[1]*i[5]+t[2]*i[8],s=t[4]*i[0]+t[5]*i[3]+t[6]*i[6],c=t[4]*i[1]+t[5]*i[4]+t[6]*i[7],r=t[4]*i[2]+t[5]*i[5]+t[6]*i[8],h=t[8]*i[0]+t[9]*i[3]+t[10]*i[6],p=t[8]*i[1]+t[9]*i[4]+t[10]*i[7],l=t[8]*i[2]+t[9]*i[5]+t[10]*i[8];e[0]=o*t[0]+a*t[1]+n*t[2],e[1]=o*t[4]+a*t[5]+n*t[6],e[2]=o*t[8]+a*t[9]+n*t[10],e[3]=s*t[0]+c*t[1]+r*t[2],e[4]=s*t[4]+c*t[5]+r*t[6],e[5]=s*t[8]+c*t[9]+r*t[10],e[6]=h*t[0]+p*t[1]+l*t[2],e[7]=h*t[4]+p*t[5]+l*t[6],e[8]=h*t[8]+p*t[9]+l*t[10],mat3.inverse(this.inverseInertiaTensorWorldFrame,this.inertiaTensorWorldFrame)},t.SequentialImpulseSolver=function(){this.contact_constraints=[],this.friction_constraints=[],this.constraints=[],this.max_iterations=10,this.relaxation=1},t.SequentialImpulseSolver.prototype.processContactManifolds=function(e){var i,o,a,n,s,c;for(this.contact_constraints.length=0,this.friction_constraints.length=0,a=e.first,i=0;a;){for(i++,n=a.points.length,o=0;n>o;o++)s=a.points[o],c=t.ObjectPool.getObject("ContactConstraint"),c.buildFromContact(s),this.contact_constraints.push(c),c=t.ObjectPool.getObject("FrictionConstraint"),c.buildFromContact(s),this.friction_constraints.push(c);a=a.next_manifold}this.constraints=[],Array.prototype.push.apply(this.constraints,this.contact_constraints),Array.prototype.push.apply(this.constraints,this.friction_constraints)},t.SequentialImpulseSolver.prototype.prepareConstraints=function(){var t,e,i,o,a,n=this.constraints.length;for(o=0;n>o;o++)for(e=this.constraints[o],t=e.rows.length,a=0;t>a;a++)i=e.rows[a],i.multiplier=0,i.computeB(e),i.computeD(e),i.computeEta(e)},t.SequentialImpulseSolver.prototype.resolveContacts=function(i){var o,n,s,c,r,h=0;for(o=0;this.max_iterations>o;o++){for(h=0,c=0;this.contact_constraints.length>c;c++){n=this.contact_constraints[c],s=n.rows[0];var p=s.jacobian[0]*n.object_a.push_velocity[0]+s.jacobian[1]*n.object_a.push_velocity[1]+s.jacobian[2]*n.object_a.push_velocity[2]+s.jacobian[4]*n.object_a.turn_velocity[1]+s.jacobian[3]*n.object_a.turn_velocity[0]+s.jacobian[5]*n.object_a.turn_velocity[2],l=s.jacobian[6]*n.object_b.push_velocity[0]+s.jacobian[7]*n.object_b.push_velocity[1]+s.jacobian[8]*n.object_b.push_velocity[2]+s.jacobian[9]*n.object_b.turn_velocity[0]+s.jacobian[10]*n.object_b.turn_velocity[1]+s.jacobian[11]*n.object_b.turn_velocity[2];r=(n.contact.penetration_depth-(p+l))/s.D;var _=s.applied_push_impulse;s.applied_push_impulse=Math.max(s.lower_limit,Math.min(_+r,s.upper_limit)),r=s.applied_push_impulse-_,h=Math.max(h,r),n.object_a.push_velocity[0]+=s.B[0]*r,n.object_a.push_velocity[1]+=s.B[1]*r,n.object_a.push_velocity[2]+=s.B[2]*r,n.object_a.turn_velocity[0]+=s.B[3]*r,n.object_a.turn_velocity[1]+=s.B[4]*r,n.object_a.turn_velocity[2]+=s.B[5]*r,n.object_b.push_velocity[0]+=s.B[6]*r,n.object_b.push_velocity[1]+=s.B[7]*r,n.object_b.push_velocity[2]+=s.B[8]*r,n.object_b.turn_velocity[0]+=s.B[9]*r,n.object_b.turn_velocity[1]+=s.B[10]*r,n.object_b.turn_velocity[2]+=s.B[11]*r}if(h>=-t.EPSILON&&t.EPSILON>=h)break}var v=.5*i;for(c=0;this.contact_constraints.length>c;c++){n=this.contact_constraints[c],s=n.rows[0];var u=s.applied_push_impulse;1/0!==n.object_a.mass&&(e[0]=s.B[0]*u,e[1]=s.B[1]*u,e[2]=s.B[2]*u,vec3.add(n.object_a.linear_velocity,e),vec3.scale(e,this.relaxation),vec3.add(n.object_a.position,e),e[0]=s.B[3]*u,e[1]=s.B[4]*u,e[2]=s.B[5]*u,a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=0,quat4.multiply(a,n.object_a.rotation),n.object_a.rotation[0]+=v*a[0],n.object_a.rotation[1]+=v*a[1],n.object_a.rotation[2]+=v*a[2],n.object_a.rotation[3]+=v*a[3],quat4.normalize(n.object_a.rotation)),1/0!==n.object_b.mass&&(e[0]=s.B[6]*u,e[1]=s.B[7]*u,e[2]=s.B[8]*u,vec3.add(n.object_b.linear_velocity,e),vec3.scale(e,this.relaxation),vec3.add(n.object_b.position,e),e[0]=s.B[9]*u,e[1]=s.B[10]*u,e[2]=s.B[11]*u,a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=0,quat4.multiply(a,n.object_b.rotation),n.object_b.rotation[0]+=v*a[0],n.object_b.rotation[1]+=v*a[1],n.object_b.rotation[2]+=v*a[2],n.object_b.rotation[3]+=v*a[3],quat4.normalize(n.object_b.rotation))}},t.SequentialImpulseSolver.prototype.solveConstraints=function(){var e,i,o,a,n,s,c,r,h=this.constraints.length,p=0;for(s=0;this.max_iterations>s;s++){for(p=0,a=0;h>a;a++)for(e=this.constraints[a],i=e.rows.length,n=0;i>n;n++){o=e.rows[n],r=0,e.object_a&&1/0!==e.object_a.mass&&(r+=o.jacobian[0]*e.object_a.solver_impulse[0]+o.jacobian[1]*e.object_a.solver_impulse[1]+o.jacobian[2]*e.object_a.solver_impulse[2]+o.jacobian[3]*e.object_a.solver_impulse[3]+o.jacobian[4]*e.object_a.solver_impulse[4]+o.jacobian[5]*e.object_a.solver_impulse[5]),e.object_b&&1/0!==e.object_b.mass&&(r+=o.jacobian[6]*e.object_b.solver_impulse[0]+o.jacobian[7]*e.object_b.solver_impulse[1]+o.jacobian[8]*e.object_b.solver_impulse[2]+o.jacobian[9]*e.object_b.solver_impulse[3]+o.jacobian[10]*e.object_b.solver_impulse[4]+o.jacobian[11]*e.object_b.solver_impulse[5]),c=(o.eta-r)/o.D;var l=o.multiplier;o.multiplier=Math.max(o.lower_limit,Math.min(l+c,o.upper_limit)),c=o.multiplier-l,p=Math.max(p,c),e.object_a&&1/0!==e.object_a.mass&&(e.object_a.solver_impulse[0]+=c*o.B[0],e.object_a.solver_impulse[1]+=c*o.B[1],e.object_a.solver_impulse[2]+=c*o.B[2],e.object_a.solver_impulse[3]+=c*o.B[3],e.object_a.solver_impulse[4]+=c*o.B[4],e.object_a.solver_impulse[5]+=c*o.B[5]),e.object_b&&1/0!==e.object_b.mass&&(e.object_b.solver_impulse[0]+=c*o.B[6],e.object_b.solver_impulse[1]+=c*o.B[7],e.object_b.solver_impulse[2]+=c*o.B[8],e.object_b.solver_impulse[3]+=c*o.B[9],e.object_b.solver_impulse[4]+=c*o.B[10],e.object_b.solver_impulse[5]+=c*o.B[11])}if(p>=-t.EPSILON&&t.EPSILON>=p)break}},t.SequentialImpulseSolver.prototype.applyConstraints=function(){var t,i,o,a,n,s,c=this.constraints.length;for(a=0;c>a;a++)for(t=this.constraints[a],i=t.rows.length,n=0;i>n;n++)o=t.rows[n],s=o.multiplier,1/0!==t.object_a.mass&&(e[0]=o.B[0]*s,e[1]=o.B[1]*s,e[2]=o.B[2]*s,vec3.add(t.object_a.linear_velocity,e),e[0]=o.B[3]*s,e[1]=o.B[4]*s,e[2]=o.B[5]*s,vec3.add(t.object_a.angular_velocity,e)),1/0!==t.object_b.mass&&(e[0]=o.B[6]*s,e[1]=o.B[7]*s,e[2]=o.B[8]*s,vec3.add(t.object_b.linear_velocity,e),e[0]=o.B[9]*s,e[1]=o.B[10]*s,e[2]=o.B[11]*s,vec3.add(t.object_b.angular_velocity,e))},t.BoxShape=function(e,i,o){this.half_width=e,this.half_height=i,this.half_depth=o,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.BoxShape.prototype.calculateLocalAABB=function(t){t.min[0]=-this.half_width,t.min[1]=-this.half_height,t.min[2]=-this.half_depth,t.max[0]=this.half_width,t.max[1]=this.half_height,t.max[2]=this.half_depth},t.BoxShape.prototype.getInertiaTensor=function(t){var e=4*this.half_height*this.half_height,i=4*this.half_width*this.half_width,o=4*this.half_depth*this.half_depth,a=.0833*t;return mat3.createFrom(a*(e+o),0,0,0,a*(i+o),0,0,0,a*(e+i))},t.BoxShape.prototype.findSupportPoint=function(t,e){e[0]=0>t[0]?-this.half_width:this.half_width,e[1]=0>t[1]?-this.half_height:this.half_height,e[2]=0>t[2]?-this.half_depth:this.half_depth},t.ConeShape=function(e,i){this.radius=e,this.half_height=i,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb),this._sinangle=this.radius/Math.sqrt(this.radius*this.radius+Math.pow(2*this.half_height,2))},t.ConeShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[2]=-this.radius,t.min[1]=-this.half_height,t.max[0]=t.max[2]=this.radius,t.max[1]=this.half_height},t.ConeShape.prototype.getInertiaTensor=function(t){var e=.1*t*Math.pow(2*this.half_height,2)+.15*t*this.radius*this.radius;return mat3.createFrom(e,0,0,0,.3*t*this.radius*this.radius,0,0,0,e)},t.ConeShape.prototype.findSupportPoint=function(t,e){var i=Math.sqrt(t[0]*t[0]+t[2]*t[2]);if(t[1]>vec3.length(t)*this._sinangle)e[0]=e[2]=0,e[1]=this.half_height;else if(i>0){var o=this.radius/i;e[0]=o*t[0],e[1]=-this.half_height,e[2]=o*t[2]}else e[0]=e[2]=0,e[1]=-this.half_height},t.CylinderShape=function(e,i){this.radius=e,this.half_height=i,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.CylinderShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[2]=-this.radius,t.min[1]=-this.half_height,t.max[0]=t.max[2]=this.radius,t.max[1]=this.half_height},t.CylinderShape.prototype.getInertiaTensor=function(t){var e=.0833*t*(3*this.radius*this.radius+(this.half_height+this.half_height)*(this.half_height+this.half_height));return mat3.createFrom(e,0,0,0,.5*t*this.radius*this.radius,0,0,0,e)},t.CylinderShape.prototype.findSupportPoint=function(t,e){if(e[1]=0>t[1]?-this.half_height:this.half_height,0===t[0]&&0===t[2])e[0]=e[2]=0;else{var i=Math.sqrt(t[0]*t[0]+t[2]*t[2]),o=this.radius/i;e[0]=o*t[0],e[2]=o*t[2]}},t.PlaneShape=function(e,i,o){this.orientation=e,this.half_width=i,this.half_length=o,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb),0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0)},t.PlaneShape.prototype.calculateLocalAABB=function(t){0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length,t.min[0]=0,t.min[1]=-this.half_width,t.min[2]=-this.half_length,t.max[0]=0,t.max[1]=this.half_width,t.max[2]=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length,t.min[0]=-this.half_width,t.min[1]=0,t.min[2]=-this.half_length,t.max[0]=this.half_width,t.max[1]=0,t.max[2]=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0,t.min[0]=-this.half_width,t.min[1]=-this.half_length,t.min[2]=0,t.max[0]=this.half_width,t.max[1]=this.half_length,t.max[2]=0)},t.PlaneShape.prototype.getInertiaTensor=function(t){var e=4*this.half_width*this.half_width,i=4*this.half_length*this.half_length,o=.0833*t,a=o*i,n=o*(e+i),s=o*e;return 0===this.orientation?mat3.createFrom(n,0,0,0,a,0,0,0,s):1===this.orientation?mat3.createFrom(a,0,0,0,n,0,0,0,s):mat3.createFrom(n,0,0,0,s,0,0,0,a)},t.PlaneShape.prototype.findSupportPoint=function(t,e){e[0]=0>t[0]?-this._half_width:this._half_width,e[1]=0>t[1]?-this._half_height:this._half_height,e[2]=0>t[2]?-this._half_depth:this._half_depth},t.SphereShape=function(e){this.radius=e,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.SphereShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[1]=t.min[2]=-this.radius,t.max[0]=t.max[1]=t.max[2]=this.radius},t.SphereShape.prototype.getInertiaTensor=function(t){var e=.4*t*this.radius*this.radius;return mat3.createFrom(e,0,0,0,e,0,0,0,e)},t.SphereShape.prototype.findSupportPoint=function(){var t=vec3.create();return function(e,i){vec3.normalize(e,t),vec3.scale(t,this.radius,i)}}(),t.World=function(t,e,i){this.broadphase=t,this.nearphase=e,this.solver=i,this.mass_points=[],this.rigid_bodies=[],this.gravity=vec3.createFrom(0,-9.8,0),this.force_generators=[],this.constraints=[]},t.World.prototype.step=function(t,i){i=i||t;var o,a,n,s,c,r;for(n=t/i,o=0;n>o;o++){for(a=Math.min(i,t),t-=i,s=0,c=this.rigid_bodies.length;c>s;s++)this.rigid_bodies[s].updateDerived();for(s=0,c=this.rigid_bodies.length;c>s;s++)r=this.rigid_bodies[s],1/0!==r.mass&&(vec3.scale(r.gravity||this.gravity,r.mass*a,e),vec3.add(r.accumulated_force,e));for(s=0,c=this.force_generators.length;c>s;s++)this.force_generators[s].applyForce();for(this.broadphase.predictContactPairs(),this.nearphase.generateContacts(this.broadphase.collision_pairs),this.solver.processContactManifolds(this.nearphase.contact_manifolds),this.solver.prepareConstraints(),this.solver.resolveContacts(a),this.solver.solveConstraints(),this.solver.applyConstraints(),s=0,c=this.rigid_bodies.length;c>s;s++)r=this.rigid_bodies[s],r.integrate(a)}},t.World.prototype.addMassPoint=function(t){t.world=this,this.mass_points.push(t)},t.World.prototype.addRigidBody=function(t){t.world=this,this.rigid_bodies.push(t),this.broadphase.addBody(t)},t.World.prototype.removeRigidBody=function(t){var e,i=this.rigid_bodies.length;for(e=0;i>e;e++)if(this.rigid_bodies[e]===t){this.rigid_bodies.splice(e,1),this.broadphase.removeBody(t);break}},t.World.prototype.addForceGenerator=function(t){var e,i;for(e=0,i=this.force_generators.length;i>e;e++)if(this.force_generators[e]===t)return;this.force_generators.push(t)},t.World.prototype.removeForceGenerator=function(t){var e,i;for(e=0,i=this.force_generators.length;i>e;e++)if(this.force_generators[e]===t)return this.force_generators.splice(e,1),void 0},t.World.prototype.addConstraint=function(t){var e,i;for(e=0,i=this.constraints.length;i>e;e++)if(this.constraints[e]===t)return;t.world=this,this.constraints.push(t)},t.World.prototype.removeConstraint=function(t){var e,i;for(e=0,i=this.constraints.length;i>e;e++)if(this.constraints[e]===t)return this.constraints.splice(e,1),void 0},t}();