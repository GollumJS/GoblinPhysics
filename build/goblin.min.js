(function(){var t=quat4.create();quat4.rotateByVector=function(i,e,o){return o||(o=i),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,quat4.multiply(t,i),o},quat4.addScaledVector=function(i,e,o,a){a||(a=i);var s=Math.cos(e[0]*o/2),n=Math.cos(e[1]*o/2),c=Math.cos(e[2]*o/2),r=Math.sin(e[0]*o/2),h=Math.sin(e[1]*o/2),l=Math.sin(e[2]*o/2);return t[0]=r*n*c+s*h*l,t[1]=s*h*c-r*n*l,t[2]=s*n*l+r*h*c,t[3]=s*n*c-r*h*l,quat4.multiply(i,t),a}})(),window.Goblin=function(){var t={},i=vec3.create(),e=vec3.create(),o=vec3.create(),a=quat4.create(),s=quat4.create(),n=mat3.create(),c=mat3.create(),r=mat4.create();return t.EPSILON=1e-6,t.EventEmitter=function(){},t.EventEmitter.prototype={addListener:function(t,i){null==this.listeners[t]&&(this.listeners[t]=[]),-1===this.listeners[t].indexOf(i)&&this.listeners[t].push(i)},removeListener:function(t,i){null==this.listeners[t]&&(this.listeners[t]=[]);var e=this.listeners[t].indexOf(i);-1!==e&&this.listeners[t].splice(e,1)},removeAllListeners:function(){for(var t=Object.keys(this.listeners),i=0;t.length>i;i++)this.listeners[t[i]].length=0},emit:function(t){var i,e=Array.prototype.slice.call(arguments,1);if(this.listeners[t]instanceof Array)for(var o=this.listeners[t].slice(),a=0;o.length>a;a++)if(i=o[a].apply(this,e),i===!1)return!1}},t.EventEmitter.apply=function(i){i.prototype.addListener=t.EventEmitter.prototype.addListener,i.prototype.removeListener=t.EventEmitter.prototype.removeListener,i.prototype.removeAllListeners=t.EventEmitter.prototype.removeAllListeners,i.prototype.emit=t.EventEmitter.prototype.emit},t.AABB=function(t,i){this.min=t||vec3.create(),this.max=i||vec3.create()},t.AABB.prototype.transform=function(){var t=vec3.create(),e=vec3.create(),o=vec3.create(),a=vec3.create(),s=mat3.create();return function(n,c){vec3.subtract(n.max,n.min,t),vec3.scale(t,.5),vec3.add(n.max,n.min,e),vec3.scale(e,.5),mat4.multiplyVec3(c,e,o),s[0]=Math.abs(c[0]),s[1]=Math.abs(c[1]),s[2]=Math.abs(c[2]),s[3]=Math.abs(c[4]),s[4]=Math.abs(c[5]),s[5]=Math.abs(c[6]),s[6]=Math.abs(c[8]),s[7]=Math.abs(c[9]),s[8]=Math.abs(c[10]),i[0]=s[0],i[1]=s[1],i[2]=s[2],a[0]=vec3.dot(t,i),i[0]=s[3],i[1]=s[4],i[2]=s[5],a[1]=vec3.dot(t,i),i[0]=s[6],i[1]=s[7],i[2]=s[8],a[2]=vec3.dot(t,i),vec3.subtract(o,a,this.min),vec3.add(o,a,this.max)}}(),t.AABB.prototype.intersects=function(t){return this.max[0]<t.min[0]||this.max[1]<t.min[1]||this.max[2]<t.min[2]||this.min[0]>t.max[0]||this.min[1]>t.max[1]||this.min[2]>t.max[2]?!1:!0},t.AABB.prototype.testRayIntersect=function(){var i,e,o,a,s,n=vec3.create();return function(c,r){i=0,vec3.subtract(r,c,n),e=vec3.length(n),vec3.scale(n,1/e);for(var h=0;3>h;h++){var l=0===h?this.min[0]:1===h?this.min[1]:this.min[2],p=0===h?this.max[0]:1===h?this.max[1]:this.max[2];if(Math.abs(n[h])<t.EPSILON){if(l>c[h]||c[h]>p)return!1}else if(o=1/n[h],a=(l-c[h])*o,s=(p-c[h])*o,a>s&&(o=a,a=s,s=o),i=Math.max(i,a),e=Math.min(e,s),i>e)return!1}return!0}}(),t.BasicBroadphase=function(){this.bodies=[],this.collision_pairs=[]},t.BasicBroadphase.prototype.addBody=function(t){this.bodies.push(t)},t.BasicBroadphase.prototype.removeBody=function(t){var i,e=this.bodies.length;for(i=0;e>i;i++)if(this.bodies[i]===t){this.bodies.splice(i,1);break}},t.BasicBroadphase.prototype.predictContactPairs=function(){var t,i,e,o,a=this.bodies.length;for(this.collision_pairs.length=0,t=0;a>t;t++)for(e=this.bodies[t],i=0;a>i;i++)i>=t||(o=this.bodies[i],(1/0!==e.mass||1/0!==o.mass)&&e.aabb.intersects(o.aabb)&&this.collision_pairs.push([e,o]))},t.BasicBroadphase.prototype.rayIntersect=function(t,i){var e,o,a=this.bodies.length,s=[];for(e=0;a>e;e++)o=this.bodies[e],o.aabb.testRayIntersect(t,i)&&o.rayIntersect(t,i,s);return s},t.BoxSphere=function(a,s){var n,c,h=a.shape instanceof t.SphereShape?a:s,l=a.shape instanceof t.SphereShape?s:a;return mat4.multiplyVec3(l.transform_inverse,h.position,i),Math.abs(i[0])-h.shape.radius>l.shape.half_width||Math.abs(i[1])-h.shape.radius>l.shape.half_height||Math.abs(i[2])-h.shape.radius>l.shape.half_depth||(e[0]=e[1]=e[2]=0,c=i[0],c>l.shape.half_width?c=l.shape.half_width:-l.shape.half_width>c&&(c=-l.shape.half_width),e[0]=c,c=i[1],c>l.shape.half_height?c=l.shape.half_height:-l.shape.half_height>c&&(c=-l.shape.half_height),e[1]=c,c=i[2],c>l.shape.half_depth?c=l.shape.half_depth:-l.shape.half_depth>c&&(c=-l.shape.half_depth),e[2]=c,vec3.subtract(e,i,o),c=vec3.squaredLength(o),c>h.shape.radius*h.shape.radius)?void 0:(n=t.ObjectPool.getObject("ContactDetails"),n.object_a=h,n.object_b=l,0===c?t.BoxSphere.spherePenetration(l.shape,i,e,n):(vec3.subtract(e,i,n.contact_normal),n.penetration_depth=-vec3.length(n.contact_normal),vec3.scale(n.contact_normal,-1/n.penetration_depth),vec3.set(e,n.contact_point_in_b)),n.penetration_depth+=h.shape.radius,mat4.toRotationMat(l.transform,r),mat4.multiplyVec3(r,n.contact_normal),mat4.toRotationMat(h.transform_inverse,r),mat4.multiplyVec3(r,n.contact_normal,n.contact_point_in_a),vec3.scale(n.contact_point_in_a,h.shape.radius),vec3.scale(n.contact_normal,h.shape.radius-n.penetration_depth/2,n.contact_point),vec3.add(n.contact_point,h.position),n.restitution=(h.restitution+l.restitution)/2,n.friction=(h.friction+l.friction)/2,n)},t.BoxSphere.spherePenetration=function(t,i,o,a){var s,n;0>i[0]?(s=t.half_width+i[0],o[0]=-t.half_width,o[1]=o[2]=0,a.penetration_depth=s):(s=t.half_width-i[0],o[0]=t.half_width,o[1]=o[2]=0,a.penetration_depth=s),0>i[1]?(n=t.half_height+i[1],s>n&&(s=n,o[1]=-t.half_height,o[0]=o[2]=0,a.penetration_depth=s)):(n=t.half_height-i[1],s>n&&(s=n,o[1]=t.half_height,o[0]=o[2]=0,a.penetration_depth=s)),0>i[2]?(n=t.half_depth+i[2],s>n&&(o[2]=-t.half_depth,o[0]=o[1]=0,a.penetration_depth=s)):(n=t.half_depth-i[2],s>n&&(o[2]=t.half_depth,o[0]=o[1]=0,a.penetration_depth=s)),vec3.set(e,a.contact_point_in_b),vec3.scale(a.contact_point_in_b,-1,a.contact_normal),vec3.normalize(a.contact_normal)},t.GjkEpa2={max_iterations:20,epa_condition:.001,SupportPoint:function(t,i,e){this.witness_a=t,this.witness_b=i,this.point=e},findSupportPoint:function(){var t=vec3.create();return function(i,e,o,a){i.findSupportPoint(o,a.witness_a),vec3.negate(o,t),e.findSupportPoint(t,a.witness_b),vec3.subtract(a.witness_a,a.witness_b,a.point)}}(),GJK:function(){return function(i,e){for(var o,a=new t.GjkEpa2.Simplex(i,e);o=a.addPoint(););return o===!1?(t.GjkEpa2.freeSimplex(a),null):a}}(),freeSimplex:function(i){for(var e=0,o=i.points.length;o>e;e++)t.ObjectPool.freeObject("GJK2SupportPoint",i.points[e])},freePolyhedron:function(i){for(var e=t.ObjectPool.pools.GJK2SupportPoint,o=0,a=i.faces.length;a>o;o++)-1===e.indexOf(i.faces[o].a)&&t.ObjectPool.freeObject("GJK2SupportPoint",i.faces[o].a),-1===e.indexOf(i.faces[o].b)&&t.ObjectPool.freeObject("GJK2SupportPoint",i.faces[o].b),-1===e.indexOf(i.faces[o].c)&&t.ObjectPool.freeObject("GJK2SupportPoint",i.faces[o].c)},EPA:function(){return function(e){for(var o=new t.GjkEpa2.Polyhedron(e),a=0;++a;){o.findFaceClosestToOrigin(),o.closest_face_distance<t.EPSILON?vec3.set(o.faces[o.closest_face].normal,i):vec3.set(o.closest_point,i);var s=t.ObjectPool.getObject("GJK2SupportPoint");t.GjkEpa2.findSupportPoint(e.object_a,e.object_b,i,s),vec3.subtract(s.point,o.closest_point,i);var n=vec3.squaredLength(i);if(a===t.GjkEpa2.max_iterations||t.GjkEpa2.epa_condition>n&&o.closest_face_distance>t.EPSILON){var c=t.ObjectPool.getObject("ContactDetails");c.object_a=e.object_a,c.object_b=e.object_b,vec3.normalize(o.closest_point,c.contact_normal),0===vec3.squaredLength(c.contact_normal)&&vec3.subtract(c.object_b.position,c.object_a.position,c.contact_normal),vec3.normalize(c.contact_normal);var r=vec3.create();if(t.GeometryMethods.findBarycentricCoordinates(o.closest_point,o.faces[o.closest_face].a.point,o.faces[o.closest_face].b.point,o.faces[o.closest_face].c.point,r),isNaN(r[0]))return t.GjkEpa2.freePolyhedron(o),null;var h={a:vec3.create(),b:vec3.create(),c:vec3.create()};return vec3.scale(o.faces[o.closest_face].a.witness_a,r[0],h.a),vec3.scale(o.faces[o.closest_face].b.witness_a,r[1],h.b),vec3.scale(o.faces[o.closest_face].c.witness_a,r[2],h.c),vec3.add(h.a,h.b,c.contact_point_in_a),vec3.add(c.contact_point_in_a,h.c),vec3.scale(o.faces[o.closest_face].a.witness_b,r[0],h.a),vec3.scale(o.faces[o.closest_face].b.witness_b,r[1],h.b),vec3.scale(o.faces[o.closest_face].c.witness_b,r[2],h.c),vec3.add(h.a,h.b,c.contact_point_in_b),vec3.add(c.contact_point_in_b,h.c),vec3.add(c.contact_point_in_a,c.contact_point_in_b,c.contact_point),vec3.scale(c.contact_point,.5),mat4.multiplyVec3(c.object_a.transform_inverse,c.contact_point_in_a),mat4.multiplyVec3(c.object_b.transform_inverse,c.contact_point_in_b),c.penetration_depth=vec3.length(o.closest_point),c.restitution=(e.object_a.restitution+e.object_b.restitution)/2,c.friction=(e.object_a.friction+e.object_b.friction)/2,t.GjkEpa2.freePolyhedron(o),c}o.addVertex(s)}return t.GjkEpa2.freePolyhedron(o),null}}(),Face:function(t,o,a,s){this.active=!0,this.polyhedron=t,this.a=o,this.b=a,this.c=s,this.normal=vec3.create(),this.neighbors=[],vec3.subtract(a.point,o.point,i),vec3.subtract(s.point,o.point,e),vec3.cross(i,e,this.normal),vec3.normalize(this.normal)}},t.GjkEpa2.Polyhedron=function(i){this.closest_face=null,this.closest_face_distance=null,this.closest_point=vec3.create(),this.faces=[new t.GjkEpa2.Face(this,i.points[2],i.points[1],i.points[0]),new t.GjkEpa2.Face(this,i.points[3],i.points[1],i.points[2]),new t.GjkEpa2.Face(this,i.points[1],i.points[3],i.points[0]),new t.GjkEpa2.Face(this,i.points[0],i.points[3],i.points[2])],this.faces[0].neighbors.push(this.faces[1],this.faces[2],this.faces[3]),this.faces[1].neighbors.push(this.faces[2],this.faces[0],this.faces[3]),this.faces[2].neighbors.push(this.faces[1],this.faces[3],this.faces[0]),this.faces[3].neighbors.push(this.faces[2],this.faces[1],this.faces[0])},t.GjkEpa2.Polyhedron.prototype={addVertex:function(i){var e,o,a,s,n,c=[],r=[];for(this.faces[this.closest_face].silhouette(i,c),e=0;c.length-5>e;e+=5){if(a=c[e+3],s=c[e+4],0!==e&&n!==a)for(o=e+5;c.length>o;o+=5)if(c[o+3]===n){var h=c.slice(e,e+5);c[e]=c[o],c[e+1]=c[o+1],c[e+2]=c[o+2],c[e+3]=c[o+3],c[e+4]=c[o+4],c[o]=h[0],c[o+1]=h[1],c[o+2]=h[2],c[o+3]=h[3],c[o+4]=h[4],a=c[e+3],s=c[e+4];break}n=s}for(e=0;c.length>e;e+=5){var l=c[e];a=c[e+3],s=c[e+4];var p=new t.GjkEpa2.Face(this,s,i,a);p.neighbors[2]=c[e],r.push(p),l.neighbors[l.neighbors.indexOf(c[e+2])]=p}for(e=0;r.length>e;e++)r[e].neighbors[0]=r[e+1===r.length?0:e+1],r[e].neighbors[1]=r[0>e-1?r.length-1:e-1];return Array.prototype.push.apply(this.faces,r),c},findFaceClosestToOrigin:function(){var i=vec3.create(),e=vec3.create();return function(){this.closest_face_distance=1/0;var o,a;for(a=0;this.faces.length>a;a++)this.faces[a].active!==!1&&(t.GeometryMethods.findClosestPointInTriangle(i,this.faces[a].a.point,this.faces[a].b.point,this.faces[a].c.point,e),o=vec3.squaredLength(e),this.closest_face_distance>o&&(this.closest_face_distance=o,this.closest_face=a,vec3.set(e,this.closest_point)))}}()},t.GjkEpa2.Face.prototype={classifyVertex:function(t){var i=vec3.dot(this.normal,this.a.point),e=vec3.dot(this.normal,t.point)-i;return e},silhouette:function(t,i,e){if(this.active!==!1)if(this.classifyVertex(t)>0)this.active=!1,this.neighbors[0].silhouette(t,i,this),this.neighbors[1].silhouette(t,i,this),this.neighbors[2].silhouette(t,i,this);else if(e){var o,a,s=this.neighbors.indexOf(e);0===s?(o=this.a,a=this.b):1===s?(o=this.b,a=this.c):(o=this.c,a=this.a),i.push(this,s,e,a,o)}}},function(){var a=vec3.create(),s=vec3.create(),n=vec3.create(),c=vec3.create();t.GjkEpa2.Simplex=function(t,i){this.object_a=t,this.object_b=i,this.points=[],this.iterations=0,this.next_direction=vec3.create(),this.updateDirection()},t.GjkEpa2.Simplex.prototype={addPoint:function(){if(++this.iterations===t.GjkEpa2.max_iterations)return!1;var i=t.ObjectPool.getObject("GJK2SupportPoint");return t.GjkEpa2.findSupportPoint(this.object_a,this.object_b,this.next_direction,i),this.points.push(i),0>vec3.dot(this.points[this.points.length-1].point,this.next_direction)?!1:this.updateDirection()===!0?null:i},findDirectionFromLine:function(){vec3.negate(this.points[1].point,a),vec3.subtract(this.points[0].point,this.points[1].point,s),0>vec3.dot(s,a)?(vec3.set(a,this.next_direction),t.ObjectPool.freeObject("GJK2SupportPoint",this.points[1]),this.points.length=1):(vec3.cross(s,a,this.next_direction),vec3.cross(this.next_direction,s),0===this.next_direction[0]&&0===this.next_direction[1]&&0===this.next_direction[2]&&(vec3.normalize(s),this.next_direction[0]=1-Math.abs(s[0]),this.next_direction[1]=1-Math.abs(s[1]),this.next_direction[2]=1-Math.abs(s[2])))},findDirectionFromTriangle:function(){var c=this.points[2],r=this.points[1],h=this.points[0];vec3.negate(c.point,a),vec3.subtract(r.point,c.point,s),vec3.subtract(h.point,c.point,n),vec3.cross(s,n,i),vec3.cross(s,i,e),vec3.cross(i,n,o),vec3.dot(o,a)>=0?vec3.dot(n,a)>=0?(this.points.length=0,this.points.push(h,c),t.ObjectPool.freeObject("GJK2SupportPoint",r),vec3.cross(n,a,this.next_direction),vec3.cross(this.next_direction,n)):vec3.dot(s,a)>=0?(this.points.length=0,this.points.push(r,c),t.ObjectPool.freeObject("GJK2SupportPoint",h),vec3.cross(s,a,this.next_direction),vec3.cross(this.next_direction,s)):(this.points.length=0,this.points.push(c),t.ObjectPool.freeObject("GJK2SupportPoint",r),t.ObjectPool.freeObject("GJK2SupportPoint",h)):vec3.dot(e,a)>=0?vec3.dot(s,a)>=0?(this.points.length=0,this.points.push(r,c),t.ObjectPool.freeObject("GJK2SupportPoint",h),vec3.cross(s,a,this.next_direction),vec3.cross(this.next_direction,s)):(this.points.length=0,this.points.push(c),t.ObjectPool.freeObject("GJK2SupportPoint",r),t.ObjectPool.freeObject("GJK2SupportPoint",h)):vec3.dot(i,a)>=0?(vec3.set(i,this.next_direction),this.points.length=0,this.points.push(c,r,h)):(vec3.set(i,this.next_direction),vec3.negate(this.next_direction))},getFaceNormal:function(t,i,e,o){vec3.subtract(i.point,t.point,s),vec3.subtract(e.point,t.point,n),vec3.cross(s,n,o),vec3.normalize(o)},faceNormalDotOrigin:function(t,o,a){return this.getFaceNormal(t,o,a,i),vec3.add(t.point,o.point,e),vec3.add(e,a.point),vec3.scale(e,-3),vec3.normalize(e),vec3.dot(i,e)},findDirectionFromTetrahedron:function(){var e,o=this.points[3],a=this.points[2],s=this.points[1],n=this.points[0],c=null,r=t.EPSILON;return e=this.faceNormalDotOrigin(a,s,n),e>r&&(c=1,r=e),e=this.faceNormalDotOrigin(o,s,a),e>r&&(c=2,r=e),e=this.faceNormalDotOrigin(s,o,n),e>r&&(c=3,r=e),e=this.faceNormalDotOrigin(n,o,a),e>r&&(c=4,r=e),null===c?!0:(1===c?(this.points.length=0,this.points.push(a,s,n),this.getFaceNormal(a,s,n,i),vec3.set(i,this.next_direction)):2===c?(this.points.length=0,this.points.push(o,s,a),this.getFaceNormal(o,s,a,i),vec3.set(i,this.next_direction)):3===c?(this.points.length=0,this.points.push(s,o,n),this.getFaceNormal(s,o,n,i),vec3.set(i,this.next_direction)):4===c&&(this.points.length=0,this.points.push(n,o,a),this.getFaceNormal(n,o,a,i),vec3.set(i,this.next_direction)),void 0)},containsOrigin:function(){var t=this.points[3],e=this.points[2],o=this.points[1],a=this.points[0];return vec3.subtract(a.point,t.point,s),vec3.subtract(o.point,t.point,c),vec3.cross(s,c,i),vec3.dot(i,t.point)>0?!1:(vec3.subtract(o.point,t.point,s),vec3.subtract(e.point,t.point,c),vec3.cross(s,c,i),vec3.dot(i,t.point)>0?!1:(vec3.subtract(e.point,t.point,s),vec3.subtract(a.point,t.point,c),vec3.cross(s,c,i),vec3.dot(i,t.point)>0?!1:(vec3.subtract(a.point,o.point,s),vec3.subtract(e.point,o.point,c),vec3.cross(s,c,i),vec3.dot(i,a.point)>0?!1:!0)))},updateDirection:function(){if(0===this.points.length)vec3.subtract(this.object_b.position,this.object_a.position,this.next_direction);else if(1===this.points.length)vec3.negate(this.next_direction);else if(2===this.points.length)this.findDirectionFromLine();else{if(3!==this.points.length)return this.findDirectionFromTetrahedron();this.findDirectionFromTriangle()}}}}(),t.SphereSphere=function(e,o){var a=e.position,s=o.position;vec3.subtract(s,a,i);var n=vec3.length(i);if(!(n>e.shape.radius+o.shape.radius)){var c=t.ObjectPool.getObject("ContactDetails");return c.object_a=e,c.object_b=o,vec3.scale(i,1/n,c.contact_normal),vec3.scale(i,-.5),vec3.add(i,a,c.contact_point),c.penetration_depth=e.shape.radius+o.shape.radius-n,vec3.scale(c.contact_normal,c.object_a.shape.radius,c.contact_point_in_a),vec3.add(c.contact_point_in_a,c.object_a.position),vec3.scale(c.contact_normal,-c.object_b.shape.radius,c.contact_point_in_b),vec3.add(c.contact_point_in_b,c.object_b.position),vec3.add(c.contact_point_in_a,c.contact_point_in_b,c.contact_point),vec3.scale(c.contact_point,.5),mat4.multiplyVec3(c.object_a.transform_inverse,c.contact_point_in_a),mat4.multiplyVec3(c.object_b.transform_inverse,c.contact_point_in_b),c.restitution=(e.restitution+o.restitution)/2,c.friction=(e.friction+o.friction)/2,c}},t.Constraint=function(){this.active=!0,this.object_a=null,this.object_b=null,this.rows=[],this.factor=1,this.last_impulse=vec3.create(),this.breaking_threshold=0,this.listeners={}},t.EventEmitter.apply(t.Constraint),t.Constraint.prototype.deactivate=function(){this.active=!1,this.emit("deactivate")},t.Constraint.prototype.update=function(){},t.ConstraintRow=function(){this.jacobian=new Float64Array(12),this.B=new Float64Array(12),this.D=0,this.lower_limit=-1/0,this.upper_limit=1/0,this.bias=0,this.multiplier=0,this.multiplier_cached=0,this.eta=0,this.eta_row=new Float64Array(12)},t.ConstraintRow.prototype.computeB=function(t){var e=0;null!=t.object_a&&1/0!==t.object_a.mass?(e=1/t.object_a.mass,this.B[0]=e*this.jacobian[0],this.B[1]=e*this.jacobian[1],this.B[2]=e*this.jacobian[2],i[0]=this.jacobian[3],i[1]=this.jacobian[4],i[2]=this.jacobian[5],mat3.multiplyVec3(t.object_a.inverseInertiaTensorWorldFrame,i),this.B[3]=i[0],this.B[4]=i[1],this.B[5]=i[2]):(this.B[0]=this.B[1]=this.B[2]=0,this.B[3]=this.B[4]=this.B[5]=0),null!=t.object_b&&1/0!==t.object_b.mass?(e=1/t.object_b.mass,this.B[6]=e*this.jacobian[6],this.B[7]=e*this.jacobian[7],this.B[8]=e*this.jacobian[8],i[0]=this.jacobian[9],i[1]=this.jacobian[10],i[2]=this.jacobian[11],mat3.multiplyVec3(t.object_b.inverseInertiaTensorWorldFrame,i),this.B[9]=i[0],this.B[10]=i[1],this.B[11]=i[2]):(this.B[6]=this.B[7]=this.B[8]=0,this.B[9]=this.B[10]=this.B[11]=0)},t.ConstraintRow.prototype.computeD=function(){this.D=this.jacobian[0]*this.B[0]+this.jacobian[1]*this.B[1]+this.jacobian[2]*this.B[2]+this.jacobian[3]*this.B[3]+this.jacobian[4]*this.B[4]+this.jacobian[5]*this.B[5]+this.jacobian[6]*this.B[6]+this.jacobian[7]*this.B[7]+this.jacobian[8]*this.B[8]+this.jacobian[9]*this.B[9]+this.jacobian[10]*this.B[10]+this.jacobian[11]*this.B[11]},t.ConstraintRow.prototype.computeEta=function(t,e){var o,a=1/e;null==t.object_a||1/0===t.object_a.mass?this.eta_row[0]=this.eta_row[1]=this.eta_row[2]=this.eta_row[3]=this.eta_row[4]=this.eta_row[5]=0:(o=1/t.object_a.mass,this.eta_row[0]=(t.object_a.linear_velocity[0]+o*t.object_a.accumulated_force[0])*a,this.eta_row[1]=(t.object_a.linear_velocity[1]+o*t.object_a.accumulated_force[1])*a,this.eta_row[2]=(t.object_a.linear_velocity[2]+o*t.object_a.accumulated_force[2])*a,vec3.set(t.object_a.accumulated_torque,i),mat3.multiplyVec3(t.object_a.inverseInertiaTensorWorldFrame,i),this.eta_row[3]=(t.object_a.angular_velocity[0]+i[0])*a,this.eta_row[4]=(t.object_a.angular_velocity[1]+i[1])*a,this.eta_row[5]=(t.object_a.angular_velocity[2]+i[2])*a),null==t.object_b||1/0===t.object_b.mass?this.eta_row[6]=this.eta_row[7]=this.eta_row[8]=this.eta_row[9]=this.eta_row[10]=this.eta_row[11]=0:(o=1/t.object_b.mass,this.eta_row[6]=(t.object_b.linear_velocity[0]+o*t.object_b.accumulated_force[0])*a,this.eta_row[7]=(t.object_b.linear_velocity[1]+o*t.object_b.accumulated_force[1])*a,this.eta_row[8]=(t.object_b.linear_velocity[2]+o*t.object_b.accumulated_force[2])*a,vec3.set(t.object_b.accumulated_torque,i),mat3.multiplyVec3(t.object_b.inverseInertiaTensorWorldFrame,i),this.eta_row[9]=(t.object_b.angular_velocity[0]+i[0])*a,this.eta_row[10]=(t.object_b.angular_velocity[1]+i[1])*a,this.eta_row[11]=(t.object_b.angular_velocity[2]+i[2])*a);var s=this.jacobian[0]*this.eta_row[0]+this.jacobian[1]*this.eta_row[1]+this.jacobian[2]*this.eta_row[2]+this.jacobian[3]*this.eta_row[3]+this.jacobian[4]*this.eta_row[4]+this.jacobian[5]*this.eta_row[5]+this.jacobian[6]*this.eta_row[6]+this.jacobian[7]*this.eta_row[7]+this.jacobian[8]*this.eta_row[8]+this.jacobian[9]*this.eta_row[9]+this.jacobian[10]*this.eta_row[10]+this.jacobian[11]*this.eta_row[11];this.eta=this.bias*a-s},t.ContactConstraint=function(){t.Constraint.call(this),this.contact=null},t.ContactConstraint.prototype=Object.create(t.Constraint.prototype),t.ContactConstraint.prototype.buildFromContact=function(i){this.object_a=i.object_a,this.object_b=i.object_b,this.contact=i;var e=this,o=function(){this.removeListener("destroy",o),e.deactivate()};this.contact.addListener("destroy",o);var a=this.rows[0]||t.ObjectPool.getObject("ConstraintRow");a.lower_limit=0,a.upper_limit=1/0,this.rows[0]=a,this.update()},t.ContactConstraint.prototype.update=function(){var t=this.rows[0];null==this.object_a||1/0===this.object_a.mass?(t.jacobian[0]=t.jacobian[1]=t.jacobian[2]=0,t.jacobian[3]=t.jacobian[4]=t.jacobian[5]=0):(t.jacobian[0]=-this.contact.contact_normal[0],t.jacobian[1]=-this.contact.contact_normal[1],t.jacobian[2]=-this.contact.contact_normal[2],vec3.subtract(this.contact.contact_point,this.contact.object_a.position,i),vec3.cross(i,this.contact.contact_normal,i),t.jacobian[3]=-i[0],t.jacobian[4]=-i[1],t.jacobian[5]=-i[2]),null==this.object_b||1/0===this.object_b.mass?(t.jacobian[6]=t.jacobian[7]=t.jacobian[8]=0,t.jacobian[9]=t.jacobian[10]=t.jacobian[11]=0):(t.jacobian[6]=this.contact.contact_normal[0],t.jacobian[7]=this.contact.contact_normal[1],t.jacobian[8]=this.contact.contact_normal[2],vec3.subtract(this.contact.contact_point,this.contact.object_b.position,i),vec3.cross(i,this.contact.contact_normal,i),t.jacobian[9]=i[0],t.jacobian[10]=i[1],t.jacobian[11]=i[2]),t.bias=0;var e=0;1/0!==this.object_a.mass&&(this.object_a.getVelocityInLocalPoint(this.contact.contact_point_in_a,i),e+=vec3.dot(i,this.contact.contact_normal)),1/0!==this.object_b.mass&&(this.object_b.getVelocityInLocalPoint(this.contact.contact_point_in_b,i),e-=vec3.dot(i,this.contact.contact_normal)),t.bias+=e*this.contact.restitution},t.FrictionConstraint=function(){t.Constraint.call(this),this.contact=null},t.FrictionConstraint.prototype=Object.create(t.Constraint.prototype),t.FrictionConstraint.prototype.buildFromContact=function(i){this.rows[0]=this.rows[0]||t.ObjectPool.getObject("ConstraintRow"),this.rows[1]=this.rows[1]||t.ObjectPool.getObject("ConstraintRow"),this.object_a=i.object_a,this.object_b=i.object_b,this.contact=i;var e=this,o=function(){this.removeListener("destroy",o),e.deactivate()};this.contact.addListener("destroy",o),this.update()},t.FrictionConstraint.prototype.update=function(){var t=this.rows[0],e=this.rows[1],o=vec3.create(),a=vec3.create();vec3.subtract(this.contact.contact_point,this.object_a.position,o),vec3.subtract(this.contact.contact_point,this.object_b.position,a);var s,n,c=vec3.create(),r=vec3.create();Math.abs(this.contact.contact_normal[2])>.7071067811865475?(s=-this.contact.contact_normal[1]*this.contact.contact_normal[1]+this.contact.contact_normal[2]*this.contact.contact_normal[2],n=1/Math.sqrt(s),c[0]=0,c[1]=-this.contact.contact_normal[2]*n,c[2]=this.contact.contact_normal[1]*n,r[0]=s*n,r[1]=-this.contact.contact_normal[0]*c[2],r[2]=this.contact.contact_normal[0]*c[1]):(s=this.contact.contact_normal[0]*this.contact.contact_normal[0]+this.contact.contact_normal[1]*this.contact.contact_normal[1],n=1/Math.sqrt(s),c[0]=-this.contact.contact_normal[1]*n,c[1]=this.contact.contact_normal[0]*n,c[2]=0,r[0]=-this.contact.contact_normal[2]*c[1],r[1]=this.contact.contact_normal[2]*c[0],r[2]=s*n),null==this.object_a||1/0===this.object_a.mass?(t.jacobian[0]=t.jacobian[1]=t.jacobian[2]=0,t.jacobian[3]=t.jacobian[4]=t.jacobian[5]=0,e.jacobian[0]=e.jacobian[1]=e.jacobian[2]=0,e.jacobian[3]=e.jacobian[4]=e.jacobian[5]=0):(t.jacobian[0]=-c[0],t.jacobian[1]=-c[1],t.jacobian[2]=-c[2],vec3.cross(o,c,i),t.jacobian[3]=-i[0],t.jacobian[4]=-i[1],t.jacobian[5]=-i[2],e.jacobian[0]=-r[0],e.jacobian[1]=-r[1],e.jacobian[2]=-r[2],vec3.cross(o,r,i),e.jacobian[3]=-i[0],e.jacobian[4]=-i[1],e.jacobian[5]=-i[2]),null==this.object_b||1/0===this.object_b.mass?(t.jacobian[6]=t.jacobian[7]=t.jacobian[8]=0,t.jacobian[9]=t.jacobian[10]=t.jacobian[11]=0,e.jacobian[6]=e.jacobian[7]=e.jacobian[8]=0,e.jacobian[9]=e.jacobian[10]=e.jacobian[11]=0):(t.jacobian[6]=c[0],t.jacobian[7]=c[1],t.jacobian[8]=c[2],vec3.cross(a,c,i),t.jacobian[9]=i[0],t.jacobian[10]=i[1],t.jacobian[11]=i[2],e.jacobian[6]=r[0],e.jacobian[7]=r[1],e.jacobian[8]=r[2],vec3.cross(a,r,i),e.jacobian[9]=i[0],e.jacobian[10]=i[1],e.jacobian[11]=i[2]);var h=vec3.dot(this.object_a.linear_velocity,this.contact.contact_normal);h-=vec3.dot(this.object_b.linear_velocity,this.contact.contact_normal);var l=0;l=null==this.object_a||1/0===this.object_a.mass?this.object_b.mass:null==this.object_b||1/0===this.object_b.mass?this.object_a.mass:(this.object_a.mass+this.object_b.mass)/2,h=1;var p=this.contact.friction*h*l;0>p&&(p=0),t.lower_limit=e.lower_limit=-p,t.upper_limit=e.upper_limit=p,t.bias=e.bias=0,this.rows[0]=t,this.rows[1]=e},t.RevoluteConstraint=function(i,e,o,a){t.Constraint.call(this),this.object_a=i,this.point_a=e,this.object_b=o||null,null!=this.object_b?this.point_b=a:(this.point_b=vec3.create(),this.object_a.updateDerived(),mat4.multiplyVec3(this.object_a.transform,this.point_a,this.point_b)),this.erp=.1;for(var s=0;3>s;s++)this.rows[s]=t.ObjectPool.getObject("ConstraintRow"),this.rows[s].lower_limit=-1/0,this.rows[s].upper_limit=1/0,this.rows[s].bias=0,this.rows[s].jacobian[6]=this.rows[s].jacobian[7]=this.rows[s].jacobian[8]=this.rows[s].jacobian[9]=this.rows[s].jacobian[10]=this.rows[s].jacobian[11]=0},t.RevoluteConstraint.prototype=Object.create(t.Constraint.prototype),t.RevoluteConstraint.prototype.update=function(){var t=vec3.create(),a=vec3.create();return function(s){mat4.multiplyVec3(this.object_a.transform,this.point_a,i),vec3.subtract(i,this.object_a.position,t),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-t[2],this.rows[0].jacobian[5]=t[1],this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=t[2],this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-t[0],this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-t[1],this.rows[2].jacobian[4]=t[0],this.rows[2].jacobian[5]=0,null!=this.object_b?(mat4.multiplyVec3(this.object_b.transform,this.point_b,e),vec3.subtract(e,this.object_b.position,a),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=a[2],this.rows[0].jacobian[11]=-a[1],this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-a[2],this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=a[0],this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=a[1],this.rows[2].jacobian[10]=-a[0],this.rows[2].jacobian[11]=0):vec3.set(this.point_b,e),vec3.subtract(i,e,o),vec3.scale(o,this.erp/s),this.rows[0].bias=o[0],this.rows[1].bias=o[1],this.rows[2].bias=o[2]}}(),t.SliderConstraint=function(i,e,o){t.Constraint.call(this),this.object_a=i,this.axis=e,this.object_b=o,this.position_error=vec3.create(),vec3.subtract(this.object_b.position,this.object_a.position,this.position_error),quat4.inverse(this.object_a.rotation,a),quat4.multiplyVec3(a,this.position_error),this.rotation_difference=quat4.create(),null!=this.object_b&&(quat4.inverse(this.object_b.rotation,a),quat4.multiply(a,this.object_a.rotation,this.rotation_difference)),this.erp=.1;for(var s=0;5>s;s++)this.rows[s]=t.ObjectPool.getObject("ConstraintRow"),this.rows[s].lower_limit=-1/0,this.rows[s].upper_limit=1/0,this.rows[s].bias=0,this.rows[s].jacobian[0]=this.rows[s].jacobian[1]=this.rows[s].jacobian[2]=this.rows[s].jacobian[3]=this.rows[s].jacobian[4]=this.rows[s].jacobian[5]=this.rows[s].jacobian[6]=this.rows[s].jacobian[7]=this.rows[s].jacobian[8]=this.rows[s].jacobian[9]=this.rows[s].jacobian[10]=this.rows[s].jacobian[11]=0},t.SliderConstraint.prototype=Object.create(t.Constraint.prototype),t.SliderConstraint.prototype.update=function(){var t=vec3.create(),i=vec3.create(),e=vec3.create();return function(o){quat4.multiplyVec3(this.object_a.rotation,this.axis,t),i[0]=t[1],i[1]=-t[0],i[2]=0,vec3.normalize(i),vec3.cross(t,i,e),this._updateLinearConstraints(o,i,e),this._updateAngularConstraints(o,i,e)}}(),t.SliderConstraint.prototype._updateLinearConstraints=function(t,o,a){var s=vec3.create();vec3.subtract(this.object_b.position,this.object_a.position,s);var n=vec3.create();vec3.cross(s,o,n),this.rows[0].jacobian[0]=-o[0],this.rows[0].jacobian[1]=-o[1],this.rows[0].jacobian[2]=-o[2],this.rows[0].jacobian[6]=o[0],this.rows[0].jacobian[7]=o[1],this.rows[0].jacobian[8]=o[2],this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=0,this.rows[0].jacobian[11]=0,vec3.cross(s,a,n),this.rows[1].jacobian[0]=-a[0],this.rows[1].jacobian[1]=-a[1],this.rows[1].jacobian[2]=-a[2],this.rows[1].jacobian[6]=a[0],this.rows[1].jacobian[7]=a[1],this.rows[1].jacobian[8]=a[2],this.rows[1].jacobian[9]=0,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=0,quat4.multiplyVec3(this.object_a.rotation,this.position_error,i),vec3.subtract(s,i,e),vec3.scale(e,this.erp/t),this.rows[0].bias=-vec3.dot(o,e),this.rows[1].bias=-vec3.dot(a,e)},t.SliderConstraint.prototype._updateAngularConstraints=function(t){this.rows[2].jacobian[3]=this.rows[3].jacobian[4]=this.rows[4].jacobian[5]=-1,this.rows[2].jacobian[9]=this.rows[3].jacobian[10]=this.rows[4].jacobian[11]=1,quat4.inverse(this.object_b.rotation,a),quat4.multiply(a,this.object_a.rotation),quat4.inverse(this.rotation_difference,s),quat4.multiply(s,a);var i=vec3.create();i[0]=s[0],i[1]=s[1],i[2]=s[2],vec3.scale(i,this.erp/t)},t.WeldConstraint=function(i,e,o,s){t.Constraint.call(this),this.object_a=i,this.point_a=e,this.object_b=o||null,this.point_b=s||null,this.rotation_difference=quat4.create(),null!=this.object_b&&(quat4.inverse(this.object_b.rotation,a),quat4.multiply(a,this.object_a.rotation,this.rotation_difference)),this.erp=.1;for(var n=0;3>n;n++)this.rows[n]=t.ObjectPool.getObject("ConstraintRow"),this.rows[n].lower_limit=-1/0,this.rows[n].upper_limit=1/0,this.rows[n].bias=0,null==this.object_b&&(this.rows[n].jacobian[0]=this.rows[n].jacobian[1]=this.rows[n].jacobian[2]=this.rows[n].jacobian[4]=this.rows[n].jacobian[5]=this.rows[n].jacobian[6]=this.rows[n].jacobian[7]=this.rows[n].jacobian[8]=this.rows[n].jacobian[9]=this.rows[n].jacobian[10]=this.rows[n].jacobian[11]=this.rows[n].jacobian[12]=0,this.rows[n].jacobian[n]=1);for(n=3;6>n;n++)this.rows[n]=t.ObjectPool.getObject("ConstraintRow"),this.rows[n].lower_limit=-1/0,this.rows[n].upper_limit=1/0,this.rows[n].bias=0,null==this.object_b?(this.rows[n].jacobian[0]=this.rows[n].jacobian[1]=this.rows[n].jacobian[2]=this.rows[n].jacobian[4]=this.rows[n].jacobian[5]=this.rows[n].jacobian[6]=this.rows[n].jacobian[7]=this.rows[n].jacobian[8]=this.rows[n].jacobian[9]=this.rows[n].jacobian[10]=this.rows[n].jacobian[11]=this.rows[n].jacobian[12]=0,this.rows[n].jacobian[n]=1):(this.rows[n].jacobian[0]=this.rows[n].jacobian[1]=this.rows[n].jacobian[2]=0,this.rows[n].jacobian[3]=this.rows[n].jacobian[4]=this.rows[n].jacobian[5]=0,this.rows[n].jacobian[n]=-1,this.rows[n].jacobian[6]=this.rows[n].jacobian[7]=this.rows[n].jacobian[8]=0,this.rows[n].jacobian[9]=this.rows[n].jacobian[10]=this.rows[n].jacobian[11]=0,this.rows[n].jacobian[n+6]=1)},t.WeldConstraint.prototype=Object.create(t.Constraint.prototype),t.WeldConstraint.prototype.update=function(){var t=vec3.create(),o=vec3.create();return function(n){if(null!=this.object_b){mat4.multiplyVec3(this.object_a.transform,this.point_a,i),vec3.subtract(i,this.object_a.position,t),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-t[2],this.rows[0].jacobian[5]=t[1],this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=t[2],this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-t[0],this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-t[1],this.rows[2].jacobian[4]=t[0],this.rows[2].jacobian[5]=0,null!=this.object_b?(mat4.multiplyVec3(this.object_b.transform,this.point_b,e),vec3.subtract(e,this.object_b.position,o),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=o[2],this.rows[0].jacobian[11]=-o[1],this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-o[2],this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=o[0],this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=o[1],this.rows[2].jacobian[10]=-o[0],this.rows[2].jacobian[11]=0):vec3.set(this.point_b,e);
var c=vec3.create();vec3.subtract(i,e,c),vec3.scale(c,this.erp/n),this.rows[0].bias=c[0],this.rows[1].bias=c[1],this.rows[2].bias=c[2],quat4.inverse(this.object_b.rotation,a),quat4.multiply(a,this.object_a.rotation),quat4.inverse(this.rotation_difference,s),quat4.multiply(s,a),c[0]=s[0],c[1]=s[1],c[2]=s[2],vec3.scale(c,1*this.erp/n),this.rows[3].bias=c[0],this.rows[4].bias=c[1],this.rows[5].bias=c[2]}}}(),t.ContactDetails=function(){this.object_a=null,this.object_b=null,this.contact_point=vec3.create(),this.contact_point_in_a=vec3.create(),this.contact_point_in_b=vec3.create(),this.contact_normal=vec3.create(),this.penetration_depth=0,this.restitution=0,this.friction=0,this.listeners={}},t.EventEmitter.apply(t.ContactDetails),t.ContactDetails.prototype.destroy=function(){this.emit("destroy"),t.ObjectPool.freeObject("ContactDetails",this)},t.ContactManifold=function(){this.object_a=null,this.object_b=null,this.points=[],this.next_manifold=null},t.ContactManifold.prototype.findWeakestContact=function(t){var o,a,s=-1,n=t.penetration_depth;for(o=0;4>o;o++)a=this.points[o],a.penetration_depth>n&&(n=a.penetration_depth,s=o);var c=0,r=0,h=0,l=0;0!==s&&(vec3.subtract(t.contact_point_in_a,this.points[1].contact_point_in_a,i),vec3.subtract(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a,e),vec3.cross(i,e),c=vec3.squaredLength(i)),1!==s&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,i),vec3.subtract(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a,e),vec3.cross(i,e),r=vec3.squaredLength(i)),2!==s&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,i),vec3.subtract(this.points[3].contact_point_in_a,this.points[1].contact_point_in_a,e),vec3.cross(i,e),h=vec3.squaredLength(i)),3!==s&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,i),vec3.subtract(this.points[2].contact_point_in_a,this.points[1].contact_point_in_a,e),vec3.cross(i,e),l=vec3.squaredLength(i));var p=0,b=c;return r>b&&(p=1,b=r),h>b&&(p=2,b=h),l>b&&(p=3),p},t.ContactManifold.prototype.addContact=function(i){var e;for(e=0;this.points.length>e;e++)if(.02>=vec3.dist(this.points[e].contact_point,i.contact_point))return i.destroy(),void 0;var o=!1;if(null!=i&&(o=i.object_a.emit("newContact",i.object_b,i),o!==!1&&(o=i.object_b.emit("newContact",i.object_a,i)),o===!1))return i.emit("destroy"),t.ObjectPool.freeObject("ContactDetails",i),void 0;if(4>this.points.length)this.points.push(i);else{var a=this.findWeakestContact(i);this.points[a].destroy(),this.points[a]=i}},t.ContactManifold.prototype.update=function(){var t,e,o,a=vec3.create(),s=vec3.create(),n=vec3.create();for(t=0;this.points.length>t;t++)if(o=this.points[t],mat4.multiplyVec3(o.object_a.transform,o.contact_point_in_a,a),mat4.multiplyVec3(o.object_b.transform,o.contact_point_in_b,s),vec3.add(a,s,o.contact_point),vec3.scale(o.contact_point,.5),vec3.subtract(a,s,n),o.penetration_depth=vec3.dot(n,o.contact_normal),-.02>o.penetration_depth){for(o.destroy(),e=t;this.points.length>e;e++)this.points[e]=this.points[e+1];this.points.length=this.points.length-1}else{vec3.scale(o.contact_normal,o.penetration_depth,i),vec3.subtract(a,i,i),vec3.subtract(s,i,i);var c=vec3.squaredLength(i);if(c>.2*.2){for(o.destroy(),e=t;this.points.length>e;e++)this.points[e]=this.points[e+1];this.points.length=this.points.length-1}}},t.ContactManifoldList=function(){this.first=null},t.ContactManifoldList.prototype.insert=function(t){t.next_manifold=this.first,this.first=t},t.ContactManifoldList.prototype.getManifoldForObjects=function(i,e){var o=null;if(null!==this.first)for(var a=this.first;null!==a;){if(a.object_a===i&&a.object_b===e||a.object_a===e&&a.object_b===i){o=a;break}a=a.next_manifold}return null===o&&(o=t.ObjectPool.getObject("ContactManifold"),o.object_a=i,o.object_b=e,this.insert(o)),o},t.ForceGenerator=function(t){this.force=t||vec3.create(),this.enabled=!0,this.affected=[]},t.ForceGenerator.prototype.applyForce=function(){if(this.enabled){var t,i;for(t=0,i=this.affected.length;i>t;t++)this.affected[t].applyForce(this.force)}},t.ForceGenerator.prototype.enable=function(){this.enabled=!0},t.ForceGenerator.prototype.disable=function(){this.enabled=!1},t.ForceGenerator.prototype.affect=function(t){var i,e;for(i=0,e=this.affected.length;e>i;i++)if(this.affected[i]===t)return;this.affected.push(t)},t.ForceGenerator.prototype.unaffect=function(t){var i,e;for(i=0,e=this.affected.length;e>i;i++)if(this.affected[i]===t)return this.affected.splice(i,1),void 0},t.DragForce=function(t,i){this.drag_coefficient=t||0,this.squared_drag_coefficient=i||0,this.enabled=!0,this.affected=[]},t.DragForce.prototype.enable=t.ForceGenerator.prototype.enable,t.DragForce.prototype.disable=t.ForceGenerator.prototype.disable,t.DragForce.prototype.affect=t.ForceGenerator.prototype.affect,t.DragForce.prototype.unaffect=t.ForceGenerator.prototype.unaffect,t.DragForce.prototype.applyForce=function(){if(this.enabled){var t,e,o,a,s=i;for(t=0,e=this.affected.length;e>t;t++)o=this.affected[t],vec3.set(o.linear_velocity,s),a=vec3.length(s),a=this.drag_coefficient*a+this.squared_drag_coefficient*a*a,vec3.normalize(s),vec3.scale(s,-a),o.applyForce(s)}},t.IterativeSolver=function(){this.contact_constraints=[],this.friction_constraints=[],this.all_constraints=[],this.constraints=[],this.max_iterations=10,this.penetrations_max_iterations=5,this.relaxation=.1,this.sor_weight=.85,this.warmstarting_factor=.95},t.IterativeSolver.prototype.addConstraint=function(t){-1===this.constraints.indexOf(t)&&this.constraints.push(t)},t.IterativeSolver.prototype.removeConstraint=function(t){var i=this.constraints.indexOf(t);-1!==i&&this.constraints.splice(i,1)},t.IterativeSolver.prototype.processContactManifolds=function(i){var e,o,a,s,n,c,r=this.contact_constraints,h=this.friction_constraints;a=i.first;for(var l=function(){this.removeListener("deactivate",l);var t=r.indexOf(this);r.splice(t,1)},p=function(){this.removeListener("deactivate",p);var t=h.indexOf(this);h.splice(t,1)};a;){for(s=a.points.length,e=0;s>e;e++){n=a.points[e];var b=null;for(o=0;r.length>o;o++)if(r[o].contact===n){b=r[o];break}for(b?b.update():(c=t.ObjectPool.getObject("ContactConstraint"),c.buildFromContact(n),r.push(c),c.addListener("deactivate",l)),b=null,o=0;h.length>o;o++)if(h[o].contact===n){b=h[o];break}b?b.update():(c=t.ObjectPool.getObject("FrictionConstraint"),c.buildFromContact(n),h.push(c),c.addListener("deactivate",p))}a=a.next_manifold}this.all_constraints.length=0,Array.prototype.push.apply(this.all_constraints,this.friction_constraints),Array.prototype.push.apply(this.all_constraints,this.constraints),Array.prototype.push.apply(this.all_constraints,this.contact_constraints)},t.IterativeSolver.prototype.prepareConstraints=function(t){var i,e,o,a,s,n=this.all_constraints.length;for(a=0;n>a;a++)if(e=this.all_constraints[a],e.active!==!1)for(i=e.rows.length,e.update(t),s=0;i>s;s++)o=e.rows[s],o.multiplier=0,o.computeB(e),o.computeD(),o.computeEta(e,t)},t.IterativeSolver.prototype.resolveContacts=function(){var e,o,s,n,c,r,h,l=0;for(e=0;this.penetrations_max_iterations>e;e++){for(l=0,c=0;this.contact_constraints.length>c;c++){o=this.contact_constraints[c],n=o.rows[0],s=0,null!=o.object_a&&1/0!==o.object_a.mass&&(s+=n.jacobian[0]*o.object_a.push_velocity[0]+n.jacobian[1]*o.object_a.push_velocity[1]+n.jacobian[2]*o.object_a.push_velocity[2]+n.jacobian[3]*o.object_a.turn_velocity[0]+n.jacobian[4]*o.object_a.turn_velocity[1]+n.jacobian[5]*o.object_a.turn_velocity[2]),null!=o.object_b&&1/0!==o.object_b.mass&&(s+=n.jacobian[6]*o.object_b.push_velocity[0]+n.jacobian[7]*o.object_b.push_velocity[1]+n.jacobian[8]*o.object_b.push_velocity[2]+n.jacobian[9]*o.object_b.turn_velocity[0]+n.jacobian[10]*o.object_b.turn_velocity[1]+n.jacobian[11]*o.object_b.turn_velocity[2]),r=(o.contact.penetration_depth-s)/n.D;var p=n.multiplier;n.multiplier=Math.max(n.lower_limit,Math.min(p+r,n.upper_limit)),r=n.multiplier-p,l=Math.max(l,r),o.object_a&&1/0!==o.object_a.mass&&(o.object_a.push_velocity[0]+=r*n.B[0],o.object_a.push_velocity[1]+=r*n.B[1],o.object_a.push_velocity[2]+=r*n.B[2],o.object_a.turn_velocity[0]+=r*n.B[3],o.object_a.turn_velocity[1]+=r*n.B[4],o.object_a.turn_velocity[2]+=r*n.B[5]),o.object_b&&1/0!==o.object_b.mass&&(o.object_b.push_velocity[0]+=r*n.B[6],o.object_b.push_velocity[1]+=r*n.B[7],o.object_b.push_velocity[2]+=r*n.B[8],o.object_b.turn_velocity[0]+=r*n.B[9],o.object_b.turn_velocity[1]+=r*n.B[10],o.object_b.turn_velocity[2]+=r*n.B[11])}if(l>=-t.EPSILON&&t.EPSILON>=l)break;document.title=e}for(c=0;this.contact_constraints.length>c;c++)o=this.contact_constraints[c],n=o.rows[0],null!=o.object_a&&1/0!==o.object_a.mass&&(h=1/o.object_a.mass,o.object_a.position[0]+=h*n.jacobian[0]*n.multiplier*this.relaxation,o.object_a.position[1]+=h*n.jacobian[1]*n.multiplier*this.relaxation,o.object_a.position[2]+=h*n.jacobian[2]*n.multiplier*this.relaxation,i[0]=n.jacobian[3]*n.multiplier*this.relaxation,i[1]=n.jacobian[4]*n.multiplier*this.relaxation,i[2]=n.jacobian[5]*n.multiplier*this.relaxation,mat3.multiplyVec3(o.object_a.inverseInertiaTensorWorldFrame,i),a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=0,quat4.multiply(a,o.object_a.rotation),o.object_a.rotation[0]+=.5*a[0],o.object_a.rotation[1]+=.5*a[1],o.object_a.rotation[2]+=.5*a[2],o.object_a.rotation[3]+=.5*a[3],quat4.normalize(o.object_a.rotation)),null!=o.object_b&&1/0!==o.object_b.mass&&(h=1/o.object_b.mass,o.object_b.position[0]+=h*n.jacobian[6]*n.multiplier*this.relaxation,o.object_b.position[1]+=h*n.jacobian[7]*n.multiplier*this.relaxation,o.object_b.position[2]+=h*n.jacobian[8]*n.multiplier*this.relaxation,i[0]=n.jacobian[9]*n.multiplier*this.relaxation,i[1]=n.jacobian[10]*n.multiplier*this.relaxation,i[2]=n.jacobian[11]*n.multiplier*this.relaxation,mat3.multiplyVec3(o.object_b.inverseInertiaTensorWorldFrame,i),a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=0,quat4.multiply(a,o.object_b.rotation),o.object_b.rotation[0]+=.5*a[0],o.object_b.rotation[1]+=.5*a[1],o.object_b.rotation[2]+=.5*a[2],o.object_b.rotation[3]+=.5*a[3],quat4.normalize(o.object_b.rotation)),n.multiplier=0},t.IterativeSolver.prototype.solveConstraints=function(){var t,i,e,o,a,s,n,c,r,h=this.all_constraints.length,l=0;for(a=0;h>a;a++)if(t=this.all_constraints[a],t.active!==!1)for(s=0;t.rows.length>s;s++)e=t.rows[s],o=e.multiplier_cached*this.warmstarting_factor,e.multiplier=o,t.object_a&&1/0!==t.object_a.mass&&(t.object_a.solver_impulse[0]+=o*e.B[0],t.object_a.solver_impulse[1]+=o*e.B[1],t.object_a.solver_impulse[2]+=o*e.B[2],t.object_a.solver_impulse[3]+=o*e.B[3],t.object_a.solver_impulse[4]+=o*e.B[4],t.object_a.solver_impulse[5]+=o*e.B[5]),t.object_b&&1/0!==t.object_b.mass&&(t.object_b.solver_impulse[0]+=o*e.B[6],t.object_b.solver_impulse[1]+=o*e.B[7],t.object_b.solver_impulse[2]+=o*e.B[8],t.object_b.solver_impulse[3]+=o*e.B[9],t.object_b.solver_impulse[4]+=o*e.B[10],t.object_b.solver_impulse[5]+=o*e.B[11]);for(n=0;this.max_iterations>n;n++){for(l=0,a=0;h>a;a++)if(t=this.all_constraints[a],t.active!==!1)for(i=t.rows.length,s=0;i>s;s++){e=t.rows[s],r=0,null!=t.object_a&&1/0!==t.object_a.mass&&(r+=e.jacobian[0]*t.object_a.solver_impulse[0]+e.jacobian[1]*t.object_a.solver_impulse[1]+e.jacobian[2]*t.object_a.solver_impulse[2]+e.jacobian[3]*t.object_a.solver_impulse[3]+e.jacobian[4]*t.object_a.solver_impulse[4]+e.jacobian[5]*t.object_a.solver_impulse[5]),null!=t.object_b&&1/0!==t.object_b.mass&&(r+=e.jacobian[6]*t.object_b.solver_impulse[0]+e.jacobian[7]*t.object_b.solver_impulse[1]+e.jacobian[8]*t.object_b.solver_impulse[2]+e.jacobian[9]*t.object_b.solver_impulse[3]+e.jacobian[10]*t.object_b.solver_impulse[4]+e.jacobian[11]*t.object_b.solver_impulse[5]),c=(e.eta-r)/e.D*t.factor;var p=e.multiplier,b=p+c;b=this.sor_weight*b+(1-this.sor_weight)*p,e.multiplier=Math.max(e.lower_limit,Math.min(b,e.upper_limit)),c=e.multiplier-p;var _=(t.object_a&&1/0!==t.object_a.mass?t.object_a.mass:0)+(t.object_b&&1/0!==t.object_b.mass?t.object_b.mass:0);l=Math.max(l,Math.abs(c)/_),t.object_a&&1/0!==t.object_a.mass&&(t.object_a.solver_impulse[0]+=c*e.B[0],t.object_a.solver_impulse[1]+=c*e.B[1],t.object_a.solver_impulse[2]+=c*e.B[2],t.object_a.solver_impulse[3]+=c*e.B[3],t.object_a.solver_impulse[4]+=c*e.B[4],t.object_a.solver_impulse[5]+=c*e.B[5]),t.object_b&&1/0!==t.object_b.mass&&(t.object_b.solver_impulse[0]+=c*e.B[6],t.object_b.solver_impulse[1]+=c*e.B[7],t.object_b.solver_impulse[2]+=c*e.B[8],t.object_b.solver_impulse[3]+=c*e.B[9],t.object_b.solver_impulse[4]+=c*e.B[10],t.object_b.solver_impulse[5]+=c*e.B[11])}if(.1>=l)break}},t.IterativeSolver.prototype.applyConstraints=function(t){var o,a,s,n,c,r,h=this.all_constraints.length;for(n=0;h>n;n++)if(o=this.all_constraints[n],o.active!==!1){for(a=o.rows.length,o.last_impulse[0]=o.last_impulse[1]=o.last_impulse[2]=0,c=0;a>c;c++)s=o.rows[c],s.multiplier_cached=s.multiplier,null!=o.object_a&&1/0!==o.object_a.mass&&(r=1/o.object_a.mass,e[0]=r*t*s.jacobian[0]*s.multiplier,e[1]=r*t*s.jacobian[1]*s.multiplier,e[2]=r*t*s.jacobian[2]*s.multiplier,o.object_a.linear_velocity[0]+=e[0],o.object_a.linear_velocity[1]+=e[1],o.object_a.linear_velocity[2]+=e[2],vec3.add(o.last_impulse,e),i[0]=t*s.jacobian[3]*s.multiplier,i[1]=t*s.jacobian[4]*s.multiplier,i[2]=t*s.jacobian[5]*s.multiplier,mat3.multiplyVec3(o.object_a.inverseInertiaTensorWorldFrame,i),o.object_a.angular_velocity[0]+=i[0],o.object_a.angular_velocity[1]+=i[1],o.object_a.angular_velocity[2]+=i[2],vec3.add(o.last_impulse,i)),null!=o.object_b&&1/0!==o.object_b.mass&&(r=1/o.object_b.mass,e[0]=r*t*s.jacobian[6]*s.multiplier,e[1]=r*t*s.jacobian[7]*s.multiplier,e[2]=r*t*s.jacobian[8]*s.multiplier,o.object_b.linear_velocity[0]+=e[0],o.object_b.linear_velocity[1]+=e[1],o.object_b.linear_velocity[2]+=e[2],vec3.add(o.last_impulse,e),i[0]=t*s.jacobian[9]*s.multiplier,i[1]=t*s.jacobian[10]*s.multiplier,i[2]=t*s.jacobian[11]*s.multiplier,mat3.multiplyVec3(o.object_b.inverseInertiaTensorWorldFrame,i),o.object_b.angular_velocity[0]+=i[0],o.object_b.angular_velocity[1]+=i[1],o.object_b.angular_velocity[2]+=i[2],vec3.add(o.last_impulse,i));o.breaking_threshold>0&&vec3.squaredLength(o.last_impulse)>=o.breaking_threshold*o.breaking_threshold&&(o.active=!1)}},t.LinkedList=function(){this.first=null},t.LinkedList.prototype.add=function(t){null==this.first?this.first=t:(this.first.prev=t,t.next=this.first,this.first=t)},t.LinkedList.prototype.remove=function(t){for(var i;i=this.first;){if(i.value===t)return i.prev&&(i.prev=i.next),i.next&&(i.next=i.prev),void 0;i=i.next}},t.LinkedListEntry=function(t){this.value=t,this.prev=null,this.next=null},t.GeometryMethods={findClosestPointInTriangle:function(){var t=vec3.create(),i=vec3.create(),e=vec3.create();return function(o,a,s,n,c){var r;vec3.subtract(s,a,t),vec3.subtract(n,a,i),vec3.subtract(o,a,e);var h=vec3.dot(t,e),l=vec3.dot(i,e);if(0>=h&&0>=l)return vec3.set(a,c),void 0;vec3.subtract(o,s,e);var p=vec3.dot(t,e),b=vec3.dot(i,e);if(p>=0&&p>=b)return vec3.set(s,c),void 0;var _=h*b-p*l;if(0>=_&&h>=0&&0>=p)return r=h/(h-p),vec3.scale(t,r,c),vec3.add(c,a),void 0;vec3.subtract(o,n,e);var u=vec3.dot(t,e),v=vec3.dot(i,e);if(v>=0&&v>=u)return vec3.set(n,c),void 0;var f,d=u*l-h*v;if(0>=d&&l>=0&&0>=v)return f=l/(l-v),vec3.scale(i,f,c),vec3.add(c,a),void 0;var j=p*v-u*b;if(0>=j&&b-p>=0&&u-v>=0)return f=(b-p)/(b-p+(u-v)),vec3.subtract(n,s,c),vec3.scale(c,f),vec3.add(c,s),void 0;var m=1/(j+d+_);r=d*m,f=_*m,vec3.scale(t,r),vec3.add(t,a),vec3.scale(i,f),vec3.add(t,i,c)}}(),findBarycentricCoordinates:function(t,i,e,o,a){var s=vec3.create(),n=vec3.create(),c=vec3.create();vec3.subtract(e,i,s),vec3.subtract(o,i,n),vec3.subtract(t,i,c);var r=vec3.dot(s,s),h=vec3.dot(s,n),l=vec3.dot(n,n),p=vec3.dot(c,s),b=vec3.dot(c,n),_=r*l-h*h;a[1]=(l*p-h*b)/_,a[2]=(r*b-h*p)/_,a[0]=1-a[1]-a[2]}},t.NearPhase=function(){this.contact_manifolds=new t.ContactManifoldList},t.NearPhase.prototype.updateContactManifolds=function(){for(var i=this.contact_manifolds.first,e=null;null!==i;)i.update(),0===i.points.length?(t.ObjectPool.freeObject("ContactManifold",i),null==e?this.contact_manifolds.first=i.next_manifold:e.next_manifold=i.next_manifold,i=i.next_manifold):(e=i,i=i.next_manifold)},t.NearPhase.prototype.midPhase=function(i,e){var o,a;i.shape instanceof t.CompoundShape?(o=i,a=e):(o=e,a=i);for(var s,n,c=t.ObjectPool.getObject("RigidBodyProxy"),r=0;o.shape.child_shapes.length>r;r++)if(s=o.shape.child_shapes[r],c.setFrom(o,s),c.shape instanceof t.CompoundShape||a.shape instanceof t.CompoundShape)this.midPhase(c,a);else if(n=this.getContact(c,a),null!=n){var h,l;if(n.object_a===c?(n.object_a=o,h=c,l=a):(n.object_b=o,h=a,l=c),h instanceof t.RigidBodyProxy)for(;h.parent;)h instanceof t.RigidBodyProxy&&mat4.multiplyVec3(h.shape_data.transform,n.contact_point_in_a),h=h.parent;if(l instanceof t.RigidBodyProxy)for(;l.parent;)l instanceof t.RigidBodyProxy&&mat4.multiplyVec3(l.shape_data.transform,n.contact_point_in_b),l=l.parent;n.object_a=h,n.object_b=l,this.addContact(h,l,n)}t.ObjectPool.freeObject("RigidBodyProxy",c)},t.NearPhase.prototype.getContact=function(i,e){if(i.shape instanceof t.CompoundShape||e.shape instanceof t.CompoundShape)return this.midPhase(i,e),void 0;var o;return i.shape instanceof t.SphereShape&&e.shape instanceof t.SphereShape?o=t.SphereSphere(i,e):i.shape instanceof t.SphereShape&&e.shape instanceof t.BoxShape||i.shape instanceof t.BoxShape&&e.shape instanceof t.SphereShape?o=t.BoxSphere(i,e):null!=(o=t.GjkEpa2.GJK(i,e))&&(o=t.GjkEpa2.EPA(o)),o},t.NearPhase.prototype.addContact=function(t,i,e){this.contact_manifolds.getManifoldForObjects(t,i).addContact(e)},t.NearPhase.prototype.generateContacts=function(t){var i,e,o=t.length;for(this.updateContactManifolds(),i=0;o>i;i++)e=this.getContact(t[i][0],t[i][1]),null!=e&&this.addContact(t[i][0],t[i][1],e)},t.ObjectPool={types:{},pools:{},registerType:function(t,i){this.types[t]=i,this.pools[t]=[]},getObject:function(t){var i=this.pools[t];return 0!==i.length?i.pop():this.types[t]()},freeObject:function(t,i){null!=i.removeAllListeners&&i.removeAllListeners(),this.pools[t].push(i)}},t.ObjectPool.registerType("ContactDetails",function(){return new t.ContactDetails}),t.ObjectPool.registerType("ContactManifold",function(){return new t.ContactManifold}),t.ObjectPool.registerType("GJK2SupportPoint",function(){return new t.GjkEpa2.SupportPoint(vec3.create(),vec3.create(),vec3.create())}),t.ObjectPool.registerType("ConstraintRow",function(){return new t.ConstraintRow}),t.ObjectPool.registerType("ContactConstraint",function(){return new t.ContactConstraint}),t.ObjectPool.registerType("FrictionConstraint",function(){return new t.FrictionConstraint}),t.ObjectPool.registerType("RayIntersection",function(){return new t.RayIntersection}),t.ObjectPool.registerType("RigidBodyProxy",function(){return new t.RigidBodyProxy}),t.RayIntersection=function(){this.object=null,this.point=vec3.create(),this.t=null,this.normal=vec3.create()},t.RigidBody=function(){var i=0;return function(e,o){this.id=i++,this.shape=e,this.aabb=new t.AABB,this.mass=o||1/0,this.position=vec3.create(),this.rotation=quat4.createFrom(0,0,0,1),this.linear_velocity=vec3.create(),this.angular_velocity=vec3.create(),this.transform=mat4.identity(),this.transform_inverse=mat4.identity(),this.inertiaTensor=e.getInertiaTensor(o),this.inverseInertiaTensor=mat3.inverse(this.inertiaTensor),this.inertiaTensorWorldFrame=mat3.create(),this.inverseInertiaTensorWorldFrame=mat3.create(),this.acceleration=vec3.create(),this.restitution=.1,this.friction=.5,this.gravity=null,this.linear_damping=0,this.angular_damping=0,this.world=null,this.accumulated_force=vec3.create(),this.accumulated_torque=vec3.create(),this.push_velocity=vec3.create(),this.turn_velocity=vec3.create(),this.solver_impulse=new Float64Array(6),this.updateDerived(),this.listeners={}}}(),t.EventEmitter.apply(t.RigidBody),t.RigidBody.prototype.findSupportPoint=function(){var t=vec3.create();return function(i,e){var o=this.transform_inverse[12],a=this.transform_inverse[13],s=this.transform_inverse[14];this.transform_inverse[12]=this.transform_inverse[13]=this.transform_inverse[14]=0,mat4.multiplyVec3(this.transform_inverse,i,t),this.transform_inverse[12]=o,this.transform_inverse[13]=a,this.transform_inverse[14]=s,this.shape.findSupportPoint(t,e),mat4.multiplyVec3(this.transform,e)}}(),t.RigidBody.prototype.rayIntersect=function(){var t=vec3.create(),i=vec3.create();return function(e,o,a){mat4.multiplyVec3(this.transform_inverse,e,t),mat4.multiplyVec3(this.transform_inverse,o,i);var s=this.shape.rayIntersect(t,i);null!=s&&(s.object=this,mat4.multiplyVec3(this.transform,s.point),mat4.toMat3(this.transform,n),mat3.multiplyVec3(n,s.normal),a.push(s))}}(),t.RigidBody.prototype.integrate=function(t){if(1/0!==this.mass){var e=1/this.mass;vec3.scale(this.accumulated_force,e,i),vec3.add(this.linear_velocity,i),mat3.multiplyVec3(this.inverseInertiaTensorWorldFrame,this.accumulated_torque,i),vec3.add(this.angular_velocity,i),vec3.scale(this.linear_velocity,Math.pow(1-this.linear_damping,t)),vec3.scale(this.angular_velocity,Math.pow(1-this.angular_damping,t)),vec3.scale(this.linear_velocity,t,i),vec3.add(this.position,i),a[0]=this.angular_velocity[0]*t,a[1]=this.angular_velocity[1]*t,a[2]=this.angular_velocity[2]*t,a[3]=0,quat4.multiply(a,this.rotation);var o=.5;this.rotation[0]+=o*a[0],this.rotation[1]+=o*a[1],this.rotation[2]+=o*a[2],this.rotation[3]+=o*a[3],quat4.normalize(this.rotation),this.accumulated_force[0]=this.accumulated_force[1]=this.accumulated_force[2]=0,this.accumulated_torque[0]=this.accumulated_torque[1]=this.accumulated_torque[2]=0,this.solver_impulse[0]=this.solver_impulse[1]=this.solver_impulse[2]=this.solver_impulse[3]=this.solver_impulse[4]=this.solver_impulse[5]=0,this.push_velocity[0]=this.push_velocity[1]=this.push_velocity[2]=0,this.turn_velocity[0]=this.turn_velocity[1]=this.turn_velocity[2]=0}},t.RigidBody.prototype.setGravity=function(t,i,e){this.gravity?(this.gravity[0]=t,this.gravity[1]=i,this.gravity[2]=e):this.gravity=vec3.createFrom(t,i,e)},t.RigidBody.prototype.applyImpulse=function(t){vec3.add(this.linear_velocity,t)},t.RigidBody.prototype.applyForce=function(t){vec3.add(this.accumulated_force,t)},t.RigidBody.prototype.applyForceAtWorldPoint=function(t,e){var o=i;vec3.set(e,o),vec3.subtract(o,this.position),vec3.cross(o,t),vec3.add(this.accumulated_force,t),vec3.add(this.accumulated_torque,o)},t.RigidBody.prototype.applyForceAtLocalPoint=function(t,e){var o=i;mat4.multiplyVec3(this.transform,e,o),this.applyForceAtWorldPoint(t,o)},t.RigidBody.prototype.getVelocityInLocalPoint=function(t,i){vec3.set(this.angular_velocity,i),vec3.cross(i,t),vec3.add(i,this.linear_velocity)},t.RigidBody.prototype.updateDerived=function(){quat4.normalize(this.rotation),mat4.fromRotationTranslation(this.rotation,this.position,this.transform),mat4.inverse(this.transform,this.transform_inverse),1/0!==this.mass&&this.updateInverseInertiaTensorWorldFrame(),this.aabb.transform(this.shape.aabb,this.transform)},t.RigidBody.prototype.updateInverseInertiaTensorWorldFrame=function(){var t=this.transform,i=this.inverseInertiaTensorWorldFrame,e=this.inverseInertiaTensor;this.rotation;var o=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],a=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],s=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],n=t[4]*e[0]+t[5]*e[3]+t[6]*e[6],c=t[4]*e[1]+t[5]*e[4]+t[6]*e[7],r=t[4]*e[2]+t[5]*e[5]+t[6]*e[8],h=t[8]*e[0]+t[9]*e[3]+t[10]*e[6],l=t[8]*e[1]+t[9]*e[4]+t[10]*e[7],p=t[8]*e[2]+t[9]*e[5]+t[10]*e[8];i[0]=o*t[0]+a*t[1]+s*t[2],i[1]=o*t[4]+a*t[5]+s*t[6],i[2]=o*t[8]+a*t[9]+s*t[10],i[3]=n*t[0]+c*t[1]+r*t[2],i[4]=n*t[4]+c*t[5]+r*t[6],i[5]=n*t[8]+c*t[9]+r*t[10],i[6]=h*t[0]+l*t[1]+p*t[2],i[7]=h*t[4]+l*t[5]+p*t[6],i[8]=h*t[8]+l*t[9]+p*t[10],mat3.inverse(this.inverseInertiaTensorWorldFrame,this.inertiaTensorWorldFrame)},t.RigidBodyProxy=function(){this.parent=null,this.id=null,this.shape=null,this.aabb=new t.AABB,this.mass=null,this.position=vec3.create(),this.rotation=quat4.create(),this.transform=mat4.create(),this.transform_inverse=mat4.create(),this.restitution=null,this.friction=null},t.RigidBodyProxy.prototype.setFrom=function(t,i){this.parent=t,this.id=t.id,this.shape=i.shape,this.shape_data=i,this.mass=t.mass,mat4.multiplyVec3(t.transform,i.position,this.position),quat4.multiply(t.rotation,i.rotation,this.rotation),mat4.fromRotationTranslation(this.rotation,this.position,this.transform),mat4.inverse(this.transform,this.transform_inverse),this.aabb.transform(this.shape.aabb,this.transform),this.restitution=t.restitution,this.friction=t.friction},t.RigidBodyProxy.prototype.findSupportPoint=t.RigidBody.prototype.findSupportPoint,t.RigidBodyProxy.prototype.getRigidBody=function(){for(var t=this.parent;t.parent;)t=this.parent;return t},t.BoxShape=function(i,e,o){this.half_width=i,this.half_height=e,this.half_depth=o,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.BoxShape.prototype.calculateLocalAABB=function(t){t.min[0]=-this.half_width,t.min[1]=-this.half_height,t.min[2]=-this.half_depth,t.max[0]=this.half_width,t.max[1]=this.half_height,t.max[2]=this.half_depth},t.BoxShape.prototype.getInertiaTensor=function(t){var i=4*this.half_height*this.half_height,e=4*this.half_width*this.half_width,o=4*this.half_depth*this.half_depth,a=.0833*t;return mat3.createFrom(a*(i+o),0,0,0,a*(e+o),0,0,0,a*(i+e))},t.BoxShape.prototype.findSupportPoint=function(t,i){i[0]=0>t[0]?-this.half_width:this.half_width,i[1]=0>t[1]?-this.half_height:this.half_height,i[2]=0>t[2]?-this.half_depth:this.half_depth},t.BoxShape.prototype.rayIntersect=function(){var i,e,o,a,s,n,c=vec3.create();return function(r,h){i=0,vec3.subtract(h,r,c),e=vec3.length(c),vec3.scale(c,1/e);for(var l=0;3>l;l++){if(n=0===l?this.half_width:1===l?this.half_height:this.half_depth,Math.abs(c[l])<t.EPSILON&&(-n>r[l]||r[l]>n))return null;if(o=1/c[l],a=(-n-r[l])*o,s=(n-r[l])*o,a>s&&(o=a,a=s,s=o),i=Math.max(i,a),e=Math.min(e,s),i>e)return null}var p=t.ObjectPool.getObject("RayIntersection");p.object=this,p.t=i,vec3.scale(c,i,p.point),vec3.add(p.point,r);var b=1/0;for(l=0;3>l;l++)n=0===l?this.half_width:1===l?this.half_height:this.half_depth,b>n-Math.abs(p.point[l])&&(p.normal[0]=p.normal[1]=p.normal[2]=0,p.normal[l]=0>p.point[l]?-1:1,b=n-Math.abs(p.point[l]));return p}}(),t.CompoundShape=function(){this.child_shapes=[],this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.CompoundShape.prototype.addChildShape=function(i,e,o){this.child_shapes.push(new t.CompoundShapeChild(i,e,o)),this.calculateLocalAABB(this.aabb)},t.CompoundShape.prototype.calculateLocalAABB=function(i){i.min[0]=i.min[1]=i.min[2]=1/0,i.max[0]=i.max[1]=i.max[2]=-1/0;var e,o;for(new t.AABB,e=0;this.child_shapes.length>e;e++)o=this.child_shapes[e],i.min[0]=Math.min(i.min[0],o.aabb.min[0]),i.min[1]=Math.min(i.min[1],o.aabb.min[1]),i.min[2]=Math.min(i.min[2],o.aabb.min[2]),i.max[0]=Math.max(i.max[0],o.aabb.max[0]),i.max[1]=Math.max(i.max[1],o.aabb.max[1]),i.max[2]=Math.max(i.max[2],o.aabb.max[2])},t.CompoundShape.prototype.getInertiaTensor=function(t){var e,o,a,s=mat3.identity(),r=mat3.create();for(t/=this.child_shapes.length,i[0]=i[1]=i[2]=0,e=0;this.child_shapes.length>e;e++)o=this.child_shapes[e],vec3.subtract(i,o.position),r[0]=t*-(i[1]*i[1]+i[2]*i[1]),r[1]=t*i[0]*i[1],r[2]=t*i[0]*i[2],r[3]=t*i[0]*i[1],r[4]=t*-(i[0]*i[0]+i[2]*i[2]),r[5]=t*i[1]*i[2],r[6]=t*i[0]*i[2],r[7]=t*i[1]*i[2],r[8]=t*-(i[0]*i[0]+i[1]*i[1]),mat4.toMat3(o.transform,n),a=o.shape.getInertiaTensor(t),mat3.transpose(n,c),mat3.multiply(n,a),mat3.multiply(n,c),s[0]+=n[0]+r[0],s[1]+=n[1]+r[1],s[2]+=n[2]+r[2],s[3]+=n[3]+r[3],s[4]+=n[4]+r[4],s[5]+=n[5]+r[5],s[6]+=n[6]+r[6],s[7]+=n[7]+r[7],s[8]+=n[8]+r[8];return s},t.CompoundShape.prototype.rayIntersect=function(){var t=function(t,i){return t.t<i.t?-1:t.t>i.t?1:0};return function(i,e){var o,a,s,n=[],c=vec3.create(),r=vec3.create();for(a=0;this.child_shapes.length>a;a++)s=this.child_shapes[a],mat4.multiplyVec3(s.transform_inverse,i,c),mat4.multiplyVec3(s.transform_inverse,e,r),o=s.shape.rayIntersect(c,r),null!=o&&(o.object=this,mat4.multiplyVec3(s.transform,o.point),n.push(o));return n.sort(t),n[0]||null}}(),t.CompoundShapeChild=function(i,e,o){this.shape=i,this.position=vec3.createFrom.apply(vec3,e),this.rotation=quat4.createFrom.apply(quat4,o),this.transform=mat4.create(),this.transform_inverse=mat4.create(),mat4.fromRotationTranslation(this.rotation,this.position,this.transform),mat4.inverse(this.transform,this.transform_inverse),this.aabb=new t.AABB,this.aabb.transform(this.shape.aabb,this.transform)},t.ConeShape=function(i,e){this.radius=i,this.half_height=e,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb),this._sinangle=this.radius/Math.sqrt(this.radius*this.radius+Math.pow(2*this.half_height,2)),this._cosangle=Math.cos(Math.asin(this._sinangle))},t.ConeShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[2]=-this.radius,t.min[1]=-this.half_height,t.max[0]=t.max[2]=this.radius,t.max[1]=this.half_height},t.ConeShape.prototype.getInertiaTensor=function(t){var i=.1*t*Math.pow(2*this.half_height,2)+.15*t*this.radius*this.radius;return mat3.createFrom(i,0,0,0,.3*t*this.radius*this.radius,0,0,0,i)},t.ConeShape.prototype.findSupportPoint=function(t,i){var e=Math.sqrt(t[0]*t[0]+t[2]*t[2]);if(t[1]>vec3.length(t)*this._sinangle)i[0]=i[2]=0,i[1]=this.half_height;else if(e>0){var o=this.radius/e;i[0]=o*t[0],i[1]=-this.half_height,i[2]=o*t[2]}else i[0]=i[2]=0,i[1]=-this.half_height},t.ConeShape.prototype.rayIntersect=function(){var i,e=vec3.create(),o=vec3.create(),a=vec3.create(),s=vec3.create(),n=vec3.create();return function(c,r){vec3.subtract(r,c,e),i=vec3.length(e),vec3.scale(e,1/i);var h,l;o[0]=o[1]=o[2]=0,h=this._rayIntersectBase(c,r,o,s),a[0]=a[1]=a[2]=0,l=this._rayIntersectCone(c,e,i,a,n);var p;return h||l?!l||h&&l>h?(p=t.ObjectPool.getObject("RayIntersection"),p.object=this,p.t=h,vec3.set(o,p.point),vec3.set(s,p.normal),p):!h||l&&h>l?(p=t.ObjectPool.getObject("RayIntersection"),p.object=this,p.t=l,vec3.set(a,p.point),vec3.set(n,p.normal),p):null:null}}(),t.ConeShape.prototype._rayIntersectBase=function(){var t,i=vec3.createFrom(0,-1,0),e=vec3.create(),o=vec3.create(),a=vec3.create();return function(s,n,c,r){return o[0]=s[0],o[1]=s[1]+this.half_height,o[2]=s[2],a[0]=n[0],a[1]=n[1]+this.half_height,a[2]=n[2],vec3.subtract(a,o,e),t=-vec3.dot(i,o)/vec3.dot(i,e),0>t||t>1?null:(vec3.scale(e,t,c),vec3.add(c,s),c[0]*c[0]+c[2]*c[2]>this.radius*this.radius?null:(r[0]=r[2]=0,r[1]=-1,t*vec3.length(e)))}}(),t.ConeShape.prototype._rayIntersectCone=function(){var e=vec3.create();return function(o,a,s,n,c){var r=vec3.createFrom(0,-1,0),h=vec3.dot(r,a),l=this._cosangle*this._cosangle,p=vec3.create();p[0]=o[0],p[1]=o[1]-this.half_height,p[2]=o[2];var b,_,u=vec3.dot(r,p),v=vec3.dot(a,p),f=vec3.dot(p,p),d=h*h-l,j=h*u-l*v,m=u*u-l*f,y=null;if(Math.abs(d)>=t.EPSILON){var g=j*j-m*d;if(-t.EPSILON>g)return null;if(g>t.EPSILON){var w=Math.sqrt(g),B=1/d;if(_=(-j-w)*B,_>=0&&s>=_&&(vec3.scale(a,_,e),vec3.add(e,o),p[1]=e[1]-this.half_height,b=vec3.dot(p,r),b>=0&&(y=_,vec3.set(e,n))),_=(-j+w)*B,_>=0&&s>=_&&(null==y||y>_)&&(vec3.scale(a,_,e),vec3.add(e,o),p[1]=e[1]-this.half_height,b=vec3.dot(p,r),b>=0&&(y=_,vec3.set(e,n))),null==y)return null;y/=s}else{if(_=-j/d,vec3.scale(a,_,e),vec3.add(e,o),p[1]=e[1]-this.half_height,b=vec3.dot(p,r),0>b)return null;if(vec3.subtract(e,o,i),vec3.squaredLength(i)>s*s)return null;y=_/s,vec3.set(e,n)}}else{if(!(Math.abs(j)>=t.EPSILON))return null;if(_=.5*m/j,vec3.scale(a,_,e),vec3.add(e,o),p[1]=e[1]-this.half_height,b=vec3.dot(p,r),0>b)return null;y=_,vec3.set(e,n)}return n[1]<-this.half_height?null:(c[0]=n[0],c[1]=0,c[2]=n[2],vec3.normalize(c),c[0]*=2*this.half_height/this.radius,c[1]=this.radius/(2*this.half_height),c[2]*=2*this.half_height/this.radius,vec3.normalize(c),y*s)}}(),t.CylinderShape=function(i,e){this.radius=i,this.half_height=e,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.CylinderShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[2]=-this.radius,t.min[1]=-this.half_height,t.max[0]=t.max[2]=this.radius,t.max[1]=this.half_height
},t.CylinderShape.prototype.getInertiaTensor=function(t){var i=.0833*t*(3*this.radius*this.radius+(this.half_height+this.half_height)*(this.half_height+this.half_height));return mat3.createFrom(i,0,0,0,.5*t*this.radius*this.radius,0,0,0,i)},t.CylinderShape.prototype.findSupportPoint=function(t,i){if(i[1]=0>t[1]?-this.half_height:this.half_height,0===t[0]&&0===t[2])i[0]=i[2]=0;else{var e=Math.sqrt(t[0]*t[0]+t[2]*t[2]),o=this.radius/e;i[0]=o*t[0],i[2]=o*t[2]}},t.CylinderShape.prototype.rayIntersect=function(){var i=vec3.create(),e=vec3.create();return function(o,a){i[1]=this.half_height,e[1]=-this.half_height;var s=vec3.create();vec3.subtract(e,i,s);var n=vec3.create();vec3.subtract(o,i,n);var c=vec3.create();vec3.subtract(a,o,c);var r=vec3.dot(n,s),h=vec3.dot(c,s),l=vec3.dot(s,s);if(0>r&&0>r+h)return null;if(r>l&&r+h>l)return null;var p,b,_=vec3.dot(c,c),u=vec3.dot(n,c),v=l*_-h*h,f=vec3.dot(n,n)-this.radius*this.radius,d=l*f-r*r;if(Math.abs(v)<t.EPSILON){if(d>0)return null;p=0>r?-u/_:r>l?(h-u)/_:0}else{var j=l*u-h*r,m=j*j-v*d;if(0>m)return null;if(b=p=(-j-Math.sqrt(m))/v,0>r+p*h){if(0>=h)return null;if(p=-r/h,!(0>=f+p*(2*u+p*_)))return null;b=p}else if(r+p*h>l){if(h>=0)return null;if(p=(l-r)/h,!(0>=f+l-2*r+p*(2*(u-h)+p*_)))return null;b=p}if(p=b,0>p||p>1)return null}var y=t.ObjectPool.getObject("RayIntersection");return y.object=this,y.t=p*vec3.length(c),vec3.scale(c,p,y.point),vec3.add(y.point,o),Math.abs(y.point[1]-this.half_height)<=t.EPSILON?(y.normal[0]=y.normal[2]=0,y.normal[1]=0>y.point[1]?-1:1):(y.normal[1]=0,y.normal[0]=y.point[0],y.normal[2]=y.point[2],vec3.scale(y.normal,1/this.radius)),y}}(),t.PlaneShape=function(i,e,o){this.orientation=i,this.half_width=e,this.half_length=o,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb),0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0)},t.PlaneShape.prototype.calculateLocalAABB=function(t){0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length,t.min[0]=0,t.min[1]=-this.half_width,t.min[2]=-this.half_length,t.max[0]=0,t.max[1]=this.half_width,t.max[2]=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length,t.min[0]=-this.half_width,t.min[1]=0,t.min[2]=-this.half_length,t.max[0]=this.half_width,t.max[1]=0,t.max[2]=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0,t.min[0]=-this.half_width,t.min[1]=-this.half_length,t.min[2]=0,t.max[0]=this.half_width,t.max[1]=this.half_length,t.max[2]=0)},t.PlaneShape.prototype.getInertiaTensor=function(t){var i=4*this.half_width*this.half_width,e=4*this.half_length*this.half_length,o=.0833*t,a=o*e,s=o*(i+e),n=o*i;return 0===this.orientation?mat3.createFrom(s,0,0,0,a,0,0,0,n):1===this.orientation?mat3.createFrom(a,0,0,0,s,0,0,0,n):mat3.createFrom(s,0,0,0,n,0,0,0,a)},t.PlaneShape.prototype.findSupportPoint=function(t,i){i[0]=0>t[0]?-this._half_width:this._half_width,i[1]=0>t[1]?-this._half_height:this._half_height,i[2]=0>t[2]?-this._half_depth:this._half_depth},t.PlaneShape.prototype.rayIntersect=function(){var i,e=vec3.create(),o=vec3.create(),a=vec3.create();return function(s,n){if(0===this.orientation?(e[0]=1,e[1]=e[2]=0):1===this.orientation?(e[1]=1,e[0]=e[2]=0):(e[2]=1,e[0]=e[1]=0),vec3.subtract(n,s,o),i=-vec3.dot(e,s)/vec3.dot(e,o),0>i||i>1)return null;if(vec3.scale(o,i,a),vec3.add(a,s),a[0]<-this._half_width||a[0]>this._half_width)return null;if(a[1]<-this._half_height||a[1]>this._half_height)return null;if(a[2]<-this._half_depth||a[2]>this._half_depth)return null;var c=t.ObjectPool.getObject("RayIntersection");return c.object=this,c.t=i*vec3.length(o),vec3.set(a,c.point),vec3.set(e,c.normal),c}}(),t.SphereShape=function(i){this.radius=i,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.SphereShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[1]=t.min[2]=-this.radius,t.max[0]=t.max[1]=t.max[2]=this.radius},t.SphereShape.prototype.getInertiaTensor=function(t){var i=.4*t*this.radius*this.radius;return mat3.createFrom(i,0,0,0,i,0,0,0,i)},t.SphereShape.prototype.findSupportPoint=function(){var t=vec3.create();return function(i,e){vec3.normalize(i,t),vec3.scale(t,this.radius,e)}}(),t.SphereShape.prototype.rayIntersect=function(){var i,e=vec3.create();return function(o,a){vec3.subtract(a,o,e),i=vec3.length(e),vec3.scale(e,1/i);var s=vec3.dot(o,e),n=vec3.dot(o,o)-this.radius*this.radius;if(s>=0&&n>=0)return null;var c=s*s-n;if(0>c)return null;var r=Math.sqrt(c),h=-s-r;if(0>h&&(h=-s+r),h>i)return null;var l=t.ObjectPool.getObject("RayIntersection");return l.object=this,vec3.scale(e,h,l.point),l.t=h,vec3.add(l.point,o),vec3.normalize(l.point,l.normal),l}}(),t.World=function(t,i,e){this.ticks=0,this.broadphase=t,this.nearphase=i,this.solver=e,e.world=this,this.mass_points=[],this.rigid_bodies=[],this.gravity=vec3.createFrom(0,-9.8,0),this.force_generators=[],this.listeners={}},t.EventEmitter.apply(t.World),t.World.prototype.step=function(t,e){e=e||t;var o,a,s,n,c,r;for(s=t/e,o=0;s>o;o++){for(this.ticks++,a=Math.min(e,t),t-=e,this.emit("stepStart",this.ticks,a),n=0,c=this.rigid_bodies.length;c>n;n++)this.rigid_bodies[n].updateDerived();for(n=0,c=this.rigid_bodies.length;c>n;n++)r=this.rigid_bodies[n],1/0!==r.mass&&(vec3.scale(r.gravity||this.gravity,r.mass*a,i),vec3.add(r.accumulated_force,i));for(n=0,c=this.force_generators.length;c>n;n++)this.force_generators[n].applyForce();for(this.broadphase.predictContactPairs(),this.nearphase.generateContacts(this.broadphase.collision_pairs),this.solver.processContactManifolds(this.nearphase.contact_manifolds),this.solver.prepareConstraints(a),this.solver.resolveContacts(),this.solver.solveConstraints(),this.solver.applyConstraints(a),n=0,c=this.rigid_bodies.length;c>n;n++)r=this.rigid_bodies[n],r.integrate(a);this.emit("stepEnd",this.ticks,a)}},t.World.prototype.addRigidBody=function(t){t.world=this,t.updateDerived(),this.rigid_bodies.push(t),this.broadphase.addBody(t)},t.World.prototype.removeRigidBody=function(t){var i,e=this.rigid_bodies.length;for(i=0;e>i;i++)if(this.rigid_bodies[i]===t){this.rigid_bodies.splice(i,1),this.broadphase.removeBody(t);break}},t.World.prototype.addForceGenerator=function(t){var i,e;for(i=0,e=this.force_generators.length;e>i;i++)if(this.force_generators[i]===t)return;this.force_generators.push(t)},t.World.prototype.removeForceGenerator=function(t){var i,e;for(i=0,e=this.force_generators.length;e>i;i++)if(this.force_generators[i]===t)return this.force_generators.splice(i,1),void 0},t.World.prototype.addConstraint=function(t){this.solver.addConstraint(t)},t.World.prototype.removeConstraint=function(t){this.solver.removeConstraint(t)},t.World.prototype.rayIntersect=function(){var t=function(t,i){return t.t<i.t?-1:t.t>i.t?1:0};return function(i,e){var o=this.broadphase.rayIntersect(i,e);return o.sort(t),o}}(),t}();