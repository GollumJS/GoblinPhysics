(function(){var t=quat4.create();vec3.create(),quat4.rotateByVector=function(e,i,o){return o||(o=e),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,quat4.multiply(t,e),o},quat4.addScaledVector=function(e,i,o,n){n||(n=e);var a=Math.cos(i[0]*o/2),c=Math.cos(i[1]*o/2),s=Math.cos(i[2]*o/2),r=Math.sin(i[0]*o/2),h=Math.sin(i[1]*o/2),p=Math.sin(i[2]*o/2);return t[0]=r*c*s+a*h*p,t[1]=a*h*s-r*c*p,t[2]=a*c*p+r*h*s,t[3]=a*c*s-r*h*p,quat4.multiply(e,t),n}})(),window.Goblin=function(){"use strict";var t={},e=vec3.create(),i=vec3.create(),o=vec3.create(),n=quat4.create();return mat3.create(),mat3.create(),t.EPSILON=1e-6,t.BasicBroadphase=function(){this.bodies=[],this.collision_pairs=[]},t.BasicBroadphase.prototype.addBody=function(t){this.bodies.push(t)},t.BasicBroadphase.prototype.removeBody=function(t){var e,i=this.bodies.length;for(e=0;i>e;e++)if(this.bodies[e]===t){this.bodies.splice(e,1);break}},t.BasicBroadphase.prototype.predictContactPairs=function(){var t,i,o,n,a,c=e,s=this.bodies.length;for(this.collision_pairs.length=0,t=0;s>t;t++)for(o=this.bodies[t],i=0;s>i;i++)i>=t||(n=this.bodies[i],(1/0!==o.mass||1/0!==n.mass)&&(vec3.subtract(o.position,n.position,c),a=vec3.length(c)-o.bounding_radius-n.bounding_radius,0>=a&&this.collision_pairs.push([o,n])))},t.BoxSphere=function(n,a){var c,s=n.shape instanceof t.SphereShape?n:a,r=n.shape instanceof t.SphereShape?a:n;if(mat4.multiplyVec3(a.transform_inverse,s.position,e),!(Math.abs(e[0])-s.bounding_radius>r.shape.half_width||Math.abs(e[1])-s.bounding_radius>r.shape.half_height||Math.abs(e[2])-s.bounding_radius>r.shape.half_depth)){i[0]=i[1]=i[2]=0;var h=e[0];if(h>r.shape.half_width?h=r.shape.half_width:-r.shape.half_width>h&&(h=-r.shape.half_width),i[0]=h,h=e[1],h>r.shape.half_height?h=r.shape.half_height:-r.shape.half_height>h&&(h=-r.shape.half_height),i[1]=h,h=e[2],h>r.shape.half_depth?h=r.shape.half_depth:-r.shape.half_depth>h&&(h=-r.shape.half_depth),i[2]=h,vec3.subtract(i,e,o),h=vec3.squaredLength(o),!(h>s.bounding_radius*s.bounding_radius))return c=t.ObjectPool.getObject("ContactDetails"),c.object_a=s,c.object_b=r,vec3.set(i,c.contact_point_in_b),mat4.multiplyVec3(r.transform,i),vec3.subtract(s.position,i,o),vec3.normalize(o,c.contact_normal),vec3.scale(c.contact_normal,-1),vec3.set(i,c.contact_point),mat4.multiplyVec3(c.object_a.transform_inverse,i,c.contact_point_in_a),mat4.multiplyVec3(c.object_b.transform_inverse,i,c.contact_point_in_b),c.penetration_depth=s.bounding_radius-Math.sqrt(h),c.restitution=(s.restitution+r.restitution)/2,c.friction=(s.friction+r.friction)/2,c}},t.GjkEpa={SupportPoint:function(t,e,i,o){this.direction=t,this.witness_a=e,this.witness_b=i,this.point=o},findSupportPoint:function(t,i,o,n){vec3.set(o,n.direction),t.findSupportPoint(o,n.witness_a),vec3.negate(o,e),i.findSupportPoint(e,n.witness_b),vec3.subtract(n.witness_a,n.witness_b,n.point)},GJK:function(){var o,n=[],a=vec3.create(),c=0,s=20,r=vec3.create(),h=vec3.create(),p=vec3.create(),l=vec3.create(),_=vec3.create(),u=vec3.create(),v=vec3.create(),b=vec3.create(),d=!0,f=e,j=i,m=function(e,i){var o,n,a,c;if(2===e.length){if(o=e[1],n=e[0],vec3.negate(o.point,r),vec3.subtract(n.point,o.point,h),0===r[0]&&0===r[1]&&0===r[2])return!0;vec3.dot(h,r)>=0?(vec3.cross(h,r,i),vec3.cross(i,h),0===i[0]&&0===i[1]&&0===i[2]&&(vec3.normalize(h),i[0]=1-Math.abs(h[0]),i[1]=1-Math.abs(h[1]),i[2]=1-Math.abs(h[2]))):(vec3.set(r,i),e.length=1)}else if(3===e.length)o=e[2],n=e[1],a=e[0],vec3.negate(o.point,r),vec3.subtract(n.point,o.point,h),vec3.subtract(a.point,o.point,p),vec3.cross(h,p,_),vec3.cross(h,_,u),vec3.cross(_,p,v),vec3.dot(v,r)>=0?vec3.dot(p,r)>=0?(e.length=0,e.push(a,o),vec3.cross(p,r,i),vec3.cross(i,p)):vec3.dot(h,r)>=0?(e.length=0,e.push(n,o),vec3.cross(h,r,i),vec3.cross(i,h)):(e.length=0,e.push(o)):vec3.dot(u,r)>=0?vec3.dot(h,r)>=0?(e.length=0,e.push(n,o),vec3.cross(h,r,i),vec3.cross(i,h)):(e.length=0,e.push(o)):vec3.dot(_,r)>=0?vec3.set(_,i):(vec3.set(_,i),vec3.negate(i),e.length=0,e.push(o,n,a));else if(4===e.length){if(o=e[3],n=e[2],a=e[1],c=e[0],vec3.negate(o.point,r),d=!0,vec3.subtract(c.point,o.point,h),vec3.subtract(a.point,o.point,l),vec3.cross(h,l,v),vec3.dot(v,o.point)>0&&(d=!1),vec3.subtract(a.point,o.point,h),vec3.subtract(n.point,o.point,l),vec3.cross(h,l,v),vec3.dot(v,o.point)>0&&(d=!1),vec3.subtract(n.point,o.point,h),vec3.subtract(c.point,o.point,l),vec3.cross(h,l,v),vec3.dot(v,o.point)>0&&(d=!1),vec3.subtract(n.point,c.point,h),vec3.subtract(a.point,c.point,l),vec3.cross(h,l,v),vec3.dot(v,c.point)>0&&(d=!1),d)return d;var s=1/0,m=0;if(t.GeometryMethods.findClosestPointInTriangle(b,c.point,a.point,o.point,j),vec3.squaredLength(j)<t.EPSILON)return!0;if(vec3.subtract(c.point,o.point,h),vec3.subtract(a.point,o.point,l),vec3.cross(h,l,f),m=vec3.length(j),s>m&&(s=m,vec3.set(f,i),e.length=0,e.push(o,a,c)),t.GeometryMethods.findClosestPointInTriangle(b,a.point,n.point,o.point,j),vec3.squaredLength(j)<t.EPSILON)return!0;if(vec3.subtract(a.point,o.point,h),vec3.subtract(n.point,o.point,l),vec3.cross(h,l,f),m=vec3.length(j),s>m&&(s=m,vec3.set(f,i),e.length=0,e.push(o,n,a)),t.GeometryMethods.findClosestPointInTriangle(b,n.point,c.point,o.point,j),vec3.squaredLength(j)<t.EPSILON)return!0;if(vec3.subtract(n.point,o.point,h),vec3.subtract(c.point,o.point,l),vec3.cross(h,l,f),m=vec3.length(j),s>m&&(s=m,vec3.set(f,i),e.length=0,e.push(n,c,o)),t.GeometryMethods.findClosestPointInTriangle(b,c.point,n.point,a.point,j),vec3.squaredLength(j)<t.EPSILON)return!0;vec3.subtract(c.point,a.point,h),vec3.subtract(n.point,a.point,l),vec3.cross(h,l,f),m=vec3.length(j),s>m&&(s=m,vec3.set(f,i),e.length=0,e.push(a,n,c))}return!1};return function(e,i){if(n.length=0,c=0,vec3.subtract(i.position,e.position,a),vec3.normalize(a),o=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(e,i,a,o),n.push(o),0>vec3.dot(n[0].point,a))return!1;for(vec3.negate(a);;){if(c++,c===s)return!1;if(o=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(e,i,a,o),n.push(o),0>vec3.dot(n[n.length-1].point,a))return!1;if(m(n,a))return t.GjkEpa.EPA(e,i,n)}}}(),EPA:function(n,a,c){function s(t,e){var i=[];return(vec3.equal(t.a.point,e.a.point)||vec3.equal(t.a.point,e.b.point)||vec3.equal(t.a.point,e.c.point))&&i.push(t.a),(vec3.equal(t.b.point,e.a.point)||vec3.equal(t.b.point,e.b.point)||vec3.equal(t.b.point,e.c.point))&&i.push(t.b),(vec3.equal(t.c.point,e.a.point)||vec3.equal(t.c.point,e.b.point)||vec3.equal(t.c.point,e.c.point))&&i.push(t.c),i}var r,h=e,p=i,l=o,_=h;if(2===c.length&&(vec3.cross(c[0].point,c[1].point,_),r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(n,a,_,r),c.push(r)),3===c.length){var u=c[2],v=c[1],b=c[0],d=h,f=p,j=l;vec3.negate(u.point,d),vec3.subtract(v.point,u.point,f),vec3.subtract(b.point,u.point,j),vec3.cross(f,j,_),r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(n,a,_,r),c.push(r)}var m=[];m.push(new t.GjkEpa.GjkFace(c[0],c[2],c[3],vec3.create(),0),new t.GjkEpa.GjkFace(c[0],c[1],c[2],vec3.create(),1),new t.GjkEpa.GjkFace(c[0],c[3],c[1],vec3.create(),2),new t.GjkEpa.GjkFace(c[3],c[2],c[1],vec3.create(),3)),vec3.subtract(m[0].b.point,m[0].a.point,h),vec3.subtract(m[0].c.point,m[0].a.point,p),vec3.cross(h,p,m[0].normal),vec3.normalize(m[0].normal),vec3.subtract(m[1].b.point,m[1].a.point,h),vec3.subtract(m[1].c.point,m[1].a.point,p),vec3.cross(h,p,m[1].normal),vec3.normalize(m[1].normal),vec3.subtract(m[2].b.point,m[2].a.point,h),vec3.subtract(m[2].c.point,m[2].a.point,p),vec3.cross(h,p,m[2].normal),vec3.normalize(m[2].normal),vec3.subtract(m[3].b.point,m[3].a.point,h),vec3.subtract(m[3].c.point,m[3].a.point,p),vec3.cross(h,p,m[3].normal),vec3.normalize(m[3].normal);for(var g,y,w,B,P,S,C=1/0,F=null,G=vec3.create(),x=vec3.create(),O=vec3.create(),M=0;;){for(M++,S=1/0,g=m.length-1;g>=0;)w=m[g],null!==w?(t.GeometryMethods.findClosestPointInTriangle(G,w.a.point,w.b.point,w.c.point,x),B=vec3.squaredLength(x),S>B&&(vec3.set(x,O),S=B,P=g),g--):g--;if(1e-4>C-S&&F===m[P]||20===M){var q=t.ObjectPool.getObject("ContactDetails");q.object_a=n,q.object_b=a,vec3.set(m[P].normal,q.contact_normal);var E=vec3.create();if(t.GeometryMethods.findBarycentricCoordinates(O,m[P].a.point,m[P].b.point,m[P].c.point,E),isNaN(E[0]))return!1;var k={a:vec3.create(),b:vec3.create(),c:vec3.create()};return vec3.scale(m[P].a.witness_a,E[0],k.a),vec3.scale(m[P].b.witness_a,E[1],k.b),vec3.scale(m[P].c.witness_a,E[2],k.c),vec3.add(k.a,k.b,q.contact_point_in_a),vec3.add(q.contact_point_in_a,k.c),vec3.scale(m[P].a.witness_b,E[0],k.a),vec3.scale(m[P].b.witness_b,E[1],k.b),vec3.scale(m[P].c.witness_b,E[2],k.c),vec3.add(k.a,k.b,q.contact_point_in_b),vec3.add(q.contact_point_in_b,k.c),vec3.add(q.contact_point_in_a,q.contact_point_in_b,q.contact_point),vec3.scale(q.contact_point,.5),mat4.multiplyVec3(q.object_a.transform_inverse,q.contact_point_in_a),mat4.multiplyVec3(q.object_b.transform_inverse,q.contact_point_in_b),q.penetration_depth=Math.sqrt(S),q.restitution=(n.restitution+a.restitution)/2,q.friction=(q.object_a.friction+q.object_b.friction)/2,q}r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(n,a,m[P].normal,r);var T=r,I=[];for(g=0;m.length>g;g++)null!==m[g]&&m[g].classifyVertex(T.point)>=t.EPSILON&&I.push(m[g]);var L=[];for(g=0;I.length>g;g++)for(y=0;I.length>y;y++)y>=g||Array.prototype.push.apply(L,s(I[g],I[y]));for(g=0;I.length>g;g++){w=I[g];var D=[];if((-1===L.indexOf(w.a)||-1===L.indexOf(w.b))&&D.push(new t.GjkEpa.GjkFace(w.a,w.b,T,vec3.create(),-1)),(-1===L.indexOf(w.b)||-1===L.indexOf(w.c))&&D.push(new t.GjkEpa.GjkFace(w.c,T,w.b,vec3.create(),-1)),(-1===L.indexOf(w.a)||-1===L.indexOf(w.c))&&D.push(new t.GjkEpa.GjkFace(w.c,w.a,T,vec3.create(),-1)),0!==D.length)for(m[w.index]=null,Array.prototype.push.apply(m,D),y=m.length-D.length;m.length>y;y++)vec3.subtract(m[y].b.point,m[y].a.point,h),vec3.subtract(m[y].c.point,m[y].a.point,p),vec3.cross(h,p,m[y].normal),vec3.normalize(m[y].normal),m[y].index=y}C=S,F=m[P]}}},t.GjkEpa.GjkFace=function(t,e,i,o,n){this.a=t,this.b=e,this.c=i,this.normal=o,this.index=n},t.GjkEpa.GjkFace.prototype.classifyVertex=function(t){var e=vec3.dot(this.normal,this.a.point),i=vec3.dot(this.normal,t)-e;return i},t.GjkEpa2={max_iterations:20,epa_condition:.001,SupportPoint:function(t,e,i){this.witness_a=t,this.witness_b=e,this.point=i},findSupportPoint:function(){var t=vec3.create();return function(e,i,o,n){e.findSupportPoint(o,n.witness_a),vec3.negate(o,t),i.findSupportPoint(t,n.witness_b),vec3.subtract(n.witness_a,n.witness_b,n.point)}}(),GJK:function(){return function(e,i){for(var o,n=new t.GjkEpa2.Simplex(e,i);o=n.addPoint(););return o===!1?null:n}}(),EPA:function(){return function(i){for(var o,n=new t.GjkEpa2.Polyhedron(i),a=0;++a;){n.findFaceClosestToOrigin(),n.closest_face_distance<t.EPSILON?vec3.set(n.faces[n.closest_face].normal,e):vec3.set(n.closest_point,e);var c=t.ObjectPool.getObject("GJK2SupportPoint");t.GjkEpa2.findSupportPoint(i.object_a,i.object_b,e,c),vec3.subtract(c.point,n.closest_point,e);var s=vec3.squaredLength(e);if(a===t.GjkEpa2.max_iterations||t.GjkEpa2.epa_condition>s&&n.closest_face_distance>t.EPSILON){var r=t.ObjectPool.getObject("ContactDetails");r.object_a=i.object_a,r.object_b=i.object_b,vec3.normalize(n.closest_point,r.contact_normal),0===vec3.squaredLength(r.contact_normal)&&vec3.subtract(r.object_b.position,r.object_a.position,r.contact_normal),vec3.normalize(r.contact_normal);var h=vec3.create();if(t.GeometryMethods.findBarycentricCoordinates(n.closest_point,n.faces[n.closest_face].a.point,n.faces[n.closest_face].b.point,n.faces[n.closest_face].c.point,h),isNaN(h[0]))return null;var p={a:vec3.create(),b:vec3.create(),c:vec3.create()};return vec3.scale(n.faces[n.closest_face].a.witness_a,h[0],p.a),vec3.scale(n.faces[n.closest_face].b.witness_a,h[1],p.b),vec3.scale(n.faces[n.closest_face].c.witness_a,h[2],p.c),vec3.add(p.a,p.b,r.contact_point_in_a),vec3.add(r.contact_point_in_a,p.c),vec3.scale(n.faces[n.closest_face].a.witness_b,h[0],p.a),vec3.scale(n.faces[n.closest_face].b.witness_b,h[1],p.b),vec3.scale(n.faces[n.closest_face].c.witness_b,h[2],p.c),vec3.add(p.a,p.b,r.contact_point_in_b),vec3.add(r.contact_point_in_b,p.c),vec3.add(r.contact_point_in_a,r.contact_point_in_b,r.contact_point),vec3.scale(r.contact_point,.5),mat4.multiplyVec3(r.object_a.transform_inverse,r.contact_point_in_a),mat4.multiplyVec3(r.object_b.transform_inverse,r.contact_point_in_b),r.penetration_depth=vec3.length(n.closest_point),r.restitution=(i.object_a.restitution+i.object_b.restitution)/2,r.friction=(i.object_a.friction+i.object_b.friction)/2,r}o=n.addVertex(c)}return null}}(),Face:function(t,o,n,a){this.active=!0,this.polyhedron=t,this.a=o,this.b=n,this.c=a,this.normal=vec3.create(),this.neighbors=[],vec3.subtract(n.point,o.point,e),vec3.subtract(a.point,o.point,i),vec3.cross(e,i,this.normal),vec3.normalize(this.normal)}},t.GjkEpa2.Polyhedron=function(e){this.closest_face=null,this.closest_face_distance=null,this.closest_point=vec3.create(),this.faces=[new t.GjkEpa2.Face(this,e.points[0],e.points[2],e.points[3]),new t.GjkEpa2.Face(this,e.points[0],e.points[1],e.points[2]),new t.GjkEpa2.Face(this,e.points[0],e.points[3],e.points[1]),new t.GjkEpa2.Face(this,e.points[3],e.points[2],e.points[1])],this.faces[0].neighbors.push(this.faces[1],this.faces[3],this.faces[2]),this.faces[1].neighbors.push(this.faces[2],this.faces[3],this.faces[0]),this.faces[2].neighbors.push(this.faces[0],this.faces[3],this.faces[1]),this.faces[3].neighbors.push(this.faces[0],this.faces[1],this.faces[2])},t.GjkEpa2.Polyhedron.prototype={addVertex:function(e){var i,o,n,a,c,s=[],r=[];for(this.faces[this.closest_face].silhouette(e,s),i=0;s.length-5>i;i+=5){if(n=s[i+3],a=s[i+4],0!==i&&c!==n)for(o=i+5;s.length>o;o+=5)if(s[o+3]===c){var h=s.slice(i,i+5);s[i]=s[o],s[i+1]=s[o+1],s[i+2]=s[o+2],s[i+3]=s[o+3],s[i+4]=s[o+4],s[o]=h[0],s[o+1]=h[1],s[o+2]=h[2],s[o+3]=h[3],s[o+4]=h[4],n=s[i+3],a=s[i+4];break}c=a}for(i=0;s.length>i;i+=5){var p=s[i];n=s[i+3],a=s[i+4];var l=new t.GjkEpa2.Face(this,a,e,n);l.neighbors[2]=s[i],r.push(l),p.neighbors[p.neighbors.indexOf(s[i+2])]=l}for(i=0;r.length>i;i++)r[i].neighbors[0]=r[i+1===r.length?0:i+1],r[i].neighbors[1]=r[0>i-1?r.length-1:i-1];return Array.prototype.push.apply(this.faces,r),s},findFaceClosestToOrigin:function(){var e=vec3.create(),i=vec3.create();return function(){this.closest_face_distance=1/0;var o,n;for(n=0;this.faces.length>n;n++)this.faces[n].active!==!1&&(t.GeometryMethods.findClosestPointInTriangle(e,this.faces[n].a.point,this.faces[n].b.point,this.faces[n].c.point,i),o=vec3.squaredLength(i),this.closest_face_distance>o&&(this.closest_face_distance=o,this.closest_face=n,vec3.set(i,this.closest_point)))}}()},t.GjkEpa2.Face.prototype={classifyVertex:function(t){var e=vec3.dot(this.normal,this.a.point),i=vec3.dot(this.normal,t.point)-e;return i},silhouette:function(t,e,i){if(this.active!==!1)if(this.classifyVertex(t)>0)this.active=!1,this.neighbors[0].silhouette(t,e,this),this.neighbors[1].silhouette(t,e,this),this.neighbors[2].silhouette(t,e,this);else if(i){var o,n,a=this.neighbors.indexOf(i);0===a?(o=this.a,n=this.b):1===a?(o=this.b,n=this.c):(o=this.c,n=this.a),e.push(this,a,i,n,o)}}},function(){var n=vec3.create(),a=vec3.create(),c=vec3.create(),s=vec3.create();t.GjkEpa2.Simplex=function(t,e){this.object_a=t,this.object_b=e,this.points=[],this.iterations=0,this.next_direction=vec3.create(),this.updateDirection()},t.GjkEpa2.Simplex.prototype={addPoint:function(){if(++this.iterations===t.GjkEpa2.max_iterations)return!1;var e=t.ObjectPool.getObject("GJK2SupportPoint");return t.GjkEpa2.findSupportPoint(this.object_a,this.object_b,this.next_direction,e),this.points.push(e),0>vec3.dot(this.points[this.points.length-1].point,this.next_direction)?!1:this.updateDirection()===!0?null:e},findDirectionFromLine:function(){vec3.negate(this.points[1].point,n),vec3.subtract(this.points[0].point,this.points[1].point,a),0>vec3.dot(a,n)?(vec3.set(n,this.next_direction),this.points.length=1):(vec3.cross(a,n,this.next_direction),vec3.cross(this.next_direction,a),0===this.next_direction[0]&&0===this.next_direction[1]&&0===this.next_direction[2]&&(vec3.normalize(a),this.next_direction[0]=1-Math.abs(a[0]),this.next_direction[1]=1-Math.abs(a[1]),this.next_direction[2]=1-Math.abs(a[2])))},findDirectionFromTriangle:function(){var t=this.points[2],s=this.points[1],r=this.points[0];vec3.negate(t.point,n),vec3.subtract(s.point,t.point,a),vec3.subtract(r.point,t.point,c),vec3.cross(a,c,e),vec3.cross(a,e,i),vec3.cross(e,c,o),vec3.dot(o,n)>=0?vec3.dot(c,n)>=0?(this.points.length=0,this.points.push(r,t),vec3.cross(c,n,this.next_direction),vec3.cross(this.next_direction,c)):vec3.dot(a,n)>=0?(this.points.length=0,this.points.push(s,t),vec3.cross(a,n,this.next_direction),vec3.cross(this.next_direction,a)):(this.points.length=0,this.points.push(t)):vec3.dot(i,n)>=0?vec3.dot(a,n)>=0?(this.points.length=0,this.points.push(s,t),vec3.cross(a,n,this.next_direction),vec3.cross(this.next_direction,a)):(this.points.length=0,this.points.push(t)):vec3.dot(e,n)>=0?vec3.set(e,this.next_direction):(vec3.set(e,this.next_direction),vec3.negate(this.next_direction),this.points.length=0,this.points.push(t,s,r))},getFaceNormal:function(t,e,i,o){vec3.subtract(i.point,t.point,c),vec3.subtract(e.point,t.point,a),vec3.cross(c,a,o),vec3.normalize(o)},faceNormalDotOrigin:function(t,o,n){return this.getFaceNormal(t,o,n,e),vec3.add(t.point,o.point,i),vec3.add(i,n.point),vec3.negate(i),vec3.normalize(i),vec3.dot(e,i)},findDirectionFromTetrahedron:function(){var o=this.points[3],n=this.points[2],c=this.points[1],r=this.points[0];if(this.containsOrigin())return!0;var h=vec3.create(),p=1/0,l=0;t.GeometryMethods.findClosestPointInTriangle(h,r.point,c.point,o.point,i),vec3.subtract(r.point,o.point,a),vec3.subtract(c.point,o.point,s),vec3.cross(a,s,e),l=vec3.length(i),p>l&&(p=l,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(o,c,r)),t.GeometryMethods.findClosestPointInTriangle(h,c.point,n.point,o.point,i),vec3.subtract(c.point,o.point,a),vec3.subtract(n.point,o.point,s),vec3.cross(a,s,e),l=vec3.length(i),p>l&&(p=l,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(o,n,c)),t.GeometryMethods.findClosestPointInTriangle(h,n.point,r.point,o.point,i),vec3.subtract(n.point,o.point,a),vec3.subtract(r.point,o.point,s),vec3.cross(a,s,e),l=vec3.length(i),p>l&&(p=l,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(n,r,o)),t.GeometryMethods.findClosestPointInTriangle(h,r.point,n.point,c.point,i),vec3.subtract(r.point,c.point,a),vec3.subtract(n.point,c.point,s),vec3.cross(a,s,e),l=vec3.length(i),p>l&&(p=l,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(c,n,r))},containsOrigin:function(){var t=this.points[3],i=this.points[2],o=this.points[1],n=this.points[0];return vec3.subtract(n.point,t.point,a),vec3.subtract(o.point,t.point,s),vec3.cross(a,s,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(o.point,t.point,a),vec3.subtract(i.point,t.point,s),vec3.cross(a,s,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(i.point,t.point,a),vec3.subtract(n.point,t.point,s),vec3.cross(a,s,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(i.point,n.point,a),vec3.subtract(o.point,n.point,s),vec3.cross(a,s,e),vec3.dot(e,n.point)>0?!1:!0)))},updateDirection:function(){if(0===this.points.length)vec3.subtract(this.object_b.position,this.object_a.position,this.next_direction);else if(1===this.points.length)vec3.negate(this.next_direction);else if(2===this.points.length)this.findDirectionFromLine();else{if(3!==this.points.length)return this.findDirectionFromTetrahedron();this.findDirectionFromTriangle()}}}}(),t.SphereSphere=function(i,o){var n=i.position,a=o.position;vec3.subtract(a,n,e);var c=vec3.length(e);if(!(c>i.bounding_radius+o.bounding_radius)){var s=t.ObjectPool.getObject("ContactDetails");return s.object_a=i,s.object_b=o,vec3.scale(e,1/c,s.contact_normal),vec3.scale(e,-.5),vec3.add(e,n,s.contact_point),s.penetration_depth=i.bounding_radius+o.bounding_radius-c,vec3.scale(s.contact_normal,s.object_a.bounding_radius,s.contact_point_in_a),vec3.add(s.contact_point_in_a,s.object_a.position),vec3.scale(s.contact_normal,-s.object_b.bounding_radius,s.contact_point_in_b),vec3.add(s.contact_point_in_b,s.object_b.position),vec3.add(s.contact_point_in_a,s.contact_point_in_b,s.contact_point),vec3.scale(s.contact_point,.5),mat4.multiplyVec3(s.object_a.transform_inverse,s.contact_point_in_a),mat4.multiplyVec3(s.object_b.transform_inverse,s.contact_point_in_b),s.restitution=(i.restitution+o.restitution)/2,s.friction=(i.friction+o.friction)/2,s}},t.Constraint=function(){this.object_a=null,this.object_b=null,this.rows=[]},t.ConstraintRow=function(){this.jacobian=new Float64Array(12),this.B=new Float64Array(12),this.D=0,this.lower_limit=-1/0,this.upper_limit=1/0,this.bias=0,this.multiplier=0,this.multiplier_cache=0,this.eta=0,this.eta_row=new Float64Array(12),this.applied_push_impulse=0},t.ConstraintRow.prototype.computeB=function(t){var i=0;null!=t.object_a&&1/0!==t.object_a.mass?(i=1/t.object_a.mass,this.B[0]=i*this.jacobian[0],this.B[1]=i*this.jacobian[1],this.B[2]=i*this.jacobian[2],e[0]=this.jacobian[3],e[1]=this.jacobian[4],e[2]=this.jacobian[5],mat3.multiplyVec3(t.object_a.inverseInertiaTensorWorldFrame,e),this.B[3]=e[0],this.B[4]=e[1],this.B[5]=e[2]):(this.B[0]=this.B[1]=this.B[2]=0,this.B[3]=this.B[4]=this.B[5]=0),null!=t.object_b&&1/0!==t.object_b.mass?(i=1/t.object_b.mass,this.B[6]=i*this.jacobian[6],this.B[7]=i*this.jacobian[7],this.B[8]=i*this.jacobian[8],e[0]=this.jacobian[9],e[1]=this.jacobian[10],e[2]=this.jacobian[11],mat3.multiplyVec3(t.object_b.inverseInertiaTensorWorldFrame,e),this.B[9]=e[0],this.B[10]=e[1],this.B[11]=e[2]):(this.B[6]=this.B[7]=this.B[8]=0,this.B[9]=this.B[10]=this.B[11]=0)},t.ConstraintRow.prototype.computeD=function(t){this.D=0,null!=t.object_a&&(this.D+=this.jacobian[0]*this.jacobian[0]+this.jacobian[1]*this.B[1]+this.jacobian[2]*this.B[2]+this.jacobian[3]*this.B[3]+this.jacobian[4]*this.B[4]+this.jacobian[5]*this.B[5]),null!=t.object_b&&(this.D+=this.jacobian[6]*this.jacobian[6]+this.jacobian[7]*this.B[7]+this.jacobian[8]*this.B[8]+this.jacobian[9]*this.B[9]+this.jacobian[10]*this.B[10]+this.jacobian[11]*this.B[11])},t.ConstraintRow.prototype.computeEta=function(t){var i;null!=t.object_a?(i=1/t.object_a.mass,this.eta_row[0]=t.object_a.linear_velocity[0]+i*t.object_a.accumulated_force[0],this.eta_row[1]=t.object_a.linear_velocity[1]+i*t.object_a.accumulated_force[1],this.eta_row[2]=t.object_a.linear_velocity[2]+i*t.object_a.accumulated_force[2],vec3.set(t.object_a.accumulated_torque,e),mat3.multiplyVec3(t.object_a.inverseInertiaTensorWorldFrame,e),this.eta_row[3]=t.object_a.angular_velocity[0]+e[0],this.eta_row[4]=t.object_a.angular_velocity[1]+e[1],this.eta_row[5]=t.object_a.angular_velocity[2]+e[2]):this.eta_row[0]=this.eta_row[1]=this.eta_row[2]=this.eta_row[3]=this.eta_row[4]=this.eta_row[5]=0,null!=t.object_b?(i=1/t.object_b.mass,this.eta_row[6]=t.object_b.linear_velocity[0]+i*t.object_b.accumulated_force[0],this.eta_row[7]=t.object_b.linear_velocity[1]+i*t.object_b.accumulated_force[1],this.eta_row[8]=t.object_b.linear_velocity[2]+i*t.object_b.accumulated_force[2],vec3.set(t.object_b.accumulated_torque,e),mat3.multiplyVec3(t.object_b.inverseInertiaTensorWorldFrame,e),this.eta_row[9]=t.object_b.angular_velocity[0]+e[0],this.eta_row[10]=t.object_b.angular_velocity[1]+e[1],this.eta_row[11]=t.object_b.angular_velocity[2]+e[2]):this.eta_row[6]=this.eta_row[7]=this.eta_row[8]=this.eta_row[9]=this.eta_row[10]=this.eta_row[11]=0;var o=this.jacobian[0]*this.eta_row[0]+this.jacobian[1]*this.eta_row[1]+this.jacobian[2]*this.eta_row[2]+this.jacobian[3]*this.eta_row[3]+this.jacobian[4]*this.eta_row[4]+this.jacobian[5]*this.eta_row[5]+this.jacobian[6]*this.eta_row[6]+this.jacobian[7]*this.eta_row[7]+this.jacobian[8]*this.eta_row[8]+this.jacobian[9]*this.eta_row[9]+this.jacobian[10]*this.eta_row[10]+this.jacobian[11]*this.eta_row[11];this.eta=this.bias-o},t.ContactConstraint=function(){t.Constraint.call(this)},t.ContactConstraint.prototype.buildFromContact=function(i){var o=this.rows[0]||t.ObjectPool.getObject("ConstraintRow");this.object_a=i.object_a,this.object_b=i.object_b,this.contact=i,o.lower_limit=0,o.upper_limit=1/0,null==this.object_a||1/0===this.object_a.mass?(o.jacobian[0]=o.jacobian[1]=o.jacobian[2]=0,o.jacobian[3]=o.jacobian[4]=o.jacobian[5]=0):(o.jacobian[0]=-i.contact_normal[0],o.jacobian[1]=-i.contact_normal[1],o.jacobian[2]=-i.contact_normal[2],vec3.subtract(i.contact_point,i.object_a.position,e),vec3.cross(e,i.contact_normal,e),o.jacobian[3]=-e[0],o.jacobian[4]=-e[1],o.jacobian[5]=-e[2]),null==this.object_b||1/0===this.object_b.mass?(o.jacobian[6]=o.jacobian[7]=o.jacobian[8]=0,o.jacobian[9]=o.jacobian[10]=o.jacobian[11]=0):(o.jacobian[6]=i.contact_normal[0],o.jacobian[7]=i.contact_normal[1],o.jacobian[8]=i.contact_normal[2],vec3.subtract(i.contact_point,i.object_b.position,e),vec3.cross(e,i.contact_normal,e),o.jacobian[9]=e[0],o.jacobian[10]=e[1],o.jacobian[11]=e[2]),o.bias=i.penetration_depth;var n=vec3.dot(this.object_a.linear_velocity,i.contact_normal);n-=vec3.dot(this.object_b.linear_velocity,i.contact_normal),o.bias+=n*i.restitution,this.rows[0]=o},t.FrictionConstraint=function(){t.Constraint.call(this)},t.FrictionConstraint.prototype.buildFromContact=function(e){var i=this.rows[0]||t.ObjectPool.getObject("ConstraintRow");this.object_a=e.object_a,this.object_b=e.object_b;var o=vec3.create(),n=vec3.create();vec3.subtract(e.contact_point,e.object_a.position,o),vec3.subtract(e.contact_point,e.object_b.position,n);var a=vec3.create(),c=vec3.create();vec3.cross(e.object_a.angular_velocity,o,a),vec3.add(a,e.object_a.linear_velocity),vec3.cross(e.object_b.angular_velocity,n,c),vec3.add(c,e.object_b.linear_velocity);var s=vec3.create();vec3.subtract(a,c,s);var r=vec3.dot(e.contact_normal,s);s[0]-=r*e.contact_normal[0],s[1]-=r*e.contact_normal[1],s[2]-=r*e.contact_normal[2];var h=vec3.squaredLength(s);if(!(h>=t.EPSILON))return this.rows.length=0,void 0;h=Math.sqrt(h),i.jacobian[0]=s[0]/h,i.jacobian[1]=s[1]/h,i.jacobian[2]=s[2]/h,i.jacobian[6]=s[0]/-h,i.jacobian[7]=s[1]/-h,i.jacobian[8]=s[2]/-h,i.jacobian[3]=o[1]*i.jacobian[2]-o[2]*i.jacobian[1],i.jacobian[4]=o[2]*i.jacobian[0]-o[0]*i.jacobian[2],i.jacobian[5]=o[0]*i.jacobian[1]-o[1]*i.jacobian[0],i.jacobian[9]=i.jacobian[1]*n[2]-i.jacobian[2]*n[1],i.jacobian[10]=i.jacobian[2]*n[0]-i.jacobian[0]*n[2],i.jacobian[11]=i.jacobian[0]*n[1]-i.jacobian[1]*n[0];var p=.1*e.friction;i.lower_limit=-p,i.upper_limit=p,i.bias=0,this.rows.push(i)},t.ContactDetails=function(){this.object_a=null,this.object_b=null,this.contact_point=vec3.create(),this.contact_point_in_a=vec3.create(),this.contact_point_in_b=vec3.create(),this.contact_normal=vec3.create(),this.penetration_depth=0,this.restitution=0,this.friction=0},t.ContactManifold=function(){this.object_a=null,this.object_b=null,this.points=[],this.next_manifold=null},t.ContactManifold.prototype.findWeakestContact=function(t){var o,n,a=-1,c=t.penetration_depth;for(o=0;4>o;o++)n=this.points[o],n.penetration_depth>c&&(c=n.penetration_depth,a=o);var s=0,r=0,h=0,p=0;0!==a&&(vec3.subtract(t.contact_point_in_a,this.points[1].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a,i),vec3.cross(e,i),s=vec3.squaredLength(e)),1!==a&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a,i),vec3.cross(e,i),r=vec3.squaredLength(e)),2!==a&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[1].contact_point_in_a,i),vec3.cross(e,i),h=vec3.squaredLength(e)),3!==a&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[2].contact_point_in_a,this.points[1].contact_point_in_a,i),vec3.cross(e,i),p=vec3.squaredLength(e));var l=0,_=s;return r>_&&(l=1,_=r),h>_&&(l=2,_=h),p>_&&(l=3),l},t.ContactManifold.prototype.addContact=function(t){var e;for(e=0;this.points.length>e;e++)if(.02>=vec3.dist(this.points[e].contact_point,t.contact_point))return;this.points.push(t)},t.ContactManifold.prototype.update=function(){for(var t,i,o=this.points.length-1,n=vec3.create(),a=vec3.create(),c=vec3.create();o>=0;){if(i=this.points[o],mat4.multiplyVec3(i.object_a.transform,i.contact_point_in_a,n),mat4.multiplyVec3(i.object_b.transform,i.contact_point_in_b,a),vec3.add(n,a,i.contact_point),vec3.scale(i.contact_point,.5),vec3.subtract(n,a,c),i.penetration_depth=vec3.dot(c,i.contact_normal),-.02>i.penetration_depth){for(t=this.points.length-2;t>=o;t--)this.points[t]=this.points[t+1];this.points.length=this.points.length-1}else{vec3.scale(i.contact_normal,i.penetration_depth,e),vec3.subtract(n,e,e),vec3.subtract(a,e,e);var s=vec3.squaredLength(e);if(s>.2*.2){for(t=this.points.length-2;t>=o;t--)this.points[t]=this.points[t+1];this.points.length=this.points.length-1}}o--}},t.ContactManifoldList=function(){this.first=null},t.ContactManifoldList.prototype.insert=function(t){t.next_manifold=this.first,this.first=t},t.ContactManifoldList.prototype.getManifoldForObjects=function(e,i){var o=null;if(null!==this.first)for(var n=this.first;null!==n;){if(n.object_a===e&&n.object_b===i||n.object_a===i&&n.object_b===e){o=n;break}n=n.next_manifold}return null===o&&(o=t.ObjectPool.getObject("ContactManifold"),o.object_a=e,o.object_b=i,this.insert(o)),o},t.ForceGenerator=function(t){this.force=t||vec3.create(),this.enabled=!0,this.affected=[]},t.ForceGenerator.prototype.applyForce=function(){if(this.enabled){var t,e;for(t=0,e=this.affected.length;e>t;t++)this.affected[t].applyForce(this.force)}},t.ForceGenerator.prototype.enable=function(){this.enabled=!0},t.ForceGenerator.prototype.disable=function(){this.enabled=!1},t.ForceGenerator.prototype.affect=function(t){var e,i;for(e=0,i=this.affected.length;i>e;e++)if(this.affected[e]===t)return;this.affected.push(t)},t.ForceGenerator.prototype.unaffect=function(t){var e,i;for(e=0,i=this.affected.length;i>e;e++)if(this.affected[e]===t)return this.affected.splice(e,1),void 0},t.DragForce=function(t,e){this.drag_coefficient=t||0,this.squared_drag_coefficient=e||0,this.enabled=!0,this.affected=[]},t.DragForce.prototype.enable=t.ForceGenerator.prototype.enable,t.DragForce.prototype.disable=t.ForceGenerator.prototype.disable,t.DragForce.prototype.affect=t.ForceGenerator.prototype.affect,t.DragForce.prototype.unaffect=t.ForceGenerator.prototype.unaffect,t.DragForce.prototype.applyForce=function(){if(this.enabled){var t,i,o,n,a=e;for(t=0,i=this.affected.length;i>t;t++)o=this.affected[t],vec3.set(o.linear_velocity,a),n=vec3.length(a),n=this.drag_coefficient*n+this.squared_drag_coefficient*n*n,vec3.normalize(a),vec3.scale(a,-n),o.applyForce(a)}},t.GeometryMethods={findClosestPointInTriangle:function(){var t=vec3.create(),e=vec3.create(),i=vec3.create();return function(o,n,a,c,s){var r;vec3.subtract(a,n,t),vec3.subtract(c,n,e),vec3.subtract(o,n,i);var h=vec3.dot(t,i),p=vec3.dot(e,i);if(0>=h&&0>=p)return vec3.set(n,s),void 0;vec3.subtract(o,a,i);var l=vec3.dot(t,i),_=vec3.dot(e,i);if(l>=0&&l>=_)return vec3.set(a,s),void 0;var u=h*_-l*p;if(0>=u&&h>=0&&0>=l)return r=h/(h-l),vec3.scale(t,r,s),vec3.add(s,n),void 0;vec3.subtract(o,c,i);var v=vec3.dot(t,i),b=vec3.dot(e,i);if(b>=0&&b>=v)return vec3.set(c,s),void 0;var d,f=v*p-h*b;if(0>=f&&p>=0&&0>=b)return d=p/(p-b),vec3.scale(e,d,s),vec3.add(s,n),void 0;var j=l*b-v*_;if(0>=j&&_-l>=0&&v-b>=0)return d=(_-l)/(_-l+(v-b)),vec3.subtract(c,a,s),vec3.scale(s,d),vec3.add(s,a),void 0;var m=1/(j+f+u);r=f*m,d=u*m,vec3.scale(t,r),vec3.add(t,n),vec3.scale(e,d),vec3.add(t,e,s)}}(),findBarycentricCoordinates:function(t,e,i,o,n){var a=vec3.create(),c=vec3.create(),s=vec3.create();vec3.subtract(i,e,a),vec3.subtract(o,e,c),vec3.subtract(t,e,s);var r=vec3.dot(a,a),h=vec3.dot(a,c),p=vec3.dot(c,c),l=vec3.dot(s,a),_=vec3.dot(s,c),u=r*p-h*h;n[1]=(p*l-h*_)/u,n[2]=(r*_-h*l)/u,n[0]=1-n[1]-n[2]
}},t.NearPhase=function(){this.contact_manifolds=new t.ContactManifoldList},t.NearPhase.prototype.updateContactManifolds=function(){for(var t=this.contact_manifolds.first,e=null;null!==t;)t.update(),e=t,t=t.next_manifold},t.NearPhase.prototype.generateContacts=function(e){var i,o,n,a,c=e.length;for(this.updateContactManifolds(),i=0;c>i;i++)o=e[i][0],n=e[i][1],o.shape instanceof t.SphereShape&&n.shape instanceof t.SphereShape?(a=t.SphereSphere(o,n),null!=a&&this.contact_manifolds.getManifoldForObjects(o,n).addContact(a)):o.shape instanceof t.SphereShape&&n.shape instanceof t.BoxShape||o.shape instanceof t.BoxShape&&n.shape instanceof t.SphereShape?(a=t.BoxSphere(o,n),null!=a&&this.contact_manifolds.getManifoldForObjects(o,n).addContact(a)):null!=(a=t.GjkEpa2.GJK(o,n))&&(a=t.GjkEpa2.EPA(a),null!=a&&this.contact_manifolds.getManifoldForObjects(o,n).addContact(a))},t.ObjectPool={types:{},pools:{},registerType:function(t,e){this.types[t]=e,this.pools[t]=[]},getObject:function(t){var e=this.pools[t];return 0!==e.length?e.pop():this.types[t]()},freeObject:function(t,e){this.pools[t].push(e)}},t.ObjectPool.registerType("vec3",vec3.create),t.ObjectPool.registerType("mat3",mat3.create),t.ObjectPool.registerType("MassPointContact",function(){return new t.MassPointContact}),t.ObjectPool.registerType("ContactDetails",function(){return new t.ContactDetails}),t.ObjectPool.registerType("ContactManifold",function(){return new t.ContactManifold}),t.ObjectPool.registerType("GJKSupportPoint",function(){return new t.GjkEpa.SupportPoint(vec3.create(),vec3.create(),vec3.create(),vec3.create())}),t.ObjectPool.registerType("GJK2SupportPoint",function(){return new t.GjkEpa2.SupportPoint(vec3.create(),vec3.create(),vec3.create(),vec3.create())}),t.ObjectPool.registerType("ConstraintRow",function(){return new t.ConstraintRow}),t.ObjectPool.registerType("ContactConstraint",function(){return new t.ContactConstraint}),t.ObjectPool.registerType("FrictionConstraint",function(){return new t.FrictionConstraint}),t.RigidBody=function(){var t=0;return function(e,i){this.id=t++,this.bounding_radius=e.getBoundingRadius(),this.shape=e,this.mass=i||1/0,this.position=vec3.create(),this.rotation=quat4.createFrom(0,0,0,1),this.linear_velocity=vec3.create(),this.angular_velocity=vec3.create(),this.transform=mat4.identity(),this.transform_inverse=mat4.identity(),this.inertiaTensor=e.getInertiaTensor(i),this.inverseInertiaTensor=mat3.inverse(this.inertiaTensor),this.inertiaTensorWorldFrame=mat3.create(),this.inverseInertiaTensorWorldFrame=mat3.create(),this.acceleration=vec3.create(),this.linear_damping=vec3.createFrom(0,0,0),this.angular_damping=vec3.createFrom(0,0,0),this.restitution=.05,this.friction=.5,this.gravity=null,this.world=null,this.accumulated_force=vec3.create(),this.accumulated_torque=vec3.create(),this.push_velocity=vec3.create(),this.turn_velocity=vec3.create(),this.solver_impulse=new Float64Array(6),this.updateDerived()}}(),t.RigidBody.prototype.findSupportPoint=function(){var t=vec3.create();return function(e,i){var o=this.transform_inverse[12],n=this.transform_inverse[13],a=this.transform_inverse[14];this.transform_inverse[12]=this.transform_inverse[13]=this.transform_inverse[14]=0,mat4.multiplyVec3(this.transform_inverse,e,t),this.transform_inverse[12]=o,this.transform_inverse[13]=n,this.transform_inverse[14]=a,this.shape.findSupportPoint(t,i),mat4.multiplyVec3(this.transform,i)}}(),t.RigidBody.prototype.integrate=function(t){if(1/0!==this.mass){var i=1/this.mass;vec3.scale(this.accumulated_force,i,e),vec3.add(this.linear_velocity,e),mat3.multiplyVec3(this.inverseInertiaTensorWorldFrame,this.accumulated_torque,e),vec3.scale(e,t),vec3.add(this.angular_velocity,e),this.linear_velocity[0]*=1/(1+t*this.linear_damping[0]),this.linear_velocity[1]*=1/(1+t*this.linear_damping[1]),this.linear_velocity[2]*=1/(1+t*this.linear_damping[2]),this.angular_velocity[0]*=1/(1+t*this.angular_damping[0]),this.angular_velocity[1]*=1/(1+t*this.angular_damping[1]),this.angular_velocity[2]*=1/(1+t*this.angular_damping[2]),vec3.scale(this.linear_velocity,t,e),vec3.add(this.position,e),n[0]=this.angular_velocity[0],n[1]=this.angular_velocity[1],n[2]=this.angular_velocity[2],n[3]=0,quat4.multiply(n,this.rotation);var o=.5*t;this.rotation[0]+=o*n[0],this.rotation[1]+=o*n[1],this.rotation[2]+=o*n[2],this.rotation[3]+=o*n[3],quat4.normalize(this.rotation),this.accumulated_force[0]=this.accumulated_force[1]=this.accumulated_force[2]=0,this.accumulated_torque[0]=this.accumulated_torque[1]=this.accumulated_torque[2]=0,this.solver_impulse[0]=this.solver_impulse[1]=this.solver_impulse[2]=this.solver_impulse[3]=this.solver_impulse[4]=this.solver_impulse[5]=0,this.push_velocity[0]=this.push_velocity[1]=this.push_velocity[2]=0,this.turn_velocity[0]=this.turn_velocity[1]=this.turn_velocity[2]=0}},t.RigidBody.prototype.setGravity=function(t,e,i){this.gravity?(this.gravity[0]=t,this.gravity[1]=e,this.gravity[2]=i):this.gravity=vec3.createFrom(t,e,i)},t.RigidBody.prototype.applyForce=function(t){vec3.add(this.accumulated_force,t)},t.RigidBody.prototype.applyForceAtWorldPoint=function(t,i){var o=e;vec3.set(i,o),vec3.subtract(o,this.position),vec3.cross(o,t),vec3.add(this.accumulated_force,t),vec3.add(this.accumulated_torque,o)},t.RigidBody.prototype.applyForceAtLocalPoint=function(t,i){var o=e;mat4.multiplyVec3(this.transform,i,o),this.applyForceAtWorldPoint(t,o)},t.RigidBody.prototype.updateDerived=function(){quat4.normalize(this.rotation),mat4.fromRotationTranslation(this.rotation,this.position,this.transform),mat4.inverse(this.transform,this.transform_inverse),1/0!==this.mass&&this.updateInverseInertiaTensorWorldFrame()},t.RigidBody.prototype.updateInverseInertiaTensorWorldFrame=function(){var t=this.transform,e=this.inverseInertiaTensorWorldFrame,i=this.inverseInertiaTensor;this.rotation;var o=t[0]*i[0]+t[1]*i[3]+t[2]*i[6],n=t[0]*i[1]+t[1]*i[4]+t[2]*i[7],a=t[0]*i[2]+t[1]*i[5]+t[2]*i[8],c=t[4]*i[0]+t[5]*i[3]+t[6]*i[6],s=t[4]*i[1]+t[5]*i[4]+t[6]*i[7],r=t[4]*i[2]+t[5]*i[5]+t[6]*i[8],h=t[8]*i[0]+t[9]*i[3]+t[10]*i[6],p=t[8]*i[1]+t[9]*i[4]+t[10]*i[7],l=t[8]*i[2]+t[9]*i[5]+t[10]*i[8];e[0]=o*t[0]+n*t[1]+a*t[2],e[1]=o*t[4]+n*t[5]+a*t[6],e[2]=o*t[8]+n*t[9]+a*t[10],e[3]=c*t[0]+s*t[1]+r*t[2],e[4]=c*t[4]+s*t[5]+r*t[6],e[5]=c*t[8]+s*t[9]+r*t[10],e[6]=h*t[0]+p*t[1]+l*t[2],e[7]=h*t[4]+p*t[5]+l*t[6],e[8]=h*t[8]+p*t[9]+l*t[10],mat3.inverse(this.inverseInertiaTensorWorldFrame,this.inertiaTensorWorldFrame)},t.SequentialImpulseSolver=function(){this.contact_constraints=[],this.friction_constraints=[],this.constraints=[],this.max_iterations=10,this.relaxation=1},t.SequentialImpulseSolver.prototype.processContactManifolds=function(e){var i,o,n,a,c,s;for(this.contact_constraints.length=0,this.friction_constraints.length=0,n=e.first,i=0;n;){for(i++,a=n.points.length,o=0;a>o;o++)c=n.points[o],s=t.ObjectPool.getObject("ContactConstraint"),s.buildFromContact(c),this.contact_constraints.push(s),s=t.ObjectPool.getObject("FrictionConstraint"),s.buildFromContact(c),this.friction_constraints.push(s);n=n.next_manifold}this.constraints=[],Array.prototype.push.apply(this.constraints,this.contact_constraints),Array.prototype.push.apply(this.constraints,this.friction_constraints)},t.SequentialImpulseSolver.prototype.prepareConstraints=function(){var t,e,i,o,n,a=this.constraints.length;for(o=0;a>o;o++)for(e=this.constraints[o],t=e.rows.length,n=0;t>n;n++)i=e.rows[n],i.multiplier=0,i.computeB(e),i.computeD(e),i.computeEta(e)},t.SequentialImpulseSolver.prototype.resolveContacts=function(i){var o,a,c,s,r,h=0;for(o=0;this.max_iterations>o;o++){for(h=0,s=0;this.contact_constraints.length>s;s++){a=this.contact_constraints[s],c=a.rows[0];var p=c.jacobian[0]*a.object_a.push_velocity[0]+c.jacobian[1]*a.object_a.push_velocity[1]+c.jacobian[2]*a.object_a.push_velocity[2]+c.jacobian[4]*a.object_a.turn_velocity[1]+c.jacobian[3]*a.object_a.turn_velocity[0]+c.jacobian[5]*a.object_a.turn_velocity[2],l=c.jacobian[6]*a.object_b.push_velocity[0]+c.jacobian[7]*a.object_b.push_velocity[1]+c.jacobian[8]*a.object_b.push_velocity[2]+c.jacobian[9]*a.object_b.turn_velocity[0]+c.jacobian[10]*a.object_b.turn_velocity[1]+c.jacobian[11]*a.object_b.turn_velocity[2];r=(a.contact.penetration_depth-(p+l))/c.D;var _=c.applied_push_impulse;c.applied_push_impulse=Math.max(c.lower_limit,Math.min(_+r,c.upper_limit)),r=c.applied_push_impulse-_,h=Math.max(h,r),a.object_a.push_velocity[0]+=c.B[0]*r,a.object_a.push_velocity[1]+=c.B[1]*r,a.object_a.push_velocity[2]+=c.B[2]*r,a.object_a.turn_velocity[0]+=c.B[3]*r,a.object_a.turn_velocity[1]+=c.B[4]*r,a.object_a.turn_velocity[2]+=c.B[5]*r,a.object_b.push_velocity[0]+=c.B[6]*r,a.object_b.push_velocity[1]+=c.B[7]*r,a.object_b.push_velocity[2]+=c.B[8]*r,a.object_b.turn_velocity[0]+=c.B[9]*r,a.object_b.turn_velocity[1]+=c.B[10]*r,a.object_b.turn_velocity[2]+=c.B[11]*r}if(h>=-t.EPSILON&&t.EPSILON>=h)break}var u=.5*i;for(s=0;this.contact_constraints.length>s;s++){a=this.contact_constraints[s],c=a.rows[0];var v=c.applied_push_impulse;1/0!==a.object_a.mass&&(e[0]=c.B[0]*v,e[1]=c.B[1]*v,e[2]=c.B[2]*v,vec3.add(a.object_a.linear_velocity,e),vec3.scale(e,this.relaxation),vec3.add(a.object_a.position,e),e[0]=c.B[3]*v,e[1]=c.B[4]*v,e[2]=c.B[5]*v,n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=0,quat4.multiply(n,a.object_a.rotation),a.object_a.rotation[0]+=u*n[0],a.object_a.rotation[1]+=u*n[1],a.object_a.rotation[2]+=u*n[2],a.object_a.rotation[3]+=u*n[3],quat4.normalize(a.object_a.rotation)),1/0!==a.object_b.mass&&(e[0]=c.B[6]*v,e[1]=c.B[7]*v,e[2]=c.B[8]*v,vec3.add(a.object_b.linear_velocity,e),vec3.scale(e,this.relaxation),vec3.add(a.object_b.position,e),e[0]=c.B[9]*v,e[1]=c.B[10]*v,e[2]=c.B[11]*v,n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=0,quat4.multiply(n,a.object_b.rotation),a.object_b.rotation[0]+=u*n[0],a.object_b.rotation[1]+=u*n[1],a.object_b.rotation[2]+=u*n[2],a.object_b.rotation[3]+=u*n[3],quat4.normalize(a.object_b.rotation))}},t.SequentialImpulseSolver.prototype.solveConstraints=function(){var e,i,o,n,a,c,s,r,h=this.constraints.length,p=0;for(c=0;this.max_iterations>c;c++){for(p=0,n=0;h>n;n++)for(e=this.constraints[n],i=e.rows.length,a=0;i>a;a++){o=e.rows[a],r=0,e.object_a&&1/0!==e.object_a.mass&&(r+=o.jacobian[0]*e.object_a.solver_impulse[0]+o.jacobian[1]*e.object_a.solver_impulse[1]+o.jacobian[2]*e.object_a.solver_impulse[2]+o.jacobian[3]*e.object_a.solver_impulse[3]+o.jacobian[4]*e.object_a.solver_impulse[4]+o.jacobian[5]*e.object_a.solver_impulse[5]),e.object_b&&1/0!==e.object_b.mass&&(r+=o.jacobian[6]*e.object_b.solver_impulse[0]+o.jacobian[7]*e.object_b.solver_impulse[1]+o.jacobian[8]*e.object_b.solver_impulse[2]+o.jacobian[9]*e.object_b.solver_impulse[3]+o.jacobian[10]*e.object_b.solver_impulse[4]+o.jacobian[11]*e.object_b.solver_impulse[5]),s=(o.eta-r)/o.D;var l=o.multiplier;o.multiplier=Math.max(o.lower_limit,Math.min(l+s,o.upper_limit)),s=o.multiplier-l,p=Math.max(p,s),e.object_a&&1/0!==e.object_a.mass&&(e.object_a.solver_impulse[0]+=s*o.B[0],e.object_a.solver_impulse[1]+=s*o.B[1],e.object_a.solver_impulse[2]+=s*o.B[2],e.object_a.solver_impulse[3]+=s*o.B[3],e.object_a.solver_impulse[4]+=s*o.B[4],e.object_a.solver_impulse[5]+=s*o.B[5]),e.object_b&&1/0!==e.object_b.mass&&(e.object_b.solver_impulse[0]+=s*o.B[6],e.object_b.solver_impulse[1]+=s*o.B[7],e.object_b.solver_impulse[2]+=s*o.B[8],e.object_b.solver_impulse[3]+=s*o.B[9],e.object_b.solver_impulse[4]+=s*o.B[10],e.object_b.solver_impulse[5]+=s*o.B[11])}if(p>=-t.EPSILON&&t.EPSILON>=p)break}},t.SequentialImpulseSolver.prototype.applyConstraints=function(){var t,i,o,n,a,c,s=this.constraints.length;for(n=0;s>n;n++)for(t=this.constraints[n],i=t.rows.length,a=0;i>a;a++)o=t.rows[a],c=o.multiplier,1/0!==t.object_a.mass&&(e[0]=o.B[0]*c,e[1]=o.B[1]*c,e[2]=o.B[2]*c,vec3.add(t.object_a.linear_velocity,e),e[0]=o.B[3]*c,e[1]=o.B[4]*c,e[2]=o.B[5]*c,vec3.add(t.object_a.angular_velocity,e)),1/0!==t.object_b.mass&&(e[0]=o.B[6]*c,e[1]=o.B[7]*c,e[2]=o.B[8]*c,vec3.add(t.object_b.linear_velocity,e),e[0]=o.B[9]*c,e[1]=o.B[10]*c,e[2]=o.B[11]*c,vec3.add(t.object_b.angular_velocity,e))},t.BoxShape=function(t,e,i){this.half_width=t,this.half_height=e,this.half_depth=i},t.BoxShape.prototype.getBoundingRadius=function(){return 1.7320508075688772*Math.max(this.half_width,this.half_height,this.half_depth)},t.BoxShape.prototype.getInertiaTensor=function(t){var e=4*this.half_height*this.half_height,i=4*this.half_width*this.half_width,o=4*this.half_depth*this.half_depth,n=.0833*t;return mat3.createFrom(n*(e+o),0,0,0,n*(i+o),0,0,0,n*(e+i))},t.BoxShape.prototype.findSupportPoint=function(t,e){e[0]=0>t[0]?-this.half_width:this.half_width,e[1]=0>t[1]?-this.half_height:this.half_height,e[2]=0>t[2]?-this.half_depth:this.half_depth},t.ConeShape=function(t,e){this.radius=t,this.half_height=e,this._sinangle=this.radius/Math.sqrt(this.radius*this.radius+Math.pow(2*this.half_height,2))},t.ConeShape.prototype.getBoundingRadius=function(){return Math.max(this.radius,this.half_height)},t.ConeShape.prototype.getInertiaTensor=function(t){var e=.1*t*Math.pow(2*this.half_height,2)+.15*t*this.radius*this.radius;return mat3.createFrom(e,0,0,0,.3*t*this.radius*this.radius,0,0,0,e)},t.ConeShape.prototype.findSupportPoint=function(t,e){var i=Math.sqrt(t[0]*t[0]+t[2]*t[2]);if(t[1]>vec3.length(t)*this._sinangle)e[0]=e[2]=0,e[1]=this.half_height;else if(i>0){var o=this.radius/i;e[0]=o*t[0],e[1]=-this.half_height,e[2]=o*t[2]}else e[0]=e[2]=0,e[1]=-this.half_height},t.CylinderShape=function(t,e){this.radius=t,this.half_height=e},t.CylinderShape.prototype.getBoundingRadius=function(){return Math.max(this.radius,this.half_height)},t.CylinderShape.prototype.getInertiaTensor=function(t){var e=.0833*t*(3*this.radius*this.radius+(this.half_height+this.half_height)*(this.half_height+this.half_height));return mat3.createFrom(e,0,0,0,.5*t*this.radius*this.radius,0,0,0,e)},t.CylinderShape.prototype.findSupportPoint=function(t,e){if(e[1]=0>t[1]?-this.half_height:this.half_height,0===t[0]&&0===t[2])e[0]=e[2]=0;else{var i=Math.sqrt(t[0]*t[0]+t[2]*t[2]),o=this.radius/i;e[0]=o*t[0],e[2]=o*t[2]}},t.SphereShape=function(t){this.radius=t},t.SphereShape.prototype.getBoundingRadius=function(){return this.radius},t.SphereShape.prototype.getInertiaTensor=function(t){var e=.4*t*this.radius*this.radius;return mat3.createFrom(e,0,0,0,e,0,0,0,e)},t.SphereShape.prototype.findSupportPoint=function(){var t=vec3.create();return function(e,i){vec3.normalize(e,t),vec3.scale(t,this.radius,i)}}(),t.World=function(t,e,i){this.broadphase=t,this.nearphase=e,this.solver=i,this.mass_points=[],this.rigid_bodies=[],this.gravity=vec3.createFrom(0,-9.8,0),this.force_generators=[],this.constraints=[]},t.World.prototype.step=function(t,i){i=i||t;var o,n,a,c,s,r;for(a=t/i,o=0;a>o;o++){for(n=Math.min(i,t),t-=i,c=0,s=this.rigid_bodies.length;s>c;c++)this.rigid_bodies[c].updateDerived();for(c=0,s=this.rigid_bodies.length;s>c;c++)r=this.rigid_bodies[c],1/0!==r.mass&&(vec3.scale(r.gravity||this.gravity,r.mass*n,e),vec3.add(r.accumulated_force,e));for(c=0,s=this.force_generators.length;s>c;c++)this.force_generators[c].applyForce();for(this.broadphase.predictContactPairs(),this.nearphase.generateContacts(this.broadphase.collision_pairs),this.solver.processContactManifolds(this.nearphase.contact_manifolds),this.solver.prepareConstraints(),this.solver.resolveContacts(n),this.solver.solveConstraints(),this.solver.applyConstraints(),c=0,s=this.rigid_bodies.length;s>c;c++)r=this.rigid_bodies[c],r.integrate(n)}},t.World.prototype.addMassPoint=function(t){t.world=this,this.mass_points.push(t)},t.World.prototype.addRigidBody=function(t){t.world=this,this.rigid_bodies.push(t),this.broadphase.addBody(t)},t.World.prototype.removeRigidBody=function(t){var e,i=this.rigid_bodies.length;for(e=0;i>e;e++)if(this.rigid_bodies[e]===t){this.rigid_bodies.splice(e,1),this.broadphase.removeBody(t);break}},t.World.prototype.addForceGenerator=function(t){var e,i;for(e=0,i=this.force_generators.length;i>e;e++)if(this.force_generators[e]===t)return;this.force_generators.push(t)},t.World.prototype.removeForceGenerator=function(t){var e,i;for(e=0,i=this.force_generators.length;i>e;e++)if(this.force_generators[e]===t)return this.force_generators.splice(e,1),void 0},t.World.prototype.addConstraint=function(t){var e,i;for(e=0,i=this.constraints.length;i>e;e++)if(this.constraints[e]===t)return;t.world=this,this.constraints.push(t)},t.World.prototype.removeConstraint=function(t){var e,i;for(e=0,i=this.constraints.length;i>e;e++)if(this.constraints[e]===t)return this.constraints.splice(e,1),void 0},t}();