(function(){var t=quat4.create();quat4.rotateByVector=function(e,i,o){return o||(o=e),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,quat4.multiply(t,e),o},quat4.addScaledVector=function(e,i,o,a){a||(a=e);var n=Math.cos(i[0]*o/2),s=Math.cos(i[1]*o/2),c=Math.cos(i[2]*o/2),r=Math.sin(i[0]*o/2),h=Math.sin(i[1]*o/2),l=Math.sin(i[2]*o/2);return t[0]=r*s*c+n*h*l,t[1]=n*h*c-r*s*l,t[2]=n*s*l+r*h*c,t[3]=n*s*c-r*h*l,quat4.multiply(e,t),a}})(),window.Goblin=function(){"use strict";var t={},e=vec3.create(),i=vec3.create(),o=vec3.create(),a=quat4.create(),n=mat3.create(),s=mat3.create(),c=mat4.create();return t.EPSILON=1e-6,t.AABB=function(t,e){this.min=t||vec3.create(),this.max=e||vec3.create()},t.AABB.prototype.transform=function(){var t=vec3.create(),i=vec3.create(),o=vec3.create(),a=vec3.create(),n=mat3.create();return function(s,c){vec3.subtract(s.max,s.min,t),vec3.scale(t,.5),vec3.add(s.max,s.min,i),vec3.scale(i,.5),mat4.multiplyVec3(c,i,o),n[0]=Math.abs(c[0]),n[1]=Math.abs(c[1]),n[2]=Math.abs(c[2]),n[3]=Math.abs(c[4]),n[4]=Math.abs(c[5]),n[5]=Math.abs(c[6]),n[6]=Math.abs(c[8]),n[7]=Math.abs(c[9]),n[8]=Math.abs(c[10]),e[0]=n[0],e[1]=n[1],e[2]=n[2],a[0]=vec3.dot(t,e),e[0]=n[3],e[1]=n[4],e[2]=n[5],a[1]=vec3.dot(t,e),e[0]=n[6],e[1]=n[7],e[2]=n[8],a[2]=vec3.dot(t,e),vec3.subtract(o,a,this.min),vec3.add(o,a,this.max)}}(),t.AABB.prototype.intersects=function(t){return this.max[0]<t.min[0]||this.max[1]<t.min[1]||this.max[2]<t.min[2]||this.min[0]>t.max[0]||this.min[1]>t.max[1]||this.min[2]>t.max[2]?!1:!0},t.AABB.prototype.testRayIntersect=function(){var e,i,o,a,n,s=vec3.create();return function(c,r){e=0,vec3.subtract(r,c,s),i=vec3.length(s),vec3.scale(s,1/i);for(var h=0;3>h;h++){var l=0===h?this.half_width:1===h?this.half_height:this.half_depth;if(Math.abs(s[h])<t.EPSILON){if(-l>c[h]||c[h]>l)return!1}else if(o=1/s[h],a=(-l-c[h])*o,n=(l-c[h])*o,a>n&&(o=a,a=n,n=o),e=Math.max(e,a),i=Math.min(i,n),e>i)return!1}return!0}}(),t.BasicBroadphase=function(){this.bodies=[],this.collision_pairs=[]},t.BasicBroadphase.prototype.addBody=function(t){this.bodies.push(t)},t.BasicBroadphase.prototype.removeBody=function(t){var e,i=this.bodies.length;for(e=0;i>e;e++)if(this.bodies[e]===t){this.bodies.splice(e,1);break}},t.BasicBroadphase.prototype.predictContactPairs=function(){var t,e,i,o,a=this.bodies.length;for(this.collision_pairs.length=0,t=0;a>t;t++)for(i=this.bodies[t],e=0;a>e;e++)e>=t||(o=this.bodies[e],(1/0!==i.mass||1/0!==o.mass)&&i.aabb.intersects(o.aabb)&&this.collision_pairs.push([i,o]))},t.BasicBroadphase.prototype.rayIntersect=function(t,e){var i,o,a=this.bodies.length,n=[];for(i=0;a>i;i++)o=this.bodies[i],o.aabb.testRayIntersect(t,e)&&o.rayIntersect(t,e,n);return n},t.BoxSphere=function(a,n){var s,r,h=a.shape instanceof t.SphereShape?a:n,l=a.shape instanceof t.SphereShape?n:a;return mat4.multiplyVec3(l.transform_inverse,h.position,e),Math.abs(e[0])-h.shape.radius>l.shape.half_width||Math.abs(e[1])-h.shape.radius>l.shape.half_height||Math.abs(e[2])-h.shape.radius>l.shape.half_depth||(i[0]=i[1]=i[2]=0,r=e[0],r>l.shape.half_width?r=l.shape.half_width:-l.shape.half_width>r&&(r=-l.shape.half_width),i[0]=r,r=e[1],r>l.shape.half_height?r=l.shape.half_height:-l.shape.half_height>r&&(r=-l.shape.half_height),i[1]=r,r=e[2],r>l.shape.half_depth?r=l.shape.half_depth:-l.shape.half_depth>r&&(r=-l.shape.half_depth),i[2]=r,vec3.subtract(i,e,o),r=vec3.squaredLength(o),r>h.shape.radius*h.shape.radius)?void 0:(s=t.ObjectPool.getObject("ContactDetails"),s.object_a=h,s.object_b=l,0===r?t.BoxSphere.spherePenetration(l.shape,e,i,s):(vec3.subtract(i,e,s.contact_normal),s.penetration_depth=-vec3.length(s.contact_normal),vec3.scale(s.contact_normal,-1/s.penetration_depth),vec3.set(i,s.contact_point_in_b)),s.penetration_depth+=h.shape.radius,mat4.toRotationMat(l.transform,c),mat4.multiplyVec3(c,s.contact_normal),mat4.toRotationMat(h.transform_inverse,c),mat4.multiplyVec3(c,s.contact_normal,s.contact_point_in_a),vec3.scale(s.contact_point_in_a,h.shape.radius),vec3.scale(s.contact_normal,h.shape.radius-s.penetration_depth/2,s.contact_point),vec3.add(s.contact_point,h.position),s.restitution=(h.restitution+l.restitution)/2,s.friction=(h.friction+l.friction)/2,s)},t.BoxSphere.spherePenetration=function(t,e,o,a){var n,s;0>e[0]?(n=t.half_width+e[0],o[0]=-t.half_width,o[1]=o[2]=0,a.penetration_depth=n):(n=t.half_width-e[0],o[0]=t.half_width,o[1]=o[2]=0,a.penetration_depth=n),0>e[1]?(s=t.half_height+e[1],n>s&&(n=s,o[1]=-t.half_height,o[0]=o[2]=0,a.penetration_depth=n)):(s=t.half_height-e[1],n>s&&(n=s,o[1]=t.half_height,o[0]=o[2]=0,a.penetration_depth=n)),0>e[2]?(s=t.half_depth+e[2],n>s&&(o[2]=-t.half_depth,o[0]=o[1]=0,a.penetration_depth=n)):(s=t.half_depth-e[2],n>s&&(o[2]=t.half_depth,o[0]=o[1]=0,a.penetration_depth=n)),vec3.set(i,a.contact_point_in_b),vec3.scale(a.contact_point_in_b,-1,a.contact_normal),vec3.normalize(a.contact_normal)},t.GjkEpa={SupportPoint:function(t,e,i,o){this.direction=t,this.witness_a=e,this.witness_b=i,this.point=o},findSupportPoint:function(t,i,o,a){vec3.set(o,a.direction),t.findSupportPoint(o,a.witness_a),vec3.negate(o,e),i.findSupportPoint(e,a.witness_b),vec3.subtract(a.witness_a,a.witness_b,a.point)},GJK:function(){var o,a=[],n=vec3.create(),s=0,c=20,r=vec3.create(),h=vec3.create(),l=vec3.create(),p=vec3.create(),_=vec3.create(),u=vec3.create(),b=vec3.create(),v=vec3.create(),f=!0,d=e,m=i,j=function(e,i){var o,a,n,s;if(2===e.length){if(o=e[1],a=e[0],vec3.negate(o.point,r),vec3.subtract(a.point,o.point,h),0===r[0]&&0===r[1]&&0===r[2])return!0;vec3.dot(h,r)>=0?(vec3.cross(h,r,i),vec3.cross(i,h),0===i[0]&&0===i[1]&&0===i[2]&&(vec3.normalize(h),i[0]=1-Math.abs(h[0]),i[1]=1-Math.abs(h[1]),i[2]=1-Math.abs(h[2]))):(vec3.set(r,i),e.length=1)}else if(3===e.length)o=e[2],a=e[1],n=e[0],vec3.negate(o.point,r),vec3.subtract(a.point,o.point,h),vec3.subtract(n.point,o.point,l),vec3.cross(h,l,_),vec3.cross(h,_,u),vec3.cross(_,l,b),vec3.dot(b,r)>=0?vec3.dot(l,r)>=0?(e.length=0,e.push(n,o),vec3.cross(l,r,i),vec3.cross(i,l)):vec3.dot(h,r)>=0?(e.length=0,e.push(a,o),vec3.cross(h,r,i),vec3.cross(i,h)):(e.length=0,e.push(o)):vec3.dot(u,r)>=0?vec3.dot(h,r)>=0?(e.length=0,e.push(a,o),vec3.cross(h,r,i),vec3.cross(i,h)):(e.length=0,e.push(o)):vec3.dot(_,r)>=0?vec3.set(_,i):(vec3.set(_,i),vec3.negate(i),e.length=0,e.push(o,a,n));else if(4===e.length){if(o=e[3],a=e[2],n=e[1],s=e[0],vec3.negate(o.point,r),f=!0,vec3.subtract(s.point,o.point,h),vec3.subtract(n.point,o.point,p),vec3.cross(h,p,b),vec3.dot(b,o.point)>0&&(f=!1),vec3.subtract(n.point,o.point,h),vec3.subtract(a.point,o.point,p),vec3.cross(h,p,b),vec3.dot(b,o.point)>0&&(f=!1),vec3.subtract(a.point,o.point,h),vec3.subtract(s.point,o.point,p),vec3.cross(h,p,b),vec3.dot(b,o.point)>0&&(f=!1),vec3.subtract(a.point,s.point,h),vec3.subtract(n.point,s.point,p),vec3.cross(h,p,b),vec3.dot(b,s.point)>0&&(f=!1),f)return f;var c=1/0,j=0;if(t.GeometryMethods.findClosestPointInTriangle(v,s.point,n.point,o.point,m),vec3.squaredLength(m)<t.EPSILON)return!0;if(vec3.subtract(s.point,o.point,h),vec3.subtract(n.point,o.point,p),vec3.cross(h,p,d),j=vec3.length(m),c>j&&(c=j,vec3.set(d,i),e.length=0,e.push(o,n,s)),t.GeometryMethods.findClosestPointInTriangle(v,n.point,a.point,o.point,m),vec3.squaredLength(m)<t.EPSILON)return!0;if(vec3.subtract(n.point,o.point,h),vec3.subtract(a.point,o.point,p),vec3.cross(h,p,d),j=vec3.length(m),c>j&&(c=j,vec3.set(d,i),e.length=0,e.push(o,a,n)),t.GeometryMethods.findClosestPointInTriangle(v,a.point,s.point,o.point,m),vec3.squaredLength(m)<t.EPSILON)return!0;if(vec3.subtract(a.point,o.point,h),vec3.subtract(s.point,o.point,p),vec3.cross(h,p,d),j=vec3.length(m),c>j&&(c=j,vec3.set(d,i),e.length=0,e.push(a,s,o)),t.GeometryMethods.findClosestPointInTriangle(v,s.point,a.point,n.point,m),vec3.squaredLength(m)<t.EPSILON)return!0;vec3.subtract(s.point,n.point,h),vec3.subtract(a.point,n.point,p),vec3.cross(h,p,d),j=vec3.length(m),c>j&&(c=j,vec3.set(d,i),e.length=0,e.push(n,a,s))}return!1};return function(e,i){if(a.length=0,s=0,vec3.subtract(i.position,e.position,n),vec3.normalize(n),o=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(e,i,n,o),a.push(o),0>vec3.dot(a[0].point,n))return!1;for(vec3.negate(n);;){if(s++,s===c)return!1;if(o=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(e,i,n,o),a.push(o),0>vec3.dot(a[a.length-1].point,n))return!1;if(j(a,n))return t.GjkEpa.EPA(e,i,a)}}}(),EPA:function(a,n,s){function c(t,e){var i=[];return(vec3.equal(t.a.point,e.a.point)||vec3.equal(t.a.point,e.b.point)||vec3.equal(t.a.point,e.c.point))&&i.push(t.a),(vec3.equal(t.b.point,e.a.point)||vec3.equal(t.b.point,e.b.point)||vec3.equal(t.b.point,e.c.point))&&i.push(t.b),(vec3.equal(t.c.point,e.a.point)||vec3.equal(t.c.point,e.b.point)||vec3.equal(t.c.point,e.c.point))&&i.push(t.c),i}var r,h=e,l=i,p=o,_=h;if(2===s.length&&(vec3.cross(s[0].point,s[1].point,_),r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(a,n,_,r),s.push(r)),3===s.length){var u=s[2],b=s[1],v=s[0],f=h,d=l,m=p;vec3.negate(u.point,f),vec3.subtract(b.point,u.point,d),vec3.subtract(v.point,u.point,m),vec3.cross(d,m,_),r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(a,n,_,r),s.push(r)}var j=[];j.push(new t.GjkEpa.GjkFace(s[0],s[2],s[3],vec3.create(),0),new t.GjkEpa.GjkFace(s[0],s[1],s[2],vec3.create(),1),new t.GjkEpa.GjkFace(s[0],s[3],s[1],vec3.create(),2),new t.GjkEpa.GjkFace(s[3],s[2],s[1],vec3.create(),3)),vec3.subtract(j[0].b.point,j[0].a.point,h),vec3.subtract(j[0].c.point,j[0].a.point,l),vec3.cross(h,l,j[0].normal),vec3.normalize(j[0].normal),vec3.subtract(j[1].b.point,j[1].a.point,h),vec3.subtract(j[1].c.point,j[1].a.point,l),vec3.cross(h,l,j[1].normal),vec3.normalize(j[1].normal),vec3.subtract(j[2].b.point,j[2].a.point,h),vec3.subtract(j[2].c.point,j[2].a.point,l),vec3.cross(h,l,j[2].normal),vec3.normalize(j[2].normal),vec3.subtract(j[3].b.point,j[3].a.point,h),vec3.subtract(j[3].c.point,j[3].a.point,l),vec3.cross(h,l,j[3].normal),vec3.normalize(j[3].normal);for(var g,y,w,B,x,P,S=1/0,C=null,O=vec3.create(),F=vec3.create(),M=vec3.create(),I=0;;){for(I++,P=1/0,g=j.length-1;g>=0;)w=j[g],null!==w?(t.GeometryMethods.findClosestPointInTriangle(O,w.a.point,w.b.point,w.c.point,F),B=vec3.squaredLength(F),P>B&&(vec3.set(F,M),P=B,x=g),g--):g--;if(1e-4>S-P&&C===j[x]||20===I){var G=t.ObjectPool.getObject("ContactDetails");G.object_a=a,G.object_b=n,vec3.set(j[x].normal,G.contact_normal);var A=vec3.create();if(t.GeometryMethods.findBarycentricCoordinates(M,j[x].a.point,j[x].b.point,j[x].c.point,A),isNaN(A[0]))return!1;var L={a:vec3.create(),b:vec3.create(),c:vec3.create()};return vec3.scale(j[x].a.witness_a,A[0],L.a),vec3.scale(j[x].b.witness_a,A[1],L.b),vec3.scale(j[x].c.witness_a,A[2],L.c),vec3.add(L.a,L.b,G.contact_point_in_a),vec3.add(G.contact_point_in_a,L.c),vec3.scale(j[x].a.witness_b,A[0],L.a),vec3.scale(j[x].b.witness_b,A[1],L.b),vec3.scale(j[x].c.witness_b,A[2],L.c),vec3.add(L.a,L.b,G.contact_point_in_b),vec3.add(G.contact_point_in_b,L.c),vec3.add(G.contact_point_in_a,G.contact_point_in_b,G.contact_point),vec3.scale(G.contact_point,.5),mat4.multiplyVec3(G.object_a.transform_inverse,G.contact_point_in_a),mat4.multiplyVec3(G.object_b.transform_inverse,G.contact_point_in_b),G.penetration_depth=Math.sqrt(P),G.restitution=(a.restitution+n.restitution)/2,G.friction=(G.object_a.friction+G.object_b.friction)/2,G}r=t.ObjectPool.getObject("GJKSupportPoint"),t.GjkEpa.findSupportPoint(a,n,j[x].normal,r);var E=r,k=[];for(g=0;j.length>g;g++)null!==j[g]&&j[g].classifyVertex(E.point)>=t.EPSILON&&k.push(j[g]);var q=[];for(g=0;k.length>g;g++)for(y=0;k.length>y;y++)y>=g||Array.prototype.push.apply(q,c(k[g],k[y]));for(g=0;k.length>g;g++){w=k[g];var T=[];if((-1===q.indexOf(w.a)||-1===q.indexOf(w.b))&&T.push(new t.GjkEpa.GjkFace(w.a,w.b,E,vec3.create(),-1)),(-1===q.indexOf(w.b)||-1===q.indexOf(w.c))&&T.push(new t.GjkEpa.GjkFace(w.c,E,w.b,vec3.create(),-1)),(-1===q.indexOf(w.a)||-1===q.indexOf(w.c))&&T.push(new t.GjkEpa.GjkFace(w.c,w.a,E,vec3.create(),-1)),0!==T.length)for(j[w.index]=null,Array.prototype.push.apply(j,T),y=j.length-T.length;j.length>y;y++)vec3.subtract(j[y].b.point,j[y].a.point,h),vec3.subtract(j[y].c.point,j[y].a.point,l),vec3.cross(h,l,j[y].normal),vec3.normalize(j[y].normal),j[y].index=y}S=P,C=j[x]}}},t.GjkEpa.GjkFace=function(t,e,i,o,a){this.a=t,this.b=e,this.c=i,this.normal=o,this.index=a},t.GjkEpa.GjkFace.prototype.classifyVertex=function(t){var e=vec3.dot(this.normal,this.a.point),i=vec3.dot(this.normal,t)-e;return i},t.GjkEpa2={max_iterations:20,epa_condition:.001,SupportPoint:function(t,e,i){this.witness_a=t,this.witness_b=e,this.point=i},findSupportPoint:function(){var t=vec3.create();return function(e,i,o,a){e.findSupportPoint(o,a.witness_a),vec3.negate(o,t),i.findSupportPoint(t,a.witness_b),vec3.subtract(a.witness_a,a.witness_b,a.point)}}(),GJK:function(){return function(e,i){for(var o,a=new t.GjkEpa2.Simplex(e,i);o=a.addPoint(););return o===!1?null:a}}(),EPA:function(){return function(i){for(var o,a=new t.GjkEpa2.Polyhedron(i),n=0;++n;){a.findFaceClosestToOrigin(),a.closest_face_distance<t.EPSILON?vec3.set(a.faces[a.closest_face].normal,e):vec3.set(a.closest_point,e);var s=t.ObjectPool.getObject("GJK2SupportPoint");t.GjkEpa2.findSupportPoint(i.object_a,i.object_b,e,s),vec3.subtract(s.point,a.closest_point,e);var c=vec3.squaredLength(e);if(n===t.GjkEpa2.max_iterations||t.GjkEpa2.epa_condition>c&&a.closest_face_distance>t.EPSILON){var r=t.ObjectPool.getObject("ContactDetails");r.object_a=i.object_a,r.object_b=i.object_b,vec3.normalize(a.closest_point,r.contact_normal),0===vec3.squaredLength(r.contact_normal)&&vec3.subtract(r.object_b.position,r.object_a.position,r.contact_normal),vec3.normalize(r.contact_normal);var h=vec3.create();if(t.GeometryMethods.findBarycentricCoordinates(a.closest_point,a.faces[a.closest_face].a.point,a.faces[a.closest_face].b.point,a.faces[a.closest_face].c.point,h),isNaN(h[0]))return null;var l={a:vec3.create(),b:vec3.create(),c:vec3.create()};return vec3.scale(a.faces[a.closest_face].a.witness_a,h[0],l.a),vec3.scale(a.faces[a.closest_face].b.witness_a,h[1],l.b),vec3.scale(a.faces[a.closest_face].c.witness_a,h[2],l.c),vec3.add(l.a,l.b,r.contact_point_in_a),vec3.add(r.contact_point_in_a,l.c),vec3.scale(a.faces[a.closest_face].a.witness_b,h[0],l.a),vec3.scale(a.faces[a.closest_face].b.witness_b,h[1],l.b),vec3.scale(a.faces[a.closest_face].c.witness_b,h[2],l.c),vec3.add(l.a,l.b,r.contact_point_in_b),vec3.add(r.contact_point_in_b,l.c),vec3.add(r.contact_point_in_a,r.contact_point_in_b,r.contact_point),vec3.scale(r.contact_point,.5),mat4.multiplyVec3(r.object_a.transform_inverse,r.contact_point_in_a),mat4.multiplyVec3(r.object_b.transform_inverse,r.contact_point_in_b),r.penetration_depth=vec3.length(a.closest_point),r.restitution=(i.object_a.restitution+i.object_b.restitution)/2,r.friction=(i.object_a.friction+i.object_b.friction)/2,r}o=a.addVertex(s)}return null}}(),Face:function(t,o,a,n){this.active=!0,this.polyhedron=t,this.a=o,this.b=a,this.c=n,this.normal=vec3.create(),this.neighbors=[],vec3.subtract(a.point,o.point,e),vec3.subtract(n.point,o.point,i),vec3.cross(e,i,this.normal),vec3.normalize(this.normal)}},t.GjkEpa2.Polyhedron=function(e){this.closest_face=null,this.closest_face_distance=null,this.closest_point=vec3.create(),this.faces=[new t.GjkEpa2.Face(this,e.points[0],e.points[2],e.points[3]),new t.GjkEpa2.Face(this,e.points[0],e.points[1],e.points[2]),new t.GjkEpa2.Face(this,e.points[0],e.points[3],e.points[1]),new t.GjkEpa2.Face(this,e.points[3],e.points[2],e.points[1])],this.faces[0].neighbors.push(this.faces[1],this.faces[3],this.faces[2]),this.faces[1].neighbors.push(this.faces[2],this.faces[3],this.faces[0]),this.faces[2].neighbors.push(this.faces[0],this.faces[3],this.faces[1]),this.faces[3].neighbors.push(this.faces[0],this.faces[1],this.faces[2])},t.GjkEpa2.Polyhedron.prototype={addVertex:function(e){var i,o,a,n,s,c=[],r=[];for(this.faces[this.closest_face].silhouette(e,c),i=0;c.length-5>i;i+=5){if(a=c[i+3],n=c[i+4],0!==i&&s!==a)for(o=i+5;c.length>o;o+=5)if(c[o+3]===s){var h=c.slice(i,i+5);c[i]=c[o],c[i+1]=c[o+1],c[i+2]=c[o+2],c[i+3]=c[o+3],c[i+4]=c[o+4],c[o]=h[0],c[o+1]=h[1],c[o+2]=h[2],c[o+3]=h[3],c[o+4]=h[4],a=c[i+3],n=c[i+4];break}s=n}for(i=0;c.length>i;i+=5){var l=c[i];a=c[i+3],n=c[i+4];var p=new t.GjkEpa2.Face(this,n,e,a);p.neighbors[2]=c[i],r.push(p),l.neighbors[l.neighbors.indexOf(c[i+2])]=p}for(i=0;r.length>i;i++)r[i].neighbors[0]=r[i+1===r.length?0:i+1],r[i].neighbors[1]=r[0>i-1?r.length-1:i-1];return Array.prototype.push.apply(this.faces,r),c},findFaceClosestToOrigin:function(){var e=vec3.create(),i=vec3.create();return function(){this.closest_face_distance=1/0;var o,a;for(a=0;this.faces.length>a;a++)this.faces[a].active!==!1&&(t.GeometryMethods.findClosestPointInTriangle(e,this.faces[a].a.point,this.faces[a].b.point,this.faces[a].c.point,i),o=vec3.squaredLength(i),this.closest_face_distance>o&&(this.closest_face_distance=o,this.closest_face=a,vec3.set(i,this.closest_point)))}}()},t.GjkEpa2.Face.prototype={classifyVertex:function(t){var e=vec3.dot(this.normal,this.a.point),i=vec3.dot(this.normal,t.point)-e;return i},silhouette:function(t,e,i){if(this.active!==!1)if(this.classifyVertex(t)>0)this.active=!1,this.neighbors[0].silhouette(t,e,this),this.neighbors[1].silhouette(t,e,this),this.neighbors[2].silhouette(t,e,this);else if(i){var o,a,n=this.neighbors.indexOf(i);0===n?(o=this.a,a=this.b):1===n?(o=this.b,a=this.c):(o=this.c,a=this.a),e.push(this,n,i,a,o)}}},function(){var a=vec3.create(),n=vec3.create(),s=vec3.create(),c=vec3.create();t.GjkEpa2.Simplex=function(t,e){this.object_a=t,this.object_b=e,this.points=[],this.iterations=0,this.next_direction=vec3.create(),this.updateDirection()},t.GjkEpa2.Simplex.prototype={addPoint:function(){if(++this.iterations===t.GjkEpa2.max_iterations)return!1;var e=t.ObjectPool.getObject("GJK2SupportPoint");return t.GjkEpa2.findSupportPoint(this.object_a,this.object_b,this.next_direction,e),this.points.push(e),0>vec3.dot(this.points[this.points.length-1].point,this.next_direction)?!1:this.updateDirection()===!0?null:e},findDirectionFromLine:function(){vec3.negate(this.points[1].point,a),vec3.subtract(this.points[0].point,this.points[1].point,n),0>vec3.dot(n,a)?(vec3.set(a,this.next_direction),this.points.length=1):(vec3.cross(n,a,this.next_direction),vec3.cross(this.next_direction,n),0===this.next_direction[0]&&0===this.next_direction[1]&&0===this.next_direction[2]&&(vec3.normalize(n),this.next_direction[0]=1-Math.abs(n[0]),this.next_direction[1]=1-Math.abs(n[1]),this.next_direction[2]=1-Math.abs(n[2])))},findDirectionFromTriangle:function(){var t=this.points[2],c=this.points[1],r=this.points[0];vec3.negate(t.point,a),vec3.subtract(c.point,t.point,n),vec3.subtract(r.point,t.point,s),vec3.cross(n,s,e),vec3.cross(n,e,i),vec3.cross(e,s,o),vec3.dot(o,a)>=0?vec3.dot(s,a)>=0?(this.points.length=0,this.points.push(r,t),vec3.cross(s,a,this.next_direction),vec3.cross(this.next_direction,s)):vec3.dot(n,a)>=0?(this.points.length=0,this.points.push(c,t),vec3.cross(n,a,this.next_direction),vec3.cross(this.next_direction,n)):(this.points.length=0,this.points.push(t)):vec3.dot(i,a)>=0?vec3.dot(n,a)>=0?(this.points.length=0,this.points.push(c,t),vec3.cross(n,a,this.next_direction),vec3.cross(this.next_direction,n)):(this.points.length=0,this.points.push(t)):vec3.dot(e,a)>=0?vec3.set(e,this.next_direction):(vec3.set(e,this.next_direction),vec3.negate(this.next_direction),this.points.length=0,this.points.push(t,c,r))},getFaceNormal:function(t,e,i,o){vec3.subtract(i.point,t.point,s),vec3.subtract(e.point,t.point,n),vec3.cross(s,n,o),vec3.normalize(o)},faceNormalDotOrigin:function(t,o,a){return this.getFaceNormal(t,o,a,e),vec3.add(t.point,o.point,i),vec3.add(i,a.point),vec3.negate(i),vec3.normalize(i),vec3.dot(e,i)},findDirectionFromTetrahedron:function(){var o=this.points[3],a=this.points[2],s=this.points[1],r=this.points[0];if(this.containsOrigin())return!0;var h=vec3.create(),l=1/0,p=0;t.GeometryMethods.findClosestPointInTriangle(h,r.point,s.point,o.point,i),vec3.subtract(r.point,o.point,n),vec3.subtract(s.point,o.point,c),vec3.cross(n,c,e),p=vec3.length(i),l>p&&(l=p,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(o,s,r)),t.GeometryMethods.findClosestPointInTriangle(h,s.point,a.point,o.point,i),vec3.subtract(s.point,o.point,n),vec3.subtract(a.point,o.point,c),vec3.cross(n,c,e),p=vec3.length(i),l>p&&(l=p,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(o,a,s)),t.GeometryMethods.findClosestPointInTriangle(h,a.point,r.point,o.point,i),vec3.subtract(a.point,o.point,n),vec3.subtract(r.point,o.point,c),vec3.cross(n,c,e),p=vec3.length(i),l>p&&(l=p,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(a,r,o)),t.GeometryMethods.findClosestPointInTriangle(h,r.point,a.point,s.point,i),vec3.subtract(r.point,s.point,n),vec3.subtract(a.point,s.point,c),vec3.cross(n,c,e),p=vec3.length(i),l>p&&(l=p,vec3.set(e,this.next_direction),this.points.length=0,this.points.push(s,a,r))},containsOrigin:function(){var t=this.points[3],i=this.points[2],o=this.points[1],a=this.points[0];return vec3.subtract(a.point,t.point,n),vec3.subtract(o.point,t.point,c),vec3.cross(n,c,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(o.point,t.point,n),vec3.subtract(i.point,t.point,c),vec3.cross(n,c,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(i.point,t.point,n),vec3.subtract(a.point,t.point,c),vec3.cross(n,c,e),vec3.dot(e,t.point)>0?!1:(vec3.subtract(i.point,a.point,n),vec3.subtract(o.point,a.point,c),vec3.cross(n,c,e),vec3.dot(e,a.point)>0?!1:!0)))},updateDirection:function(){if(0===this.points.length)vec3.subtract(this.object_b.position,this.object_a.position,this.next_direction);else if(1===this.points.length)vec3.negate(this.next_direction);else if(2===this.points.length)this.findDirectionFromLine();else{if(3!==this.points.length)return this.findDirectionFromTetrahedron();this.findDirectionFromTriangle()}}}}(),t.SphereSphere=function(i,o){var a=i.position,n=o.position;vec3.subtract(n,a,e);var s=vec3.length(e);if(!(s>i.shape.radius+o.shape.radius)){var c=t.ObjectPool.getObject("ContactDetails");return c.object_a=i,c.object_b=o,vec3.scale(e,1/s,c.contact_normal),vec3.scale(e,-.5),vec3.add(e,a,c.contact_point),c.penetration_depth=i.shape.radius+o.shape.radius-s,vec3.scale(c.contact_normal,c.object_a.shape.radius,c.contact_point_in_a),vec3.add(c.contact_point_in_a,c.object_a.position),vec3.scale(c.contact_normal,-c.object_b.shape.radius,c.contact_point_in_b),vec3.add(c.contact_point_in_b,c.object_b.position),vec3.add(c.contact_point_in_a,c.contact_point_in_b,c.contact_point),vec3.scale(c.contact_point,.5),mat4.multiplyVec3(c.object_a.transform_inverse,c.contact_point_in_a),mat4.multiplyVec3(c.object_b.transform_inverse,c.contact_point_in_b),c.restitution=(i.restitution+o.restitution)/2,c.friction=(i.friction+o.friction)/2,c}},t.Constraint=function(){this.object_a=null,this.object_b=null,this.rows=[]},t.ConstraintRow=function(){this.jacobian=new Float64Array(12),this.B=new Float64Array(12),this.D=0,this.lower_limit=-1/0,this.upper_limit=1/0,this.bias=0,this.multiplier=0,this.eta=0,this.eta_row=new Float64Array(12),this.applied_push_impulse=0},t.ConstraintRow.prototype.computeB=function(t){var i=0;null!=t.object_a&&1/0!==t.object_a.mass?(i=1/t.object_a.mass,this.B[0]=i*this.jacobian[0],this.B[1]=i*this.jacobian[1],this.B[2]=i*this.jacobian[2],e[0]=this.jacobian[3],e[1]=this.jacobian[4],e[2]=this.jacobian[5],mat3.multiplyVec3(t.object_a.inverseInertiaTensorWorldFrame,e),this.B[3]=e[0],this.B[4]=e[1],this.B[5]=e[2]):(this.B[0]=this.B[1]=this.B[2]=0,this.B[3]=this.B[4]=this.B[5]=0),null!=t.object_b&&1/0!==t.object_b.mass?(i=1/t.object_b.mass,this.B[6]=i*this.jacobian[6],this.B[7]=i*this.jacobian[7],this.B[8]=i*this.jacobian[8],e[0]=this.jacobian[9],e[1]=this.jacobian[10],e[2]=this.jacobian[11],mat3.multiplyVec3(t.object_b.inverseInertiaTensorWorldFrame,e),this.B[9]=e[0],this.B[10]=e[1],this.B[11]=e[2]):(this.B[6]=this.B[7]=this.B[8]=0,this.B[9]=this.B[10]=this.B[11]=0)},t.ConstraintRow.prototype.computeD=function(){this.D=this.jacobian[0]*this.B[0]+this.jacobian[1]*this.B[1]+this.jacobian[2]*this.B[2]+this.jacobian[3]*this.B[3]+this.jacobian[4]*this.B[4]+this.jacobian[5]*this.B[5]+this.jacobian[6]*this.B[6]+this.jacobian[7]*this.B[7]+this.jacobian[8]*this.B[8]+this.jacobian[9]*this.B[9]+this.jacobian[10]*this.B[10]+this.jacobian[11]*this.B[11]},t.ConstraintRow.prototype.computeEta=function(t,i){var o,a=1/i;null==t.object_a||1/0===t.object_a.mass?this.eta_row[0]=this.eta_row[1]=this.eta_row[2]=this.eta_row[3]=this.eta_row[4]=this.eta_row[5]=0:(o=1/t.object_a.mass,this.eta_row[0]=(t.object_a.linear_velocity[0]+o*t.object_a.accumulated_force[0])*a,this.eta_row[1]=(t.object_a.linear_velocity[1]+o*t.object_a.accumulated_force[1])*a,this.eta_row[2]=(t.object_a.linear_velocity[2]+o*t.object_a.accumulated_force[2])*a,vec3.set(t.object_a.accumulated_torque,e),mat3.multiplyVec3(t.object_a.inverseInertiaTensorWorldFrame,e),this.eta_row[3]=(t.object_a.angular_velocity[0]+e[0])*a,this.eta_row[4]=(t.object_a.angular_velocity[1]+e[1])*a,this.eta_row[5]=(t.object_a.angular_velocity[2]+e[2])*a),null==t.object_b||1/0===t.object_b.mass?this.eta_row[6]=this.eta_row[7]=this.eta_row[8]=this.eta_row[9]=this.eta_row[10]=this.eta_row[11]=0:(o=1/t.object_b.mass,this.eta_row[6]=(t.object_b.linear_velocity[0]+o*t.object_b.accumulated_force[0])*a,this.eta_row[7]=(t.object_b.linear_velocity[1]+o*t.object_b.accumulated_force[1])*a,this.eta_row[8]=(t.object_b.linear_velocity[2]+o*t.object_b.accumulated_force[2])*a,vec3.set(t.object_b.accumulated_torque,e),mat3.multiplyVec3(t.object_b.inverseInertiaTensorWorldFrame,e),this.eta_row[9]=(t.object_b.angular_velocity[0]+e[0])*a,this.eta_row[10]=(t.object_b.angular_velocity[1]+e[1])*a,this.eta_row[11]=(t.object_b.angular_velocity[2]+e[2])*a);var n=this.jacobian[0]*this.eta_row[0]+this.jacobian[1]*this.eta_row[1]+this.jacobian[2]*this.eta_row[2]+this.jacobian[3]*this.eta_row[3]+this.jacobian[4]*this.eta_row[4]+this.jacobian[5]*this.eta_row[5]+this.jacobian[6]*this.eta_row[6]+this.jacobian[7]*this.eta_row[7]+this.jacobian[8]*this.eta_row[8]+this.jacobian[9]*this.eta_row[9]+this.jacobian[10]*this.eta_row[10]+this.jacobian[11]*this.eta_row[11];this.eta=this.bias*a-n},t.ContactConstraint=function(){t.Constraint.call(this),this.contact=null},t.ContactConstraint.prototype.buildFromContact=function(i){var o=this.rows[0]||t.ObjectPool.getObject("ConstraintRow");this.object_a=i.object_a,this.object_b=i.object_b,this.contact=i,o.lower_limit=0,o.upper_limit=1/0,null==this.object_a||1/0===this.object_a.mass?(o.jacobian[0]=o.jacobian[1]=o.jacobian[2]=0,o.jacobian[3]=o.jacobian[4]=o.jacobian[5]=0):(o.jacobian[0]=-i.contact_normal[0],o.jacobian[1]=-i.contact_normal[1],o.jacobian[2]=-i.contact_normal[2],vec3.subtract(i.contact_point,i.object_a.position,e),vec3.cross(e,i.contact_normal,e),o.jacobian[3]=-e[0],o.jacobian[4]=-e[1],o.jacobian[5]=-e[2]),null==this.object_b||1/0===this.object_b.mass?(o.jacobian[6]=o.jacobian[7]=o.jacobian[8]=0,o.jacobian[9]=o.jacobian[10]=o.jacobian[11]=0):(o.jacobian[6]=i.contact_normal[0],o.jacobian[7]=i.contact_normal[1],o.jacobian[8]=i.contact_normal[2],vec3.subtract(i.contact_point,i.object_b.position,e),vec3.cross(e,i.contact_normal,e),o.jacobian[9]=e[0],o.jacobian[10]=e[1],o.jacobian[11]=e[2]),o.bias=0;var a=0;1/0!==this.object_a.mass&&(this.object_a.getVelocityInLocalPoint(i.contact_point_in_a,e),a+=vec3.dot(e,i.contact_normal)),1/0!==this.object_b.mass&&(this.object_b.getVelocityInLocalPoint(i.contact_point_in_b,e),a-=vec3.dot(e,i.contact_normal)),o.bias+=a*i.restitution,this.rows[0]=o},t.FrictionConstraint=function(){t.Constraint.call(this)},t.FrictionConstraint.prototype.buildFromContact=function(i){var o=this.rows[0]||t.ObjectPool.getObject("ConstraintRow"),a=this.rows[1]||t.ObjectPool.getObject("ConstraintRow");this.object_a=i.object_a,this.object_b=i.object_b;var n=vec3.create(),s=vec3.create();vec3.subtract(i.contact_point,i.object_a.position,n),vec3.subtract(i.contact_point,i.object_b.position,s);var c=vec3.create(),r=vec3.create();c[0]=1-Math.abs(i.contact_normal[0]),c[1]=1-Math.abs(i.contact_normal[1]),c[2]=1-Math.abs(i.contact_normal[2]),vec3.normalize(c),vec3.cross(i.contact_normal,c,r),null==this.object_a||1/0===this.object_a.mass?(o.jacobian[0]=o.jacobian[1]=o.jacobian[2]=0,o.jacobian[3]=o.jacobian[4]=o.jacobian[5]=0,a.jacobian[0]=a.jacobian[1]=a.jacobian[2]=0,a.jacobian[3]=a.jacobian[4]=a.jacobian[5]=0):(o.jacobian[0]=-c[0],o.jacobian[1]=-c[1],o.jacobian[2]=-c[2],vec3.cross(n,c,e),o.jacobian[3]=-e[0],o.jacobian[4]=-e[1],o.jacobian[5]=-e[2],a.jacobian[0]=-r[0],a.jacobian[1]=-r[1],a.jacobian[2]=-r[2],vec3.cross(n,r,e),a.jacobian[3]=-e[0],a.jacobian[4]=-e[1],a.jacobian[5]=-e[2]),null==this.object_b||1/0===this.object_b.mass?(o.jacobian[6]=o.jacobian[7]=o.jacobian[8]=0,o.jacobian[9]=o.jacobian[10]=o.jacobian[11]=0,a.jacobian[6]=a.jacobian[7]=a.jacobian[8]=0,a.jacobian[9]=a.jacobian[10]=a.jacobian[11]=0):(o.jacobian[6]=c[0],o.jacobian[7]=c[1],o.jacobian[8]=c[2],vec3.cross(s,c,e),o.jacobian[9]=e[0],o.jacobian[10]=e[1],o.jacobian[11]=e[2],a.jacobian[6]=r[0],a.jacobian[7]=r[1],a.jacobian[8]=r[2],vec3.cross(s,r,e),a.jacobian[9]=e[0],a.jacobian[10]=e[1],a.jacobian[11]=e[2]);var h=vec3.dot(this.object_a.linear_velocity,i.contact_normal);h-=vec3.dot(this.object_b.linear_velocity,i.contact_normal);var l=0;l=null==this.object_a||1/0===this.object_a.mass?this.object_b.mass:null==this.object_b||1/0===this.object_b.mass?this.object_a.mass:(this.object_a.mass+this.object_b.mass)/2,h=1;var p=i.friction*h*l;0>p&&(p=0),o.lower_limit=a.lower_limit=-p,o.upper_limit=a.upper_limit=p,o.bias=a.bias=0,this.rows[0]=o,this.rows[1]=a},t.ContactDetails=function(){this.object_a=null,this.object_b=null,this.contact_point=vec3.create(),this.contact_point_in_a=vec3.create(),this.contact_point_in_b=vec3.create(),this.contact_normal=vec3.create(),this.penetration_depth=0,this.restitution=0,this.friction=0},t.ContactManifold=function(){this.object_a=null,this.object_b=null,this.points=[],this.next_manifold=null},t.ContactManifold.prototype.findWeakestContact=function(t){var o,a,n=-1,s=t.penetration_depth;for(o=0;4>o;o++)a=this.points[o],a.penetration_depth>s&&(s=a.penetration_depth,n=o);var c=0,r=0,h=0,l=0;0!==n&&(vec3.subtract(t.contact_point_in_a,this.points[1].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a,i),vec3.cross(e,i),c=vec3.squaredLength(e)),1!==n&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a,i),vec3.cross(e,i),r=vec3.squaredLength(e)),2!==n&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[3].contact_point_in_a,this.points[1].contact_point_in_a,i),vec3.cross(e,i),h=vec3.squaredLength(e)),3!==n&&(vec3.subtract(t.contact_point_in_a,this.points[0].contact_point_in_a,e),vec3.subtract(this.points[2].contact_point_in_a,this.points[1].contact_point_in_a,i),vec3.cross(e,i),l=vec3.squaredLength(e));var p=0,_=c;return r>_&&(p=1,_=r),h>_&&(p=2,_=h),l>_&&(p=3),p},t.ContactManifold.prototype.addContact=function(e){var i;for(i=0;this.points.length>i;i++)if(.02>=vec3.dist(this.points[i].contact_point,e.contact_point))return t.ObjectPool.freeObject("ContactDetails",e),void 0;this.points.push(e)},t.ContactManifold.prototype.update=function(){var i,o,a,n=vec3.create(),s=vec3.create(),c=vec3.create();for(i=0;this.points.length>i;i++)if(a=this.points[i],mat4.multiplyVec3(a.object_a.transform,a.contact_point_in_a,n),mat4.multiplyVec3(a.object_b.transform,a.contact_point_in_b,s),vec3.add(n,s,a.contact_point),vec3.scale(a.contact_point,.5),vec3.subtract(n,s,c),a.penetration_depth=vec3.dot(c,a.contact_normal),-.02>a.penetration_depth){for(t.ObjectPool.freeObject("ContactDetails",a),o=i;this.points.length>o;o++)this.points[o]=this.points[o+1];this.points.length=this.points.length-1
}else{vec3.scale(a.contact_normal,a.penetration_depth,e),vec3.subtract(n,e,e),vec3.subtract(s,e,e);var r=vec3.squaredLength(e);if(r>.2*.2){for(t.ObjectPool.freeObject("ContactDetails",a),o=i;this.points.length>o;o++)this.points[o]=this.points[o+1];this.points.length=this.points.length-1}}},t.ContactManifoldList=function(){this.first=null},t.ContactManifoldList.prototype.insert=function(t){t.next_manifold=this.first,this.first=t},t.ContactManifoldList.prototype.getManifoldForObjects=function(e,i){var o=null;if(null!==this.first)for(var a=this.first;null!==a;){if(a.object_a===e&&a.object_b===i||a.object_a===i&&a.object_b===e){o=a;break}a=a.next_manifold}return null===o&&(o=t.ObjectPool.getObject("ContactManifold"),o.object_a=e,o.object_b=i,this.insert(o)),o},t.ForceGenerator=function(t){this.force=t||vec3.create(),this.enabled=!0,this.affected=[]},t.ForceGenerator.prototype.applyForce=function(){if(this.enabled){var t,e;for(t=0,e=this.affected.length;e>t;t++)this.affected[t].applyForce(this.force)}},t.ForceGenerator.prototype.enable=function(){this.enabled=!0},t.ForceGenerator.prototype.disable=function(){this.enabled=!1},t.ForceGenerator.prototype.affect=function(t){var e,i;for(e=0,i=this.affected.length;i>e;e++)if(this.affected[e]===t)return;this.affected.push(t)},t.ForceGenerator.prototype.unaffect=function(t){var e,i;for(e=0,i=this.affected.length;i>e;e++)if(this.affected[e]===t)return this.affected.splice(e,1),void 0},t.DragForce=function(t,e){this.drag_coefficient=t||0,this.squared_drag_coefficient=e||0,this.enabled=!0,this.affected=[]},t.DragForce.prototype.enable=t.ForceGenerator.prototype.enable,t.DragForce.prototype.disable=t.ForceGenerator.prototype.disable,t.DragForce.prototype.affect=t.ForceGenerator.prototype.affect,t.DragForce.prototype.unaffect=t.ForceGenerator.prototype.unaffect,t.DragForce.prototype.applyForce=function(){if(this.enabled){var t,i,o,a,n=e;for(t=0,i=this.affected.length;i>t;t++)o=this.affected[t],vec3.set(o.linear_velocity,n),a=vec3.length(n),a=this.drag_coefficient*a+this.squared_drag_coefficient*a*a,vec3.normalize(n),vec3.scale(n,-a),o.applyForce(n)}},t.IterativeSolver=function(){this.contact_constraints=[],this.friction_constraints=[],this.constraints=[],this.max_iterations=10,this.penetrations_max_iterations=5,this.relaxation=.5},t.IterativeSolver.prototype.processContactManifolds=function(e){var i,o,a,n,s,c;for(this.contact_constraints.length=0,this.friction_constraints.length=0,a=e.first,i=0;a;){for(i++,n=a.points.length,o=0;n>o;o++)s=a.points[o],c=t.ObjectPool.getObject("ContactConstraint"),c.buildFromContact(s),this.contact_constraints.push(c),c=t.ObjectPool.getObject("FrictionConstraint"),c.buildFromContact(s),this.friction_constraints.push(c);a=a.next_manifold}this.constraints=[],Array.prototype.push.apply(this.constraints,this.contact_constraints),Array.prototype.push.apply(this.constraints,this.friction_constraints)},t.IterativeSolver.prototype.prepareConstraints=function(t){var e,i,o,a,n,s=this.constraints.length;for(a=0;s>a;a++)for(i=this.constraints[a],e=i.rows.length,n=0;e>n;n++)o=i.rows[n],o.multiplier=0,o.computeB(i),o.computeD(),o.computeEta(i,t)},t.IterativeSolver.prototype.resolveContacts=function(){var i,o,n,s,c,r,h,l=0;for(i=0;this.penetrations_max_iterations>i;i++){for(l=0,c=0;this.contact_constraints.length>c;c++){o=this.contact_constraints[c],s=o.rows[0],n=0,null!=o.object_a&&1/0!==o.object_a.mass&&(n+=s.jacobian[0]*o.object_a.push_velocity[0]+s.jacobian[1]*o.object_a.push_velocity[1]+s.jacobian[2]*o.object_a.push_velocity[2]+s.jacobian[3]*o.object_a.turn_velocity[0]+s.jacobian[4]*o.object_a.turn_velocity[1]+s.jacobian[5]*o.object_a.turn_velocity[2]),null!=o.object_b&&1/0!==o.object_b.mass&&(n+=s.jacobian[6]*o.object_b.push_velocity[0]+s.jacobian[7]*o.object_b.push_velocity[1]+s.jacobian[8]*o.object_b.push_velocity[2]+s.jacobian[9]*o.object_b.turn_velocity[0]+s.jacobian[10]*o.object_b.turn_velocity[1]+s.jacobian[11]*o.object_b.turn_velocity[2]),r=(o.contact.penetration_depth-n)/s.D;var p=s.multiplier;s.multiplier=Math.max(s.lower_limit,Math.min(p+r,s.upper_limit)),r=s.multiplier-p,l=Math.max(l,r),o.object_a&&1/0!==o.object_a.mass&&(o.object_a.push_velocity[0]+=r*s.B[0],o.object_a.push_velocity[1]+=r*s.B[1],o.object_a.push_velocity[2]+=r*s.B[2],o.object_a.turn_velocity[0]+=r*s.B[3],o.object_a.turn_velocity[1]+=r*s.B[4],o.object_a.turn_velocity[2]+=r*s.B[5]),o.object_b&&1/0!==o.object_b.mass&&(o.object_b.push_velocity[0]+=r*s.B[6],o.object_b.push_velocity[1]+=r*s.B[7],o.object_b.push_velocity[2]+=r*s.B[8],o.object_b.turn_velocity[0]+=r*s.B[9],o.object_b.turn_velocity[1]+=r*s.B[10],o.object_b.turn_velocity[2]+=r*s.B[11])}if(l>=-t.EPSILON&&t.EPSILON>=l)break}for(c=0;this.contact_constraints.length>c;c++)o=this.contact_constraints[c],s=o.rows[0],null!=o.object_a&&1/0!==o.object_a.mass&&(h=1/o.object_a.mass,o.object_a.position[0]+=h*s.jacobian[0]*s.multiplier*this.relaxation,o.object_a.position[1]+=h*s.jacobian[1]*s.multiplier*this.relaxation,o.object_a.position[2]+=h*s.jacobian[2]*s.multiplier*this.relaxation,e[0]=s.jacobian[3]*s.multiplier*this.relaxation,e[1]=s.jacobian[4]*s.multiplier*this.relaxation,e[2]=s.jacobian[5]*s.multiplier*this.relaxation,mat3.multiplyVec3(o.object_a.inverseInertiaTensorWorldFrame,e),a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=0,quat4.multiply(a,o.object_a.rotation),o.object_a.rotation[0]+=.5*a[0],o.object_a.rotation[1]+=.5*a[1],o.object_a.rotation[2]+=.5*a[2],o.object_a.rotation[3]+=.5*a[3],quat4.normalize(o.object_a.rotation)),null!=o.object_b&&1/0!==o.object_b.mass&&(h=1/o.object_b.mass,o.object_b.position[0]+=h*s.jacobian[6]*s.multiplier*this.relaxation,o.object_b.position[1]+=h*s.jacobian[7]*s.multiplier*this.relaxation,o.object_b.position[2]+=h*s.jacobian[8]*s.multiplier*this.relaxation,e[0]=s.jacobian[9]*s.multiplier*this.relaxation,e[1]=s.jacobian[10]*s.multiplier*this.relaxation,e[2]=s.jacobian[11]*s.multiplier*this.relaxation,mat3.multiplyVec3(o.object_b.inverseInertiaTensorWorldFrame,e),a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=0,quat4.multiply(a,o.object_b.rotation),o.object_b.rotation[0]+=.5*a[0],o.object_b.rotation[1]+=.5*a[1],o.object_b.rotation[2]+=.5*a[2],o.object_b.rotation[3]+=.5*a[3],quat4.normalize(o.object_b.rotation))},t.IterativeSolver.prototype.solveConstraints=function(){var e,i,o,a,n,s,c,r,h=this.constraints.length,l=0;for(s=0;this.max_iterations>s;s++){for(l=0,a=0;h>a;a++)for(e=this.constraints[a],i=e.rows.length,n=0;i>n;n++){o=e.rows[n],r=0,null!=e.object_a&&1/0!==e.object_a.mass&&(r+=o.jacobian[0]*e.object_a.solver_impulse[0]+o.jacobian[1]*e.object_a.solver_impulse[1]+o.jacobian[2]*e.object_a.solver_impulse[2]+o.jacobian[3]*e.object_a.solver_impulse[3]+o.jacobian[4]*e.object_a.solver_impulse[4]+o.jacobian[5]*e.object_a.solver_impulse[5]),null!=e.object_b&&1/0!==e.object_b.mass&&(r+=o.jacobian[6]*e.object_b.solver_impulse[0]+o.jacobian[7]*e.object_b.solver_impulse[1]+o.jacobian[8]*e.object_b.solver_impulse[2]+o.jacobian[9]*e.object_b.solver_impulse[3]+o.jacobian[10]*e.object_b.solver_impulse[4]+o.jacobian[11]*e.object_b.solver_impulse[5]),c=(o.eta-r)/o.D;var p=o.multiplier;o.multiplier=Math.max(o.lower_limit,Math.min(p+c,o.upper_limit)),c=o.multiplier-p,l=Math.max(l,c),e.object_a&&1/0!==e.object_a.mass&&(e.object_a.solver_impulse[0]+=c*o.B[0],e.object_a.solver_impulse[1]+=c*o.B[1],e.object_a.solver_impulse[2]+=c*o.B[2],e.object_a.solver_impulse[3]+=c*o.B[3],e.object_a.solver_impulse[4]+=c*o.B[4],e.object_a.solver_impulse[5]+=c*o.B[5]),e.object_b&&1/0!==e.object_b.mass&&(e.object_b.solver_impulse[0]+=c*o.B[6],e.object_b.solver_impulse[1]+=c*o.B[7],e.object_b.solver_impulse[2]+=c*o.B[8],e.object_b.solver_impulse[3]+=c*o.B[9],e.object_b.solver_impulse[4]+=c*o.B[10],e.object_b.solver_impulse[5]+=c*o.B[11])}if(l>=-t.EPSILON&&t.EPSILON>=l)break}},t.IterativeSolver.prototype.applyConstraints=function(t){var i,o,a,n,s,c,r=this.constraints.length;for(n=0;r>n;n++)for(i=this.constraints[n],o=i.rows.length,s=0;o>s;s++)a=i.rows[s],null!=i.object_a&&1/0!==i.object_a.mass&&(c=1/i.object_a.mass,i.object_a.linear_velocity[0]+=c*t*a.jacobian[0]*a.multiplier,i.object_a.linear_velocity[1]+=c*t*a.jacobian[1]*a.multiplier,i.object_a.linear_velocity[2]+=c*t*a.jacobian[2]*a.multiplier,e[0]=t*a.jacobian[3]*a.multiplier,e[1]=t*a.jacobian[4]*a.multiplier,e[2]=t*a.jacobian[5]*a.multiplier,mat3.multiplyVec3(i.object_a.inverseInertiaTensorWorldFrame,e),i.object_a.angular_velocity[0]+=e[0],i.object_a.angular_velocity[1]+=e[1],i.object_a.angular_velocity[2]+=e[2]),null!=i.object_b&&1/0!==i.object_b.mass&&(c=1/i.object_b.mass,i.object_b.linear_velocity[0]+=c*t*a.jacobian[6]*a.multiplier,i.object_b.linear_velocity[1]+=c*t*a.jacobian[7]*a.multiplier,i.object_b.linear_velocity[2]+=c*t*a.jacobian[8]*a.multiplier,e[0]=t*a.jacobian[9]*a.multiplier,e[1]=t*a.jacobian[10]*a.multiplier,e[2]=t*a.jacobian[11]*a.multiplier,mat3.multiplyVec3(i.object_b.inverseInertiaTensorWorldFrame,e),i.object_b.angular_velocity[0]+=e[0],i.object_b.angular_velocity[1]+=e[1],i.object_b.angular_velocity[2]+=e[2])},t.LinkedList=function(){this.first=null},t.LinkedList.prototype.add=function(t){null==this.first?this.first=t:(this.first.prev=t,t.next=this.first,this.first=t)},t.LinkedList.prototype.remove=function(t){for(var e;e=this.first;){if(e.value===t)return e.prev&&(e.prev=e.next),e.next&&(e.next=e.prev),void 0;e=e.next}},t.LinkedListEntry=function(t){this.value=t,this.prev=null,this.next=null},t.GeometryMethods={findClosestPointInTriangle:function(){var t=vec3.create(),e=vec3.create(),i=vec3.create();return function(o,a,n,s,c){var r;vec3.subtract(n,a,t),vec3.subtract(s,a,e),vec3.subtract(o,a,i);var h=vec3.dot(t,i),l=vec3.dot(e,i);if(0>=h&&0>=l)return vec3.set(a,c),void 0;vec3.subtract(o,n,i);var p=vec3.dot(t,i),_=vec3.dot(e,i);if(p>=0&&p>=_)return vec3.set(n,c),void 0;var u=h*_-p*l;if(0>=u&&h>=0&&0>=p)return r=h/(h-p),vec3.scale(t,r,c),vec3.add(c,a),void 0;vec3.subtract(o,s,i);var b=vec3.dot(t,i),v=vec3.dot(e,i);if(v>=0&&v>=b)return vec3.set(s,c),void 0;var f,d=b*l-h*v;if(0>=d&&l>=0&&0>=v)return f=l/(l-v),vec3.scale(e,f,c),vec3.add(c,a),void 0;var m=p*v-b*_;if(0>=m&&_-p>=0&&b-v>=0)return f=(_-p)/(_-p+(b-v)),vec3.subtract(s,n,c),vec3.scale(c,f),vec3.add(c,n),void 0;var j=1/(m+d+u);r=d*j,f=u*j,vec3.scale(t,r),vec3.add(t,a),vec3.scale(e,f),vec3.add(t,e,c)}}(),findBarycentricCoordinates:function(t,e,i,o,a){var n=vec3.create(),s=vec3.create(),c=vec3.create();vec3.subtract(i,e,n),vec3.subtract(o,e,s),vec3.subtract(t,e,c);var r=vec3.dot(n,n),h=vec3.dot(n,s),l=vec3.dot(s,s),p=vec3.dot(c,n),_=vec3.dot(c,s),u=r*l-h*h;a[1]=(l*p-h*_)/u,a[2]=(r*_-h*p)/u,a[0]=1-a[1]-a[2]}},t.NearPhase=function(){this.contact_manifolds=new t.ContactManifoldList},t.NearPhase.prototype.updateContactManifolds=function(){for(var e=this.contact_manifolds.first,i=null;null!==e;)e.update(),0===e.points.length?(t.ObjectPool.freeObject("ContactManifold",e),null==i?this.contact_manifolds.first=e.next_manifold:i.next_manifold=e.next_manifold,e=e.next_manifold):(i=e,e=e.next_manifold)},t.NearPhase.prototype.midPhase=function(e,i){var o,a;e.shape instanceof t.CompoundShape?(o=e,a=i):(o=i,a=e);for(var n,s,c=t.ObjectPool.getObject("RigidBodyProxy"),r=0;o.shape.child_shapes.length>r;r++)if(n=o.shape.child_shapes[r],c.setFrom(o,n),c.shape instanceof t.CompoundShape||a.shape instanceof t.CompoundShape)this.midPhase(c,a);else if(s=this.getContact(c,a),null!=s){var h,l;if(s.object_a===c?(s.object_a=o,h=c,l=a):(s.object_b=o,h=a,l=c),h instanceof t.RigidBodyProxy)for(;h.parent;)h instanceof t.RigidBodyProxy&&mat4.multiplyVec3(h.shape_data.transform,s.contact_point_in_a),h=h.parent;if(l instanceof t.RigidBodyProxy)for(;l.parent;)l instanceof t.RigidBodyProxy&&mat4.multiplyVec3(l.shape_data.transform,s.contact_point_in_b),l=l.parent;s.object_a=h,s.object_b=l,this.addContact(h,l,s)}t.ObjectPool.freeObject("RigidBodyProxy",c)},t.NearPhase.prototype.getContact=function(e,i){if(e.shape instanceof t.CompoundShape||i.shape instanceof t.CompoundShape)return this.midPhase(e,i),void 0;var o;return e.shape instanceof t.SphereShape&&i.shape instanceof t.SphereShape?o=t.SphereSphere(e,i):e.shape instanceof t.SphereShape&&i.shape instanceof t.BoxShape||e.shape instanceof t.BoxShape&&i.shape instanceof t.SphereShape?o=t.BoxSphere(e,i):null!=(o=t.GjkEpa2.GJK(e,i))&&(o=t.GjkEpa2.EPA(o)),o},t.NearPhase.prototype.addContact=function(t,e,i){this.contact_manifolds.getManifoldForObjects(t,e).addContact(i)},t.NearPhase.prototype.generateContacts=function(t){var e,i,o=t.length;for(this.updateContactManifolds(),e=0;o>e;e++)i=this.getContact(t[e][0],t[e][1]),null!=i&&this.addContact(t[e][0],t[e][1],i)},t.ObjectPool={types:{},pools:{},registerType:function(t,e){this.types[t]=e,this.pools[t]=[]},getObject:function(t){var e=this.pools[t];return 0!==e.length?e.pop():this.types[t]()},freeObject:function(t,e){this.pools[t].push(e)}},t.ObjectPool.registerType("ContactDetails",function(){return new t.ContactDetails}),t.ObjectPool.registerType("ContactManifold",function(){return new t.ContactManifold}),t.ObjectPool.registerType("GJKSupportPoint",function(){return new t.GjkEpa.SupportPoint(vec3.create(),vec3.create(),vec3.create(),vec3.create())}),t.ObjectPool.registerType("GJK2SupportPoint",function(){return new t.GjkEpa2.SupportPoint(vec3.create(),vec3.create(),vec3.create(),vec3.create())}),t.ObjectPool.registerType("ConstraintRow",function(){return new t.ConstraintRow}),t.ObjectPool.registerType("ContactConstraint",function(){return new t.ContactConstraint}),t.ObjectPool.registerType("FrictionConstraint",function(){return new t.FrictionConstraint}),t.ObjectPool.registerType("RayIntersection",function(){return new t.RayIntersection}),t.ObjectPool.registerType("RigidBodyProxy",function(){return new t.RigidBodyProxy}),t.RayIntersection=function(){this.object=null,this.point=vec3.create(),this.t=null},t.RigidBody=function(){var e=0;return function(i,o){this.id=e++,this.shape=i,this.aabb=new t.AABB,this.mass=o||1/0,this.position=vec3.create(),this.rotation=quat4.createFrom(0,0,0,1),this.linear_velocity=vec3.create(),this.angular_velocity=vec3.create(),this.transform=mat4.identity(),this.transform_inverse=mat4.identity(),this.inertiaTensor=i.getInertiaTensor(o),this.inverseInertiaTensor=mat3.inverse(this.inertiaTensor),this.inertiaTensorWorldFrame=mat3.create(),this.inverseInertiaTensorWorldFrame=mat3.create(),this.acceleration=vec3.create(),this.restitution=.1,this.friction=.5,this.gravity=null,this.world=null,this.accumulated_force=vec3.create(),this.accumulated_torque=vec3.create(),this.push_velocity=vec3.create(),this.turn_velocity=vec3.create(),this.solver_impulse=new Float64Array(6),this.updateDerived()}}(),t.RigidBody.prototype.findSupportPoint=function(){var t=vec3.create();return function(e,i){var o=this.transform_inverse[12],a=this.transform_inverse[13],n=this.transform_inverse[14];this.transform_inverse[12]=this.transform_inverse[13]=this.transform_inverse[14]=0,mat4.multiplyVec3(this.transform_inverse,e,t),this.transform_inverse[12]=o,this.transform_inverse[13]=a,this.transform_inverse[14]=n,this.shape.findSupportPoint(t,i),mat4.multiplyVec3(this.transform,i)}}(),t.RigidBody.prototype.rayIntersect=function(){var t=vec3.create(),e=vec3.create();return function(i,o,a){mat4.multiplyVec3(this.transform_inverse,i,t),mat4.multiplyVec3(this.transform_inverse,o,e);var n=this.shape.rayIntersect(t,e);null!=n&&(n.object=this,mat4.multiplyVec3(this.transform,n.point),a.push(n))}}(),t.RigidBody.prototype.integrate=function(t){if(1/0!==this.mass){var i=1/this.mass;vec3.scale(this.accumulated_force,i,e),vec3.add(this.linear_velocity,e),mat3.multiplyVec3(this.inverseInertiaTensorWorldFrame,this.accumulated_torque,e),vec3.add(this.angular_velocity,e),vec3.scale(this.linear_velocity,t,e),vec3.add(this.position,e),a[0]=this.angular_velocity[0]*t,a[1]=this.angular_velocity[1]*t,a[2]=this.angular_velocity[2]*t,a[3]=0,quat4.multiply(a,this.rotation);var o=.5;this.rotation[0]+=o*a[0],this.rotation[1]+=o*a[1],this.rotation[2]+=o*a[2],this.rotation[3]+=o*a[3],quat4.normalize(this.rotation),this.accumulated_force[0]=this.accumulated_force[1]=this.accumulated_force[2]=0,this.accumulated_torque[0]=this.accumulated_torque[1]=this.accumulated_torque[2]=0,this.solver_impulse[0]=this.solver_impulse[1]=this.solver_impulse[2]=this.solver_impulse[3]=this.solver_impulse[4]=this.solver_impulse[5]=0,this.push_velocity[0]=this.push_velocity[1]=this.push_velocity[2]=0,this.turn_velocity[0]=this.turn_velocity[1]=this.turn_velocity[2]=0}},t.RigidBody.prototype.setGravity=function(t,e,i){this.gravity?(this.gravity[0]=t,this.gravity[1]=e,this.gravity[2]=i):this.gravity=vec3.createFrom(t,e,i)},t.RigidBody.prototype.applyImpulse=function(t){vec3.add(this.linear_velocity,t)},t.RigidBody.prototype.applyForce=function(t){vec3.add(this.accumulated_force,t)},t.RigidBody.prototype.applyForceAtWorldPoint=function(t,i){var o=e;vec3.set(i,o),vec3.subtract(o,this.position),vec3.cross(o,t),vec3.add(this.accumulated_force,t),vec3.add(this.accumulated_torque,o)},t.RigidBody.prototype.applyForceAtLocalPoint=function(t,i){var o=e;mat4.multiplyVec3(this.transform,i,o),this.applyForceAtWorldPoint(t,o)},t.RigidBody.prototype.getVelocityInLocalPoint=function(t,e){vec3.set(this.angular_velocity,e),vec3.cross(e,t),vec3.add(e,this.linear_velocity)},t.RigidBody.prototype.updateDerived=function(){quat4.normalize(this.rotation),mat4.fromRotationTranslation(this.rotation,this.position,this.transform),mat4.inverse(this.transform,this.transform_inverse),1/0!==this.mass&&this.updateInverseInertiaTensorWorldFrame(),this.aabb.transform(this.shape.aabb,this.transform)},t.RigidBody.prototype.updateInverseInertiaTensorWorldFrame=function(){var t=this.transform,e=this.inverseInertiaTensorWorldFrame,i=this.inverseInertiaTensor;this.rotation;var o=t[0]*i[0]+t[1]*i[3]+t[2]*i[6],a=t[0]*i[1]+t[1]*i[4]+t[2]*i[7],n=t[0]*i[2]+t[1]*i[5]+t[2]*i[8],s=t[4]*i[0]+t[5]*i[3]+t[6]*i[6],c=t[4]*i[1]+t[5]*i[4]+t[6]*i[7],r=t[4]*i[2]+t[5]*i[5]+t[6]*i[8],h=t[8]*i[0]+t[9]*i[3]+t[10]*i[6],l=t[8]*i[1]+t[9]*i[4]+t[10]*i[7],p=t[8]*i[2]+t[9]*i[5]+t[10]*i[8];e[0]=o*t[0]+a*t[1]+n*t[2],e[1]=o*t[4]+a*t[5]+n*t[6],e[2]=o*t[8]+a*t[9]+n*t[10],e[3]=s*t[0]+c*t[1]+r*t[2],e[4]=s*t[4]+c*t[5]+r*t[6],e[5]=s*t[8]+c*t[9]+r*t[10],e[6]=h*t[0]+l*t[1]+p*t[2],e[7]=h*t[4]+l*t[5]+p*t[6],e[8]=h*t[8]+l*t[9]+p*t[10],mat3.inverse(this.inverseInertiaTensorWorldFrame,this.inertiaTensorWorldFrame)},t.RigidBodyProxy=function(){this.parent=null,this.id=null,this.shape=null,this.aabb=new t.AABB,this.mass=null,this.position=vec3.create(),this.rotation=quat4.create(),this.transform=mat4.create(),this.transform_inverse=mat4.create(),this.restitution=null,this.friction=null},t.RigidBodyProxy.prototype.setFrom=function(t,e){this.parent=t,this.id=t.id,this.shape=e.shape,this.shape_data=e,this.mass=t.mass,mat4.multiplyVec3(t.transform,e.position,this.position),quat4.multiply(t.rotation,e.rotation,this.rotation),mat4.fromRotationTranslation(this.rotation,this.position,this.transform),mat4.inverse(this.transform,this.transform_inverse),this.aabb.transform(this.shape.aabb,this.transform),this.restitution=t.restitution,this.friction=t.friction},t.RigidBodyProxy.prototype.findSupportPoint=t.RigidBody.prototype.findSupportPoint,t.RigidBodyProxy.prototype.getRigidBody=function(){for(var t=this.parent;t.parent;)t=this.parent;return t},t.BoxShape=function(e,i,o){this.half_width=e,this.half_height=i,this.half_depth=o,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.BoxShape.prototype.calculateLocalAABB=function(t){t.min[0]=-this.half_width,t.min[1]=-this.half_height,t.min[2]=-this.half_depth,t.max[0]=this.half_width,t.max[1]=this.half_height,t.max[2]=this.half_depth},t.BoxShape.prototype.getInertiaTensor=function(t){var e=4*this.half_height*this.half_height,i=4*this.half_width*this.half_width,o=4*this.half_depth*this.half_depth,a=.0833*t;return mat3.createFrom(a*(e+o),0,0,0,a*(i+o),0,0,0,a*(e+i))},t.BoxShape.prototype.findSupportPoint=function(t,e){e[0]=0>t[0]?-this.half_width:this.half_width,e[1]=0>t[1]?-this.half_height:this.half_height,e[2]=0>t[2]?-this.half_depth:this.half_depth},t.BoxShape.prototype.rayIntersect=function(){var e,i,o,a,n,s=vec3.create();return function(c,r){e=0,vec3.subtract(r,c,s),i=vec3.length(s),vec3.scale(s,1/i);for(var h=0;3>h;h++){var l=0===h?this.half_width:1===h?this.half_height:this.half_depth;if(Math.abs(s[h])<t.EPSILON){if(-l>c[h]||c[h]>l)return null}else if(o=1/s[h],a=(-l-c[h])*o,n=(l-c[h])*o,a>n&&(o=a,a=n,n=o),e=Math.max(e,a),i=Math.min(i,n),e>i)return null}var p=t.ObjectPool.getObject("RayIntersection");return p.object=this,p.t=e,vec3.scale(s,e,p.point),vec3.add(p.point,c),p}}(),t.CompoundShape=function(){this.child_shapes=[],this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.CompoundShape.prototype.addChildShape=function(e,i,o){this.child_shapes.push(new t.CompoundShapeChild(e,i,o)),this.calculateLocalAABB(this.aabb)},t.CompoundShape.prototype.calculateLocalAABB=function(e){e.min[0]=e.min[1]=e.min[2]=1/0,e.max[0]=e.max[1]=e.max[2]=-1/0;var i,o;for(new t.AABB,i=0;this.child_shapes.length>i;i++)o=this.child_shapes[i],e.min[0]=Math.min(e.min[0],o.aabb.min[0]),e.min[1]=Math.min(e.min[1],o.aabb.min[1]),e.min[2]=Math.min(e.min[2],o.aabb.min[2]),e.max[0]=Math.max(e.max[0],o.aabb.max[0]),e.max[1]=Math.max(e.max[1],o.aabb.max[1]),e.max[2]=Math.max(e.max[2],o.aabb.max[2])},t.CompoundShape.prototype.getInertiaTensor=function(t){var i,o,a,c=mat3.identity(),r=mat3.create();for(t/=this.child_shapes.length,e[0]=e[1]=e[2]=0,i=0;this.child_shapes.length>i;i++)o=this.child_shapes[i],vec3.subtract(e,o.position),r[0]=t*-(e[1]*e[1]+e[2]*e[1]),r[1]=t*e[0]*e[1],r[2]=t*e[0]*e[2],r[3]=t*e[0]*e[1],r[4]=t*-(e[0]*e[0]+e[2]*e[2]),r[5]=t*e[1]*e[2],r[6]=t*e[0]*e[2],r[7]=t*e[1]*e[2],r[8]=t*-(e[0]*e[0]+e[1]*e[1]),mat4.toMat3(o.transform,n),a=o.shape.getInertiaTensor(t),mat3.transpose(n,s),mat3.multiply(n,a),mat3.multiply(n,s),c[0]+=n[0]+r[0],c[1]+=n[1]+r[1],c[2]+=n[2]+r[2],c[3]+=n[3]+r[3],c[4]+=n[4]+r[4],c[5]+=n[5]+r[5],c[6]+=n[6]+r[6],c[7]+=n[7]+r[7],c[8]+=n[8]+r[8];return c},t.CompoundShape.prototype.rayIntersect=function(){},t.CompoundShapeChild=function(e,i,o){this.shape=e,this.position=vec3.createFrom.apply(vec3,i),this.rotation=quat4.createFrom.apply(quat4,o),this.transform=mat4.create(),this.transform_inverse=mat4.create(),mat4.fromRotationTranslation(this.rotation,this.position,this.transform),mat4.inverse(this.transform,this.transform_inverse),this.aabb=new t.AABB,this.aabb.transform(this.shape.aabb,this.transform)},t.ConeShape=function(e,i){this.radius=e,this.half_height=i,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb),this._sinangle=this.radius/Math.sqrt(this.radius*this.radius+Math.pow(2*this.half_height,2)),this._cosangle=Math.cos(Math.asin(this._sinangle))},t.ConeShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[2]=-this.radius,t.min[1]=-this.half_height,t.max[0]=t.max[2]=this.radius,t.max[1]=this.half_height},t.ConeShape.prototype.getInertiaTensor=function(t){var e=.1*t*Math.pow(2*this.half_height,2)+.15*t*this.radius*this.radius;return mat3.createFrom(e,0,0,0,.3*t*this.radius*this.radius,0,0,0,e)},t.ConeShape.prototype.findSupportPoint=function(t,e){var i=Math.sqrt(t[0]*t[0]+t[2]*t[2]);if(t[1]>vec3.length(t)*this._sinangle)e[0]=e[2]=0,e[1]=this.half_height;else if(i>0){var o=this.radius/i;e[0]=o*t[0],e[1]=-this.half_height,e[2]=o*t[2]}else e[0]=e[2]=0,e[1]=-this.half_height},t.ConeShape.prototype.rayIntersect=function(){var e,i=vec3.create(),o=vec3.create(),a=vec3.create();return function(n,s){vec3.subtract(s,n,i),e=vec3.length(i),vec3.scale(i,1/e);var c,r;o[0]=o[1]=o[2]=0,c=this._rayIntersectBase(n,s,o),a[0]=a[1]=a[2]=0,r=this._rayIntersectCone(n,i,e,a);var h;return c||r?!r||c&&r>c?(h=t.ObjectPool.getObject("RayIntersection"),h.object=this,h.t=c,vec3.set(o,h.point),h):!c||r&&c>r?(h=t.ObjectPool.getObject("RayIntersection"),h.object=this,h.t=r,vec3.set(a,h.point),h):null:null}}(),t.ConeShape.prototype._rayIntersectBase=function(){var t,e=vec3.createFrom(0,-1,0),i=vec3.create(),o=vec3.create(),a=vec3.create();return function(n,s,c){return o[0]=n[0],o[1]=n[1]+this.half_height,o[2]=n[2],a[0]=s[0],a[1]=s[1]+this.half_height,a[2]=s[2],vec3.subtract(a,o,i),t=-vec3.dot(e,o)/vec3.dot(e,i),0>t||t>1?null:(vec3.scale(i,t,c),vec3.add(c,n),c[0]*c[0]+c[2]*c[2]>this.radius*this.radius?null:t)}}(),t.ConeShape.prototype._rayIntersectCone=function(){var i=vec3.create();return function(o,a,n,s){var c=vec3.createFrom(0,-1,0),r=vec3.dot(c,a),h=this._cosangle*this._cosangle,l=vec3.create();l[0]=o[0],l[1]=o[1]-this.half_height,l[2]=o[2];var p,_,u=vec3.dot(c,l),b=vec3.dot(a,l),v=vec3.dot(l,l),f=r*r-h,d=r*u-h*b,m=u*u-h*v,j=null;if(Math.abs(f)>=t.EPSILON){var g=d*d-m*f;if(-t.EPSILON>g)return null;if(g>t.EPSILON){var y=Math.sqrt(g),w=1/f;if(_=(-d-y)*w,_>=0&&n>=_&&(vec3.scale(a,_,i),vec3.add(i,o),l[1]=i[1]-this.half_height,p=vec3.dot(l,c),p>=0&&(j=_,vec3.set(i,s))),_=(-d+y)*w,_>=0&&n>=_&&(null==j||j>_)&&(vec3.scale(a,_,i),vec3.add(i,o),l[1]=i[1]-this.half_height,p=vec3.dot(l,c),p>=0&&(j=_,vec3.set(i,s))),null==j)return null;j/=n}else{if(_=-d/f,vec3.scale(a,_,i),vec3.add(i,o),l[1]=i[1]-this.half_height,p=vec3.dot(l,c),0>p)return null;if(vec3.subtract(i,o,e),vec3.squaredLength(e)>n*n)return null;j=_/n,vec3.set(i,s)}}else{if(!(Math.abs(d)>=t.EPSILON))return null;if(_=.5*m/d,vec3.scale(a,_,i),vec3.add(i,o),l[1]=i[1]-this.half_height,p=vec3.dot(l,c),0>p)return null;j=_,vec3.set(i,s)}return s[1]<-this.half_height?null:j}}(),t.CylinderShape=function(e,i){this.radius=e,this.half_height=i,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.CylinderShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[2]=-this.radius,t.min[1]=-this.half_height,t.max[0]=t.max[2]=this.radius,t.max[1]=this.half_height},t.CylinderShape.prototype.getInertiaTensor=function(t){var e=.0833*t*(3*this.radius*this.radius+(this.half_height+this.half_height)*(this.half_height+this.half_height));return mat3.createFrom(e,0,0,0,.5*t*this.radius*this.radius,0,0,0,e)},t.CylinderShape.prototype.findSupportPoint=function(t,e){if(e[1]=0>t[1]?-this.half_height:this.half_height,0===t[0]&&0===t[2])e[0]=e[2]=0;else{var i=Math.sqrt(t[0]*t[0]+t[2]*t[2]),o=this.radius/i;e[0]=o*t[0],e[2]=o*t[2]}},t.CylinderShape.prototype.rayIntersect=function(){var e=vec3.create(),i=vec3.create();return function(o,a){e[1]=this.half_height,i[1]=-this.half_height;var n=vec3.create();vec3.subtract(i,e,n);var s=vec3.create();vec3.subtract(o,e,s);var c=vec3.create();vec3.subtract(a,o,c);var r=vec3.dot(s,n),h=vec3.dot(c,n),l=vec3.dot(n,n);if(0>r&&0>r+h)return null;if(r>l&&r+h>l)return null;var p,_,u=vec3.dot(c,c),b=vec3.dot(s,c),v=l*u-h*h,f=vec3.dot(s,s)-this.radius*this.radius,d=l*f-r*r;if(Math.abs(v)<t.EPSILON){if(d>0)return null;p=0>r?-b/u:r>l?(h-b)/u:0}else{var m=l*b-h*r,j=m*m-v*d;if(0>j)return null;if(_=p=(-m-Math.sqrt(j))/v,0>r+p*h){if(0>=h)return null;p=-r/h,0>=f+p*(2*b+p*u)&&(_=p)}else if(r+p*h>l){if(h>=0)return null;p=(l-r)/h,0>=f+l-2*r+p*(2*(b-h)+p*u)&&(_=p)}if(p=_,0>p||p>1)return null}var g=t.ObjectPool.getObject("RayIntersection");return g.object=this,g.t=p,vec3.scale(c,p,g.point),vec3.add(g.point,o),g}}(),t.PlaneShape=function(e,i,o){this.orientation=e,this.half_width=i,this.half_length=o,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb),0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0)},t.PlaneShape.prototype.calculateLocalAABB=function(t){0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length,t.min[0]=0,t.min[1]=-this.half_width,t.min[2]=-this.half_length,t.max[0]=0,t.max[1]=this.half_width,t.max[2]=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length,t.min[0]=-this.half_width,t.min[1]=0,t.min[2]=-this.half_length,t.max[0]=this.half_width,t.max[1]=0,t.max[2]=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0,t.min[0]=-this.half_width,t.min[1]=-this.half_length,t.min[2]=0,t.max[0]=this.half_width,t.max[1]=this.half_length,t.max[2]=0)},t.PlaneShape.prototype.getInertiaTensor=function(t){var e=4*this.half_width*this.half_width,i=4*this.half_length*this.half_length,o=.0833*t,a=o*i,n=o*(e+i),s=o*e;return 0===this.orientation?mat3.createFrom(n,0,0,0,a,0,0,0,s):1===this.orientation?mat3.createFrom(a,0,0,0,n,0,0,0,s):mat3.createFrom(n,0,0,0,s,0,0,0,a)},t.PlaneShape.prototype.findSupportPoint=function(t,e){e[0]=0>t[0]?-this._half_width:this._half_width,e[1]=0>t[1]?-this._half_height:this._half_height,e[2]=0>t[2]?-this._half_depth:this._half_depth},t.PlaneShape.prototype.rayIntersect=function(){var e,i=vec3.create(),o=vec3.create(),a=vec3.create();return function(n,s){if(0===this.orientation?(i[0]=1,i[1]=i[2]=0):1===this.orientation?(i[1]=1,i[0]=i[2]=0):(i[2]=1,i[0]=i[1]=0),vec3.subtract(s,n,o),e=-vec3.dot(i,n)/vec3.dot(i,o),0>e||e>1)return null;if(vec3.scale(o,e,a),vec3.add(a,n),a[0]<-this._half_width||a[0]>this._half_width)return null;if(a[1]<-this._half_height||a[1]>this._half_height)return null;if(a[2]<-this._half_depth||a[2]>this._half_depth)return null;var c=t.ObjectPool.getObject("RayIntersection");return c.object=this,c.t=e,vec3.set(a,c.point),c}}(),t.SphereShape=function(e){this.radius=e,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.SphereShape.prototype.calculateLocalAABB=function(t){t.min[0]=t.min[1]=t.min[2]=-this.radius,t.max[0]=t.max[1]=t.max[2]=this.radius},t.SphereShape.prototype.getInertiaTensor=function(t){var e=.4*t*this.radius*this.radius;return mat3.createFrom(e,0,0,0,e,0,0,0,e)},t.SphereShape.prototype.findSupportPoint=function(){var t=vec3.create();return function(e,i){vec3.normalize(e,t),vec3.scale(t,this.radius,i)}}(),t.SphereShape.prototype.rayIntersect=function(){var e,i=vec3.create();return function(o,a){vec3.subtract(a,o,i),e=vec3.length(i),vec3.scale(i,1/e);var n=vec3.dot(o,i),s=vec3.dot(o,o)-this.radius*this.radius;if(n>=0&&s>=0)return null;var c=n*n-s;if(0>c)return null;var r=Math.sqrt(c),h=-n-r;if(0>h&&(h=-n+r),h>e)return null;var l=t.ObjectPool.getObject("RayIntersection");return l.object=this,vec3.scale(i,h,l.point),l.t=h,vec3.add(l.point,o),l}}(),t.World=function(t,e,i){this.ticks=0,this.broadphase=t,this.nearphase=e,this.solver=i,i.world=this,this.mass_points=[],this.rigid_bodies=[],this.gravity=vec3.createFrom(0,-9.8,0),this.force_generators=[],this.constraints=[]},t.World.prototype.step=function(t,i){i=i||t;var o,a,n,s,c,r;for(n=t/i,o=0;n>o;o++){for(this.ticks++,a=Math.min(i,t),t-=i,s=0,c=this.rigid_bodies.length;c>s;s++)this.rigid_bodies[s].updateDerived();for(s=0,c=this.rigid_bodies.length;c>s;s++)r=this.rigid_bodies[s],1/0!==r.mass&&(vec3.scale(r.gravity||this.gravity,r.mass*a,e),vec3.add(r.accumulated_force,e));for(s=0,c=this.force_generators.length;c>s;s++)this.force_generators[s].applyForce();for(this.broadphase.predictContactPairs(),this.nearphase.generateContacts(this.broadphase.collision_pairs),this.solver.processContactManifolds(this.nearphase.contact_manifolds),this.solver.prepareConstraints(a),this.solver.resolveContacts(a),this.solver.solveConstraints(),this.solver.applyConstraints(a),s=0,c=this.rigid_bodies.length;c>s;s++)r=this.rigid_bodies[s],r.integrate(a)}},t.World.prototype.addRigidBody=function(t){t.world=this,this.rigid_bodies.push(t),this.broadphase.addBody(t)},t.World.prototype.removeRigidBody=function(t){var e,i=this.rigid_bodies.length;for(e=0;i>e;e++)if(this.rigid_bodies[e]===t){this.rigid_bodies.splice(e,1),this.broadphase.removeBody(t);break}},t.World.prototype.addForceGenerator=function(t){var e,i;for(e=0,i=this.force_generators.length;i>e;e++)if(this.force_generators[e]===t)return;this.force_generators.push(t)},t.World.prototype.removeForceGenerator=function(t){var e,i;for(e=0,i=this.force_generators.length;i>e;e++)if(this.force_generators[e]===t)return this.force_generators.splice(e,1),void 0
},t.World.prototype.addConstraint=function(t){var e,i;for(e=0,i=this.constraints.length;i>e;e++)if(this.constraints[e]===t)return;t.world=this,this.constraints.push(t)},t.World.prototype.removeConstraint=function(t){var e,i;for(e=0,i=this.constraints.length;i>e;e++)if(this.constraints[e]===t)return this.constraints.splice(e,1),void 0},t.World.prototype.rayIntersect=function(){var t=function(t,e){return t.t<e.t?-1:t.t>e.t?1:0};return function(e,i){var o=this.broadphase.rayIntersect(e,i);return o.sort(t),o}}(),t}();