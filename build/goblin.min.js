!function(){var a={};a.Matrix3=function(a,b,c,d,e,f,g,h,i){this.e00=a||0,this.e01=b||0,this.e02=c||0,this.e10=d||0,this.e11=e||0,this.e12=f||0,this.e20=g||0,this.e21=h||0,this.e22=i||0},a.Matrix3.prototype={identity:function(){this.e00=1,this.e01=0,this.e02=0,this.e10=0,this.e11=1,this.e12=0,this.e20=0,this.e21=0,this.e22=1},fromMatrix4:function(a){this.e00=a.e00,this.e01=a.e01,this.e02=a.e02,this.e10=a.e10,this.e11=a.e11,this.e12=a.e12,this.e20=a.e20,this.e21=a.e21,this.e22=a.e22},fromQuaternion:function(a){var b=a.x+a.x,c=a.y+a.y,d=a.z+a.z,e=a.x*b,f=a.x*c,g=a.x*d,h=a.y*c,i=a.y*d,j=a.z*d,k=a.w*b,l=a.w*c,m=a.w*d;this.e00=1-(h+j),this.e10=f+m,this.e20=g-l,this.e01=f-m,this.e11=1-(e+j),this.e21=i+k,this.e02=g+l,this.e12=i-k,this.e22=1-(e+h)},transformVector3:function(a){var b=a.x,c=a.y,d=a.z;a.x=this.e00*b+this.e01*c+this.e02*d,a.y=this.e10*b+this.e11*c+this.e12*d,a.z=this.e20*b+this.e21*c+this.e22*d},transformVector3Into:function(a,b){b.x=this.e00*a.x+this.e01*a.y+this.e02*a.z,b.y=this.e10*a.x+this.e11*a.y+this.e12*a.z,b.z=this.e20*a.x+this.e21*a.y+this.e22*a.z},transposeInto:function(a){a.e00=this.e00,a.e10=this.e01,a.e20=this.e02,a.e01=this.e10,a.e11=this.e11,a.e21=this.e12,a.e02=this.e20,a.e12=this.e21,a.e22=this.e22},invert:function(){var a,b=this.e00,c=this.e01,d=this.e02,e=this.e10,f=this.e11,g=this.e12,h=this.e20,i=this.e21,j=this.e22,k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;return n?(a=1/n,this.e00=k*a,this.e01=(-j*c+d*i)*a,this.e02=(g*c-d*f)*a,this.e10=l*a,this.e11=(j*b-d*h)*a,this.e12=(-g*b+d*e)*a,this.e20=m*a,this.e21=(-i*b+c*h)*a,this.e22=(f*b-c*e)*a,!0):!0},invertInto:function(a){var b,c=this.e00,d=this.e01,e=this.e02,f=this.e10,g=this.e11,h=this.e12,i=this.e20,j=this.e21,k=this.e22,l=k*g-h*j,m=-k*f+h*i,n=j*f-g*i,o=c*l+d*m+e*n;return o?(b=1/o,a.e00=l*b,a.e01=(-k*d+e*j)*b,a.e02=(h*d-e*g)*b,a.e10=m*b,a.e11=(k*c-e*i)*b,a.e12=(-h*c+e*f)*b,a.e20=n*b,a.e21=(-j*c+d*i)*b,a.e22=(g*c-d*f)*b,!0):!1},multiply:function(a){var b=this.e00,c=this.e01,d=this.e02,e=this.e10,f=this.e11,g=this.e12,h=this.e20,i=this.e21,j=this.e22,k=a.e00,l=a.e01,m=a.e02,n=a.e10,o=a.e11,p=a.e12,q=a.e20,r=a.e21,s=a.e22;this.e00=k*b+n*c+q*d,this.e10=k*e+n*f+q*g,this.e20=k*h+n*i+q*j,this.e01=l*b+o*c+r*d,this.e11=l*e+o*f+r*g,this.e21=l*h+o*i+r*j,this.e02=m*b+p*c+s*d,this.e12=m*e+p*f+s*g,this.e22=m*h+p*i+s*j},multiplyFrom:function(a,b){var c=a.e00,d=a.e01,e=a.e02,f=a.e10,g=a.e11,h=a.e12,i=a.e20,j=a.e21,k=a.e22,l=b.e00,m=b.e01,n=b.e02,o=b.e10,p=b.e11,q=b.e12,r=b.e20,s=b.e21,t=b.e22;this.e00=l*c+o*d+r*e,this.e10=l*f+o*g+r*h,this.e20=l*i+o*j+r*k,this.e01=m*c+p*d+s*e,this.e11=m*f+p*g+s*h,this.e21=m*i+p*j+s*k,this.e02=n*c+q*d+t*e,this.e12=n*f+q*g+t*h,this.e22=n*i+q*j+t*k}},a.Matrix4=function(){this.e00=0,this.e01=0,this.e02=0,this.e03=0,this.e10=0,this.e11=0,this.e12=0,this.e13=0,this.e20=0,this.e21=0,this.e22=0,this.e23=0,this.e30=0,this.e31=0,this.e32=0,this.e33=0},a.Matrix4.prototype={identity:function(){this.e00=1,this.e01=0,this.e02=0,this.e03=0,this.e10=0,this.e11=1,this.e12=0,this.e13=0,this.e20=0,this.e21=0,this.e22=1,this.e23=0,this.e30=0,this.e31=0,this.e32=0,this.e33=1},copy:function(a){this.e00=a.e00,this.e01=a.e01,this.e02=a.e02,this.e03=a.e03,this.e10=a.e10,this.e11=a.e11,this.e12=a.e12,this.e13=a.e13,this.e20=a.e20,this.e21=a.e21,this.e22=a.e22,this.e23=a.e23,this.e30=a.e30,this.e31=a.e31,this.e32=a.e32,this.e33=a.e33},makeTransform:function(a,b){var c=a.x+a.x,d=a.y+a.y,e=a.z+a.z,f=a.x*c,g=a.x*d,h=a.x*e,i=a.y*d,j=a.y*e,k=a.z*e,l=a.w*c,m=a.w*d,n=a.w*e;this.e00=1-(i+k),this.e10=g+n,this.e20=h-m,this.e30=0,this.e01=g-n,this.e11=1-(f+k),this.e21=j+l,this.e31=0,this.e02=h+m,this.e12=j-l,this.e22=1-(f+i),this.e32=0,this.e03=b.x,this.e13=b.y,this.e23=b.z,this.e33=1},transformVector3:function(a){var b=a.x,c=a.y,d=a.z;a.x=this.e00*b+this.e01*c+this.e02*d+this.e03,a.y=this.e10*b+this.e11*c+this.e12*d+this.e13,a.z=this.e20*b+this.e21*c+this.e22*d+this.e23},transformVector3Into:function(a,b){b.x=this.e00*a.x+this.e01*a.y+this.e02*a.z+this.e03,b.y=this.e10*a.x+this.e11*a.y+this.e12*a.z+this.e13,b.z=this.e20*a.x+this.e21*a.y+this.e22*a.z+this.e23},rotateVector3:function(a){var b=a.x,c=a.y,d=a.z;a.x=this.e00*b+this.e01*c+this.e02*d,a.y=this.e10*b+this.e11*c+this.e12*d,a.z=this.e20*b+this.e21*c+this.e22*d},rotateVector3Into:function(a,b){b.x=this.e00*a.x+this.e01*a.y+this.e02*a.z,b.y=this.e10*a.x+this.e11*a.y+this.e12*a.z,b.z=this.e20*a.x+this.e21*a.y+this.e22*a.z},invert:function(){var a,b=this.e00,c=this.e01,d=this.e02,e=this.e03,f=this.e10,g=this.e11,h=this.e12,i=this.e13,j=this.e20,k=this.e21,l=this.e22,m=this.e23,n=this.e30,o=this.e31,p=this.e32,q=this.e33,r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p,D=r*C-s*B+t*A+u*z-v*y+w*x;return D?(a=1/D,this.e00=(g*C-h*B+i*A)*a,this.e01=(-c*C+d*B-e*A)*a,this.e02=(o*w-p*v+q*u)*a,this.e03=(-k*w+l*v-m*u)*a,this.e10=(-f*C+h*z-i*y)*a,this.e11=(b*C-d*z+e*y)*a,this.e12=(-n*w+p*t-q*s)*a,this.e13=(j*w-l*t+m*s)*a,this.e20=(f*B-g*z+i*x)*a,this.e21=(-b*B+c*z-e*x)*a,this.e22=(n*v-o*t+q*r)*a,this.e23=(-j*v+k*t-m*r)*a,this.e30=(-f*A+g*y-h*x)*a,this.e31=(b*A-c*y+d*x)*a,this.e32=(-n*u+o*s-p*r)*a,this.e33=(j*u-k*s+l*r)*a,!0):!1},invertInto:function(a){var b,c=this.e00,d=this.e10,e=this.e20,f=this.e30,g=this.e01,h=this.e11,i=this.e21,j=this.e31,k=this.e02,l=this.e12,m=this.e22,n=this.e32,o=this.e03,p=this.e13,q=this.e23,r=this.e33,s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(b=1/E,a.e00=(h*D-i*C+j*B)*b,a.e10=(-d*D+e*C-f*B)*b,a.e20=(p*x-q*w+r*v)*b,a.e30=(-l*x+m*w-n*v)*b,a.e01=(-g*D+i*A-j*z)*b,a.e11=(c*D-e*A+f*z)*b,a.e21=(-o*x+q*u-r*t)*b,a.e31=(k*x-m*u+n*t)*b,a.e02=(g*C-h*A+j*y)*b,a.e12=(-c*C+d*A-f*y)*b,a.e22=(o*w-p*u+r*s)*b,a.e32=(-k*w+l*u-n*s)*b,a.e03=(-g*B+h*z-i*y)*b,a.e13=(c*B-d*z+e*y)*b,a.e23=(-o*v+p*t-q*s)*b,void(a.e33=(k*v-l*t+m*s)*b)):!1},multiply:function(a){var b=this.e00,c=this.e10,d=this.e20,e=this.e30,f=this.e01,g=this.e11,h=this.e21,i=this.e31,j=this.e02,k=this.e12,l=this.e22,m=this.e32,n=this.e03,o=this.e13,p=this.e23,q=this.e33,r=a.e00,s=a.e10,t=a.e20,u=a.e30;this.e00=r*b+s*f+t*j+u*n,this.e10=r*c+s*g+t*k+u*o,this.e20=r*d+s*h+t*l+u*p,this.e30=r*e+s*i+t*m+u*q,r=a.e01,s=a.e11,t=a.e21,u=a.e31,this.e01=r*b+s*f+t*j+u*n,this.e11=r*c+s*g+t*k+u*o,this.e21=r*d+s*h+t*l+u*p,this.e31=r*e+s*i+t*m+u*q,r=a.e02,s=a.e12,t=a.e22,u=a.e32,this.e02=r*b+s*f+t*j+u*n,this.e12=r*c+s*g+t*k+u*o,this.e22=r*d+s*h+t*l+u*p,this.e32=r*e+s*i+t*m+u*q,r=a.e03,s=a.e13,t=a.e23,u=a.e33,this.e03=r*b+s*f+t*j+u*n,this.e13=r*c+s*g+t*k+u*o,this.e23=r*d+s*h+t*l+u*p,this.e33=r*e+s*i+t*m+u*q}},a.Quaternion=function(a,b,c,d){this.x=null!=a?a:0,this.y=null!=b?b:0,this.z=null!=c?c:0,this.w=null!=d?d:1,this.normalize()},a.Quaternion.prototype={set:function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},multiply:function(a){var b=this.x,c=this.y,d=this.z,e=this.w,f=a.x,g=a.y,h=a.z,i=a.w;this.x=b*i+e*f+c*h-d*g,this.y=c*i+e*g+d*f-b*h,this.z=d*i+e*h+b*g-c*f,this.w=e*i-b*f-c*g-d*h},multiplyQuaternions:function(a,b){this.x=a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,this.y=a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,this.z=a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,this.w=a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z},normalize:function(){var a=this.x,b=this.y,c=this.z,d=this.w,e=Math.sqrt(a*a+b*b+c*c+d*d);0===e?this.x=this.y=this.z=this.w=0:(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},invertQuaternion:function(a){var b=a.x,c=a.y,d=a.z,e=a.w,f=b*b+c*c+d*d+e*e;if(0===f)this.x=this.y=this.z=this.w=0;else{var g=-1/f;this.x=a.x*g,this.y=a.y*g,this.z=a.z*g,this.w=a.w*-g}},transformVector3:function(a){var b=a.x,c=a.y,d=a.z,e=this.x,f=this.y,g=this.z,h=this.w,i=h*b+f*d-g*c,j=h*c+g*b-e*d,k=h*d+e*c-f*b,l=-e*b-f*c-g*d;a.x=i*h+l*-e+j*-g-k*-f,a.y=j*h+l*-f+k*-e-i*-g,a.z=k*h+l*-g+i*-f-j*-e},transformVector3Into:function(a,b){var c=a.x,d=a.y,e=a.z,f=this.x,g=this.y,h=this.z,i=this.w,j=i*c+g*e-h*d,k=i*d+h*c-f*e,l=i*e+f*d-g*c,m=-f*c-g*d-h*e;b.x=j*i+m*-f+k*-h-l*-g,b.y=k*i+m*-g+l*-f-j*-h,b.z=l*i+m*-h+j*-g-k*-f}},a.Vector3=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},a.Vector3.prototype={set:function(a,b,c){this.x=a,this.y=b,this.z=c},copy:function(a){this.x=a.x,this.y=a.y,this.z=a.z},add:function(a){this.x+=a.x,this.y+=a.y,this.z+=a.z},addVectors:function(a,b){this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z},subtract:function(a){this.x-=a.x,this.y-=a.y,this.z-=a.z},subtractVectors:function(a,b){this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z},multiply:function(a){this.x*=a.x,this.y*=a.y,this.z*=a.z},multiplyVectors:function(a,b){this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z},scale:function(a){this.x*=a,this.y*=a,this.z*=a},scaleVector:function(a,b){this.x=a.x*b,this.y=a.y*b,this.z=a.z*b},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){var a=this.length();0===a?this.x=this.y=this.z=0:this.scale(1/a)},normalizeVector:function(a){this.copy(a),this.normalize()},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a){var b=this.x,c=this.y,d=this.z;this.x=c*a.z-d*a.y,this.y=d*a.x-b*a.z,this.z=b*a.y-c*a.x},crossVectors:function(a,b){this.x=a.y*b.z-a.z*b.y,this.y=a.z*b.x-a.x*b.z,this.z=a.x*b.y-a.y*b.x},distanceTo:function(a){var b=a.x-this.x,c=a.y-this.y,d=a.z-this.z;return Math.sqrt(b*b+c*c+d*d)}},a.EPSILON=1e-5;var b=new a.Vector3,c=new a.Vector3,d=new a.Vector3,e=new a.Quaternion,f=new a.Quaternion,g=new a.Matrix3,h=new a.Matrix3;a.EventEmitter=function(){},a.EventEmitter.prototype={addListener:function(a,b){null==this.listeners[a]&&(this.listeners[a]=[]),-1===this.listeners[a].indexOf(b)&&this.listeners[a].push(b)},removeListener:function(a,b){null==this.listeners[a]&&(this.listeners[a]=[]);var c=this.listeners[a].indexOf(b);-1!==c&&this.listeners[a].splice(c,1)},removeAllListeners:function(){for(var a=Object.keys(this.listeners),b=0;b<a.length;b++)this.listeners[a[b]].length=0},emit:function(a){var b,c=Array.prototype.slice.call(arguments,1);if(this.listeners[a]instanceof Array)for(var d=this.listeners[a].slice(),e=0;e<d.length;e++)if(b=d[e].apply(this,c),b===!1)return!1}},a.EventEmitter.apply=function(b){b.prototype.addListener=a.EventEmitter.prototype.addListener,b.prototype.removeListener=a.EventEmitter.prototype.removeListener,b.prototype.removeAllListeners=a.EventEmitter.prototype.removeAllListeners,b.prototype.emit=a.EventEmitter.prototype.emit},a.AABB=function(b,c){this.min=b||new a.Vector3,this.max=c||new a.Vector3},a.AABB.prototype.copy=function(a){this.min.x=a.min.x,this.min.y=a.min.y,this.min.z=a.min.z,this.max.x=a.max.x,this.max.y=a.max.y,this.max.z=a.max.z},a.AABB.prototype.combineAABBs=function(a,b){this.min.x=Math.min(a.min.x,b.min.x),this.min.y=Math.min(a.min.y,b.min.y),this.min.z=Math.min(a.min.z,b.min.z),this.max.x=Math.max(a.max.x,b.max.x),this.max.y=Math.max(a.max.y,b.max.y),this.max.z=Math.max(a.max.z,b.max.z)},a.AABB.prototype.transform=function(){var c=new a.Vector3,d=new a.Vector3,e=new a.Vector3,f=new a.Vector3,g=new a.Matrix3;return function(a,h){c.subtractVectors(a.max,a.min),c.scale(.5),d.addVectors(a.max,a.min),d.scale(.5),h.transformVector3Into(d,e),g.e00=Math.abs(h.e00),g.e01=Math.abs(h.e01),g.e02=Math.abs(h.e02),g.e10=Math.abs(h.e10),g.e11=Math.abs(h.e11),g.e12=Math.abs(h.e12),g.e20=Math.abs(h.e20),g.e21=Math.abs(h.e21),g.e22=Math.abs(h.e22),b.x=g.e00,b.y=g.e10,b.z=g.e20,f.x=c.dot(b),b.x=g.e01,b.y=g.e11,b.z=g.e21,f.y=c.dot(b),b.x=g.e02,b.y=g.e12,b.z=g.e22,f.z=c.dot(b),this.min.subtractVectors(e,f),this.max.addVectors(e,f)}}(),a.AABB.prototype.intersects=function(a){return this.max.x<a.min.x||this.max.y<a.min.y||this.max.z<a.min.z||this.min.x>a.max.x||this.min.y>a.max.y||this.min.z>a.max.z?!1:!0},a.AABB.prototype.testRayIntersect=function(){var b,c,d,e,f,g=new a.Vector3;return function(h,i){b=0,g.subtractVectors(i,h),c=g.length(),g.scale(1/c);var j,k;if(j=this.min.x,k=this.max.x,Math.abs(g.x)<a.EPSILON){if(h.x<j||h.x>k)return!1}else if(d=1/g.x,e=(j-h.x)*d,f=(k-h.x)*d,e>f&&(d=e,e=f,f=d),b=Math.max(b,e),c=Math.min(c,f),b>c)return!1;if(j=this.min.y,k=this.max.y,Math.abs(g.y)<a.EPSILON){if(h.y<j||h.y>k)return!1}else if(d=1/g.y,e=(j-h.y)*d,f=(k-h.y)*d,e>f&&(d=e,e=f,f=d),b=Math.max(b,e),c=Math.min(c,f),b>c)return!1;if(j=this.min.z,k=this.max.z,Math.abs(g.z)<a.EPSILON){if(h.z<j||h.z>k)return!1}else if(d=1/g.z,e=(j-h.z)*d,f=(k-h.z)*d,e>f&&(d=e,e=f,f=d),b=Math.max(b,e),c=Math.min(c,f),b>c)return!1;return!0}}(),function(){function b(a){var b=a.max.x-a.min.x,c=a.max.y-a.min.y,d=a.max.z-a.min.z;return b*(c+d)+c*d}var c=function(){function c(a){return a=4278190335&(a^a<<16),a=50393103&(a^a<<8),a=51130563&(a^a<<4),a=153391689&(a^a<<2)}function e(a,b,d){return(c(d)<<2)+(c(b)<<1)+c(a)}var f=new a.AABB,g=function(a,b){for(var c=a.max.x-a.min.x,d=a.max.y-a.min.y,f=a.max.z-a.min.z,h=512,i=h/c,j=h/d,k=h/f,l=0;l<b.length;l++){var m=b[l],n=(m.aabb.max.x-m.aabb.min.x)/2+m.aabb.min.x,o=(m.aabb.max.y-m.aabb.min.y)/2+m.aabb.min.y,p=(m.aabb.max.z-m.aabb.min.z)/2+m.aabb.min.z;m.morton=e((n+a.min.x)*i,(o+a.min.y)*j,(p+a.min.z)*k)}b.sort(g.mortonSort);var q=g.buildTree(b,29);return g.combineCluster(q,1),q};return g.mortonSort=function(a,b){return a.morton<b.morton?-1:a.morton>b.morton?1:0},g.clusterReductionCount=function(a){var b=Math.pow(a,.5)/2,c=.5;return Math.max(b*Math.pow(a,c),1)},g.buildTree=function(a,b){var c=[];if(a.length<g.max_bucket_size)c.push.apply(c,a),g.combineCluster(c,g.clusterReductionCount(g.max_bucket_size));else{var d=[],e=[];if(1>b)d=a.slice(0,a.length/2),e=a.slice(a.length/2);else for(var f=1<<b,h=0;h<a.length;h++){var i=a[h];i.morton&f?e.push(i):d.push(i)}c.push.apply(c,g.buildTree(d,b-1)),c.push.apply(c,g.buildTree(e,b-1)),g.combineCluster(c,g.clusterReductionCount(c.length))}return c},g.combineCluster=function(b,c){if(b.length<=1)return b;for(var e,f=new a.MinHeap,h=0;h<b.length;h++)e=new d,e.left=b[h],e.right=g.findBestMatch(b,b[h]),e.computeBounds(),f.push(e);for(var i;b.length>c;)for(i=f.pop(),b.splice(b.indexOf(i.left),1),b.splice(b.indexOf(i.right),1),b.push(i),f.heap.length=0,h=0;h<b.length;h++)e=new d,e.left=b[h],e.right=g.findBestMatch(b,b[h]),e.computeBounds(),f.push(e)},g.findBestMatch=function(a,c){for(var d,e=1/0,g=0,h=0;h<a.length;h++)a[h]!==c&&(f.combineAABBs(c.aabb,a[h].aabb),d=b(f),e>d&&(e=d,g=h));return a[g]},g.max_bucket_size=20,g}(),d=function(b){this.aabb=new a.AABB,this.area=0,this.parent=null,this.left=null,this.right=null,this.morton=null,this.object=b||null};d.prototype={isLeaf:function(){return null!=this.object},computeBounds:function(){this.isLeaf()?this.aabb.copy(this.object.aabb):this.aabb.combineAABBs(this.left.aabb,this.right.aabb),this.area=b(this.aabb)},valueOf:function(){return this.area}},a.BVH=function(b){for(var e=[],f=new a.AABB,g=0;g<b.length;g++){f.combineAABBs(f,b[g].aabb);var h=new d(b[g]);h.computeBounds(),e.push(h)}this.tree=c(f,e)[0]},a.BVH.AAC=c}(),a.BasicBroadphase=function(){this.bodies=[],this.collision_pairs=[]},a.BasicBroadphase.prototype.addBody=function(a){this.bodies.push(a)},a.BasicBroadphase.prototype.removeBody=function(a){var b,c=this.bodies.length;for(b=0;c>b;b++)if(this.bodies[b]===a){this.bodies.splice(b,1);break}},a.BasicBroadphase.prototype.predictContactPairs=function(){var a,b,c,d,e=this.bodies.length;for(this.collision_pairs.length=0,a=0;e>a;a++)for(c=this.bodies[a],b=0;e>b;b++)if(!(b>=a)&&(d=this.bodies[b],1/0!==c._mass||1/0!==d._mass)){if(0!==c.collision_mask)if(0===(1&c.collision_mask)){if(0!==(c.collision_mask&d.collision_groups))continue}else if(0===(c.collision_mask&d.collision_groups))continue;if(0!==d.collision_mask)if(0===(1&d.collision_mask)){if(0!==(d.collision_mask&c.collision_groups))continue}else if(0===(d.collision_mask&c.collision_groups))continue;this.mightIntersect(c,d)&&this.collision_pairs.push([c,d])}},a.BasicBroadphase.prototype.intersectsWith=function(a){var b,c,d=this.bodies.length,e=[];for(b=0;d>b;b++)c=this.bodies[b],a!==c&&this.mightIntersect(a,c)&&e.push(c);return e},a.BasicBroadphase.prototype.mightIntersect=function(a,b){return a.aabb.intersects(b.aabb)},a.BasicBroadphase.prototype.rayIntersect=function(a,b){var c,d,e=this.bodies.length,f=[];for(c=0;e>c;c++)d=this.bodies[c],d.aabb.testRayIntersect(a,b)&&d.rayIntersect(a,b,f);return f},a.BoxSphere=function(e,f){var g,h,i=e.shape instanceof a.SphereShape?e:f,j=e.shape instanceof a.SphereShape?f:e;return j.transform_inverse.transformVector3Into(i.position,b),Math.abs(b.x)-i.shape.radius>j.shape.half_width||Math.abs(b.y)-i.shape.radius>j.shape.half_height||Math.abs(b.z)-i.shape.radius>j.shape.half_depth||(c.x=c.y=c.z=0,h=b.x,h>j.shape.half_width?h=j.shape.half_width:h<-j.shape.half_width&&(h=-j.shape.half_width),c.x=h,h=b.y,h>j.shape.half_height?h=j.shape.half_height:h<-j.shape.half_height&&(h=-j.shape.half_height),c.y=h,h=b.z,h>j.shape.half_depth?h=j.shape.half_depth:h<-j.shape.half_depth&&(h=-j.shape.half_depth),c.z=h,d.subtractVectors(c,b),h=d.lengthSquared(),h>i.shape.radius*i.shape.radius)?void 0:(g=a.ObjectPool.getObject("ContactDetails"),g.object_a=i,g.object_b=j,0===h?a.BoxSphere.spherePenetration(j.shape,b,c,g):(g.contact_normal.subtractVectors(c,b),g.penetration_depth=-g.contact_normal.length(),g.contact_normal.scale(-1/g.penetration_depth),g.contact_point_in_b.copy(c)),g.penetration_depth+=i.shape.radius,j.transform.rotateVector3(g.contact_normal),i.transform_inverse.rotateVector3Into(g.contact_normal,g.contact_point_in_a),g.contact_point_in_a.scale(i.shape.radius),g.contact_point.scaleVector(g.contact_normal,i.shape.radius-g.penetration_depth/2),g.contact_point.add(i.position),g.restitution=(i.restitution+j.restitution)/2,g.friction=(i.friction+j.friction)/2,g)},a.BoxSphere.spherePenetration=function(a,b,d,e){var f,g;b.x<0?(f=a.half_width+b.x,d.x=-a.half_width,d.y=d.z=0,e.penetration_depth=f):(f=a.half_width-b.x,d.x=a.half_width,d.y=d.z=0,e.penetration_depth=f),b.y<0?(g=a.half_height+b.y,f>g&&(f=g,d.y=-a.half_height,d.x=d.z=0,e.penetration_depth=f)):(g=a.half_height-b.y,f>g&&(f=g,d.y=a.half_height,d.x=d.z=0,e.penetration_depth=f)),b.z<0?(g=a.half_depth+b.z,f>g&&(d.z=-a.half_depth,d.x=d.y=0,e.penetration_depth=f)):(g=a.half_depth-b.z,f>g&&(d.z=a.half_depth,d.x=d.y=0,e.penetration_depth=f)),e.contact_point_in_b.copy(c),e.contact_normal.scaleVector(e.contact_point_in_b,-1),e.contact_normal.normalize()},a.GjkEpa={margins:.03,result:null,max_iterations:20,epa_condition:.001,SupportPoint:function(a,b,c){this.witness_a=a,this.witness_b=b,this.point=c},findSupportPoint:function(){var b=new a.Vector3;return function(a,c,d,e){a.findSupportPoint(d,e.witness_a),b.scaleVector(d,-1),c.findSupportPoint(b,e.witness_b),e.point.subtractVectors(e.witness_a,e.witness_b)}}(),testCollision:function(b,c){var d=a.GjkEpa.GJK(b,c);return null!=a.GjkEpa.result?a.GjkEpa.result:null!=d?a.GjkEpa.EPA(d):void 0},GJK:function(){return function(b,c){var d,e=new a.GjkEpa.Simplex(b,c);for(a.GjkEpa.result=null;d=e.addPoint(););return d===!1?(a.GjkEpa.freeSimplex(e),null):e}}(),freeSimplex:function(b){for(var c=0,d=b.points.length;d>c;c++)a.ObjectPool.freeObject("GJK2SupportPoint",b.points[c])},freePolyhedron:function(b){for(var c=a.ObjectPool.pools.GJK2SupportPoint,d=0,e=b.faces.length;e>d;d++)-1===c.indexOf(b.faces[d].a)&&a.ObjectPool.freeObject("GJK2SupportPoint",b.faces[d].a),-1===c.indexOf(b.faces[d].b)&&a.ObjectPool.freeObject("GJK2SupportPoint",b.faces[d].b),-1===c.indexOf(b.faces[d].c)&&a.ObjectPool.freeObject("GJK2SupportPoint",b.faces[d].c)},EPA:function(){var c=new a.Vector3,d={a:new a.Vector3,b:new a.Vector3,c:new a.Vector3};return function(e){for(var f=new a.GjkEpa.Polyhedron(e),g=0;++g;){f.findFaceClosestToOrigin(),b.copy(f.closest_face_distance<a.EPSILON?f.faces[f.closest_face].normal:f.closest_point);var h=a.ObjectPool.getObject("GJK2SupportPoint");a.GjkEpa.findSupportPoint(e.object_a,e.object_b,b,h),b.subtractVectors(h.point,f.closest_point);var i=b.lengthSquared();if(g===a.GjkEpa.max_iterations||i<a.GjkEpa.epa_condition&&f.closest_face_distance>a.EPSILON){var j=a.ObjectPool.getObject("ContactDetails");return j.object_a=e.object_a,j.object_b=e.object_b,j.contact_normal.normalizeVector(f.closest_point),0===j.contact_normal.lengthSquared()&&j.contact_normal.subtractVectors(j.object_b.position,j.object_a.position),j.contact_normal.normalize(),a.GeometryMethods.findBarycentricCoordinates(f.closest_point,f.faces[f.closest_face].a.point,f.faces[f.closest_face].b.point,f.faces[f.closest_face].c.point,c),isNaN(c.x)?(a.GjkEpa.freePolyhedron(f),null):(d.a.scaleVector(f.faces[f.closest_face].a.witness_a,c.x),d.b.scaleVector(f.faces[f.closest_face].b.witness_a,c.y),d.c.scaleVector(f.faces[f.closest_face].c.witness_a,c.z),j.contact_point_in_a.addVectors(d.a,d.b),j.contact_point_in_a.add(d.c),d.a.scaleVector(f.faces[f.closest_face].a.witness_b,c.x),d.b.scaleVector(f.faces[f.closest_face].b.witness_b,c.y),d.c.scaleVector(f.faces[f.closest_face].c.witness_b,c.z),j.contact_point_in_b.addVectors(d.a,d.b),j.contact_point_in_b.add(d.c),j.contact_point.addVectors(j.contact_point_in_a,j.contact_point_in_b),j.contact_point.scale(.5),j.object_a.transform_inverse.transformVector3(j.contact_point_in_a),j.object_b.transform_inverse.transformVector3(j.contact_point_in_b),j.penetration_depth=f.closest_point.length()+a.GjkEpa.margins,j.restitution=(e.object_a.restitution+e.object_b.restitution)/2,j.friction=(e.object_a.friction+e.object_b.friction)/2,a.GjkEpa.freePolyhedron(f),j)}f.addVertex(h)}return a.GjkEpa.freePolyhedron(f),null}}(),Face:function(d,e,f,g){this.active=!0,this.a=e,this.b=f,this.c=g,this.normal=new a.Vector3,this.neighbors=[],b.subtractVectors(f.point,e.point),c.subtractVectors(g.point,e.point),this.normal.crossVectors(b,c),this.normal.normalize()}},a.GjkEpa.Polyhedron=function(b){this.closest_face=null,this.closest_face_distance=null,this.closest_point=new a.Vector3,this.faces=[new a.GjkEpa.Face(this,b.points[2],b.points[1],b.points[0]),new a.GjkEpa.Face(this,b.points[3],b.points[1],b.points[2]),new a.GjkEpa.Face(this,b.points[1],b.points[3],b.points[0]),new a.GjkEpa.Face(this,b.points[0],b.points[3],b.points[2])],this.faces[0].neighbors.push(this.faces[1],this.faces[2],this.faces[3]),this.faces[1].neighbors.push(this.faces[2],this.faces[0],this.faces[3]),this.faces[2].neighbors.push(this.faces[1],this.faces[3],this.faces[0]),this.faces[3].neighbors.push(this.faces[2],this.faces[1],this.faces[0])},a.GjkEpa.Polyhedron.prototype={addVertex:function(b){var c,d,e,f,g,h=[],i=[];for(this.faces[this.closest_face].silhouette(b,h),c=0;c<h.length-5;c+=5){if(e=h[c+3],f=h[c+4],0!==c&&g!==e)for(d=c+5;d<h.length;d+=5)if(h[d+3]===g){var j=h.slice(c,c+5);h[c]=h[d],h[c+1]=h[d+1],h[c+2]=h[d+2],h[c+3]=h[d+3],h[c+4]=h[d+4],h[d]=j[0],h[d+1]=j[1],h[d+2]=j[2],h[d+3]=j[3],h[d+4]=j[4],e=h[c+3],f=h[c+4];break}g=f}for(c=0;c<h.length;c+=5){var k=h[c];e=h[c+3],f=h[c+4];var l=new a.GjkEpa.Face(this,f,b,e);l.neighbors[2]=h[c],i.push(l),k.neighbors[k.neighbors.indexOf(h[c+2])]=l}for(c=0;c<i.length;c++)i[c].neighbors[0]=i[c+1===i.length?0:c+1],i[c].neighbors[1]=i[0>c-1?i.length-1:c-1];return Array.prototype.push.apply(this.faces,i),h},findFaceClosestToOrigin:function(){var b=new a.Vector3,c=new a.Vector3;return function(){this.closest_face_distance=1/0;var d,e;for(e=0;e<this.faces.length;e++)this.faces[e].active!==!1&&(a.GeometryMethods.findClosestPointInTriangle(b,this.faces[e].a.point,this.faces[e].b.point,this.faces[e].c.point,c),d=c.lengthSquared(),d<this.closest_face_distance&&(this.closest_face_distance=d,this.closest_face=e,this.closest_point.copy(c)))}}()},a.GjkEpa.Face.prototype={classifyVertex:function(a){var b=this.normal.dot(this.a.point);return this.normal.dot(a.point)-b},silhouette:function(a,b,c){if(this.active!==!1)if(this.classifyVertex(a)>0)this.active=!1,this.neighbors[0].silhouette(a,b,this),this.neighbors[1].silhouette(a,b,this),this.neighbors[2].silhouette(a,b,this);else if(c){var d,e,f=this.neighbors.indexOf(c);0===f?(d=this.a,e=this.b):1===f?(d=this.b,e=this.c):(d=this.c,e=this.a),b.push(this,f,c,e,d)}}},function(){var e=new a.Vector3,f=new a.Vector3,g=new a.Vector3,h=new a.Vector3,i=new a.Vector3,j=new a.Vector3,k={a:new a.Vector3,b:new a.Vector3,c:new a.Vector3};a.GjkEpa.Simplex=function(b,c){this.object_a=b,this.object_b=c,this.points=[],this.iterations=0,this.next_direction=new a.Vector3,this.updateDirection()},a.GjkEpa.Simplex.prototype={addPoint:function(){if(++this.iterations===a.GjkEpa.max_iterations)return!1;var c=a.ObjectPool.getObject("GJK2SupportPoint");if(a.GjkEpa.findSupportPoint(this.object_a,this.object_b,this.next_direction,c),this.points.push(c),c.point.dot(this.next_direction)<0&&this.points.length>1){if(this.points.length>=3){a.GeometryMethods.findClosestPointInTriangle(e,this.points[0].point,this.points[1].point,this.points[2].point,b);var d=b.lengthSquared();if(d<=a.GjkEpa.margins*a.GjkEpa.margins){var f=a.ObjectPool.getObject("ContactDetails");return f.object_a=this.object_a,f.object_b=this.object_b,f.contact_normal.normalizeVector(b),0===f.contact_normal.lengthSquared()&&f.contact_normal.subtractVectors(f.object_b.position,f.object_a.position),f.contact_normal.normalize(),f.contact_normal.scale(-1),f.penetration_depth=a.GjkEpa.margins-Math.sqrt(d),a.GeometryMethods.findBarycentricCoordinates(b,this.points[0].point,this.points[1].point,this.points[2].point,j),isNaN(j.x)?!1:(k.a.scaleVector(this.points[0].witness_a,j.x),k.b.scaleVector(this.points[1].witness_a,j.y),k.c.scaleVector(this.points[2].witness_a,j.z),f.contact_point_in_a.addVectors(k.a,k.b),f.contact_point_in_a.add(k.c),f.contact_point_in_b.scaleVector(f.contact_normal,-f.penetration_depth),f.contact_point_in_b.add(f.contact_point_in_a),f.contact_point.addVectors(f.contact_point_in_a,f.contact_point_in_b),f.contact_point.scale(.5),f.object_a.transform_inverse.transformVector3(f.contact_point_in_a),f.object_b.transform_inverse.transformVector3(f.contact_point_in_b),f.restitution=(this.object_a.restitution+this.object_b.restitution)/2,f.friction=(this.object_a.friction+this.object_b.friction)/2,a.GjkEpa.result=f,null)}}return!1}return this.updateDirection()===!0?null:c},findDirectionFromLine:function(){f.scaleVector(this.points[1].point,-1),g.subtractVectors(this.points[0].point,this.points[1].point),g.dot(f)<0?(this.next_direction.copy(f),a.ObjectPool.freeObject("GJK2SupportPoint",this.points[1]),this.points.length=1):(this.next_direction.crossVectors(g,f),this.next_direction.cross(g),0===this.next_direction.x&&0===this.next_direction.y&&0===this.next_direction.z&&(g.normalize(),this.next_direction.x=1-Math.abs(g.x),this.next_direction.y=1-Math.abs(g.y),this.next_direction.z=1-Math.abs(g.z)))},findDirectionFromTriangle:function(){var e=this.points[2],i=this.points[1],j=this.points[0];f.scaleVector(e.point,-1),g.subtractVectors(i.point,e.point),h.subtractVectors(j.point,e.point),b.crossVectors(g,h),c.crossVectors(g,b),d.crossVectors(b,h),d.dot(f)>=0?h.dot(f)>=0?(this.points.length=0,this.points.push(j,e),a.ObjectPool.freeObject("GJK2SupportPoint",i),this.next_direction.crossVectors(h,f),this.next_direction.cross(h)):g.dot(f)>=0?(this.points.length=0,this.points.push(i,e),a.ObjectPool.freeObject("GJK2SupportPoint",j),this.next_direction.crossVectors(g,f),this.next_direction.cross(g)):(this.points.length=0,this.points.push(e),a.ObjectPool.freeObject("GJK2SupportPoint",i),a.ObjectPool.freeObject("GJK2SupportPoint",j)):c.dot(f)>=0?g.dot(f)>=0?(this.points.length=0,this.points.push(i,e),a.ObjectPool.freeObject("GJK2SupportPoint",j),this.next_direction.crossVectors(g,f),this.next_direction.cross(g)):(this.points.length=0,this.points.push(e),a.ObjectPool.freeObject("GJK2SupportPoint",i),a.ObjectPool.freeObject("GJK2SupportPoint",j)):b.dot(f)>=0?(this.next_direction.copy(b),this.points.length=0,this.points.push(e,i,j)):(this.next_direction.copy(b),this.next_direction.scale(-1))},getFaceNormal:function(a,b,c,d){g.subtractVectors(b.point,a.point),h.subtractVectors(c.point,a.point),d.crossVectors(g,h),d.normalize()},faceNormalDotOrigin:function(a,d,e){return this.getFaceNormal(a,d,e,b),c.addVectors(a.point,d.point),c.add(e.point),c.scale(-3),c.normalize(),b.dot(c)},findDirectionFromTetrahedron:function(){var c,d=this.points[3],e=this.points[2],f=this.points[1],g=this.points[0],h=null,i=a.EPSILON;return c=this.faceNormalDotOrigin(e,f,g),c>i&&(h=1,i=c),c=this.faceNormalDotOrigin(d,f,e),c>i&&(h=2,i=c),c=this.faceNormalDotOrigin(f,d,g),c>i&&(h=3,i=c),c=this.faceNormalDotOrigin(g,d,e),c>i&&(h=4,i=c),null===h?!0:void(1===h?(this.points.length=0,this.points.push(e,f,g),this.getFaceNormal(e,f,g,b),this.next_direction.copy(b)):2===h?(this.points.length=0,this.points.push(d,f,e),this.getFaceNormal(d,f,e,b),this.next_direction.copy(b)):3===h?(this.points.length=0,this.points.push(f,d,g),this.getFaceNormal(f,d,g,b),this.next_direction.copy(b)):4===h&&(this.points.length=0,this.points.push(g,d,e),this.getFaceNormal(g,d,e,b),this.next_direction.copy(b)))},containsOrigin:function(){var a=this.points[3],c=this.points[2],d=this.points[1],e=this.points[0];return g.subtractVectors(e.point,a.point),i.subtractVectors(d.point,a.point),b.crossVectors(g,i),b.dot(a.point)>0?!1:(g.subtractVectors(d.point,a.point),i.subtractVectors(c.point,a.point),b.crossVectors(g,i),b.dot(a.point)>0?!1:(g.subtractVectors(c.point,a.point),i.subtractVectors(e.point,a.point),b.crossVectors(g,i),b.dot(a.point)>0?!1:(g.subtractVectors(e.point,d.point),i.subtractVectors(c.point,d.point),b.crossVectors(g,i),b.dot(e.point)>0?!1:!0)))},updateDirection:function(){if(0===this.points.length)this.next_direction.subtractVectors(this.object_b.position,this.object_a.position);else if(1===this.points.length)this.next_direction.scale(-1);else if(2===this.points.length)this.findDirectionFromLine();else{if(3!==this.points.length)return this.findDirectionFromTetrahedron();this.findDirectionFromTriangle()}}}}(),a.SphereSphere=function(c,d){var e=c.position,f=d.position;b.subtractVectors(f,e);var g=b.length();if(!(g>c.shape.radius+d.shape.radius)){var h=a.ObjectPool.getObject("ContactDetails");return h.object_a=c,h.object_b=d,h.contact_normal.scaleVector(b,1/g),b.scale(-.5),h.contact_point.addVectors(b,e),h.penetration_depth=c.shape.radius+d.shape.radius-g,h.contact_point_in_a.scaleVector(h.contact_normal,h.object_a.shape.radius),h.contact_point_in_a.add(h.object_a.position),h.contact_point_in_b.scaleVector(h.contact_normal,-h.object_b.shape.radius),h.contact_point_in_b.add(h.object_b.position),h.contact_point.addVectors(h.contact_point_in_a,h.contact_point_in_b),h.contact_point.scale(.5),h.object_a.transform_inverse.transformVector3(h.contact_point_in_a),h.object_b.transform_inverse.transformVector3(h.contact_point_in_b),h.restitution=(c.restitution+d.restitution)/2,h.friction=(c.friction+d.friction)/2,h}},a.TriangleTriangle=function(d,e){var f=e.classifyVertex(d.a),g=e.classifyVertex(d.b),h=e.classifyVertex(d.c);if(f>0&&g>0&&h>0||0>f&&0>g&&0>h)return null;var i=d.classifyVertex(e.a),j=d.classifyVertex(e.b),k=d.classifyVertex(e.c);if(i>0&&j>0&&k>0||0>i&&0>j&&0>k)return null;var l=new a.Vector3;l.crossVectors(d.normal,e.normal),l.normalize();var m,n=l.dot(d.a),o=l.dot(d.b),p=l.dot(d.c),q=l.dot(e.a),r=l.dot(e.b),s=l.dot(e.c),t=d.a,u=d.b,v=d.c,w=e.a,x=e.b,y=e.c;Math.sign(f)===Math.sign(g)?(m=f,f=h,h=m,m=n,n=p,p=m,m=t,t=v,v=m):Math.sign(f)===Math.sign(h)&&(m=f,f=g,g=m,m=n,n=o,o=m,m=t,t=u,u=m),Math.sign(i)===Math.sign(j)?(m=i,i=k,k=m,m=q,q=s,s=m,m=w,w=y,y=m):Math.sign(i)===Math.sign(k)&&(m=i,i=j,j=m,m=q,q=r,r=m,m=w,w=x,x=m);var z=n+(o-n)*(f/(f-g)),A=n+(p-n)*(f/(f-h)),B=q+(r-q)*(i/(i-j)),C=q+(s-q)*(i/(i-k));if(z>A&&(m=z,z=A,A=m,m=o,o=p,p=m,m=u,u=v,v=m),B>C&&(m=B,B=C,C=m,m=r,r=s,s=m,m=x,x=y,y=m),z>=B&&C>=z||A>=B&&C>=A||B>=z&&A>=B||C>=z&&A>=C){var D=a.ObjectPool.getObject("ContactDetails");D.object_a=d,D.object_b=e;var E=new a.Vector3,F=new a.Vector3,G=new a.Vector3,H=new a.Vector3,I=new a.Vector3,J=new a.Vector3,K=!1,L=!1;return e.classifyVertex(t)<=0?(K=!0,a.GeometryMethods.findClosestPointInTriangle(t,w,x,y,F),E.copy(t),G.copy(e.normal),G.scale(-1)):z>=B&&C>=z?(K=!0,a.GeometryMethods.findClosestPointInTriangle(u,w,x,y,F),E.copy(u),G.copy(e.normal),G.scale(-1)):A>=B&&C>=A&&(K=!0,a.GeometryMethods.findClosestPointInTriangle(v,w,x,y,F),E.copy(v),G.copy(e.normal),G.scale(-1)),d.classifyVertex(w)<=0?(L=!0,a.GeometryMethods.findClosestPointInTriangle(w,t,u,v,H),I.copy(w),J.copy(d.normal)):B>=z&&A>=B?(L=!0,a.GeometryMethods.findClosestPointInTriangle(x,t,u,v,H),I.copy(x),J.copy(d.normal)):C>=z&&A>=C&&(L=!0,a.GeometryMethods.findClosestPointInTriangle(y,t,u,v,H),I.copy(y),J.copy(d.normal)),b.subtractVectors(E,F),c.subtractVectors(H,I),!L||K&&b.lengthSquared()<c.lengthSquared()?(D.contact_point_in_a.copy(E),D.contact_point_in_b.copy(F),D.contact_normal.copy(G)):(D.contact_point_in_a.copy(H),D.contact_point_in_b.copy(I),D.contact_normal.copy(J)),b.subtractVectors(D.contact_point_in_a,D.contact_point_in_b),D.penetration_depth=b.length(),D.contact_point.addVectors(D.contact_point_in_a,D.contact_point_in_b),D.contact_point.scale(.5),D
}return null},a.Constraint=function(){this.active=!0,this.object_a=null,this.object_b=null,this.rows=[],this.factor=1,this.last_impulse=new a.Vector3,this.breaking_threshold=0,this.listeners={}},a.EventEmitter.apply(a.Constraint),a.Constraint.prototype.deactivate=function(){this.active=!1,this.emit("deactivate")},a.Constraint.prototype.update=function(){},a.ConstraintRow=function(){this.jacobian=new Float64Array(12),this.B=new Float64Array(12),this.D=0,this.lower_limit=-1/0,this.upper_limit=1/0,this.bias=0,this.multiplier=0,this.multiplier_cached=0,this.eta=0,this.eta_row=new Float64Array(12)},a.ConstraintRow.prototype.computeB=function(a){var c;null!=a.object_a&&1/0!==a.object_a._mass?(c=a.object_a._mass_inverted,this.B[0]=c*this.jacobian[0]*a.object_a.linear_factor.x,this.B[1]=c*this.jacobian[1]*a.object_a.linear_factor.y,this.B[2]=c*this.jacobian[2]*a.object_a.linear_factor.z,b.x=this.jacobian[3],b.y=this.jacobian[4],b.z=this.jacobian[5],a.object_a.inverseInertiaTensorWorldFrame.transformVector3(b),this.B[3]=b.x*a.object_a.angular_factor.x,this.B[4]=b.y*a.object_a.angular_factor.y,this.B[5]=b.z*a.object_a.angular_factor.z):(this.B[0]=this.B[1]=this.B[2]=0,this.B[3]=this.B[4]=this.B[5]=0),null!=a.object_b&&1/0!==a.object_b._mass?(c=a.object_b._mass_inverted,this.B[6]=c*this.jacobian[6]*a.object_b.linear_factor.x,this.B[7]=c*this.jacobian[7]*a.object_b.linear_factor.y,this.B[8]=c*this.jacobian[8]*a.object_b.linear_factor.z,b.x=this.jacobian[9],b.y=this.jacobian[10],b.z=this.jacobian[11],a.object_b.inverseInertiaTensorWorldFrame.transformVector3(b),this.B[9]=b.x*a.object_b.linear_factor.x,this.B[10]=b.y*a.object_b.linear_factor.y,this.B[11]=b.z*a.object_b.linear_factor.z):(this.B[6]=this.B[7]=this.B[8]=0,this.B[9]=this.B[10]=this.B[11]=0)},a.ConstraintRow.prototype.computeD=function(){this.D=this.jacobian[0]*this.B[0]+this.jacobian[1]*this.B[1]+this.jacobian[2]*this.B[2]+this.jacobian[3]*this.B[3]+this.jacobian[4]*this.B[4]+this.jacobian[5]*this.B[5]+this.jacobian[6]*this.B[6]+this.jacobian[7]*this.B[7]+this.jacobian[8]*this.B[8]+this.jacobian[9]*this.B[9]+this.jacobian[10]*this.B[10]+this.jacobian[11]*this.B[11]},a.ConstraintRow.prototype.computeEta=function(a,c){var d,e=1/c;null==a.object_a||1/0===a.object_a._mass?this.eta_row[0]=this.eta_row[1]=this.eta_row[2]=this.eta_row[3]=this.eta_row[4]=this.eta_row[5]=0:(d=a.object_a._mass_inverted,this.eta_row[0]=(a.object_a.linear_velocity.x+d*a.object_a.accumulated_force.x)*e,this.eta_row[1]=(a.object_a.linear_velocity.y+d*a.object_a.accumulated_force.y)*e,this.eta_row[2]=(a.object_a.linear_velocity.z+d*a.object_a.accumulated_force.z)*e,b.copy(a.object_a.accumulated_torque),a.object_a.inverseInertiaTensorWorldFrame.transformVector3(b),this.eta_row[3]=(a.object_a.angular_velocity.x+b.x)*e,this.eta_row[4]=(a.object_a.angular_velocity.y+b.y)*e,this.eta_row[5]=(a.object_a.angular_velocity.z+b.z)*e),null==a.object_b||1/0===a.object_b._mass?this.eta_row[6]=this.eta_row[7]=this.eta_row[8]=this.eta_row[9]=this.eta_row[10]=this.eta_row[11]=0:(d=a.object_b._mass_inverted,this.eta_row[6]=(a.object_b.linear_velocity.x+d*a.object_b.accumulated_force.x)*e,this.eta_row[7]=(a.object_b.linear_velocity.y+d*a.object_b.accumulated_force.y)*e,this.eta_row[8]=(a.object_b.linear_velocity.z+d*a.object_b.accumulated_force.z)*e,b.copy(a.object_b.accumulated_torque),a.object_b.inverseInertiaTensorWorldFrame.transformVector3(b),this.eta_row[9]=(a.object_b.angular_velocity.x+b.x)*e,this.eta_row[10]=(a.object_b.angular_velocity.y+b.y)*e,this.eta_row[11]=(a.object_b.angular_velocity.z+b.z)*e);var f=this.jacobian[0]*this.eta_row[0]+this.jacobian[1]*this.eta_row[1]+this.jacobian[2]*this.eta_row[2]+this.jacobian[3]*this.eta_row[3]+this.jacobian[4]*this.eta_row[4]+this.jacobian[5]*this.eta_row[5]+this.jacobian[6]*this.eta_row[6]+this.jacobian[7]*this.eta_row[7]+this.jacobian[8]*this.eta_row[8]+this.jacobian[9]*this.eta_row[9]+this.jacobian[10]*this.eta_row[10]+this.jacobian[11]*this.eta_row[11];this.eta=this.bias*e-f},a.ContactConstraint=function(){a.Constraint.call(this),this.contact=null},a.ContactConstraint.prototype=Object.create(a.Constraint.prototype),a.ContactConstraint.prototype.buildFromContact=function(b){this.object_a=b.object_a,this.object_b=b.object_b,this.contact=b;var c=this,d=function(){this.removeListener("destroy",d),c.deactivate()};this.contact.addListener("destroy",d);var e=this.rows[0]||a.ObjectPool.getObject("ConstraintRow");e.lower_limit=0,e.upper_limit=1/0,this.rows[0]=e,this.update()},a.ContactConstraint.prototype.update=function(){var a=this.rows[0];null==this.object_a||1/0===this.object_a._mass?(a.jacobian[0]=a.jacobian[1]=a.jacobian[2]=0,a.jacobian[3]=a.jacobian[4]=a.jacobian[5]=0):(a.jacobian[0]=-this.contact.contact_normal.x,a.jacobian[1]=-this.contact.contact_normal.y,a.jacobian[2]=-this.contact.contact_normal.z,b.subtractVectors(this.contact.contact_point,this.contact.object_a.position),b.cross(this.contact.contact_normal),a.jacobian[3]=-b.x,a.jacobian[4]=-b.y,a.jacobian[5]=-b.z),null==this.object_b||1/0===this.object_b._mass?(a.jacobian[6]=a.jacobian[7]=a.jacobian[8]=0,a.jacobian[9]=a.jacobian[10]=a.jacobian[11]=0):(a.jacobian[6]=this.contact.contact_normal.x,a.jacobian[7]=this.contact.contact_normal.y,a.jacobian[8]=this.contact.contact_normal.z,b.subtractVectors(this.contact.contact_point,this.contact.object_b.position),b.cross(this.contact.contact_normal),a.jacobian[9]=b.x,a.jacobian[10]=b.y,a.jacobian[11]=b.z),a.bias=0;var c=0;1/0!==this.object_a._mass&&(this.object_a.getVelocityInLocalPoint(this.contact.contact_point_in_a,b),c+=b.dot(this.contact.contact_normal)),1/0!==this.object_b._mass&&(this.object_b.getVelocityInLocalPoint(this.contact.contact_point_in_b,b),c-=b.dot(this.contact.contact_normal)),a.bias+=c*this.contact.restitution},a.FrictionConstraint=function(){a.Constraint.call(this),this.contact=null},a.FrictionConstraint.prototype=Object.create(a.Constraint.prototype),a.FrictionConstraint.prototype.buildFromContact=function(b){this.rows[0]=this.rows[0]||a.ObjectPool.getObject("ConstraintRow"),this.rows[1]=this.rows[1]||a.ObjectPool.getObject("ConstraintRow"),this.object_a=b.object_a,this.object_b=b.object_b,this.contact=b;var c=this,d=function(){this.removeListener("destroy",d),c.deactivate()};this.contact.addListener("destroy",d),this.update()},a.FrictionConstraint.prototype.update=function(){var e=this.rows[0],f=this.rows[1],g=new a.Vector3,h=new a.Vector3;g.subtractVectors(this.contact.contact_point,this.object_a.position),h.subtractVectors(this.contact.contact_point,this.object_b.position);var i,j,k=new a.Vector3,l=new a.Vector3;Math.abs(this.contact.contact_normal.z)>.7071067811865475?(i=-this.contact.contact_normal.y*this.contact.contact_normal.y+this.contact.contact_normal.z*this.contact.contact_normal.z,j=1/Math.sqrt(i),k.set(0,-this.contact.contact_normal.z*j,this.contact.contact_normal.y*j),l.set(i*j,-this.contact.contact_normal.x*k.z,this.contact.contact_normal.x*k.y)):(i=this.contact.contact_normal.x*this.contact.contact_normal.x+this.contact.contact_normal.y*this.contact.contact_normal.y,j=1/Math.sqrt(i),k.set(-this.contact.contact_normal.y*j,this.contact.contact_normal.x*j,0),l.set(-this.contact.contact_normal.z*k.y,this.contact.contact_normal.z*k.x,i*j)),null==this.object_a||1/0===this.object_a._mass?(e.jacobian[0]=e.jacobian[1]=e.jacobian[2]=0,e.jacobian[3]=e.jacobian[4]=e.jacobian[5]=0,f.jacobian[0]=f.jacobian[1]=f.jacobian[2]=0,f.jacobian[3]=f.jacobian[4]=f.jacobian[5]=0):(e.jacobian[0]=-k.x,e.jacobian[1]=-k.y,e.jacobian[2]=-k.z,b.crossVectors(g,k),e.jacobian[3]=-b.x,e.jacobian[4]=-b.y,e.jacobian[5]=-b.z,f.jacobian[0]=-l.x,f.jacobian[1]=-l.y,f.jacobian[2]=-l.z,b.crossVectors(g,l),f.jacobian[3]=-b.x,f.jacobian[4]=-b.y,f.jacobian[5]=-b.z),null==this.object_b||1/0===this.object_b._mass?(e.jacobian[6]=e.jacobian[7]=e.jacobian[8]=0,e.jacobian[9]=e.jacobian[10]=e.jacobian[11]=0,f.jacobian[6]=f.jacobian[7]=f.jacobian[8]=0,f.jacobian[9]=f.jacobian[10]=f.jacobian[11]=0):(e.jacobian[6]=k.x,e.jacobian[7]=k.y,e.jacobian[8]=k.z,b.crossVectors(h,k),e.jacobian[9]=b.x,e.jacobian[10]=b.y,e.jacobian[11]=b.z,f.jacobian[6]=l.x,f.jacobian[7]=l.y,f.jacobian[8]=l.z,b.crossVectors(h,l),f.jacobian[9]=b.x,f.jacobian[10]=b.y,f.jacobian[11]=b.z),this.object_a.getVelocityInLocalPoint(this.contact.contact_point_in_a,b),1/0!==this.object_a._mass?(b.scaleVector(this.object_a.accumulated_force,1/this.object_a._mass),b.add(this.object_a.linear_velocity),this.object_a.inverseInertiaTensorWorldFrame.transformVector3Into(this.object_a.accumulated_torque,d),d.add(this.object_a.angular_velocity),d.cross(this.contact.contact_point_in_a),b.add(d),b.scale(this.object_a._mass)):b.set(0,0,0),1/0!==this.object_b._mass?(c.scaleVector(this.object_b.accumulated_force,1/this.object_b._mass),c.add(this.object_b.linear_velocity),this.object_b.inverseInertiaTensorWorldFrame.transformVector3Into(this.object_b.accumulated_torque,d),d.add(this.object_b.angular_velocity),d.cross(this.contact.contact_point_in_b),c.add(d),c.scale(this.object_b._mass)):c.set(0,0,0),b.subtract(c);var m=b.dot(this.contact.contact_normal),n=this.contact.friction*m*10;0>n&&(n=0),e.lower_limit=f.lower_limit=-n,e.upper_limit=f.upper_limit=n,e.bias=f.bias=0,this.rows[0]=e,this.rows[1]=f},a.PointConstraint=function(b,c,d,e){a.Constraint.call(this),this.object_a=b,this.point_a=c,this.object_b=d||null,null!=this.object_b?this.point_b=e:(this.point_b=new a.Vector3,this.object_a.updateDerived(),this.object_a.transform.transformVector3Into(this.point_a,this.point_b)),this.erp=.1;for(var f=0;3>f;f++)this.rows[f]=a.ObjectPool.getObject("ConstraintRow"),this.rows[f].lower_limit=-1/0,this.rows[f].upper_limit=1/0,this.rows[f].bias=0,this.rows[f].jacobian[6]=this.rows[f].jacobian[7]=this.rows[f].jacobian[8]=this.rows[f].jacobian[9]=this.rows[f].jacobian[10]=this.rows[f].jacobian[11]=0},a.PointConstraint.prototype=Object.create(a.Constraint.prototype),a.PointConstraint.prototype.update=function(){var e=new a.Vector3,f=new a.Vector3;return function(a){this.object_a.transform.transformVector3Into(this.point_a,b),e.subtractVectors(b,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-e.z,this.rows[0].jacobian[5]=e.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=e.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-e.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-e.y,this.rows[2].jacobian[4]=e.x,this.rows[2].jacobian[5]=0,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,c),f.subtractVectors(c,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=f.z,this.rows[0].jacobian[11]=-f.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-f.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=f.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=f.y,this.rows[2].jacobian[10]=-f.z,this.rows[2].jacobian[11]=0):c.copy(this.point_b),d.subtractVectors(b,c),d.scale(this.erp/a),this.rows[0].bias=d.x,this.rows[1].bias=d.y,this.rows[2].bias=d.z}}(),a.SliderConstraint=function(b,c,d){a.Constraint.call(this),this.object_a=b,this.axis=c,this.object_b=d,this.position_error=new a.Vector3,this.position_error.subtractVectors(this.object_b.position,this.object_a.position),e.invertQuaternion(this.object_a.rotation),e.transformVector3(this.position_error),this.rotation_difference=new a.Quaternion,null!=this.object_b&&(e.invertQuaternion(this.object_b.rotation),this.rotation_difference.multiplyQuaternions(e,this.object_a.rotation)),this.erp=.1;for(var f=0;5>f;f++)this.rows[f]=a.ObjectPool.getObject("ConstraintRow"),this.rows[f].lower_limit=-1/0,this.rows[f].upper_limit=1/0,this.rows[f].bias=0,this.rows[f].jacobian[0]=this.rows[f].jacobian[1]=this.rows[f].jacobian[2]=this.rows[f].jacobian[3]=this.rows[f].jacobian[4]=this.rows[f].jacobian[5]=this.rows[f].jacobian[6]=this.rows[f].jacobian[7]=this.rows[f].jacobian[8]=this.rows[f].jacobian[9]=this.rows[f].jacobian[10]=this.rows[f].jacobian[11]=0},a.SliderConstraint.prototype=Object.create(a.Constraint.prototype),a.SliderConstraint.prototype.update=function(){var b=new a.Vector3,c=new a.Vector3,d=new a.Vector3;return function(a){this.object_a.rotation.transformVector3Into(this.axis,b),c.x=b.y,c.y=-b.x,c.z=0,c.normalize(),d.crossVectors(b,c),this._updateLinearConstraints(a,c,d),this._updateAngularConstraints(a,c,d)}}(),a.SliderConstraint.prototype._updateLinearConstraints=function(d,e,f){var g=new a.Vector3;g.subtractVectors(this.object_b.position,this.object_a.position);var h=new a.Vector3;h.crossVectors(g,e),this.rows[0].jacobian[0]=-e.x,this.rows[0].jacobian[1]=-e.y,this.rows[0].jacobian[2]=-e.z,this.rows[0].jacobian[6]=e.x,this.rows[0].jacobian[7]=e.y,this.rows[0].jacobian[8]=e.z,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=0,this.rows[0].jacobian[11]=0,h.crossVectors(g,f),this.rows[1].jacobian[0]=-f.x,this.rows[1].jacobian[1]=-f.y,this.rows[1].jacobian[2]=-f.z,this.rows[1].jacobian[6]=f.x,this.rows[1].jacobian[7]=f.y,this.rows[1].jacobian[8]=f.z,this.rows[1].jacobian[9]=0,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=0,this.object_a.rotation.transformVector3Into(this.position_error,b),c.subtractVectors(g,b),c.scale(this.erp/d),this.rows[0].bias=-e.dot(c),this.rows[1].bias=-f.dot(c)},a.SliderConstraint.prototype._updateAngularConstraints=function(b){this.rows[2].jacobian[3]=this.rows[3].jacobian[4]=this.rows[4].jacobian[5]=-1,this.rows[2].jacobian[9]=this.rows[3].jacobian[10]=this.rows[4].jacobian[11]=1,e.invertQuaternion(this.object_b.rotation),e.multiply(this.object_a.rotation),f.invertQuaternion(this.rotation_difference),f.multiply(e);var c=new a.Vector3;c.x=f.x,c.y=f.y,c.z=f.z,c.scale(this.erp/b)},a.WeldConstraint=function(b,c,d,f){a.Constraint.call(this),this.object_a=b,this.point_a=c,this.object_b=d||null,this.point_b=f||null,this.rotation_difference=new a.Quaternion,null!=this.object_b&&(e.invertQuaternion(this.object_b.rotation),this.rotation_difference.multiplyQuaternions(e,this.object_a.rotation)),this.erp=.1;for(var g=0;3>g;g++)this.rows[g]=a.ObjectPool.getObject("ConstraintRow"),this.rows[g].lower_limit=-1/0,this.rows[g].upper_limit=1/0,this.rows[g].bias=0,null==this.object_b&&(this.rows[g].jacobian[0]=this.rows[g].jacobian[1]=this.rows[g].jacobian[2]=this.rows[g].jacobian[4]=this.rows[g].jacobian[5]=this.rows[g].jacobian[6]=this.rows[g].jacobian[7]=this.rows[g].jacobian[8]=this.rows[g].jacobian[9]=this.rows[g].jacobian[10]=this.rows[g].jacobian[11]=this.rows[g].jacobian[12]=0,this.rows[g].jacobian[g]=1);for(g=3;6>g;g++)this.rows[g]=a.ObjectPool.getObject("ConstraintRow"),this.rows[g].lower_limit=-1/0,this.rows[g].upper_limit=1/0,this.rows[g].bias=0,null==this.object_b?(this.rows[g].jacobian[0]=this.rows[g].jacobian[1]=this.rows[g].jacobian[2]=this.rows[g].jacobian[4]=this.rows[g].jacobian[5]=this.rows[g].jacobian[6]=this.rows[g].jacobian[7]=this.rows[g].jacobian[8]=this.rows[g].jacobian[9]=this.rows[g].jacobian[10]=this.rows[g].jacobian[11]=this.rows[g].jacobian[12]=0,this.rows[g].jacobian[g]=1):(this.rows[g].jacobian[0]=this.rows[g].jacobian[1]=this.rows[g].jacobian[2]=0,this.rows[g].jacobian[3]=this.rows[g].jacobian[4]=this.rows[g].jacobian[5]=0,this.rows[g].jacobian[g]=-1,this.rows[g].jacobian[6]=this.rows[g].jacobian[7]=this.rows[g].jacobian[8]=0,this.rows[g].jacobian[9]=this.rows[g].jacobian[10]=this.rows[g].jacobian[11]=0,this.rows[g].jacobian[g+6]=1)},a.WeldConstraint.prototype=Object.create(a.Constraint.prototype),a.WeldConstraint.prototype.update=function(){var d=new a.Vector3,g=new a.Vector3;return function(h){if(null!=this.object_b){this.object_a.transform.transformVector3Into(this.point_a,b),d.subtractVectors(b,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-d.z,this.rows[0].jacobian[5]=d.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=d.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-d.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-d.y,this.rows[2].jacobian[4]=d.x,this.rows[2].jacobian[5]=0,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,c),g.subtractVectors(c,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=g.z,this.rows[0].jacobian[11]=-g.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-g.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=g.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=g.y,this.rows[2].jacobian[10]=-g.x,this.rows[2].jacobian[11]=0):c.copy(this.point_b);var i=new a.Vector3;i.subtractVectors(b,c),i.scale(this.erp/h),this.rows[0].bias=i.x,this.rows[1].bias=i.y,this.rows[2].bias=i.z,e.invertQuaternion(this.object_b.rotation),e.multiply(this.object_a.rotation),f.invertQuaternion(this.rotation_difference),f.multiply(e),i.x=f.x,i.y=f.y,i.z=f.z,i.scale(this.erp/h),this.rows[3].bias=i.x,this.rows[4].bias=i.y,this.rows[5].bias=i.z}}}(),a.ContactDetails=function(){this.object_a=null,this.object_b=null,this.contact_point=new a.Vector3,this.contact_point_in_a=new a.Vector3,this.contact_point_in_b=new a.Vector3,this.contact_normal=new a.Vector3,this.penetration_depth=0,this.restitution=0,this.friction=0,this.listeners={}},a.EventEmitter.apply(a.ContactDetails),a.ContactDetails.prototype.destroy=function(){this.emit("destroy"),a.ObjectPool.freeObject("ContactDetails",this)},a.ContactManifold=function(){this.object_a=null,this.object_b=null,this.points=[],this.next_manifold=null},a.ContactManifold.prototype.findWeakestContact=function(a){var d,e,f=-1,g=a.penetration_depth;for(d=0;4>d;d++)e=this.points[d],e.penetration_depth>g&&(g=e.penetration_depth,f=d);var h=0,i=0,j=0,k=0;0!==f&&(b.subtractVectors(a.contact_point_in_a,this.points[1].contact_point_in_a),c.subtractVectors(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a),b.cross(c),h=b.lengthSquared()),1!==f&&(b.subtractVectors(a.contact_point_in_a,this.points[0].contact_point_in_a),c.subtractVectors(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a),b.cross(c),i=b.lengthSquared()),2!==f&&(b.subtractVectors(a.contact_point_in_a,this.points[0].contact_point_in_a),c.subtractVectors(this.points[3].contact_point_in_a,this.points[1].contact_point_in_a),b.cross(c),j=b.lengthSquared()),3!==f&&(b.subtractVectors(a.contact_point_in_a,this.points[0].contact_point_in_a),c.subtractVectors(this.points[2].contact_point_in_a,this.points[1].contact_point_in_a),b.cross(c),k=b.lengthSquared());var l=0,m=h;return i>m&&(l=1,m=i),j>m&&(l=2,m=j),k>m&&(l=3),l},a.ContactManifold.prototype.addContact=function(a){var b;for(b=0;b<this.points.length;b++)if(this.points[b].contact_point.distanceTo(a.contact_point)<=.02)return void a.destroy();var c=!1;if(null!=a){if(c=a.object_a.emit("speculativeContact",a.object_b,a),c!==!1&&(c=a.object_b.emit("speculativeContact",a.object_a,a)),c===!1)return void a.destroy();a.object_a.emit("contact",a.object_b,a),a.object_b.emit("contact",a.object_a,a)}if(this.points.length<4)this.points.push(a);else{var d=this.findWeakestContact(a);this.points[d].destroy(),this.points[d]=a}},a.ContactManifold.prototype.update=function(){var c,d,e,f=new a.Vector3,g=new a.Vector3,h=new a.Vector3;for(c=0;c<this.points.length;c++)if(e=this.points[c],e.object_a.transform.transformVector3Into(e.contact_point_in_a,f),e.object_b.transform.transformVector3Into(e.contact_point_in_b,g),e.contact_point.addVectors(f,g),e.contact_point.scale(.5),h.subtractVectors(f,g),e.penetration_depth=h.dot(e.contact_normal),e.penetration_depth<-.02){for(e.destroy(),d=c;d<this.points.length;d++)this.points[d]=this.points[d+1];this.points.length=this.points.length-1}else{b.scaleVector(e.contact_normal,e.penetration_depth),b.subtractVectors(f,b),b.subtractVectors(g,b);var i=b.lengthSquared();if(i>.2*.2){for(e.destroy(),d=c;d<this.points.length;d++)this.points[d]=this.points[d+1];this.points.length=this.points.length-1}}0===this.points.length&&(this.object_a.emit("endContact",this.object_b),this.object_b.emit("endContact",this.object_a))},a.ContactManifoldList=function(){this.first=null},a.ContactManifoldList.prototype.insert=function(a){a.next_manifold=this.first,this.first=a},a.ContactManifoldList.prototype.getManifoldForObjects=function(b,c){var d=null;if(null!==this.first)for(var e=this.first;null!==e;){if(e.object_a===b&&e.object_b===c||e.object_a===c&&e.object_b===b){d=e;break}e=e.next_manifold}return null===d&&(d=a.ObjectPool.getObject("ContactManifold"),d.object_a=b,d.object_b=c,this.insert(d)),d},a.ForceGenerator=function(b){this.force=b||new a.Vector3,this.enabled=!0,this.affected=[]},a.ForceGenerator.prototype.applyForce=function(){if(this.enabled){var a,b;for(a=0,b=this.affected.length;b>a;a++)this.affected[a].applyForce(this.force)}},a.ForceGenerator.prototype.enable=function(){this.enabled=!0},a.ForceGenerator.prototype.disable=function(){this.enabled=!1},a.ForceGenerator.prototype.affect=function(a){var b,c;for(b=0,c=this.affected.length;c>b;b++)if(this.affected[b]===a)return;this.affected.push(a)},a.ForceGenerator.prototype.unaffect=function(a){var b,c;for(b=0,c=this.affected.length;c>b;b++)if(this.affected[b]===a)return void this.affected.splice(b,1)},a.DragForce=function(a,b){this.drag_coefficient=a||0,this.squared_drag_coefficient=b||0,this.enabled=!0,this.affected=[]},a.DragForce.prototype.enable=a.ForceGenerator.prototype.enable,a.DragForce.prototype.disable=a.ForceGenerator.prototype.disable,a.DragForce.prototype.affect=a.ForceGenerator.prototype.affect,a.DragForce.prototype.unaffect=a.ForceGenerator.prototype.unaffect,a.DragForce.prototype.applyForce=function(){if(this.enabled){var a,c,d,e,f=b;for(a=0,c=this.affected.length;c>a;a++)d=this.affected[a],f.copy(d.linear_velocity),e=f.length(),e=this.drag_coefficient*e+this.squared_drag_coefficient*e*e,f.normalize(),f.scale(-e),d.applyForce(f)}},a.IterativeSolver=function(){this.contact_constraints=[],this.friction_constraints=[],this.all_constraints=[],this.constraints=[],this.max_iterations=10,this.penetrations_max_iterations=5,this.relaxation=.1,this.sor_weight=.85,this.warmstarting_factor=.95;var a=this;this.onContactDeactivate=function(){this.removeListener("deactivate",a.onContactDeactivate);var b=a.contact_constraints.indexOf(this);a.contact_constraints.splice(b,1)},this.onFrictionDeactivate=function(){this.removeListener("deactivate",a.onFrictionDeactivate);var b=a.friction_constraints.indexOf(this);a.friction_constraints.splice(b,1)}},a.IterativeSolver.prototype.addConstraint=function(a){-1===this.constraints.indexOf(a)&&this.constraints.push(a)},a.IterativeSolver.prototype.removeConstraint=function(a){var b=this.constraints.indexOf(a);-1!==b&&this.constraints.splice(b,1)},a.IterativeSolver.prototype.processContactManifolds=function(b){var c,d,e,f,g,h;for(e=b.first;e;){for(f=e.points.length,c=0;f>c;c++){g=e.points[c];var i=null;for(d=0;d<this.contact_constraints.length;d++)if(this.contact_constraints[d].contact===g){i=this.contact_constraints[d];break}i||(h=a.ObjectPool.getObject("ContactConstraint"),h.buildFromContact(g),this.contact_constraints.push(h),h.addListener("deactivate",this.onContactDeactivate),h=a.ObjectPool.getObject("FrictionConstraint"),h.buildFromContact(g),this.friction_constraints.push(h),h.addListener("deactivate",this.onFrictionDeactivate))}e=e.next_manifold}this.all_constraints.length=0,Array.prototype.push.apply(this.all_constraints,this.friction_constraints),Array.prototype.push.apply(this.all_constraints,this.constraints),Array.prototype.push.apply(this.all_constraints,this.contact_constraints)},a.IterativeSolver.prototype.prepareConstraints=function(a){var b,c,d,e,f,g=this.all_constraints.length;for(e=0;g>e;e++)if(c=this.all_constraints[e],c.active!==!1)for(b=c.rows.length,c.update(a),f=0;b>f;f++)d=c.rows[f],d.multiplier=0,d.computeB(c),d.computeD(),d.computeEta(c,a)},a.IterativeSolver.prototype.resolveContacts=function(){var c,d,f,g,h,i,j,k=0;for(c=0;c<this.penetrations_max_iterations;c++){for(k=0,h=0;h<this.contact_constraints.length;h++){d=this.contact_constraints[h],g=d.rows[0],f=0,null!=d.object_a&&1/0!==d.object_a._mass&&(f+=g.jacobian[0]*d.object_a.linear_factor.x*d.object_a.push_velocity.x+g.jacobian[1]*d.object_a.linear_factor.y*d.object_a.push_velocity.y+g.jacobian[2]*d.object_a.linear_factor.z*d.object_a.push_velocity.z+g.jacobian[3]*d.object_a.angular_factor.x*d.object_a.turn_velocity.x+g.jacobian[4]*d.object_a.angular_factor.y*d.object_a.turn_velocity.y+g.jacobian[5]*d.object_a.angular_factor.z*d.object_a.turn_velocity.z),null!=d.object_b&&1/0!==d.object_b._mass&&(f+=g.jacobian[6]*d.object_b.linear_factor.x*d.object_b.push_velocity.x+g.jacobian[7]*d.object_b.linear_factor.y*d.object_b.push_velocity.y+g.jacobian[8]*d.object_b.linear_factor.z*d.object_b.push_velocity.z+g.jacobian[9]*d.object_b.angular_factor.x*d.object_b.turn_velocity.x+g.jacobian[10]*d.object_b.angular_factor.y*d.object_b.turn_velocity.y+g.jacobian[11]*d.object_b.angular_factor.z*d.object_b.turn_velocity.z),i=(d.contact.penetration_depth-f)/g.D||0;var l=g.multiplier;g.multiplier=Math.max(g.lower_limit,Math.min(l+i,g.upper_limit)),i=g.multiplier-l,k=Math.max(k,i),d.object_a&&1/0!==d.object_a._mass&&(d.object_a.push_velocity.x+=i*g.B[0],d.object_a.push_velocity.y+=i*g.B[1],d.object_a.push_velocity.z+=i*g.B[2],d.object_a.turn_velocity.x+=i*g.B[3],d.object_a.turn_velocity.y+=i*g.B[4],d.object_a.turn_velocity.z+=i*g.B[5]),d.object_b&&1/0!==d.object_b._mass&&(d.object_b.push_velocity.x+=i*g.B[6],d.object_b.push_velocity.y+=i*g.B[7],d.object_b.push_velocity.z+=i*g.B[8],d.object_b.turn_velocity.x+=i*g.B[9],d.object_b.turn_velocity.y+=i*g.B[10],d.object_b.turn_velocity.z+=i*g.B[11])}if(k>=-a.EPSILON&&k<=a.EPSILON)break}for(h=0;h<this.contact_constraints.length;h++)d=this.contact_constraints[h],g=d.rows[0],null!=d.object_a&&1/0!==d.object_a._mass&&(j=d.object_a._mass_inverted,d.object_a.position.x+=j*g.jacobian[0]*d.object_a.linear_factor.x*g.multiplier*this.relaxation,d.object_a.position.y+=j*g.jacobian[1]*d.object_a.linear_factor.y*g.multiplier*this.relaxation,d.object_a.position.z+=j*g.jacobian[2]*d.object_a.linear_factor.z*g.multiplier*this.relaxation,b.x=g.jacobian[3]*d.object_a.angular_factor.x*g.multiplier*this.relaxation,b.y=g.jacobian[4]*d.object_a.angular_factor.y*g.multiplier*this.relaxation,b.z=g.jacobian[5]*d.object_a.angular_factor.z*g.multiplier*this.relaxation,d.object_a.inverseInertiaTensorWorldFrame.transformVector3(b),e.x=b.x,e.y=b.y,e.z=b.z,e.w=0,e.multiply(d.object_a.rotation),d.object_a.rotation.x+=.5*e.x,d.object_a.rotation.y+=.5*e.y,d.object_a.rotation.z+=.5*e.z,d.object_a.rotation.w+=.5*e.w,d.object_a.rotation.normalize()),null!=d.object_b&&1/0!==d.object_b._mass&&(j=d.object_b._mass_inverted,d.object_b.position.x+=j*g.jacobian[6]*d.object_b.linear_factor.x*g.multiplier*this.relaxation,d.object_b.position.y+=j*g.jacobian[7]*d.object_b.linear_factor.y*g.multiplier*this.relaxation,d.object_b.position.z+=j*g.jacobian[8]*d.object_b.linear_factor.z*g.multiplier*this.relaxation,b.x=g.jacobian[9]*d.object_b.angular_factor.x*g.multiplier*this.relaxation,b.y=g.jacobian[10]*d.object_b.angular_factor.y*g.multiplier*this.relaxation,b.z=g.jacobian[11]*d.object_b.angular_factor.z*g.multiplier*this.relaxation,d.object_b.inverseInertiaTensorWorldFrame.transformVector3(b),e.x=b.x,e.y=b.y,e.z=b.z,e.w=0,e.multiply(d.object_b.rotation),d.object_b.rotation.x+=.5*e.x,d.object_b.rotation.y+=.5*e.y,d.object_b.rotation.z+=.5*e.z,d.object_b.rotation.w+=.5*e.w,d.object_b.rotation.normalize()),g.multiplier=0},a.IterativeSolver.prototype.solveConstraints=function(){var a,b,c,d,e,f,g,h,i,j=this.all_constraints.length,k=0;for(e=0;j>e;e++)if(a=this.all_constraints[e],a.active!==!1)for(f=0;f<a.rows.length;f++)c=a.rows[f],d=c.multiplier_cached*this.warmstarting_factor,c.multiplier=d,a.object_a&&1/0!==a.object_a._mass&&(a.object_a.solver_impulse[0]+=d*c.B[0],a.object_a.solver_impulse[1]+=d*c.B[1],a.object_a.solver_impulse[2]+=d*c.B[2],a.object_a.solver_impulse[3]+=d*c.B[3],a.object_a.solver_impulse[4]+=d*c.B[4],a.object_a.solver_impulse[5]+=d*c.B[5]),a.object_b&&1/0!==a.object_b._mass&&(a.object_b.solver_impulse[0]+=d*c.B[6],a.object_b.solver_impulse[1]+=d*c.B[7],a.object_b.solver_impulse[2]+=d*c.B[8],a.object_b.solver_impulse[3]+=d*c.B[9],a.object_b.solver_impulse[4]+=d*c.B[10],a.object_b.solver_impulse[5]+=d*c.B[11]);for(g=0;g<this.max_iterations;g++){for(k=0,e=0;j>e;e++)if(a=this.all_constraints[e],a.active!==!1)for(b=a.rows.length,f=0;b>f;f++){c=a.rows[f],i=0,null!=a.object_a&&1/0!==a.object_a._mass&&(i+=c.jacobian[0]*a.object_a.linear_factor.x*a.object_a.solver_impulse[0]+c.jacobian[1]*a.object_a.linear_factor.y*a.object_a.solver_impulse[1]+c.jacobian[2]*a.object_a.linear_factor.z*a.object_a.solver_impulse[2]+c.jacobian[3]*a.object_a.angular_factor.x*a.object_a.solver_impulse[3]+c.jacobian[4]*a.object_a.angular_factor.y*a.object_a.solver_impulse[4]+c.jacobian[5]*a.object_a.angular_factor.z*a.object_a.solver_impulse[5]),null!=a.object_b&&1/0!==a.object_b._mass&&(i+=c.jacobian[6]*a.object_b.linear_factor.x*a.object_b.solver_impulse[0]+c.jacobian[7]*a.object_b.linear_factor.y*a.object_b.solver_impulse[1]+c.jacobian[8]*a.object_b.linear_factor.z*a.object_b.solver_impulse[2]+c.jacobian[9]*a.object_b.angular_factor.x*a.object_b.solver_impulse[3]+c.jacobian[10]*a.object_b.angular_factor.y*a.object_b.solver_impulse[4]+c.jacobian[11]*a.object_b.angular_factor.z*a.object_b.solver_impulse[5]),h=((c.eta-i)/c.D||0)*a.factor;var l=c.multiplier,m=l+h;m=this.sor_weight*m+(1-this.sor_weight)*l,c.multiplier=Math.max(c.lower_limit,Math.min(m,c.upper_limit)),h=c.multiplier-l;var n=(a.object_a&&1/0!==a.object_a._mass?a.object_a._mass:0)+(a.object_b&&1/0!==a.object_b._mass?a.object_b._mass:0);k=Math.max(k,Math.abs(h)/n),a.object_a&&1/0!==a.object_a._mass&&(a.object_a.solver_impulse[0]+=h*c.B[0],a.object_a.solver_impulse[1]+=h*c.B[1],a.object_a.solver_impulse[2]+=h*c.B[2],a.object_a.solver_impulse[3]+=h*c.B[3],a.object_a.solver_impulse[4]+=h*c.B[4],a.object_a.solver_impulse[5]+=h*c.B[5]),a.object_b&&1/0!==a.object_b._mass&&(a.object_b.solver_impulse[0]+=h*c.B[6],a.object_b.solver_impulse[1]+=h*c.B[7],a.object_b.solver_impulse[2]+=h*c.B[8],a.object_b.solver_impulse[3]+=h*c.B[9],a.object_b.solver_impulse[4]+=h*c.B[10],a.object_b.solver_impulse[5]+=h*c.B[11])}if(.1>=k)break}},a.IterativeSolver.prototype.applyConstraints=function(a){var d,e,f,g,h,i,j=this.all_constraints.length;for(g=0;j>g;g++)if(d=this.all_constraints[g],d.active!==!1){for(e=d.rows.length,d.last_impulse.x=d.last_impulse.y=d.last_impulse.z=0,h=0;e>h;h++)f=d.rows[h],f.multiplier_cached=f.multiplier,null!=d.object_a&&1/0!==d.object_a._mass&&(i=d.object_a._mass_inverted,c.x=i*a*f.jacobian[0]*d.object_a.linear_factor.x*f.multiplier,c.y=i*a*f.jacobian[1]*d.object_a.linear_factor.y*f.multiplier,c.z=i*a*f.jacobian[2]*d.object_a.linear_factor.z*f.multiplier,d.object_a.linear_velocity.add(c),d.last_impulse.add(c),b.x=a*f.jacobian[3]*d.object_a.angular_factor.x*f.multiplier,b.y=a*f.jacobian[4]*d.object_a.angular_factor.y*f.multiplier,b.z=a*f.jacobian[5]*d.object_a.angular_factor.z*f.multiplier,d.object_a.inverseInertiaTensorWorldFrame.transformVector3(b),d.object_a.angular_velocity.add(b),d.last_impulse.add(b)),null!=d.object_b&&1/0!==d.object_b._mass&&(i=d.object_b._mass_inverted,c.x=i*a*f.jacobian[6]*d.object_b.linear_factor.x*f.multiplier,c.y=i*a*f.jacobian[7]*d.object_b.linear_factor.y*f.multiplier,c.z=i*a*f.jacobian[8]*d.object_b.linear_factor.z*f.multiplier,d.object_b.linear_velocity.add(c),d.last_impulse.add(c),b.x=a*f.jacobian[9]*d.object_b.angular_factor.x*f.multiplier,b.y=a*f.jacobian[10]*d.object_b.angular_factor.y*f.multiplier,b.z=a*f.jacobian[11]*d.object_b.angular_factor.z*f.multiplier,d.object_b.inverseInertiaTensorWorldFrame.transformVector3(b),d.object_b.angular_velocity.add(b),d.last_impulse.add(b));
d.breaking_threshold>0&&d.last_impulse.lengthSquared()>=d.breaking_threshold*d.breaking_threshold&&(d.active=!1)}},a.NarrowPhase=function(){this.contact_manifolds=new a.ContactManifoldList},a.NarrowPhase.prototype.updateContactManifolds=function(){for(var b=this.contact_manifolds.first,c=null;null!==b;)b.update(),0===b.points.length?(a.ObjectPool.freeObject("ContactManifold",b),null==c?this.contact_manifolds.first=b.next_manifold:c.next_manifold=b.next_manifold,b=b.next_manifold):(c=b,b=b.next_manifold)},a.NarrowPhase.prototype.midPhase=function(b,c){var d,e;b.shape instanceof a.CompoundShape?(d=b,e=c):(d=c,e=b);for(var f,g,h=a.ObjectPool.getObject("RigidBodyProxy"),i=0;i<d.shape.child_shapes.length;i++)if(f=d.shape.child_shapes[i],h.setFrom(d,f),h.shape instanceof a.CompoundShape||e.shape instanceof a.CompoundShape)this.midPhase(h,e);else if(g=this.getContact(h,e),null!=g){var j,k;if(g.object_a===h?(g.object_a=d,j=h,k=e):(g.object_b=d,j=e,k=h),j instanceof a.RigidBodyProxy)for(;j.parent;)j instanceof a.RigidBodyProxy&&j.shape_data.transform.transformVector3(g.contact_point_in_a),j=j.parent;if(k instanceof a.RigidBodyProxy)for(;k.parent;)k instanceof a.RigidBodyProxy&&k.shape_data.transform.transformVector3(g.contact_point_in_b),k=k.parent;g.object_a=j,g.object_b=k,this.addContact(j,k,g)}a.ObjectPool.freeObject("RigidBodyProxy",h)},a.NarrowPhase.prototype.meshCollision=function(){function b(b,c,d){var e=a.ObjectPool.getObject("RigidBodyProxy"),f=new a.CompoundShapeChild(b,new a.Vector3,new a.Quaternion);e.setFrom(c,f);var g,h=a.GjkEpa.GJK(e,d);return null!=a.GjkEpa.result?g=a.GjkEpa.result:null!=h&&(g=a.GjkEpa.EPA(h)),a.ObjectPool.freeObject("RigidBodyProxy",e),g}var c=(new a.Matrix4,function(){var c=new a.Matrix4,d=new a.AABB;return function(a,e,f){c.copy(e.transform),c.multiply(a.transform_inverse),d.transform(e.aabb,a.transform_inverse);for(var g,h=[a.shape.hierarchy];g=h.shift();)if(g.aabb.intersects(d))if(g.isLeaf()){var i=b(g.object,a,e);null!=i&&(i.object_a=a,f(a,e,i))}else h.push(g.left,g.right)}}());return function(b,d){var e=b.shape instanceof a.MeshShape,f=d.shape instanceof a.MeshShape;e&&f||(e?c(b,d,this.addContact.bind(this)):c(d,b,this.addContact.bind(this)))}}(),a.NarrowPhase.prototype.getContact=function(b,c){if(b.shape instanceof a.CompoundShape||c.shape instanceof a.CompoundShape)return void this.midPhase(b,c);if(b.shape instanceof a.MeshShape||c.shape instanceof a.MeshShape)return void this.meshCollision(b,c);var d;if(b.shape instanceof a.SphereShape&&c.shape instanceof a.SphereShape)d=a.SphereSphere(b,c);else if(b.shape instanceof a.SphereShape&&c.shape instanceof a.BoxShape||b.shape instanceof a.BoxShape&&c.shape instanceof a.SphereShape)d=a.BoxSphere(b,c);else{var e=a.GjkEpa.GJK(b,c);null!=a.GjkEpa.result?d=a.GjkEpa.result:null!=e&&(d=a.GjkEpa.EPA(e))}return d},a.NarrowPhase.prototype.addContact=function(a,b,c){this.contact_manifolds.getManifoldForObjects(a,b).addContact(c)},a.NarrowPhase.prototype.generateContacts=function(a){var b,c,d=a.length;for(this.updateContactManifolds(),b=0;d>b;b++)c=this.getContact(a[b][0],a[b][1]),null!=c&&this.addContact(a[b][0],a[b][1],c)},a.ObjectPool={types:{},pools:{},registerType:function(a,b){this.types[a]=b,this.pools[a]=[]},getObject:function(a){var b=this.pools[a];return 0!==b.length?b.pop():this.types[a]()},freeObject:function(a,b){null!=b.removeAllListeners&&b.removeAllListeners(),this.pools[a].push(b)}},a.ObjectPool.registerType("ContactDetails",function(){return new a.ContactDetails}),a.ObjectPool.registerType("ContactManifold",function(){return new a.ContactManifold}),a.ObjectPool.registerType("GJK2SupportPoint",function(){return new a.GjkEpa.SupportPoint(new a.Vector3,new a.Vector3,new a.Vector3)}),a.ObjectPool.registerType("ConstraintRow",function(){return new a.ConstraintRow}),a.ObjectPool.registerType("ContactConstraint",function(){return new a.ContactConstraint}),a.ObjectPool.registerType("FrictionConstraint",function(){return new a.FrictionConstraint}),a.ObjectPool.registerType("RayIntersection",function(){return new a.RayIntersection}),a.ObjectPool.registerType("RigidBodyProxy",function(){return new a.RigidBodyProxy}),a.RayIntersection=function(){this.object=null,this.point=new a.Vector3,this.t=null,this.normal=new a.Vector3},a.RigidBody=function(){var b=0;return function(c,d){this.id=b++,this.shape=c,this.aabb=new a.AABB,this._mass=d||1/0,this._mass_inverted=1/d,this.position=new a.Vector3,this.rotation=new a.Quaternion(0,0,0,1),this.linear_velocity=new a.Vector3,this.angular_velocity=new a.Vector3,this.transform=new a.Matrix4,this.transform.identity(),this.transform_inverse=new a.Matrix4,this.transform_inverse.identity(),this.inertiaTensor=c.getInertiaTensor(d),this.inverseInertiaTensor=new a.Matrix3,this.inertiaTensor.invertInto(this.inverseInertiaTensor),this.inertiaTensorWorldFrame=new a.Matrix3,this.inverseInertiaTensorWorldFrame=new a.Matrix3,this.acceleration=new a.Vector3,this.restitution=.1,this.friction=.5,this.collision_groups=0,this.collision_mask=0,this.gravity=null,this.linear_damping=0,this.angular_damping=0,this.linear_factor=new a.Vector3(1,1,1),this.angular_factor=new a.Vector3(1,1,1),this.world=null,this.accumulated_force=new a.Vector3,this.accumulated_torque=new a.Vector3,this.push_velocity=new a.Vector3,this.turn_velocity=new a.Vector3,this.solver_impulse=new Float64Array(6),this.updateDerived(),this.listeners={}}}(),a.EventEmitter.apply(a.RigidBody),Object.defineProperty(a.RigidBody.prototype,"mass",{get:function(){return this._mass},set:function(a){this._mass=a,this._mass_inverted=1/a,this.inertiaTensor=this.shape.getInertiaTensor(a)}}),a.RigidBody.prototype.findSupportPoint=function(){var b=new a.Vector3;return function(a,c){this.transform_inverse.rotateVector3Into(a,b),this.shape.findSupportPoint(b,c),this.transform.transformVector3(c)}}(),a.RigidBody.prototype.rayIntersect=function(){var b=new a.Vector3,c=new a.Vector3;return function(a,d,e){this.transform_inverse.transformVector3Into(a,b),this.transform_inverse.transformVector3Into(d,c);var f=this.shape.rayIntersect(b,c);null!=f&&(f.object=this,this.transform.transformVector3(f.point),this.transform.rotateVector3(f.normal),e.push(f))}}(),a.RigidBody.prototype.integrate=function(a){if(1/0!==this._mass){b.scaleVector(this.accumulated_force,this._mass_inverted),b.multiply(this.linear_factor),this.linear_velocity.add(b),this.inverseInertiaTensorWorldFrame.transformVector3Into(this.accumulated_torque,b),b.multiply(this.angular_factor),this.angular_velocity.add(b),this.linear_velocity.scale(Math.pow(1-this.linear_damping,a)),this.angular_velocity.scale(Math.pow(1-this.angular_damping,a)),b.scaleVector(this.linear_velocity,a),this.position.add(b),e.x=this.angular_velocity.x*a,e.y=this.angular_velocity.y*a,e.z=this.angular_velocity.z*a,e.w=0,e.multiply(this.rotation);var c=.5;this.rotation.x+=c*e.x,this.rotation.y+=c*e.y,this.rotation.z+=c*e.z,this.rotation.w+=c*e.w,this.rotation.normalize(),this.accumulated_force.x=this.accumulated_force.y=this.accumulated_force.z=0,this.accumulated_torque.x=this.accumulated_torque.y=this.accumulated_torque.z=0,this.solver_impulse[0]=this.solver_impulse[1]=this.solver_impulse[2]=this.solver_impulse[3]=this.solver_impulse[4]=this.solver_impulse[5]=0,this.push_velocity.x=this.push_velocity.y=this.push_velocity.z=0,this.turn_velocity.x=this.turn_velocity.y=this.turn_velocity.z=0}},a.RigidBody.prototype.setGravity=function(b,c,d){this.gravity?(this.gravity.x=b,this.gravity.y=c,this.gravity.z=d):this.gravity=new a.Vector3(b,c,d)},a.RigidBody.prototype.applyImpulse=function(a){b.multiplyVectors(a,this.linear_factor),this.linear_velocity.add(b)},a.RigidBody.prototype.applyForce=function(a){this.accumulated_force.add(a)},a.RigidBody.prototype.applyForceAtWorldPoint=function(a,c){b.copy(c),b.subtract(this.position),b.cross(a),this.accumulated_force.add(a),this.accumulated_torque.add(b)},a.RigidBody.prototype.applyForceAtLocalPoint=function(a,c){this.transform.transformVector3Into(c,b),this.applyForceAtWorldPoint(a,b)},a.RigidBody.prototype.getVelocityInLocalPoint=function(a,b){1/0===this._mass?b.set(0,0,0):(b.copy(this.angular_velocity),b.cross(a),b.add(this.linear_velocity))},a.RigidBody.prototype.updateDerived=function(){this.rotation.normalize(),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),1/0!==this._mass&&(g.fromMatrix4(this.transform_inverse),g.transposeInto(h),h.multiply(this.inertiaTensor),this.inertiaTensorWorldFrame.multiplyFrom(h,g),this.inertiaTensorWorldFrame.invertInto(this.inverseInertiaTensorWorldFrame)),this.aabb.transform(this.shape.aabb,this.transform)},a.RigidBodyProxy=function(){this.parent=null,this.id=null,this.shape=null,this.aabb=new a.AABB,this._mass=null,this._mass_inverted=null,this.position=new a.Vector3,this.rotation=new a.Quaternion,this.transform=new a.Matrix4,this.transform_inverse=new a.Matrix4,this.restitution=null,this.friction=null},Object.defineProperty(a.RigidBodyProxy.prototype,"mass",{get:function(){return this._mass},set:function(a){this._mass=a,this._mass_inverted=1/a,this.inertiaTensor=this.shape.getInertiaTensor(a)}}),a.RigidBodyProxy.prototype.setFrom=function(a,b){this.parent=a,this.id=a.id,this.shape=b.shape,this.shape_data=b,this._mass=a._mass,a.transform.transformVector3Into(b.position,this.position),this.rotation.multiplyQuaternions(a.rotation,b.rotation),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this.aabb.transform(this.shape.aabb,this.transform),this.restitution=a.restitution,this.friction=a.friction},a.RigidBodyProxy.prototype.findSupportPoint=a.RigidBody.prototype.findSupportPoint,a.RigidBodyProxy.prototype.getRigidBody=function(){for(var a=this.parent;a.parent;)a=this.parent;return a},a.BoxShape=function(b,c,d){this.half_width=b,this.half_height=c,this.half_depth=d,this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb)},a.BoxShape.prototype.calculateLocalAABB=function(a){a.min.x=-this.half_width,a.min.y=-this.half_height,a.min.z=-this.half_depth,a.max.x=this.half_width,a.max.y=this.half_height,a.max.z=this.half_depth},a.BoxShape.prototype.getInertiaTensor=function(b){var c=this.half_height*this.half_height*4,d=this.half_width*this.half_width*4,e=this.half_depth*this.half_depth*4,f=.0833*b;return new a.Matrix3(f*(c+e),0,0,0,f*(d+e),0,0,0,f*(c+d))},a.BoxShape.prototype.findSupportPoint=function(a,b){b.x=a.x<0?-this.half_width:this.half_width,b.y=a.y<0?-this.half_height:this.half_height,b.z=a.z<0?-this.half_depth:this.half_depth},a.BoxShape.prototype.rayIntersect=function(){var b,c,d,e,f,g,h,i=new a.Vector3;return function(j,k){b=0,i.subtractVectors(k,j),c=i.length(),i.scale(1/c);for(var l=0;3>l;l++){if(d=0===l?"x":1===l?"y":"z",h=0===l?this.half_width:1===l?this.half_height:this.half_depth,Math.abs(i[d])<a.EPSILON&&(j[d]<-h||j[d]>h))return null;if(e=1/i[d],f=(-h-j[d])*e,g=(h-j[d])*e,f>g&&(e=f,f=g,g=e),b=Math.max(b,f),c=Math.min(c,g),b>c)return null}var m=a.ObjectPool.getObject("RayIntersection");m.object=this,m.t=b,m.point.scaleVector(i,b),m.point.add(j);var n=1/0;for(l=0;3>l;l++)d=0===l?"x":1===l?"y":"z",h=0===l?this.half_width:1===l?this.half_height:this.half_depth,h-Math.abs(m.point[d])<n&&(m.normal.x=m.normal.y=m.normal.z=0,m.normal[d]=m.point[d]<0?-1:1,n=h-Math.abs(m.point[d]));return m}}(),a.CompoundShape=function(){this.child_shapes=[],this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb)},a.CompoundShape.prototype.addChildShape=function(b,c,d){this.child_shapes.push(new a.CompoundShapeChild(b,c,d)),this.calculateLocalAABB(this.aabb)},a.CompoundShape.prototype.calculateLocalAABB=function(a){a.min.x=a.min.y=a.min.z=1/0,a.max.x=a.max.y=a.max.z=-1/0;var b,c;for(b=0;b<this.child_shapes.length;b++)c=this.child_shapes[b],a.min.x=Math.min(a.min.x,c.aabb.min.x),a.min.y=Math.min(a.min.y,c.aabb.min.y),a.min.z=Math.min(a.min.z,c.aabb.min.z),a.max.x=Math.max(a.max.x,c.aabb.max.x),a.max.y=Math.max(a.max.y,c.aabb.max.y),a.max.z=Math.max(a.max.z,c.aabb.max.z)},a.CompoundShape.prototype.getInertiaTensor=function(c){var d,e,f,i=new a.Matrix3,j=new a.Matrix3;for(i.identity(),c/=this.child_shapes.length,b.x=b.y=b.z=0,d=0;d<this.child_shapes.length;d++)e=this.child_shapes[d],b.subtract(e.position),j.e00=c*-(b.y*b.y+b.z*b.z),j.e10=c*b.x*b.y,j.e20=c*b.x*b.z,j.e01=c*b.x*b.y,j.e11=c*-(b.x*b.x+b.z*b.z),j.e21=c*b.y*b.z,j.e02=c*b.x*b.z,j.e12=c*b.y*b.z,j.e22=c*-(b.x*b.x+b.y*b.y),g.fromMatrix4(e.transform),f=e.shape.getInertiaTensor(c),g.transposeInto(h),g.multiply(f),g.multiply(h),i.e00+=g.e00+j.e00,i.e10+=g.e10+j.e10,i.e20+=g.e20+j.e20,i.e01+=g.e01+j.e01,i.e11+=g.e11+j.e11,i.e21+=g.e21+j.e21,i.e02+=g.e02+j.e02,i.e12+=g.e12+j.e12,i.e22+=g.e22+j.e22;return i},a.CompoundShape.prototype.rayIntersect=function(){var b=function(a,b){return a.t<b.t?-1:a.t>b.t?1:0};return function(c,d){var e,f,g,h=[],i=new a.Vector3,j=new a.Vector3;for(f=0;f<this.child_shapes.length;f++)g=this.child_shapes[f],g.transform_inverse.transformVector3Into(c,i),g.transform_inverse.transformVector3Into(d,j),e=g.shape.rayIntersect(i,j),null!=e&&(e.object=this,g.transform.transformVector3(e.point),h.push(e));return h.sort(b),h[0]||null}}(),a.CompoundShapeChild=function(b,c,d){this.shape=b,this.position=new a.Vector3(c.x,c.y,c.z),this.rotation=new a.Quaternion(d.x,d.y,d.z,d.w),this.transform=new a.Matrix4,this.transform_inverse=new a.Matrix4,this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this.aabb=new a.AABB,this.aabb.transform(this.shape.aabb,this.transform)},a.ConeShape=function(b,c){this.radius=b,this.half_height=c,this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb),this._sinangle=this.radius/Math.sqrt(this.radius*this.radius+Math.pow(2*this.half_height,2)),this._cosangle=Math.cos(Math.asin(this._sinangle))},a.ConeShape.prototype.calculateLocalAABB=function(a){a.min.x=a.min.z=-this.radius,a.min.y=-this.half_height,a.max.x=a.max.z=this.radius,a.max.y=this.half_height},a.ConeShape.prototype.getInertiaTensor=function(b){var c=.1*b*Math.pow(2*this.half_height,2)+.15*b*this.radius*this.radius;return new a.Matrix3(c,0,0,0,.3*b*this.radius*this.radius,0,0,0,c)},a.ConeShape.prototype.findSupportPoint=function(a,b){var c=Math.sqrt(a.x*a.x+a.z*a.z);if(a.y>a.length()*this._sinangle)b.x=b.z=0,b.y=this.half_height;else if(c>0){var d=this.radius/c;b.x=d*a.x,b.y=-this.half_height,b.z=d*a.z}else b.x=b.z=0,b.y=-this.half_height},a.ConeShape.prototype.rayIntersect=function(){var b,c=new a.Vector3,d=new a.Vector3,e=new a.Vector3,f=new a.Vector3,g=new a.Vector3;return function(h,i){c.subtractVectors(i,h),b=c.length(),c.scale(1/b);var j,k;d.x=d.y=d.z=0,j=this._rayIntersectBase(h,i,d,f),e.x=e.y=e.z=0,k=this._rayIntersectCone(h,c,b,e,g);var l;return j||k?!k||j&&k>j?(l=a.ObjectPool.getObject("RayIntersection"),l.object=this,l.t=j,l.point.copy(d),l.normal.copy(f),l):!j||k&&j>k?(l=a.ObjectPool.getObject("RayIntersection"),l.object=this,l.t=k,l.point.copy(e),l.normal.copy(g),l):null:null}}(),a.ConeShape.prototype._rayIntersectBase=function(){var b,c=new a.Vector3(0,-1,0),d=new a.Vector3,e=new a.Vector3,f=new a.Vector3;return function(a,g,h,i){return e.x=a.x,e.y=a.y+this.half_height,e.z=a.z,f.x=g.x,f.y=g.y+this.half_height,f.z=g.z,d.subtractVectors(f,e),b=-c.dot(e)/c.dot(d),0>b||b>1?null:(h.scaleVector(d,b),h.add(a),h.x*h.x+h.z*h.z>this.radius*this.radius?null:(i.x=i.z=0,i.y=-1,b*d.length()))}}(),a.ConeShape.prototype._rayIntersectCone=function(){var c=new a.Vector3;return function(d,e,f,g,h){var i=new a.Vector3(0,-1,0),j=i.dot(e),k=this._cosangle*this._cosangle,l=new a.Vector3;l.x=d.x,l.y=d.y-this.half_height,l.z=d.z;var m,n,o=i.dot(l),p=e.dot(l),q=l.dot(l),r=j*j-k,s=j*o-k*p,t=o*o-k*q,u=null;if(Math.abs(r)>=a.EPSILON){var v=s*s-t*r;if(v<-a.EPSILON)return null;if(v>a.EPSILON){var w=Math.sqrt(v),x=1/r;if(n=(-s-w)*x,n>=0&&f>=n&&(c.scaleVector(e,n),c.add(d),l.y=c.y-this.half_height,m=l.dot(i),m>=0&&(u=n,g.copy(c))),n=(-s+w)*x,n>=0&&f>=n&&(null==u||u>n)&&(c.scaleVector(e,n),c.add(d),l.y=c.y-this.half_height,m=l.dot(i),m>=0&&(u=n,g.copy(c))),null==u)return null;u/=f}else{if(n=-s/r,c.scaleVector(e,n),c.add(d),l.y=c.y-this.half_height,m=l.dot(i),0>m)return null;if(b.subtractVectors(c,d),b.lengthSquared()>f*f)return null;u=n/f,g.copy(c)}}else{if(!(Math.abs(s)>=a.EPSILON))return null;if(n=.5*t/s,c.scaleVector(e,n),c.add(d),l.y=c.y-this.half_height,m=l.dot(i),0>m)return null;u=n,g.copy(c)}return g.y<-this.half_height?null:(h.x=g.x,h.y=0,h.z=g.z,h.normalize(),h.x*=2*this.half_height/this.radius,h.y=this.radius/(2*this.half_height),h.z*=2*this.half_height/this.radius,h.normalize(),u*f)}}(),a.ConvexShape=function(b){this.vertices=[],this.faces=[],this.volume=0,this.center_of_mass=new a.Vector3,this._integral=new Float32Array(10),this.process(b),this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb)},a.ConvexShape.prototype.process=function(d){for(var e=d.slice(),f=null,g=null,h=0;h<e.length;h++){var i=e[h];(null==f||f.x>i.x)&&(f=i),(null==g||g.x>i.x)&&(g=i)}f===g&&(g=d[0]===f?d[1]:d[0]);var j=f,k=g;e.splice(e.indexOf(j),1),e.splice(e.indexOf(k),1);var l,m,n=-1/0,o=null;for(h=0;h<e.length;h++)l=e[h],m=a.GeometryMethods.findSquaredDistanceFromSegment(l,j,k),m>n&&(n=m,o=h);var p=e[o];for(e.splice(o,1),b.subtractVectors(k,j),c.subtractVectors(p,j),b.cross(c),n=-1/0,o=null,h=0;h<e.length;h++)l=e[h],m=Math.abs(b.dot(l)),m>n&&(n=m,o=h);var q=e[o];if(e.splice(o,1),b.dot(q)>0){var r=j;j=p,p=r}var s=new a.GjkEpa.Polyhedron({points:[{point:p},{point:k},{point:j},{point:q}]});for(h=0;h<e.length;h++){s.closest_face=null;for(var t=0;t<s.faces.length;t++)if(s.faces[t].active===!0&&s.faces[t].classifyVertex({point:e[h]})>0){s.closest_face=t;break}null!=s.closest_face&&s.addVertex({point:e[h]})}this.faces=s.faces.filter(function(a){return a.active});var u=this;this.faces.forEach(function(a){var b=a.a.point,c=a.b.point,d=a.c.point,e=u.vertices.indexOf(b),f=u.vertices.indexOf(c),g=u.vertices.indexOf(d);-1===e&&u.vertices.push(b),-1===f&&u.vertices.push(c),-1===g&&u.vertices.push(d)}),this.computeVolume(this.faces)},a.ConvexShape.prototype.calculateLocalAABB=function(a){a.min.x=a.min.y=a.min.z=0,a.max.x=a.max.y=a.max.z=0;for(var b=0;b<this.vertices.length;b++)a.min.x=Math.min(a.min.x,this.vertices[b].x),a.min.y=Math.min(a.min.y,this.vertices[b].y),a.min.z=Math.min(a.min.z,this.vertices[b].z),a.max.x=Math.max(a.max.x,this.vertices[b].x),a.max.y=Math.max(a.max.y,this.vertices[b].y),a.max.z=Math.max(a.max.z,this.vertices[b].z)},a.ConvexShape.prototype.computeVolume=function(){var b={point:new a.Vector3},c=new Float32Array(6),d=function(a,b,d){var e=a+b,f=a*a,g=f+b*e;c[0]=e+d,c[1]=g+d*c[0],c[2]=a*f+b*g+d*c[1],c[3]=c[1]+a*(c[0]+a),c[4]=c[1]+b*(c[0]+b),c[5]=c[1]+d*(c[0]+d)};return function(a){for(var e=0;e<a.length;e++){var f=a[e],g=f.a.point,h=f.b.point,i=f.c.point,j=h.x-g.x,k=h.y-g.y,l=h.z-g.z,m=i.x-g.x,n=i.y-g.y,o=i.z-g.z,p=k*o-n*l,q=m*l-j*o,r=j*n-m*k;d(g.x,h.x,i.x);var s=c[0],t=c[1],u=c[2],v=c[3],w=c[4],x=c[5];d(g.y,h.y,i.y);var y=(c[0],c[1]),z=c[2],A=c[3],B=c[4],C=c[5];d(g.z,h.z,i.z);var D=(c[0],c[1]),E=c[2],F=c[3],G=c[4],H=c[5],I=f.classifyVertex(b)>0?-1:1;this._integral[0]+=I*p*s,this._integral[1]+=I*p*t,this._integral[2]+=I*q*y,this._integral[3]+=I*r*D,this._integral[4]+=I*p*u,this._integral[5]+=I*q*z,this._integral[6]+=I*r*E,this._integral[7]+=I*p*(g.y*v+h.y*w+i.y*x),this._integral[8]+=I*q*(g.z*A+h.z*B+i.z*C),this._integral[9]+=I*r*(g.x*F+h.x*G+i.x*H)}this._integral[0]*=1/6,this._integral[1]*=1/24,this._integral[2]*=1/24,this._integral[3]*=1/24,this._integral[4]*=1/60,this._integral[5]*=1/60,this._integral[6]*=1/60,this._integral[7]*=1/120,this._integral[8]*=1/120,this._integral[9]*=1/120,this.volume=this._integral[0],this.center_of_mass.x=this._integral[1]/this.volume,this.center_of_mass.y=this._integral[2]/this.volume,this.center_of_mass.z=this._integral[3]/this.volume}}(),a.ConvexShape.prototype.getInertiaTensor=function(){return function(b){var c=new a.Matrix3;return b/=this.volume,c.e00=(this._integral[5]+this._integral[6])*b,c.e11=(this._integral[4]+this._integral[6])*b,c.e22=(this._integral[4]+this._integral[5])*b,c.e10=c.e01=-this._integral[7]*b,c.e21=c.e12=-this._integral[8]*b,c.e20=c.e02=-this._integral[9]*b,c.e00-=b*(this.center_of_mass.y*this.center_of_mass.y+this.center_of_mass.z*this.center_of_mass.z),c.e11-=b*(this.center_of_mass.x*this.center_of_mass.x+this.center_of_mass.z*this.center_of_mass.z),c.e22-=b*(this.center_of_mass.x*this.center_of_mass.x+this.center_of_mass.y*this.center_of_mass.y),c.e10+=b*this.center_of_mass.x*this.center_of_mass.y,c.e01+=b*this.center_of_mass.x*this.center_of_mass.y,c.e21+=b*this.center_of_mass.y*this.center_of_mass.z,c.e12+=b*this.center_of_mass.y*this.center_of_mass.z,c.e20+=b*this.center_of_mass.x*this.center_of_mass.z,c.e02+=b*this.center_of_mass.x*this.center_of_mass.z,c}}(),a.ConvexShape.prototype.findSupportPoint=function(a,b){for(var c,d,e=-1/0,f=0;f<this.vertices.length;f++)d=this.vertices[f].dot(a),d>e&&(e=d,c=f);b.copy(this.vertices[c])},a.ConvexShape.prototype.rayIntersect=function(){{var b,c,d=new a.Vector3,e=new a.Vector3,f=new a.Vector3,g=new a.Vector3,h=new a.Vector3,i=new a.Vector3;new a.Vector3,new a.Vector3}return function(j,k){b=0,d.subtractVectors(k,j),c=d.length(),d.scale(1/c);for(var l=0;l<this.faces.length;l++){var m=this.faces[l];e.subtractVectors(m.b.point,m.a.point),f.subtractVectors(m.c.point,m.a.point),g.crossVectors(d,f);var n=e.dot(g);if(!(n<a.EPSILON)){var o=1/n;h.subtractVectors(j,m.a.point);var p=o*h.dot(g);if(!(0>p)){i.crossVectors(h,e);var q=o*d.dot(i);if(!(0>q||p+q>1)){var r=o*f.dot(i);if(!(b>r||r>c)){var s=a.ObjectPool.getObject("RayIntersection");return s.object=this,s.t=r,s.point.scaleVector(d,r),s.point.add(j),s.normal.copy(m.normal),s}}}}}return null}}(),a.CylinderShape=function(b,c){this.radius=b,this.half_height=c,this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb)},a.CylinderShape.prototype.calculateLocalAABB=function(a){a.min.x=a.min.z=-this.radius,a.min.y=-this.half_height,a.max.x=a.max.z=this.radius,a.max.y=this.half_height},a.CylinderShape.prototype.getInertiaTensor=function(b){var c=.0833*b*(3*this.radius*this.radius+(this.half_height+this.half_height)*(this.half_height+this.half_height));return new a.Matrix3(c,0,0,0,.5*b*this.radius*this.radius,0,0,0,c)},a.CylinderShape.prototype.findSupportPoint=function(a,b){if(b.y=a.y<0?-this.half_height:this.half_height,0===a.x&&0===a.z)b.x=b.z=0;else{var c=Math.sqrt(a.x*a.x+a.z*a.z),d=this.radius/c;b.x=d*a.x,b.z=d*a.z}},a.CylinderShape.prototype.rayIntersect=function(){var b=new a.Vector3,c=new a.Vector3;return function(d,e){b.y=this.half_height,c.y=-this.half_height;var f=new a.Vector3;f.subtractVectors(c,b);var g=new a.Vector3;g.subtractVectors(d,b);var h=new a.Vector3;h.subtractVectors(e,d);var i=g.dot(f),j=h.dot(f),k=f.dot(f);if(0>i&&0>i+j)return null;if(i>k&&i+j>k)return null;var l,m,n=h.dot(h),o=g.dot(h),p=k*n-j*j,q=g.dot(g)-this.radius*this.radius,r=k*q-i*i;if(Math.abs(p)<a.EPSILON){if(r>0)return null;l=0>i?-o/n:i>k?(j-o)/n:0}else{var s=k*o-j*i,t=s*s-p*r;if(0>t)return null;if(m=l=(-s-Math.sqrt(t))/p,0>i+l*j){if(0>=j)return null;if(l=-i/j,!(0>=q+l*(2*o+l*n)))return null;m=l}else if(i+l*j>k){if(j>=0)return null;if(l=(k-i)/j,!(0>=q+k-2*i+l*(2*(o-j)+l*n)))return null;m=l}if(l=m,0>l||l>1)return null}var u=a.ObjectPool.getObject("RayIntersection");return u.object=this,u.t=l*h.length(),u.point.scaleVector(h,l),u.point.add(d),Math.abs(u.point.y-this.half_height)<=a.EPSILON?(u.normal.x=u.normal.z=0,u.normal.y=u.point.y<0?-1:1):(u.normal.y=0,u.normal.x=u.point.x,u.normal.z=u.point.z,u.normal.scale(1/this.radius)),u}}(),a.MeshShape=function(b,c){this.vertices=b,this.triangles=[];for(var d=0;d<c.length;d+=3)this.triangles.push(new a.TriangleShape(b[c[d]],b[c[d+1]],b[c[d+2]]));this.volume=0,this.center_of_mass=new a.Vector3,this._integral=new Float32Array(10),this.hierarchy=new a.BVH(this.triangles).tree;var e=this.triangles.map(function(b){return new a.GjkEpa.Face(null,{point:b.a},{point:b.b},{point:b.c})});a.ConvexShape.prototype.computeVolume.call(this,e),this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb)},a.MeshShape.prototype.calculateLocalAABB=function(a){a.min.x=a.min.y=a.min.z=0,a.max.x=a.max.y=a.max.z=0;for(var b=0;b<this.vertices.length;b++)a.min.x=Math.min(a.min.x,this.vertices[b].x),a.min.y=Math.min(a.min.y,this.vertices[b].y),a.min.z=Math.min(a.min.z,this.vertices[b].z),a.max.x=Math.max(a.max.x,this.vertices[b].x),a.max.y=Math.max(a.max.y,this.vertices[b].y),a.max.z=Math.max(a.max.z,this.vertices[b].z)},a.MeshShape.prototype.getInertiaTensor=function(b){return a.ConvexShape.prototype.getInertiaTensor.call(this,b)},a.MeshShape.prototype.findSupportPoint=function(){},a.MeshShape.prototype.rayIntersect=function(){var a=[],b=function(a,b){return a.t<b.t?-1:a.t>b.t?1:0};return function(c,d){var e,f=[this.hierarchy];a.length=0;for(var g=0;f.length>0;)if(g++,e=f.shift(),e.aabb.testRayIntersect(c,d))if(e.isLeaf()){var h=e.object.rayIntersect(c,d);null!=h&&a.push(h)}else f.push(e.left,e.right);return a.sort(b),a[0]||null}}(),a.PlaneShape=function(b,c,d){this.orientation=b,this.half_width=c,this.half_length=d,this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb),0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0)},a.PlaneShape.prototype.calculateLocalAABB=function(a){0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length,a.min.x=0,a.min.y=-this.half_width,a.min.z=-this.half_length,a.max.x=0,a.max.y=this.half_width,a.max.z=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length,a.min.x=-this.half_width,a.min.y=0,a.min.z=-this.half_length,a.max.x=this.half_width,a.max.y=0,a.max.z=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0,a.min.x=-this.half_width,a.min.y=-this.half_length,a.min.z=0,a.max.x=this.half_width,a.max.y=this.half_length,a.max.z=0)},a.PlaneShape.prototype.getInertiaTensor=function(b){var c=this.half_width*this.half_width*4,d=this.half_length*this.half_length*4,e=.0833*b,f=e*d,g=e*(c+d),h=e*c;return 0===this.orientation?new a.Matrix3(g,0,0,0,f,0,0,0,h):1===this.orientation?new a.Matrix3(f,0,0,0,g,0,0,0,h):new a.Matrix3(g,0,0,0,h,0,0,0,f)},a.PlaneShape.prototype.findSupportPoint=function(a,b){b.x=a.x<0?-this._half_width:this._half_width,b.y=a.y<0?-this._half_height:this._half_height,b.z=a.z<0?-this._half_depth:this._half_depth},a.PlaneShape.prototype.rayIntersect=function(){var b,c=new a.Vector3,d=new a.Vector3,e=new a.Vector3;return function(f,g){if(0===this.orientation?(c.x=1,c.y=c.z=0):1===this.orientation?(c.y=1,c.x=c.z=0):(c.z=1,c.x=c.y=0),d.subtractVectors(g,f),b=-c.dot(f)/c.dot(d),0>b||b>1)return null;if(e.scaleVector(d,b),e.add(f),e.x<-this._half_width||e.x>this._half_width)return null;if(e.y<-this._half_height||e.y>this._half_height)return null;if(e.z<-this._half_depth||e.z>this._half_depth)return null;var h=a.ObjectPool.getObject("RayIntersection");return h.object=this,h.t=b*d.length(),h.point.copy(e),h.normal.copy(c),h}}(),a.SphereShape=function(b){this.radius=b,this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb)},a.SphereShape.prototype.calculateLocalAABB=function(a){a.min.x=a.min.y=a.min.z=-this.radius,a.max.x=a.max.y=a.max.z=this.radius},a.SphereShape.prototype.getInertiaTensor=function(b){var c=.4*b*this.radius*this.radius;return new a.Matrix3(c,0,0,0,c,0,0,0,c)},a.SphereShape.prototype.findSupportPoint=function(){var b=new a.Vector3;return function(a,c){b.normalizeVector(a),c.scaleVector(b,this.radius)}}(),a.SphereShape.prototype.rayIntersect=function(){var b,c=new a.Vector3;return function(d,e){c.subtractVectors(e,d),b=c.length(),c.scale(1/b);var f=d.dot(c),g=d.dot(d)-this.radius*this.radius;if(f>=0&&g>=0)return null;var h=f*f-g;if(0>h)return null;var i=Math.sqrt(h),j=-f-i;if(0>j&&(j=-f+i),j>b)return null;var k=a.ObjectPool.getObject("RayIntersection");return k.object=this,k.point.scaleVector(c,j),k.t=j,k.point.add(d),k.normal.normalizeVector(k.point),k}}(),a.LineSweptShape=function(b,c,d){this.start=b,this.end=c,this.shape=d,this.direction=new a.Vector3,this.direction.subtractVectors(c,b),this.length=this.direction.length(),this.direction.normalize(),this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb)},a.LineSweptShape.prototype.calculateLocalAABB=function(a){this.shape.calculateLocalAABB(a),a.min.x=Math.min(a.min.x+this.start.x,a.min.x+this.end.x),a.min.y=Math.min(a.min.y+this.start.y,a.min.y+this.end.y),a.min.z=Math.min(a.min.z+this.start.z,a.min.z+this.end.z),a.max.x=Math.max(a.max.x+this.start.x,a.max.x+this.end.x),a.max.y=Math.max(a.max.y+this.start.y,a.max.y+this.end.y),a.max.z=Math.max(a.max.z+this.start.z,a.max.z+this.end.z)},a.LineSweptShape.prototype.getInertiaTensor=function(a){return this.shape.getInertiaTensor(a)},a.LineSweptShape.prototype.findSupportPoint=function(a,b){this.shape.findSupportPoint(a,b);var c=this.direction.dot(a);b.add(0>c?this.start:this.end)},a.LineSweptShape.prototype.rayIntersect=function(){return null},a.TriangleShape=function(d,e,f){this.a=d,this.b=e,this.c=f,this.normal=new a.Vector3,b.subtractVectors(this.b,this.a),c.subtractVectors(this.c,this.a),this.normal.crossVectors(b,c),this.volume=this.normal.length()/2,this.normal.normalize(),this.aabb=new a.AABB,this.calculateLocalAABB(this.aabb)},a.TriangleShape.prototype.calculateLocalAABB=function(a){a.min.x=Math.min(this.a.x,this.b.x,this.c.x),a.min.y=Math.min(this.a.y,this.b.y,this.c.y),a.min.z=Math.min(this.a.z,this.b.z,this.c.z),a.max.x=Math.max(this.a.x,this.b.x,this.c.x),a.max.y=Math.max(this.a.y,this.b.y,this.c.y),a.max.z=Math.max(this.a.z,this.b.z,this.c.z)},a.TriangleShape.prototype.getInertiaTensor=function(){return new a.Matrix3(0,0,0,0,0,0,0,0,0)},a.TriangleShape.prototype.classifyVertex=function(a){var b=this.normal.dot(this.a);return this.normal.dot(a)-b},a.TriangleShape.prototype.findSupportPoint=function(a,b){var c,d=-1/0;c=a.dot(this.a),c>d&&(b.copy(this.a),d=c),c=a.dot(this.b),c>d&&(b.copy(this.b),d=c),c=a.dot(this.c),c>d&&b.copy(this.c)},a.TriangleShape.prototype.rayIntersect=function(){var b=new a.Vector3,c=new a.Vector3,d=new a.Vector3,e=new a.Vector3,f=new a.Vector3,g=new a.Vector3;return function(h,i){b.subtractVectors(this.b,this.a),c.subtractVectors(this.c,this.a),d.crossVectors(b,c),e.subtractVectors(i,h);var j=-e.dot(d);if(0>=j)return null;f.subtractVectors(h,this.a);var k=f.dot(d)/j;if(0>k||k>1)return null;g.crossVectors(f,e);var l=c.dot(g)/j,m=-b.dot(g)/j;if(l+m>1||0>l||0>m)return null;var n=a.ObjectPool.getObject("RayIntersection");return n.object=this,n.t=k*e.length(),n.point.scaleVector(e,k),n.point.add(h),n.normal.copy(this.normal),n}}(),a.GeometryMethods={findClosestPointInTriangle:function(){var b=new a.Vector3,c=new a.Vector3,d=new a.Vector3;return function(a,e,f,g,h){var i;b.subtractVectors(f,e),c.subtractVectors(g,e),d.subtractVectors(a,e);var j=b.dot(d),k=c.dot(d);if(0>=j&&0>=k)return void h.copy(e);d.subtractVectors(a,f);var l=b.dot(d),m=c.dot(d);if(l>=0&&l>=m)return void h.copy(f);var n=j*m-l*k;if(0>=n&&j>=0&&0>=l)return i=j/(j-l),h.scaleVector(b,i),void h.add(e);d.subtractVectors(a,g);var o=b.dot(d),p=c.dot(d);if(p>=0&&p>=o)return void h.copy(g);var q,r=o*k-j*p;if(0>=r&&k>=0&&0>=p)return q=k/(k-p),h.scaleVector(c,q),void h.add(e);var s=l*p-o*m;if(0>=s&&m-l>=0&&o-p>=0)return q=(m-l)/(m-l+(o-p)),h.subtractVectors(g,f),h.scale(q),void h.add(f);var t=1/(s+r+n);i=r*t,q=n*t,b.scale(i),b.add(e),c.scale(q),h.addVectors(b,c)}}(),findBarycentricCoordinates:function(b,c,d,e,f){var g=new a.Vector3,h=new a.Vector3,i=new a.Vector3;g.subtractVectors(d,c),h.subtractVectors(e,c),i.subtractVectors(b,c);var j=g.dot(g),k=g.dot(h),l=h.dot(h),m=i.dot(g),n=i.dot(h),o=j*l-k*k;
f.y=(l*m-k*n)/o,f.z=(j*n-k*m)/o,f.x=1-f.y-f.z},findSquaredDistanceFromSegment:function(){var b=new a.Vector3,c=new a.Vector3,d=new a.Vector3;return function(a,e,f){b.subtractVectors(e,f),c.subtractVectors(e,a),d.subtractVectors(f,a);var g=c.dot(b);if(0>=g)return c.dot(c);var h=b.dot(b);return g>=h?d.dot(d):c.dot(c)-g*g/h}}(),findClosestPointsOnSegments:function(){var c=new a.Vector3,d=new a.Vector3,e=new a.Vector3,f=function(a,b,c){return Math.min(Math.max(a,b),c)};return function(g,h,i,j,k,l){c.subtractVectors(h,g),d.subtractVectors(j,i),e.subtractVectors(g,i);var m,n,o=c.dot(c),p=d.dot(d),q=d.dot(e);if(o<=a.EPSILON&&p<=a.EPSILON)return m=n=0,k.copy(g),l.copy(i),b.subtractVectors(k,l),b.dot(b);if(o<=a.EPSILON)m=0,n=q/p,n=f(n,0,1);else{var r=c.dot(e);if(p<=a.EPSILON)n=0,m=f(-r/o,0,1);else{var s=c.dot(d),t=o*p-s*s;m=0!==t?f((s*q-r*p)/t,0,1):0,n=(s*m+q)/p,0>n?(n=0,m=f(-r/o,0,1)):n>1&&(n=1,m=f((s-r)/o,0,1))}}return k.scaleVector(c,m),k.add(g),l.scaleVector(d,n),l.add(i),b.subtractVectors(k,l),b.dot(b)}}()},function(){a.MinHeap=function(a){this.heap=null==a?[]:a.slice(),this.heap.length>0&&this.heapify()},a.MinHeap.prototype={heapify:function(){for(var a=~~((this.heap.length-2)/2);a>=0;)this.siftUp(a,this.heap.length-1),a--},siftUp:function(a,b){for(var c=a;b>=2*c+1;){var d=2*c+1;if(b>=d+1&&this.heap[d+1].valueOf()<this.heap[d].valueOf()&&d++,!(this.heap[d].valueOf()<this.heap[c].valueOf()))return;var e=this.heap[d];this.heap[d]=this.heap[c],this.heap[c]=e,c=d}},push:function(a){this.heap.push(a);for(var b=this.heap.length-1;0!==b;){var c=~~((b-1)/2);if(this.heap[c].valueOf()>this.heap[b].valueOf()){var d=this.heap[c];this.heap[c]=this.heap[b],this.heap[b]=d}b=c}},peek:function(){return this.heap.length>0?this.heap[0]:null},pop:function(){var a=this.heap[0];return this.heap[0]=this.heap[this.heap.length-1],this.heap.length=this.heap.length-1,this.siftUp(0,this.heap.length-1),a}}}(),a.World=function(b,c,d){this.ticks=0,this.broadphase=b,this.narrowphase=c,this.solver=d,d.world=this,this.rigid_bodies=[],this.gravity=new a.Vector3(0,-9.8,0),this.force_generators=[],this.listeners={}},a.EventEmitter.apply(a.World),a.World.prototype.step=function(a,c){c=c||a;var d,e,f,g,h,i;for(f=a/c,d=0;f>d;d++){for(this.ticks++,e=Math.min(c,a),a-=c,this.emit("stepStart",this.ticks,e),g=0,h=this.rigid_bodies.length;h>g;g++)this.rigid_bodies[g].updateDerived();for(g=0,h=this.rigid_bodies.length;h>g;g++)i=this.rigid_bodies[g],1/0!==i._mass&&(b.scaleVector(i.gravity||this.gravity,i._mass*e),i.accumulated_force.add(b));for(g=0,h=this.force_generators.length;h>g;g++)this.force_generators[g].applyForce();for(this.broadphase.predictContactPairs(),this.narrowphase.generateContacts(this.broadphase.collision_pairs),this.solver.processContactManifolds(this.narrowphase.contact_manifolds),this.solver.prepareConstraints(e),this.solver.resolveContacts(),this.solver.solveConstraints(),this.solver.applyConstraints(e),g=0,h=this.rigid_bodies.length;h>g;g++)i=this.rigid_bodies[g],i.integrate(e);this.emit("stepEnd",this.ticks,e)}},a.World.prototype.addRigidBody=function(a){a.world=this,a.updateDerived(),this.rigid_bodies.push(a),this.broadphase.addBody(a)},a.World.prototype.removeRigidBody=function(a){var b,c=this.rigid_bodies.length;for(b=0;c>b;b++)if(this.rigid_bodies[b]===a){this.rigid_bodies.splice(b,1),this.broadphase.removeBody(a);break}},a.World.prototype.addForceGenerator=function(a){var b,c;for(b=0,c=this.force_generators.length;c>b;b++)if(this.force_generators[b]===a)return;this.force_generators.push(a)},a.World.prototype.removeForceGenerator=function(a){var b,c;for(b=0,c=this.force_generators.length;c>b;b++)if(this.force_generators[b]===a)return void this.force_generators.splice(b,1)},a.World.prototype.addConstraint=function(a){this.solver.addConstraint(a)},a.World.prototype.removeConstraint=function(a){this.solver.removeConstraint(a)},function(){var b=function(a,b){return a.t<b.t?-1:a.t>b.t?1:0};a.World.prototype.rayIntersect=function(a,c){var d=this.broadphase.rayIntersect(a,c);return d.sort(b),d},a.World.prototype.shapeIntersect=function(c,d,e){var f=new a.LineSweptShape(d,e,c),g=new a.RigidBody(f,0);g.updateDerived();for(var h=this.broadphase.intersectsWith(g),i=[],j=0;j<h.length;j++){var k=this.narrowphase.getContact(g,h[j]);if(null!=k){var l=a.ObjectPool.getObject("RayIntersection");l.object=k.object_b,l.normal.copy(k.contact_normal),l.point.scaleVector(k.contact_normal,-k.penetration_depth),l.point.add(k.contact_point),l.t=l.point.distanceTo(d),i.push(l)}}return i.sort(b),i}}(),"undefined"!=typeof window&&(window.Goblin=a),"undefined"!=typeof module&&(module.exports=a)}();